function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e2){throw _e2},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e3){didErr=true;err=_e3},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]()}finally{if(didErr)throw err}}}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_x,_r,_arr=[],_n=!0,_d=!1;try{if(_x=(_i=_i.call(arr)).next,0===i){if(Object(_i)!==_i)return;_n=!1}else for(;!(_n=(_s=_x.call(_i)).done)&&(_arr.push(_s.value),_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{if(!_n&&null!=_i["return"]&&(_r=_i["return"](),Object(_r)!==_r))return}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor}function _defineProperty(obj,key,value){key=_toPropertyKey(key);if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return _typeof(key)==="symbol"?key:String(key)}function _toPrimitive(input,hint){if(_typeof(input)!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(_typeof(res)!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return(hint==="string"?String:Number)(input)}import{createTaskProcessor}from"./createTaskProcessor.js";var Queue=function(){function Queue(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var compare=arguments.length>1&&arguments[1]!==undefined?arguments[1]:defaultCompare;_classCallCheck(this,Queue);_defineProperty(this,"data",void 0);_defineProperty(this,"length",void 0);_defineProperty(this,"compare",void 0);this.data=data;this.length=this.data.length;this.compare=compare;if(this.length>0){for(var i=(this.length>>1)-1;i>=0;i--)this._down(i)}}_createClass(Queue,[{key:"push",value:function push(item){this.data.push(item);this._up(this.length++)}},{key:"pop",value:function pop(){if(this.length===0)return undefined;var top=this.data[0];var bottom=this.data.pop();if(--this.length>0){this.data[0]=bottom;this._down(0)}return top}},{key:"peek",value:function peek(){return this.data[0]}},{key:"_up",value:function _up(pos){var data=this.data,compare=this.compare;var item=data[pos];while(pos>0){var parent=pos-1>>1;var current=data[parent];if(compare(item,current)>=0)break;data[pos]=current;pos=parent}data[pos]=item}},{key:"_down",value:function _down(pos){var data=this.data,compare=this.compare;var halfLength=this.length>>1;var item=data[pos];while(pos<halfLength){var bestChild=(pos<<1)+1;var right=bestChild+1;if(right<this.length&&compare(data[right],data[bestChild])<0){bestChild=right}if(compare(data[bestChild],item)>=0)break;data[pos]=data[bestChild];pos=bestChild}data[pos]=item}}]);return Queue}();function defaultCompare(a,b){return a<b?-1:a>b?1:0}function polygonlabel(polygon,precision,debug){precision=precision||1;var minX;var minY;var maxX;var maxY;for(var i=0,len=polygon[0].length;i<len;i++){var p=polygon[0][i];if(!i||p[0]<minX)minX=p[0];if(!i||p[1]<minY)minY=p[1];if(!i||p[0]>maxX)maxX=p[0];if(!i||p[1]>maxY)maxY=p[1]}var width=maxX-minX;var height=maxY-minY;var cellSize=Math.min(width,height);var h=cellSize/2;var cellQueue=new Queue([],compareMax);for(var x=minX;x<maxX;x+=cellSize){for(var y=minY;y<maxY;y+=cellSize){cellQueue.push(new Cell(x+h,y+h,h,polygon))}}var center=getCentroidCell(polygon);var bestCell=center;var numProbes;while(cellQueue.length){var cell=cellQueue.pop();if(cell.d>bestCell.d){bestCell=cell;if(debug){console.warn("found best %d after %d probes",Math.round(1e4*cell.d)/1e4,numProbes)}}if(cell.max-bestCell.d<=precision)continue;h=cell.h/2;cellQueue.push(new Cell(cell.x-h,cell.y-h,h,polygon));cellQueue.push(new Cell(cell.x+h,cell.y-h,h,polygon));cellQueue.push(new Cell(cell.x-h,cell.y+h,h,polygon));cellQueue.push(new Cell(cell.x+h,cell.y+h,h,polygon));numProbes+=4}if(isNaN(bestCell.x)){console.warn("Cell-compute rushed into problems!",polygon,bestCell,center)}return[isNaN(bestCell.x)?center.x:bestCell.x,isNaN(bestCell.y)?center.y:bestCell.y]}function compareMax(a,b){return b.max-a.max}function Cell(x,y,h,polygon){this.x=x;this.y=y;this.h=h;this.d=pointToPolygonDist(x,y,polygon);this.max=this.d+this.h*Math.SQRT2}function pointToPolygonDist(x,y,polygon){var inside=false;var minDistSq=Infinity;for(var k=0,num=polygon.length;k<num;k++){var ring=polygon[k];for(var i=0,len=ring.length,j=len-1;i<len;j=i++){var a=ring[i];var b=ring[j];if(a[1]>y!==b[1]>y&&x<(b[0]-a[0])*(y-a[1])/(b[1]-a[1])+a[0]){inside=!inside}minDistSq=Math.min(minDistSq,getSegDistSq(x,y,a,b))}}return minDistSq===0?0:(inside?1:-1)*Math.sqrt(minDistSq)}function getCentroidCell(polygon){var area=0;var x=0;var y=0;var points=polygon[0];for(var i=0,len=points.length,j=len-1;i<len;j=i++){var a=points[i];var b=points[j];var f=a[0]*b[1]-b[0]*a[1];x+=(a[0]+b[0])*f;y+=(a[1]+b[1])*f;area+=f*3}if(area===0)return new Cell(points[0][0],points[0][1],0,polygon);return new Cell(x/area,y/area,0,polygon)}function getSegDistSq(px,py,a,b){var x=a[0];var y=a[1];var dx=b[0]-x;var dy=b[1]-y;if(dx!==0||dy!==0){var t=((px-x)*dx+(py-y)*dy)/(dx*dx+dy*dy);if(t>1){x=b[0];y=b[1]}else if(t>0){x+=dx*t;y+=dy*t}}dx=px-x;dy=py-y;return dx*dx+dy*dy}function mod(i,n){return(i%n+n)%n}function getPolygonArea(outline){var area=0;var n=outline.length;for(var i=0;i<=n-1;i++){var _outline$i=_slicedToArray(outline[i],2),x1=_outline$i[0],y1=_outline$i[1];var _outline$mod=_slicedToArray(outline[mod(i+1,n)],2),x2=_outline$mod[0],y2=_outline$mod[1];area+=x1*y2-x2*y1}area*=1/2;return Math.abs(area)}function getPolylineLength(line){var length=0;var len=line.length;if(len>1){var firstP;var secondP;for(var i=0;i<len-1;i++){firstP=line[i];secondP=line[(i+1)%len];length+=Math.pow(Math.pow(secondP[0]-firstP[0],2)+Math.pow(secondP[1]-firstP[1],2),0.5)}}return length}function computedLabel(parameters){var features=parameters.features,style=parameters.style,_parameters$poiCaches=parameters.poiCaches,poiCaches=_parameters$poiCaches===void 0?[]:_parameters$poiCaches;var _ref=style||{},_ref$labelPropertyNam=_ref.labelPropertyName,labelPropertyName=_ref$labelPropertyNam===void 0?"NAME":_ref$labelPropertyNam,_ref$maxFeatureNum=_ref.maxFeatureNum,maxFeatureNum=_ref$maxFeatureNum===void 0?100000:_ref$maxFeatureNum;var poiList=[];var centerLabelList=[];var featureNum=features.length;if(featureNum>0){var outlines;var line;var label;var coordinates;var altitude;var name;var interval=Math.max(1,Math.floor(featureNum/maxFeatureNum));var _loop=function _loop(){var _features$i=features[i],id=_features$i.id,geometry=_features$i.geometry,properties=_features$i.properties;switch(geometry.type){case"Polygon":outlines=geometry.coordinates;break;case"MultiPolygon":outlines=geometry.coordinates[0];break;case"LineString":line=geometry.coordinates;break;case"MultiLineString":line=geometry.coordinates[0];break;case"Point":coordinates=[geometry.coordinates];break;case"MultiPoint":coordinates=geometry.coordinates;break;default:return"continue";}if(outlines){var center=polygonlabel(outlines,0.1,false);altitude=center.length>2?center[2]:properties["Z"]!==undefined?properties["Z"]:properties["z"];name=properties[labelPropertyName.toUpperCase()];label={x:center[0],y:center[1],z:altitude,id:id,name:name,weight:getPolygonArea(outlines[0]),properties:properties};centerLabelList.push(label)}if(line){var centerIndex=Math.floor(line.length/2);var center1=line[centerIndex];var center2=line[centerIndex];altitude=center1.length>2?(center1[2]+center2[2])/2:properties["Z"]!==undefined?properties["Z"]:properties["z"];name=properties[labelPropertyName.toUpperCase()];label={x:(center1[0]+center2[0])/2,y:(center1[1]+center2[1])/2,z:altitude,id:id,name:name,weight:getPolylineLength(line),properties:properties};centerLabelList.push(label)}if(coordinates){var _iterator=_createForOfIteratorHelper(coordinates),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var coordinate=_step.value;if(coordinate.length>1&&!poiCaches.find(function(poi){return poi.id===id})){altitude=coordinate.length>2?coordinate[2]:properties["Z"]!==undefined?properties["Z"]:properties["z"];label={x:coordinate[0],y:coordinate[1],z:altitude,id:id,name:name,weight:Math.random()*100+1,properties:properties};poiList.push(label)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}};for(var i=0;i<featureNum;i+=interval){var _ret=_loop();if(_ret==="continue")continue}}poiList.sort(function(a,b){return a.weight-b.weight});centerLabelList.sort(function(a,b){return b.weight-a.weight});return{poiList:poiList,centerLabelList:centerLabelList}}self.onmessage=createTaskProcessor(computedLabel);