var C=Object.defineProperty;var A=(o,e,t)=>e in o?C(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var u=(o,e,t)=>(A(o,typeof e!="symbol"?e+"":e,t),t);import{d as N,c as w,r as O,a4 as $,N as U,T as b,w as W,R as B,aj as _,o as G,f as V}from"./element-plus.59ccb443.js";import{u as J}from"./login.a4e9287e.js";import{I as g,u as z,h as q,a as v,i as F,D as P,M as Z,b as I,y as j,B as H,X as K,c as X,J as Y,d as Q,v as ee,e as te,q as ie,f as re,_ as se,z as ae,g as ne,x as oe,j as le}from"./smart3d.ce055bc9.js";function M(o,e,t=0){let i="";if(t!==0){const s=new Date;s.setTime(s.getTime()+t*1e3),i=`; expires=${s.toUTCString()}`}document.cookie=`${o}=${encodeURI(e)}${i}; path=/`}function T(o){if(document.cookie.length>0){let e=document.cookie.indexOf(`${o}=`);if(e!==-1){e=e+o.length+1;let t=document.cookie.indexOf(";",e);return t===-1&&(t=document.cookie.length),decodeURI(document.cookie.substring(e,t)).replace(/'/g,"")}}return null}const S="server_user_id",E="server_user_token";function ce(o){const e=g.toDegrees(o.longitude),t=g.toDegrees(o.latitude),{height:i}=o;return{longitude:e,latitude:t,height:i}}function de(o){const{heading:e,pitch:t,roll:i}=o,s=ce(o.positionCartographic);return{InitialPosition:{lon:s.longitude,lat:s.latitude,height:s.height},InitialOrientation:{heading:g.toDegrees(e),pitch:g.toDegrees(t),roll:g.toDegrees(i)}}}class ue{constructor(e,t){u(this,"$message");u(this,"_viewer");u(this,"_vectorLayerManager");u(this,"_vectorUpdating");u(this,"layerInstance");if(this.$message=t,!z(e))throw new q("viewer is required.");this._viewer=e,this._vectorUpdating=!1,this.layerInstance=null}_add3DTiles(e,t=!0){const i=this._viewer.scene.primitives.add(new v({url:this.getResoureWithUserId(e.url)}));return i.readyPromise.then(()=>{t&&this._viewer.flyTo(i)}),this.layerInstance=i,i}_addImageTilesLayer(e,t=!0){const i=new F({url:new P({url:e.url})}),s=this._viewer.imageryLayers.addImageryProvider(i);return i.readyPromise&&i.readyPromise.then(()=>{s.imageryProvider?t&&this._viewer.camera.flyTo({destination:s.imageryProvider.rectangle}):t&&this._viewer.flyTo(s)}),i}_addWMSLayer(e,t=!0){if(e&&e.url){const i=new Z({url:this.getResoureWithUserId(e.url),layers:e.layerName,parameters:{service:"WMS",srs:"EPSG:4326",format:"image/png",transparent:!0},tilingScheme:new I,rectangle:e.rectangle});i.errorEvent.addEventListener(n=>{if(document.getElementsByClassName("el-message").length===0){let d="服务加载失败, 找不到该服务";n.error.statusCode===410&&(d="服务加载失败，已超出服务访问量限额"),this.$message({type:"error",message:d,duration:6e3})}});const s=this._viewer.imageryLayers.addImageryProvider(i);return i.readyPromise&&i.readyPromise.then(()=>{t&&this._viewer.flyTo(s)}),s}}_addWMTSLayer(e,t=!0){if(e&&e.url){const i=this,s=j(e.maximumLevel,26),n=[];for(let m=0;m<s;m++)n.push(`EPSG:4326:${m}`);const d=new H({url:this.getResoureWithUserId(`${e.url}?`),maximumLevel:s,layer:e.layerName,style:"",format:"image/png",rectangle:e.rectangle,tilingScheme:new I,tileMatrixSetID:"EPSG:4326",tileMatrixLabels:n});d.defaultMinificationFilter=K.NEAREST,d.defaultMagnificationFilter=X.NEAREST;const f=i._viewer.imageryLayers.addImageryProvider(d);return d.errorEvent.addEventListener(m=>{if(document.getElementsByClassName("el-message").length===0){let r="服务加载失败, 找不到该服务";m.error.statusCode===410&&(r="服务加载失败，已超出服务访问量限额"),this.$message({type:"error",message:r,duration:6e3})}}),t&&i._viewer.flyTo(f),f}}_addVectorByEntity(e,t=!0){const i=Y.load(this.getResoureWithUserId(e.url),{clampToGround:!0});return i.then(n=>{n&&(this._viewer.dataSources.add(n),t&&this._viewer.flyTo(n))}),{type:e.type,readyPromise:i}}add(e,t=!0){const{type:i}=e;let s;switch(i){case"POINTCLOUD":case"IMAGERY":case"MODEL":case"BIMMODEL":case"GEO3DML":s=this._add3DTiles(e,t);break;case"TERRAIN":e.show;break;case"IMAGEDATA":s=this._addImageTilesLayer(e,t);break;case"VECTOR":case"PANORAMICIMAGE":s=this._addVectorByEntity(e,t);break;case"WMS":s=this._addWMSLayer(e,t);break;case"WMTS":s=this._addWMTSLayer(e,t);break}return s}getResoureWithUserId(e){return new P({url:e,queryParameters:{userId:T(S)||"",ak:T(E)||""}})}flyTo(e){e!=="TERRAIN"&&(e==="IMAGEDATA"||this._viewer.flyTo(this.layerInstance,{duration:0}))}}const me=["WMS","WMTS","VECTOR2"];class ge{constructor(e,t){u(this,"$message");u(this,"layerManager");u(this,"viewer");this.$message=t,this.viewer=e,this.init()}init(){this.viewer&&(this.layerManager=new ue(this.viewer,this.$message))}addLayer(e,t=!0){return this.addLayerFromType(e,t)}async addLayerFromType(e,t=!0){if(me.includes(e.type)){const{minx:n,miny:d,maxx:f,maxy:m}=e.rectangle;e.rectangle=Q.fromDegrees(n,d,f,m)}const i=this._addSingleLayer(e,t),s=this.getLayerPromise(i);return this.handlePromise(s,e),s}handlePromise(e,t){if(!e){this.$message({type:"error",message:"服务加载失败"});return}e.then(i=>{i||this.$message({type:"error",message:"服务加载失败"})},i=>{let s=i.response||"获取服务错误";i.statusCode===404&&(s="服务加载失败, 找不到该服务"),this.$message({type:"error",message:`${s}`,duration:6e3}),this.layerManager.remove(t)})}getLayerPromise(e){let t;return e instanceof v?t=e.readyPromise:e instanceof ee?t=e.imageryProvider&&e.imageryProvider.readyPromise:e instanceof te?t=e.readyPromise:e&&e.type==="VECTOR2"?t=e.vectorTilesLayer&&e.vectorTilesLayer.readyPromise:e&&e.type==="VECTOR"||e&&e.type==="PANORAMICIMAGE"?t=e.readyPromise:t=e&&e.readyPromise||Promise.resolve(!1),t}_addSingleLayer(e,t=!0){return this.layerManager.add(e,t)}flyTo(e){this.layerManager.flyTo(e)}}const fe={id:"mapContainer",class:"mapContainer"},we=N({__name:"SmartMap",props:{isData:{type:Boolean,default:!1},url:{type:String,default:""},category:{type:String,default:""},layerName:{type:String,default:""},aliasName:{type:String,default:""},rectangle:{type:Object,default:()=>{}},needFly:{type:Boolean,default:!0}},emits:["loadSuccess"],setup(o,{expose:e,emit:t}){class i extends oe{constructor(c){super(c);u(this,"name11");this.name11="xxx"}_createGridCanvas(){this.name11="xxx";const c=document.createElement("canvas");return c.width=1,c.height=1,c}}const s=t,n=o,d=J(),f=w(()=>{var a;return(a=d.userInfo)==null?void 0:a.id}),m=w(()=>d.getUserToken.access_token),r=O({isInit:!1,viewer:null}),y=$({layerManageService:null});U(()=>{r.isInit=!0,n.url&&p()}),b(()=>{var a;r.viewer&&((a=r.viewer)==null||a.destroy(),r.viewer=void 0)}),W(()=>n.url,a=>{a&&r.isInit&&p()});function p(){r.viewer&&(r.viewer.destroy(),r.viewer=void 0),setTimeout(()=>{r.isInit&&L()},100)}function L(){M(S,f.value),M(E,m.value),r.viewer=new ie("mapContainer",{baseMapMode:6,terrainProvider:re.createSTKTerrain(),navigation:!1,location:!1,copyrightLogo:!1}),r.viewer&&(y.layerManageService=new ge(B(r.viewer),_)),r.viewer.canvas.style.width="100%",r.viewer.canvas.style.height="100%";const{screenSpaceCameraController:a}=r.viewer.scene;if(a.enableCollisionDetection=!1,a.maximumZoomDistance=2e7,a.minimumZoomDistance=1,a.maximumPitchDegrees=10,a.inputRotateRate=1,a.inputPanFactor=1,a._zoomFactor=5,a.inertiaZoom=.8,r.viewer.scene.terrainProvider=new se({}),r.viewer.scene.skyAtmosphere.show=!1,r.viewer.scene.skyBox.show=!1,r.viewer.scene.moon.show=!1,r.viewer.scene.sun.show=!1,r.viewer.scene.fog.enabled=!1,r.viewer.scene.globe.baseColor=new ae(0,0,0,1),r.viewer.clock.shouldAnimate=!0,r.viewer.postProcessStages.fxaa.enabled=!0,!n.url){_({type:"warning",message:"获取服务地址错误！"});return}r.viewer.imageryLayers.addImageryProvider(new i),n.isData?x():R()}function x(){const a=new v({url:n.url});r.viewer.scene.primitives.add(a),a.readyPromise.then(()=>{if(s("loadSuccess"),n.needFly){const{boundingSphere:l}=a,c={};c.offset=new ne(0,-.5,l.radius);const h={offset:c.offset,duration:c.duration,maximumHeight:c.maximumHeight,complete:function(){},cancel:function(){}};r.viewer.camera.flyToBoundingSphere(a.boundingSphere,h)}})}function R(){const a={url:n.url,type:n.category.toUpperCase(),layerName:n.layerName,rectangle:n.rectangle,aliasName:n.aliasName};y.layerManageService.addLayer(a,n.needFly).then(()=>{s("loadSuccess")})}async function D(a){if(r.viewer){const l=de(r.viewer.camera),c=r.viewer.canvas.clientWidth/r.viewer.canvas.height,h=await r.viewer.saveSceneAsIMG(480,480/c);a==null||a(l,h)}}function k(a){var c;let l;typeof a=="object"?l=JSON.parse(JSON.stringify(a)):typeof a=="string"&&(l=JSON.parse(a)),(c=r.viewer)==null||c.camera.flyTo({destination:le.fromDegrees(l.InitialPosition.lon,l.InitialPosition.lat,l.InitialPosition.height),orientation:{heading:g.toRadians(l.InitialOrientation.heading),pitch:g.toRadians(l.InitialOrientation.pitch),roll:g.toRadians(l.InitialOrientation.roll)}})}return e({handleSetAngle:D,flyByPerspectiveJson:k}),(a,l)=>(G(),V("div",fe))}});export{we as _};
