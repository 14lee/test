import{b as X,r as Z,S as fe,d as oe,w as ie,e as E,t as Te,o as m,x as H,k as o,g as i,j as a,v as we,f as S,B as v,F as j,z as q,y as le,l as O,u as c,aj as ae,N as re,n as me,U as Ie,Q as Ne,ak as M,ai as Y,L as Le,bo as Ee,c as Fe,bG as Pe,X as Ve}from"./element-plus.59ccb443.js";import{u as ge,s as be,t as ke,P as _e,x as ce,y as he,z as ye,A as ve,v as de}from"./login.a4e9287e.js";import{f as Oe,S as We,D as Q}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{S as W}from"./serviceManage.8c46f250.js";import{_ as De,W as Ce}from"./WorkerInfoDialog.898a9f84.js";import{k as se,m as Ae,i as ne}from"./index-a95bb620.js";import{q as Be}from"./lodash.22f463b4.js";import{_ as xe}from"./error.229cea25.js";import"../../app-config.js";import"./jointPrepare.318e4ddb.js";import"./useTableAndPagination.0c6e0294.js";import"./dataType.8bfa5e6a.js";import"./echarts.39e3cf74.js";import"./wujie-vue3.9ecbe737.js";import"./smartweb3.2d5e4c59.js";import"./smart-ui.e8e0134c.js";const ue=[{value:"所有",label:""}];function Re(){const w=X([]),k=Z({searchOptions:[{label:"关键字",key:"keyword",type:"text",span:5,placeholder:"数据名称/创建者"},{label:"数据类型",key:"resourceDataType",type:"select",placeholder:"请选择",options:[],clearable:!0,span:6},{label:"服务类型",key:"serviceType",type:"select",clearable:!0,span:5,options:ue}],columns:[{prop:"resultDataName",label:"任务名称",minWidth:120,slot:"resultDataName",sortable:!0},{prop:"dataTypeAliasName",label:"数据类型",minWidth:120,sortable:!0},{prop:"serviceType",label:"服务类型",minWidth:120,sortable:!0},{prop:"creator",label:"创建者",minWidth:120,sortable:!0},{prop:"process",label:"处理进度",minWidth:220,slot:"process",sortable:!0,sortMethod:$e}]});async function g(){const e=await se("DATATYPE");if(e.code==="0000"){const{data:{DATATYPE:D}}=e;w.value=D||[],w.value.forEach(s=>{s.value=s.dictKey,s.label=s.dictValue}),w.value.unshift({value:"",label:"所有数据"}),k.searchOptions[1].options=w.value}}g();function I(){se("kjfwlx").then(e=>{if(e.code==="0000"){const{data:{kjfwlx:D}}=e,s=D.map(n=>({...n,label:n.dictValue,value:n.dictKey})),F=ue.concat(s);k.searchOptions[2].options=F}})}return I(),{...fe(k)}}function $e(w,k){const g=new Map;g.set("SLICING",0),g.set("UPLOAD_FAIL",1),g.set("NOT_PROCESS",2),g.set("PROCESSED",3),g.set("PUBLISHED",4),g.set("UPLOADING",5),g.set("PROCESSING",6);const I=g.get(w.status)||0,e=g.get(k.status)||0;return I-e}const Ue={class:"main-content"},Me={class:"title"},He=i("span",null,"任务信息",-1),ze={ref:"mainRef",class:"main","element-loading-text":"信息加载中..."},Ge={class:"card"},je=i("div",{class:"subtitle"},"服务信息",-1),qe={class:"content-wrap"},Ke={class:"item-wrap item2"},Je={class:"item-wrap item2"},Ye={class:"card"},Qe=i("div",{class:"subtitle"},"数据信息",-1),Xe={class:"content-wrap"},Ze={key:2,class:"card"},et=i("div",{class:"subtitle"},"参数设置",-1),tt={class:"content-wrap"},at={class:"item-wrap item2"},st={key:3,class:"card"},ot=i("div",{class:"subtitle"},"参数设置",-1),lt={key:0,class:"content-wrap"},nt={key:0,class:"item-wrap item2"},it={class:"item-wrap"},rt={key:1,class:"item-wrap"},ct={key:1,class:"content-wrap"},dt={key:0,class:"item-wrap item2"},ut={class:"item-wrap"},pt={key:1,class:"item-wrap"},ft={class:"item-wrap"},mt={class:"item-wrap item2"},gt=i("span",{style:{margin:"0 15px"}},"——",-1),bt={key:4,class:"card"},kt=i("div",{class:"subtitle"},"参数设置",-1),_t={class:"content-wrap"},ht={class:"item-wrap item2"},yt={key:0,class:"item-wrap item2"},vt={class:"params-value"},Dt={key:1,class:"item-wrap item2"},Ct={class:"params-value"},St={class:"footer"},Se=oe({__name:"TaskInfoDialog",props:{visible:{type:Boolean,default:!1},domId:{default:""},taskId:{}},emits:["update:visible"],setup(w,{emit:k}){const g=w,I=k,e=Z({isLoadingData:!1,dialogVisible:!1,serviceInfo:{},rules:{name:[{required:!0,message:"服务标识不能为空",trigger:["blur","change"]}],aliasName:[{required:!0,message:"服务名称不能为空",trigger:["blur","change"]}]},dataInfoTableData:[],is3Dtiles:!1,isIOT:!1,isMapTilePackge:!1,is2D:!1,isCommon:!1,tileConfigFormData:{},paramsList:[],stylesList:[],gridSetsList:[]});ie(()=>g.visible,f=>{e.dialogVisible=f}),F(),n();function D(){e.is3Dtiles=!1,e.isIOT=!1,e.isMapTilePackge=!1,e.is2D=!1,e.isCommon=!1,e.tileConfigFormData={},e.paramsList=[],z()}function s(){I("update:visible",!1),e.isLoadingData=!1}function F(){Ae.getStylesList().then(f=>{f.code==="0000"?e.stylesList=f.data||[]:e.stylesList=[]}).catch(()=>{e.stylesList=[]})}function n(){Oe.getGridSetsList().then(f=>{f.code==="0000"?e.gridSetsList=f.data||[]:e.gridSetsList=[]}).catch(()=>{e.gridSetsList=[]})}function z(){e.isLoadingData=!0,W.getTileWorkerInfo(g.taskId).then(f=>{if(f.code==="0000"){const{serviceInfo:_={},resourceDataInfos:h=[],tileLogs:y={}}=f.data;e.serviceInfo=_,e.serviceInfo.dataType=y.dataType.toUpperCase(),e.dataInfoTableData=h,G(f.data)}else ae({type:"error",message:f.message||"获取任务信息失败"}),s()}).catch(()=>{ae({type:"error",message:"获取任务信息错误"}),s()}).finally(()=>{e.isLoadingData=!1})}function G({tileLogs:f,serviceInfo:_}){const{dataType:h,dataFormat:y,tileConfig:d}=f,{category:b}=_;if(["3DTILES","GEOJSON","TERRAIN","PNG","WEBP","PAK","ZNP"].includes(y.toUpperCase())){e.is3Dtiles=!0;return}if(h.toUpperCase()==="IOT"){e.isIOT=!0,e.tileConfigFormData=ne(d)?JSON.parse(d):{};return}if(h.toUpperCase()==="MAPTILEPACKGE"){e.isMapTilePackge=!0;return}if(["VECTOR","TERRAIN","IMAGEDATA"].includes(h.toUpperCase()))if(b==="WMS"||b==="WMTS"){if(e.is2D=!0,e.tileConfigFormData=ne(d)?JSON.parse(d):{},h.toUpperCase()==="VECTOR"){const B=R(e.tileConfigFormData.styleId);e.tileConfigFormData.styleName=B?B.name:""}b==="WMTS"&&(e.tileConfigFormData.gridSetsName=J(e.tileConfigFormData.gridSets),e.tileConfigFormData.format=e.tileConfigFormData.format.split(",").join(" , ")),e.tileConfigFormData.srs=`EPSG: ${e.tileConfigFormData.srs}`;return}else{K({tileLogs:f,serviceInfo:_});return}K({tileLogs:f,serviceInfo:_})}function K({tileLogs:f,serviceInfo:_}){const{tilesLog:h}=f,{taskName:y}=_;e.isCommon=!0,e.tileConfigFormData.taskName=y||"未正确获取方案名称",ne(h)?e.paramsList=Be.chunk(JSON.parse(h),2):e.paramsList=[]}function R(f){let _=null;const h=y=>{var d;for(let b=0,P=y.length;b<P;b++)if(y[b].id===f){_=y[b];break}else((d=y[b].children)==null?void 0:d.length)>0&&h(y[b].children)};return h(e.stylesList),_}function J(f){const _=e.gridSetsList.find(h=>h.value===f);return _?_.label:f}return(f,_)=>{const h=E("ArrowLeft"),y=E("el-icon"),d=E("el-form-item"),b=E("el-form"),P=E("el-table-column"),A=E("el-table"),B=E("el-tooltip"),$=E("el-button"),ee=Te("loading");return m(),H(c(We),{id:"task-info-dialog",modelValue:e.dialogVisible,"onUpdate:modelValue":_[0]||(_[0]=T=>e.dialogVisible=T),class:"full-dialog common-full-dialog","append-to-dom":f.domId,"modal-append-to-body":!1,fullscreen:"","is-custom":"","close-on-press-escape":!1,onOpen:D,onClosed:s},{default:o(()=>[i("div",Ue,[i("div",Me,[a(y,{onClick:s},{default:o(()=>[a(h)]),_:1}),He]),we((m(),S("div",ze,[i("div",Ge,[je,i("div",qe,[a(b,{ref:"editForm",class:"form edit-form",inline:"",model:e.serviceInfo,rules:e.rules,"label-width":"auto","label-position":"right"},{default:o(()=>[i("div",Ke,[a(d,{label:"服务标识",prop:"name"},{default:o(()=>[i("span",null,v(e.serviceInfo.name),1)]),_:1}),a(d,{label:"服务名称",prop:"aliasName"},{default:o(()=>[i("span",null,v(e.serviceInfo.aliasName),1)]),_:1})]),i("div",Je,[a(d,{label:"服务类型",prop:"categoryAliasName"},{default:o(()=>[i("span",null,v(e.serviceInfo.categoryAliasName),1)]),_:1}),a(d)])]),_:1},8,["model","rules"])])]),i("div",Ye,[Qe,i("div",Xe,[a(b,{ref:"tableFormRef",class:"table-form tableContainer",model:e},{default:o(()=>[a(A,{ref:"tableRef",class:"table commonTable sortableTable",data:e.dataInfoTableData},{default:o(()=>[a(P,{prop:"name",label:"数据名称"}),a(P,{prop:"dataTypeAliasName",label:"数据类型"}),a(P,{prop:"dataFormat",label:"数据格式"}),a(P,{prop:"createTime",label:"创建时间"})]),_:1},8,["data"])]),_:1},8,["model"])])]),e.is3Dtiles?(m(),S(j,{key:0},[],64)):e.isMapTilePackge?(m(),S(j,{key:1},[],64)):e.isIOT?(m(),S("div",Ze,[et,i("div",tt,[a(b,{ref:"paramsForm",class:"form edit-form",inline:"",model:e.tileConfigFormData,"label-width":"auto","label-position":"right"},{default:o(()=>[i("div",at,[a(d,{key:"protocol",label:"协议类型",prop:"protocol",rules:{required:!0,message:"协议类型不能为空",trigger:"change"}},{default:o(()=>[i("span",null,v(e.tileConfigFormData.protocol),1)]),_:1}),a(d)])]),_:1},8,["model"])])])):e.is2D?(m(),S("div",st,[ot,e.serviceInfo.category==="WMS"?(m(),S("div",lt,[a(b,{ref:"paramsForm",class:"form edit-form params-form",inline:"",model:e.tileConfigFormData,"label-width":"auto","label-position":"right"},{default:o(()=>{var T,L;return[((T=e.serviceInfo)==null?void 0:T.dataType)==="VECTOR"?(m(),S("div",nt,[a(d,{key:"styleInfo",class:"style-item",label:"样式设置",prop:"styleInfo"},{default:o(()=>[i("div",null,v(e.tileConfigFormData.styleName||e.tileConfigFormData.styleId),1)]),_:1}),a(d)])):q("",!0),i("div",it,[a(d,{key:"tileConfigFormData.srs",label:"输出坐标",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:o(()=>[i("div",null,v(e.tileConfigFormData.srs),1)]),_:1})]),((L=e.serviceInfo)==null?void 0:L.dataType)==="VECTOR"?(m(),S("div",rt,[a(d,{label:"过滤条件",prop:"cqlFilter"},{default:o(()=>[i("div",null,v(e.tileConfigFormData.cqlFilter),1)]),_:1})])):q("",!0)]}),_:1},8,["model"])])):q("",!0),e.serviceInfo.category==="WMTS"?(m(),S("div",ct,[a(b,{ref:"paramsForm",class:"form edit-form params-form",inline:"",model:e.tileConfigFormData,"label-width":"auto","label-position":"right"},{default:o(()=>{var T,L;return[((T=e.serviceInfo)==null?void 0:T.dataType)==="VECTOR"?(m(),S("div",dt,[a(d,{key:"styleInfo",class:"style-item",label:"样式设置",prop:"styleInfo"},{default:o(()=>[i("div",null,v(e.tileConfigFormData.styleName||e.tileConfigFormData.styleId),1)]),_:1}),a(d)])):q("",!0),i("div",ut,[a(d,{key:"tileConfigFormData.srs",label:"输出坐标",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:o(()=>[i("div",null,v(e.tileConfigFormData.srs),1)]),_:1})]),((L=e.serviceInfo)==null?void 0:L.dataType)==="VECTOR"?(m(),S("div",pt,[a(d,{label:"过滤条件",prop:"cqlFilter"},{default:o(()=>[i("div",null,v(e.tileConfigFormData.cqlFilter),1)]),_:1})])):q("",!0),i("div",ft,[a(d,{key:"tileConfigFormData.format",label:"输出格式",prop:"format",rules:{required:!0,message:"至少选择一种输出格式",trigger:"change"}},{default:o(()=>[i("div",null,v(e.tileConfigFormData.format),1)]),_:1})]),i("div",mt,[a(d,{key:"tileConfigFormData.gridSets",label:"网格集",prop:"gridSets",rules:{required:!0,message:"网格集不能为空",trigger:"change"}},{default:o(()=>[i("div",null,v(e.tileConfigFormData.gridSetsName),1)]),_:1}),a(d,{key:"tileConfigFormData.level",label:"切片级别",prop:"level"},{default:o(()=>[i("span",null,v(e.tileConfigFormData.zoomStart),1),gt,i("span",null,v(e.tileConfigFormData.zoomStop),1)]),_:1})])]}),_:1},8,["model"])])):q("",!0)])):(m(),S("div",bt,[kt,i("div",_t,[a(b,{ref:"paramsForm",class:"form edit-form params-form",inline:"",model:e.tileConfigFormData,"label-width":"auto","label-position":"right"},{default:o(()=>[i("div",ht,[a(d,{key:"taskName",label:"切片方案",prop:"taskName",rules:{required:!0,message:"不能为空",trigger:"change"}},{default:o(()=>[i("div",null,v(e.tileConfigFormData.taskName),1)]),_:1}),a(d)]),(m(!0),S(j,null,le(e.paramsList,(T,L)=>(m(),S(j,{key:L},[T.length===2?(m(),S("div",yt,[(m(!0),S(j,null,le(T,(V,U)=>(m(),H(d,{key:U+"xx",label:V.label},{default:o(()=>[a(B,{"popper-class":"scene-dec",effect:"dark",content:String(V.value),placement:"top-end"},{default:o(()=>[i("div",vt,v(V.value),1)]),_:2},1032,["content"])]),_:2},1032,["label"]))),128))])):(m(),S("div",Dt,[(m(!0),S(j,null,le(T,(V,U)=>(m(),H(d,{key:U+"xx",label:V.label},{default:o(()=>[a(B,{"popper-class":"scene-dec",effect:"dark",content:String(V.value),placement:"top-end"},{default:o(()=>[i("div",Ct,v(V.value),1)]),_:2},1032,["content"])]),_:2},1032,["label"]))),128)),a(d)]))],64))),128))]),_:1},8,["model"])])]))])),[[ee,e.isLoadingData]]),i("div",St,[a($,{onClick:s},{default:o(()=>[O("关 闭")]),_:1})])])]),_:1},8,["modelValue","append-to-dom"])}}});const Tt={class:"data-progress"},wt=oe({__name:"PublishingPage",setup(w){const k=X(),g=X(),{searchOptions:I,columns:e}=Re(),D=ge(),{userInfo:s}=be(D),F={publishStatus:["PUBLISHING","PUBLISH_FAIL"]},n=Z({domId:"publish-task-page",dialogVisible:!1,dialogType:Q.CHECK,curTaskId:"",runTaskDialogVisible:!1,taskData:{},workerDialogVisible:!1,curWorkerData:{},websocket:null}),{data:z,total:G,pageNo:K,pageSize:R,multipleSelection:J,loading:f,handleSizeChange:_,handleCurrentChange:h,handleSelectionChange:y,handleSearch:d,initData:b}=ke(W.getProcessPageList,F);ie(()=>s.value.id,l=>{var t;l?P():window.WebSocket&&((t=n.websocket)==null||t.close())}),re(()=>{b(),me(()=>{P()})});function P(){var l,t;window.WebSocket&&((l=n.websocket)==null||l.close()),(t=s.value)!=null&&t.id&&window.WebSocket&&(n.websocket=new WebSocket(`${_e}/mapserver/websocket/tileWorkerRefresh?userId=${s.value.id}&type=PUBLISHING`),n.websocket.onopen=()=>{},n.websocket.onclose=()=>{},n.websocket.onmessage=C=>{const x=JSON.parse(C.data),{resourceRefresh:p}=x;p&&(z.value=p.records||[],G.value=p.total||0)},n.websocket.onerror=()=>{ae({type:"error",message:"websocket连接错误！"})})}function A(l){const{runTaskStatus:t}=l;switch(+t){case 0:case-1:case 1:return"normal";case-99:return"cancel";case 2:return"error";default:return"error"}}function B(l){const{runTaskStatus:t}=l;return t==="1"?l.process:t==="2"?"失败":t==="-1"?"等待中":t==="0"?"完成":t==="-99"?"已取消":"失败"}function $(l){!l.taskId||l.runTaskStatus==="1"||(n.workerDialogVisible=!1,n.taskData={...l,isRunSuccess:l.runTaskStatus==="0"},n.runTaskDialogVisible=!0)}function ee(l){M.confirm("是否取消选中任务?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{W.cancelPublishByIds(l.id,"CANCEL").then(t=>{var C;t.code==="0000"?(Y({type:"success",title:"取消任务成功"}),d(),(C=g.value)==null||C.clearSelection()):Y({type:"warning",title:"取消失败，请重试"})}).catch(t=>{Y({type:"error",title:"取消错误",message:t.message})})}).catch(()=>{})}function T(l,t=!0,C=!1){if(t&&l.runTaskStatus==="-99")return;const x=t?"取消":"删除";if(C){L(l,x,t);return}M.confirm(`${x}【${l.jobInfo.name}】数据, 是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{L(l,x,t)}).catch(()=>{})}function L(l,t,C=!0){const x=C?"CANCEL":"CANCEL_AND_DELETE";W.cancelPublishByIds(l.jobInfo.id,x).then(p=>{p.code==="0000"?(Y({type:"success",title:`${p.message}`}),d(),n.workerDialogVisible=!1):Y({type:"warning",title:`${t}失败，请重试`})}).catch(p=>{Y({type:"error",title:`${t}错误`,message:p.message||"服务有错"})})}function V(l){l.taskId&&W.getWorkerInfo(l.id).then(t=>{n.taskData={...l,isRunSuccess:l.runTaskStatus==="0"},n.curWorkerData.jobInfo=t.data.jobInfo,n.workerDialogVisible=!0})}function U(l){!Array.isArray(l)||l.length===0||W.cancelPublishByIds(l.join(","),"CANCEL_AND_DELETE").then(t=>{t.code==="0000"&&(b(),J.value=[])})}function r(l){M.confirm(`删除【${l.resultDataName||"--"}】数据, 是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{U([l.id])}).catch(()=>{})}function u(){M.confirm("是否批量删除选中数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const l=J.value.map(t=>t.id);U(l)}).catch(()=>{})}function N(l,t=Q.EDIT){n.curTaskId=l.id,n.dialogType=t,n.dialogVisible=!0}return(l,t)=>{const C=E("el-button"),x=E("el-link");return m(),H(c(de),{background:""},{default:o(()=>[a(c(ce),{padding:"1 1 0",border:""},{default:o(()=>[a(c(he),{ref_key:"SmartSearchRef",ref:k,options:c(I),onHandleSearch:c(d)},null,8,["options","onHandleSearch"])]),_:1}),a(c(ye),null,{default:o(()=>[a(c(ve),{ref:"baseTable","operation-width":"250",columns:c(e),"table-data":c(z),"current-page":c(K),"page-size":c(R),total:c(G),"pagination-is-need":!0,"operation-is-need":!0,loading:c(f),"search-form-ref":k.value,"selection-is-need":!0,"index-is-need":!1,"desc-options":!1,onSizeChange:c(_),onCurrentChange:c(h),onSelectionChange:c(y)},{"smart-table_batch-operation":o(()=>[a(C,{link:"",type:"danger",onClick:u},{default:o(()=>[O(" 批量删除 ")]),_:1})]),resultDataName:o(({scope:p})=>[a(x,{type:"primary",onClick:te=>N(p.row,c(Q).CHECK)},{default:o(()=>[O(v(p.row.resultDataName||"--"),1)]),_:2},1032,["onClick"])]),process:o(({scope:p})=>[i("div",Tt,[i("div",{class:Ie(["progress-bg",A(p.row)])},[i("span",{class:"progress-bar",style:Ne({width:p.row.process})},null,4)],2),i("span",null,v(B(p.row)),1)])]),operation:o(({scope:p})=>[A(p.row)!=="normal"?(m(),H(C,{key:0,disabled:p.row.runTaskStatus==="1"||!p.row.taskId,link:"",type:"primary",onClick:te=>$(p.row)},{default:o(()=>[O("重新运行 ")]),_:2},1032,["disabled","onClick"])):q("",!0),a(C,{type:"primary",link:"",disabled:p.row.runTaskStatus!=="1",onClick:te=>ee(p.row)},{default:o(()=>[O(" 取消 ")]),_:2},1032,["disabled","onClick"]),a(C,{type:"primary",link:"",disabled:!p.row.taskId,onClick:te=>V(p.row)},{default:o(()=>[O(" 查看 ")]),_:2},1032,["disabled","onClick"]),a(C,{link:"",disabled:p.row.type===1,type:"danger",onClick:te=>r(p.row)},{default:o(()=>[O(" 删除 ")]),_:2},1032,["disabled","onClick"])]),_:1},8,["columns","table-data","current-page","page-size","total","loading","search-form-ref","onSizeChange","onCurrentChange","onSelectionChange"])]),_:1}),a(De,{visible:n.runTaskDialogVisible,"onUpdate:visible":t[0]||(t[0]=p=>n.runTaskDialogVisible=p),"dag-data":n.taskData,"is-service":!0,"is-result-data":"",onSuccess:c(d)},null,8,["visible","dag-data","onSuccess"]),a(Ce,{visible:n.workerDialogVisible,"onUpdate:visible":t[1]||(t[1]=p=>n.workerDialogVisible=p),"dom-id":n.domId,"cur-edit-data":n.curWorkerData,onCancelOrDelete:T,onCancel:t[2]||(t[2]=p=>T(n.curWorkerData)),onDelete:t[3]||(t[3]=p=>T(n.curWorkerData,!1)),onRerun:t[4]||(t[4]=p=>$(n.taskData)),onRepublish:$},null,8,["visible","dom-id","cur-edit-data"]),a(Se,{visible:n.dialogVisible,"onUpdate:visible":t[5]||(t[5]=p=>n.dialogVisible=p),"dom-id":n.domId,"task-id":n.curTaskId},null,8,["visible","dom-id","task-id"])]),_:1})}}});const It=xe(wt,[["__scopeId","data-v-137b95f7"]]),pe=[{value:"所有",label:""}];function Nt(){const w=X([]),k=Z({searchOptions:[{label:"关键字",key:"keyword",type:"text",span:5,placeholder:"数据名称/创建者"},{label:"数据类型",key:"resourceDataType",type:"select",placeholder:"请选择",options:[],clearable:!0,span:6},{label:"服务类型",key:"serviceType",type:"select",clearable:!0,span:5,options:pe}],columns:[{prop:"resultDataName",label:"任务名称",minWidth:140,slot:"resultDataName",sortable:!0},{prop:"dataTypeAliasName",label:"数据类型",minWidth:120,sortable:!0},{prop:"serviceType",label:"服务类型",minWidth:120,sortable:!0},{prop:"createTime",label:"创建时间",minWidth:120,sortable:!0},{prop:"beginTime",label:"开始时间",minWidth:120,sortable:!0},{prop:"endTime",label:"结束时间",minWidth:120,sortable:!0},{prop:"cumulativeTime",label:"处理时长",minWidth:80,sortable:!0},{prop:"creator",label:"创建者",minWidth:80,sortable:!0}]});async function g(){const e=await se("DATATYPE");if(e.code==="0000"){const{data:{DATATYPE:D}}=e;w.value=D||[],w.value.forEach(s=>{s.value=s.dictKey,s.label=s.dictValue}),w.value.unshift({value:"",label:"所有数据"}),k.searchOptions[1].options=w.value}}g();function I(){se("kjfwlx").then(e=>{if(e.code==="0000"){const{data:{kjfwlx:D}}=e,s=D.map(n=>({...n,label:n.dictValue,value:n.dictKey})),F=pe.concat(s);k.searchOptions[2].options=F}})}return I(),{...fe(k)}}const Lt=oe({__name:"PublishedPage",setup(w){const{searchOptions:k,columns:g}=Nt(),I=X(),e=ge(),{userInfo:D}=be(e),s=Z({domId:"publish-task-page",dialogVisible:!1,dialogType:Q.CHECK,curTaskId:"",runTaskDialogVisible:!1,taskData:{},workerDialogVisible:!1,curWorkerData:{},websocket:null}),{data:F,total:n,pageNo:z,pageSize:G,multipleSelection:K,loading:R,handleSizeChange:J,handleCurrentChange:f,handleSelectionChange:_,handleSearch:h,initData:y}=ke(W.getProcessPageList);ie(()=>D.value.id,r=>{var u;r?d():window.WebSocket&&((u=s.websocket)==null||u.close())}),re(()=>{y(),me(()=>{d()})}),Le(()=>{var r;window.WebSocket&&((r=s.websocket)==null||r.close())});function d(){var r,u;window.WebSocket&&((r=s.websocket)==null||r.close()),(u=D.value)!=null&&u.id&&window.WebSocket&&(s.websocket=new WebSocket(`${_e}/mapserver/websocket/tileWorkerRefresh?userId=${D.value.id}&type=PUBLISHED`),s.websocket.onopen=()=>{b()},s.websocket.onclose=()=>{},s.websocket.onmessage=N=>{const l=JSON.parse(N.data),{resourceRefresh:t}=l;t&&(F.value=t.records||[],n.value=t.total||0)},s.websocket.onerror=()=>{ae({type:"error",message:"websocket连接错误！"})})}function b(){var N,l,t;const r=(N=I.value)==null?void 0:N.getForm(),u={publishStatus:["PUBLISHED"],page:z.value,rows:G.value,...r};u.userId=D.value.id,((l=s.websocket)==null?void 0:l.readyState)===1&&((t=s.websocket)==null||t.send(JSON.stringify(u)))}function P(r){U(r,Q.CHECK)}function A(r){r.taskId&&(s.workerDialogVisible=!1,M.confirm(`<p>重新切片【${r.resourceDataName}】数据</p>
       <strong>重新切片完成后，将替换对应成果数据及数据服务，是否确定执行？</strong>`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",draggable:!0,dangerouslyUseHTMLString:!0}).then(()=>{s.taskData={...r,isRunSuccess:r.runTaskStatus==="0"},s.runTaskDialogVisible=!0}))}function B(r){r.taskId&&W.getWorkerInfo(r.id).then(u=>{s.taskData={...r,isRunSuccess:r.runTaskStatus==="0"},s.curWorkerData.jobInfo=u.data.jobInfo,s.workerDialogVisible=!0})}function $(r){!Array.isArray(r)||r.length===0||(R.value=!0,W.cancelPublishByIds(r.join(","),"CANCEL_AND_DELETE").then(u=>{R.value=!1,u.code==="0000"&&y()}).catch(()=>{R.value=!1}))}function ee(r){M.confirm(`删除【${r.resultDataName}】数据, 是否继续?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{$([r.id])}).catch(()=>{})}function T(){M.confirm("是否批量删除选中数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const r=K.value.map(u=>u.id);$(r)}).catch(()=>{})}function L(r,u=!0,N=!1){if(u&&r.runTaskStatus==="-99")return;const l=u?"取消":"删除";if(N){V(r,l,u);return}M.confirm(`${l}【${r.name}】数据, 是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{V(r,l,u)}).catch(()=>{})}function V(r,u,N=!0){const l=N?"CANCEL":"CANCEL_AND_DELETE";W.cancelPublishByIds(r.id,l).then(t=>{t.code==="0000"&&(y(),s.workerDialogVisible=!1)})}function U(r,u=Q.EDIT){s.curTaskId=r.id,s.dialogType=u,s.dialogVisible=!0}return(r,u)=>{const N=E("el-button"),l=E("el-link");return m(),S(j,null,[a(c(de),{background:""},{default:o(()=>[a(c(ce),{padding:"1 1 0",border:""},{default:o(()=>[a(c(he),{ref_key:"SmartSearchRef",ref:I,options:c(k),onHandleSearch:c(h)},null,8,["options","onHandleSearch"])]),_:1}),a(c(ye),null,{default:o(()=>[a(c(ve),{ref:"baseTable","operation-width":"220",columns:c(g),"table-data":c(F),"current-page":c(z),"page-size":c(G),total:c(n),"pagination-is-need":!0,"operation-is-need":!0,loading:c(R),"search-form-ref":I.value,"selection-is-need":!0,"index-is-need":!1,"desc-options":{isRefresh:!1},onSizeChange:c(J),onCurrentChange:c(f),onSelectionChange:c(_)},{"smart-table_operation":o(()=>[]),"smart-table_batch-operation":o(()=>[a(N,{link:"",type:"danger",icon:c(Ee),onClick:T},{default:o(()=>[O(" 批量删除 ")]),_:1},8,["icon"])]),resultDataName:o(({scope:t})=>[a(l,{type:"primary",onClick:C=>P(t.row)},{default:o(()=>[O(v(t.row.resultDataName),1)]),_:2},1032,["onClick"])]),operation:o(({scope:t})=>[a(N,{link:"",type:"primary",disabled:t.row.runTaskStatus==="1"||!t.row.taskId,onClick:C=>A(t.row)},{default:o(()=>[O(" 重新运行 ")]),_:2},1032,["disabled","onClick"]),a(N,{link:"",type:"primary",disabled:!t.row.taskId,onClick:C=>B(t.row)},{default:o(()=>[O(" 查看任务 ")]),_:2},1032,["disabled","onClick"]),a(N,{link:"",type:"danger",disabled:t.row.type===1,onClick:C=>ee(t.row)},{default:o(()=>[O(" 删除 ")]),_:2},1032,["disabled","onClick"])]),_:1},8,["columns","table-data","current-page","page-size","total","loading","search-form-ref","onSizeChange","onCurrentChange","onSelectionChange"])]),_:1})]),_:1}),a(De,{visible:s.runTaskDialogVisible,"onUpdate:visible":u[0]||(u[0]=t=>s.runTaskDialogVisible=t),"dag-data":s.taskData,"is-service":!0,"is-result-data":"",onSuccess:c(y)},null,8,["visible","dag-data","onSuccess"]),a(Ce,{visible:s.workerDialogVisible,"onUpdate:visible":u[1]||(u[1]=t=>s.workerDialogVisible=t),"dom-id":s.domId,"cur-edit-data":s.curWorkerData,onCancelOrdelete:L,onCancel:u[2]||(u[2]=t=>L(s.curWorkerData)),onDelete:u[3]||(u[3]=t=>L(s.curWorkerData,!1)),onRerun:u[4]||(u[4]=t=>A(s.taskData)),onRepublish:A},null,8,["visible","dom-id","cur-edit-data"]),a(Se,{visible:s.dialogVisible,"onUpdate:visible":u[5]||(u[5]=t=>s.dialogVisible=t),"dom-id":s.domId,"task-id":s.curTaskId},null,8,["visible","dom-id","task-id"])],64)}}}),jt=oe({__name:"index",setup(w){const k=Z({curTabName:"PUBLISHING"}),g=X(),I=Fe(()=>({PUBLISHING:It,PUBLISHED:Lt,none:null})[k.curTabName]||null);return re(()=>{k.curTabName="PUBLISHING"}),(e,D)=>{const s=E("el-tab-pane"),F=E("el-tabs");return m(),H(c(de),{id:"publish-task-page",background:""},{default:o(()=>[a(c(ce),{padding:"0 1 0 1",border:""},{default:o(()=>[a(F,{modelValue:k.curTabName,"onUpdate:modelValue":D[0]||(D[0]=n=>k.curTabName=n),class:"db-tabs"},{default:o(()=>[a(s,{label:"任务中",name:"PUBLISHING"}),a(s,{label:"已完成",name:"PUBLISHED"})]),_:1},8,["modelValue"])]),_:1}),(m(),H(Pe,null,[(m(),H(Ve(I.value),{ref_key:"componentRef",ref:g},null,512))],1024))]),_:1})}}});export{jt as default};
