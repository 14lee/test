import{d as Oe,b as q,r as ue,c as De,w as ke,N as Pe,n as Te,e as b,t as Ve,o as d,f as N,j as n,k as t,u as i,g as y,U as Re,B as R,v as ae,x as v,ad as we,z,l as x,A as sa,F as Ee,y as Ge,ak as se,ai as F,i as je,S as Be,aj as xe,aK as da,b1 as ca,bK as ua,ae as pa,p as ze,bo as ma}from"./element-plus.59ccb443.js";import{r as G,E as fa,U as ga,t as ya,D as ha,v as Ye,w as _a,x as ba,y as Ta,z as Da,A as Ca}from"./login.a4e9287e.js";import{c as va,j as Ue,h as ka,_ as wa,a0 as Va,d as Ea}from"./index-a95bb620.js";import{D as u,d as We,o as He,g as Je,j as Qe,n as xa,l as Ne,m as Se,k as Na,b as Sa,t as Ia,S as Ka,p as Aa,q as Xe}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{q as U}from"./lodash.22f463b4.js";import"./error.229cea25.js";import"../../app-config.js";import"./echarts.39e3cf74.js";import"./wujie-vue3.9ecbe737.js";import"./smartweb3.2d5e4c59.js";import"./smart-ui.e8e0134c.js";const j={getClassifyTree(){return G.doGetPromise("/algorithm/manager/template/catalog/tree")},getTemplatePageList({name:h,dataType:V,dataLayerType:O,creatorId:k,catalogId:_,rows:D,page:K}){return G.doGetPromise("/algorithm/manager/template/list",{name:h,dataType:V,dataLayerType:O,creatorId:k,catalogId:_,rows:D,page:K})},saveOrUpdateTemplate(h){return G.doPostPromiseJson("/algorithm/manager/template/saveOrUpdate",h,{})},addClassify(h){return G.doPostPromiseJson("/algorithm/manager/template/catalog/add",h,{})},modifyClassify(h){return G.doPostPromiseJson("/algorithm/manager/template/catalog/update",h,{})},deleteClassify(h){return G.doPostPromise(`/algorithm/manager/template/catalog/delete?catalogId=${h}`,{},{})},getTemplate(h){return G.doGetPromise("/algorithm/manager/template/info",{id:h})},deleteTemplate(h){return G.doPostPromise("/algorithm/manager/template/delete",{id:h},{})},checkTemplateName(h,V){return G.doGetPromise("/algorithm/manager/template/checkname",{name:h,id:V})},exportTemplate(h){return G.doGetPromise(`/algorithm/manager/template/exportTemplate/${h}`,{},{responseType:"blob"})},importTemplate(h){return G.doPostPromiseForm("/algorithm/manager/template/importTemplate",h,{})}},$a={key:0,class:"db-node__toolbar"},La={class:"classify-data"},Ra={class:"item-wrap"},Ua={class:"item-wrap"},Oa={class:"item-wrap"},Pa={class:"dialog-footer"},Ba=Oe({__name:"CatalogTree",emits:["change","setData"],setup(h,{expose:V,emit:O}){const k=O,_=q(),D=q(),K=q(),a=ue({isLoadingTree:!0,classifyTreeData:[],filterText:"",treeProps:{label:"name",children:"children"},defaultExpandedkeys:[],curActiveKey:"#",checkAll:!0,selectText:"所有数据",dialogType:u.ADD,curClassifyData:{},dialogVisible:!1,submiting:!1,defaultData:{name:"",pid:"#",description:""},editData:{},rules:{name:[{required:!0,message:"目录名称不能为空",trigger:["change","blur"]},{min:0,max:10,message:"长度在 10 个字符以内",trigger:["blur","change"]}],pid:[{required:!0,message:"上级目录不能为空",trigger:["change"]}]}}),S=De(()=>{if(a.classifyTreeData.length===0)return[{value:"#",label:"/"}];{let g=[{value:"#",label:"/",idx:0}];const s=(m,A,ne)=>{m.forEach(H=>{var te;const ee=H.pid==="#"?H.name:`${A} / ${H.name}`,J=H.pid==="#"?1:ne;g.push({value:H.id,label:ee,idx:J}),((te=H==null?void 0:H.children)==null?void 0:te.length)>0&&s(H.children,ee,J+1)})},B=U.cloneDeep(a.classifyTreeData).filter(m=>!m.isDefault);return s(B,"",1),a.dialogType===u.EDIT&&(g=g.filter(m=>m.value!==a.editData.id)),g=g.filter(m=>m.idx<=3),g}});ke(()=>a.filterText,g=>{D.value.filter(g)}),Pe(()=>{e()});function Y(){if(!a.checkAll)a.curActiveKey="#",D.value.smartTreeRef.setCurrentKey(null),a.selectText="所有数据",k("change",a.curActiveKey),a.checkAll=!0;else{const g=a.classifyTreeData.find(s=>s.isDefault);a.curActiveKey=g.id,D.value.smartTreeRef.setCurrentKey(a.curActiveKey),a.selectText=g.name,k("change",a.curActiveKey),a.checkAll=!1}}function e(g=!1){a.isLoadingTree=!0,j.getClassifyTree().then(s=>{s.code==="0000"&&(a.classifyTreeData=U.cloneDeep(s.data)||[],k("setData",U.cloneDeep(a.classifyTreeData)),g?Te(()=>{a.curActiveKey=a.classifyTreeData[0].id,D.value.smartTreeRef.setCurrentKey(a.curActiveKey),k("change",a.curActiveKey),a.selectText=a.classifyTreeData[0].name}):Te(()=>{D.value.smartTreeRef.setCurrentKey(a.curActiveKey)}))}).catch(()=>{}).finally(()=>{a.isLoadingTree=!1})}function f(){a.curClassifyData={pid:"#"},a.dialogType=u.ADD,a.dialogVisible=!0}function p(g,s,B){return g?va(g,s,B,a.treeProps.label):!0}function P(g,s){var B,m;g&&(a.curActiveKey=g.id,a.selectText=g.name,a.checkAll=!1,(B=D.value)==null||B.smartTreeRef.setCurrentKey(a.curActiveKey),(m=D.value)==null||m.changeCheckBoxStatus(!1),k("change",a.curActiveKey))}function W(g){a.curClassifyData={pid:g.id},a.dialogType=u.ADD,a.dialogVisible=!0}function pe(g){a.curClassifyData=U.cloneDeep(g),a.dialogType=u.EDIT,a.dialogVisible=!0}function me(g){se.confirm(`删除【${g[a.treeProps.label]}】分类, 是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{j.deleteClassify(g.id).then(s=>{s.code==="0000"?(F({type:"success",title:"删除成功"}),e(a.curActiveKey===g.id)):F({type:"error",title:"删除失败"})}).catch(s=>{F({type:"error",title:"删除失败",message:s.message||"服务连接有错"})})}).catch(()=>{})}function fe(){a.dialogType===u.ADD?(a.editData=U.cloneDeep(a.defaultData),a.editData.pid=a.curClassifyData.pid):a.dialogType===u.EDIT&&(a.editData={...a.curClassifyData}),Te(()=>{_.value.clearValidate()})}function de(){_.value.validate(g=>{if(g){const s=a.dialogType===u.ADD?"新增":"编辑",B=a.dialogType===u.ADD?"addClassify":"modifyClassify",m={...a.editData};a.dialogType!==u.ADD&&(delete m.children,delete m.level),a.submiting=!0,j[B](m).then(A=>{a.submiting=!1,A.code==="0000"?(F({type:"success",title:`${s}目录成功`}),a.dialogVisible=!1,e()):F({type:"error",title:`${s}目录失败`,message:A.message})}).catch(A=>{a.submiting=!1,F({type:"error",title:`${s}目录失败`,message:A.message})})}})}return V({treeRef:D,treeAsideRef:K}),(g,s)=>{const B=b("circle-plus"),m=b("ElIcon"),A=b("ElTooltip"),ne=b("Edit"),H=b("Delete"),ee=b("el-input"),J=b("el-form-item"),te=b("el-option"),ge=b("el-select"),ye=b("el-form"),ce=b("el-button"),he=b("el-dialog"),oe=Ve("action");return d(),N(Ee,null,[n(i(ga),{ref_key:"treeRef",ref:D,data:a.classifyTreeData,props:a.treeProps,"node-key":"id","empty-text":"暂无数据","default-expand-all":"","default-expanded-keys":a.defaultExpandedkeys,"operate-config":{showCheckBox:!0,showBtn:!0},"current-node-key":a.curActiveKey,"highlight-current":"","expand-on-click-node":!1,"filter-node-method":p,draggable:!0,onCheckBoxChange:Y,onClickBtn:f,onCurrentChange:P},{"smart-tree__node":t(({node:c,data:E})=>[n(i(fa),{"custom-class":"db-node__content",text:c.label},{content:t(({setSlotRef:I,ellipsis:_e})=>[y("div",{ref:Q=>I(Q),class:Re({"db-node__label":!0,"db-text__ellipsis":_e})},R(c.label),3),a.curActiveKey===E.id?(d(),N("div",$a,[!E.isDefault&&E.level<4?ae((d(),v(A,{key:0,content:"添加子目录",placement:"bottom",effect:"light"},{default:t(()=>[n(m,{size:"16",color:"var(--el-color-primary)",onClick:we(Q=>W(E),["stop"])},{default:t(()=>[n(B)]),_:2},1032,["onClick"])]),_:2},1024)),[[oe,"algorithm_template_add"]]):z("",!0),E.isDefault?z("",!0):ae((d(),v(A,{key:1,content:"编辑",placement:"bottom",effect:"light"},{default:t(()=>[n(m,{size:"16",color:"var(--el-color-primary)",onClick:we(Q=>pe(E),["stop"])},{default:t(()=>[n(ne)]),_:2},1032,["onClick"])]),_:2},1024)),[[oe,"algorithm_template_update"]]),E.isDefault?z("",!0):ae((d(),v(A,{key:2,content:"删除",placement:"bottom",effect:"light"},{default:t(()=>[n(m,{size:"16",color:"var(--el-color-danger)",onClick:we(Q=>me(E),["stop"])},{default:t(()=>[n(H)]),_:2},1032,["onClick"])]),_:2},1024)),[[oe,"algorithm_template_catalog_delete"]])])):z("",!0)]),_:2},1032,["text"])]),_:1},8,["data","props","default-expanded-keys","current-node-key"]),n(he,{modelValue:a.dialogVisible,"onUpdate:modelValue":s[4]||(s[4]=c=>a.dialogVisible=c),class:"center-dialog",title:(i(We).get(a.dialogType)||"新增")+"目录","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:fe,onClosed:s[5]||(s[5]=c=>a.dialogVisible=!1)},{footer:t(()=>[y("span",Pa,[n(ce,{onClick:s[3]||(s[3]=c=>a.dialogVisible=!1)},{default:t(()=>[x("取 消")]),_:1}),n(ce,{type:"primary",loading:a.submiting,onClick:de},{default:t(()=>[x(" 确 定 ")]),_:1},8,["loading"])])]),default:t(()=>[y("div",La,[n(ye,{ref_key:"editForm",ref:_,class:"edit-form",inline:"",model:a.editData,rules:a.rules,"label-width":"100px","label-position":"right",onKeyup:sa(de,["enter"])},{default:t(()=>[y("div",Ra,[n(J,{label:"目录名称：",prop:"name"},{default:t(()=>[n(ee,{modelValue:a.editData.name,"onUpdate:modelValue":s[0]||(s[0]=c=>a.editData.name=c),type:"text",placeholder:"请输入目录名称",maxlength:"10","show-word-limit":""},null,8,["modelValue"])]),_:1})]),y("div",Ua,[n(J,{label:"上级目录：",prop:"pid"},{default:t(()=>[n(ge,{modelValue:a.editData.pid,"onUpdate:modelValue":s[1]||(s[1]=c=>a.editData.pid=c),placeholder:"请选择上级目录",style:{width:"100%"}},{default:t(()=>[(d(!0),N(Ee,null,Ge(S.value,c=>(d(),v(te,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),y("div",Oa,[n(J,{label:"描述：",prop:"description"},{default:t(()=>[n(ee,{modelValue:a.editData.description,"onUpdate:modelValue":s[2]||(s[2]=c=>a.editData.description=c),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","title"])],64)}}});function Ha(h,V=!0,O=()=>{}){const k=q(h),_=ue({treeProps:{label:"name",children:"children",disabled:"no"},classifyTreeData:[]}),D=V?je("getClassifyTreeData"):O;_.classifyTreeData=De(()=>(D==null?void 0:D())||[]);const K=Ue(_.classifyTreeData);function a(e){if(typeof e!="object")k.value.type=null;else{const f=U.cloneDeep(e);k.value.type={...S(f)}}}function S(e){const f=Ue(_.classifyTreeData),p={[_.treeProps.label]:f.value.get(e.id),id:e.id};return U.cloneDeep(p)}function Y(e,f){for(const p of e){if(p.id===f)return p;if(p.children){const P=Y(p.children,f);if(P)return P}}return null}return{...Be(_),handleTypeChange:a,getTypeObj:S,findTreeNodeById:Y,currentEditData:k,catalogNameMap:K}}function Ze(h){const V=ue({checkingUniq:!1,checkTimer:null});function O(){const e=Object.entries(He).map(([f,p])=>({value:f,label:p}));return e.unshift({value:"",label:"所有"}),e}const k=O();function _(e,f,p){if(f){const P=f.match(/[\W_]/);P&&P.length>0?p(new Error("模板标识不能输入汉字、空格和特殊符号!")):(V.checkingUniq=!0,V.checkTimer&&clearTimeout(V.checkTimer),V.checkTimer=setTimeout(()=>{j.checkTemplateName(f,(h==null?void 0:h())||"").then(W=>{V.checkingUniq=!1,W.code==="0000"?W.data?p():p(new Error("该模板标识已被使用")):(xe({type:"warning",message:W.message}),p(new Error("后台验证失败，无法通过")))}).catch(()=>{V.checkingUniq=!1,xe({type:"error",message:"验证是否重名接口失败"}),p(new Error("后台验证失败，无法通过"))})},500))}else V.checkTimer&&clearTimeout(V.checkTimer),V.checkingUniq=!1,p(new Error("模板标识不能为空!"))}function D(){return{id:Je(),name:"",aliasName:"",type:"",primaryKey:!1,length:32,decimal:0,required:!1,description:"",indexYn:!1,initialValue:""}}function K(){const e=[],f=D();f.name=Qe,f.aliasName="实体编码",f.type="STRING",f.length=255,f.required=!0,f.indexYn=!0,e.push(f);const p=D();return p.name=xa,p.aliasName="实体名称",p.type="STRING",p.length=255,p.required=!0,e.push(p),[...e]}function a(){const e=[],f=D();f.name=Ne,f.aliasName="来源实体",f.type="STRING",f.length=255,f.required=!0,f.indexYn=!0,e.push(f);const p=D();return p.name=Se,p.aliasName="目标实体",p.type="STRING",p.length=255,p.required=!0,p.indexYn=!0,e.push(p),[...e]}function S(e){return!(Na.includes(e.name)&&e.aliasName&&e.required)}function Y(e){return[Ne,Se].includes(e.name)}return{...Be(V),cascaderOptions:k,checkTemplateName:_,createTableItem:D,getDefaultEntityObjectTable:K,getDefaultEntityRelationshipTable:a,isSelectable:S,isRelationKey:Y}}const qa={class:"main-content"},Fa={class:"title"},Ma={class:"card"},za=y("div",{class:"subtitle"},"基本信息",-1),Ya={class:"content-wrap"},Ga={class:"item-wrap item2"},ja={key:1},Wa={key:1},Ja={class:"item-wrap item2"},Qa={key:1},Xa={key:1},Za={class:"item-wrap"},et={key:0,class:"item-wrap item2"},at={class:"card"},tt=y("div",{class:"subtitle fieldTitle"},"字段信息",-1),lt={key:0,class:"content-wrap TableBtnsContainer"},nt={class:"content-wrap"},ot=y("span",{style:{"font-size":"16px",color:"#ff8282"}},"*",-1),it=y("div",null,[x(" 若该模板用于数据库表，需按数据库列名规范设置，请勿使用保留关键词 "),y("br"),x(" 例如：INTEGER, STRING, INT64, INT32, INT16, INT8, DOUBLE, "),y("br"),x(" FLOAT, DECIMAL, DATE, DATETIME, TIME, DURATION, BOOL "),y("br"),x(" BOOLEAN, LIST, SET, MAP, POINT, LINESTRING, POLYGON ")],-1),rt={key:1},st=y("p",null,[y("span",{style:{"font-size":"16px",color:"#ff8282"}},"*"),x(" 中文名称 ")],-1),dt={key:1},ct=y("p",null,[y("span",{style:{"font-size":"16px",color:"#ff8282"}},"*"),x(" 数据类型 ")],-1),ut={key:1},pt={key:1},mt={key:1},ft={key:1},gt=["onClick"],yt={key:1,class:"content-wrap"},ht=y("div",{id:"anchorPoint",style:{overflow:"hidden"}},null,-1),_t={class:"footer"},bt=Oe({__name:"TemplateInfoDialog",props:{visible:{type:Boolean,default:!1},dialogType:{default:u.CHECK},domId:{default:""},curEditId:{default:""}},emits:["update:visible","changeEdit","save"],setup(h,{emit:V}){const O=V,k=h,_=je("getCatalogNode"),D=q(),K=q(),a=q(),S=q(),Y=q(),e=ue({isLoading:!1,dialogVisible:!1,submiting:!1,isHandling:!1,file:null,initData:{id:"",name:"",aliasName:"",type:null,cascaderValue:[],description:""},editData:{},rules:{name:[{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]}],aliasName:[{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]},{required:!0,message:"模板名称不能为空",trigger:["blur","change"]}],type:[{required:!0,message:"算法分类不能为空",trigger:["change"]}],cascaderValue:[{required:!0,message:"模板类型不能为空",trigger:["change"]}]},tableData:[],tableRules:{name:[{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]},{required:!0,message:"英文名称不能为空",trigger:["blur","change"]}],aliasName:[{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]},{required:!0,message:"中文名称不能为空",trigger:["blur","change"]}],type:[{required:!0,message:"数据类型不能为空",trigger:["change"]}]},selection:[]}),f=De(()=>k.dialogType!==u.CHECK),p=q(null),P=De(()=>{var l,r,C,$;return((r=(l=e.editData)==null?void 0:l.cascaderValue)==null?void 0:r[0])==="ENTITYOBJECT"||(($=(C=e.editData)==null?void 0:C.cascaderValue)==null?void 0:$[0])==="ENTITYRELATIONSHIP"}),{checkTemplateName:W,checkingUniq:pe,cascaderOptions:me,createTableItem:fe,getDefaultEntityObjectTable:de,getDefaultEntityRelationshipTable:g,isSelectable:s,isRelationKey:B}=Ze(ce);e.rules.name.push({required:!0,validator:W,trigger:["blur","change"]});const{classifyTreeData:m,treeProps:A,handleTypeChange:ne,currentEditData:H,findTreeNodeById:ee,catalogNameMap:J}=Ha(e.editData);ke(()=>k.visible,l=>{e.dialogVisible=l}),ke(()=>H,l=>{e.editData.type=l.value.type},{deep:!0}),ke(()=>f.value,l=>{var r,C;l?te():(r=p.value)!=null&&r.el&&((C=p.value)==null||C.destroy())}),Pe(()=>{document.body.ondrop=function(l){l.preventDefault(),l.stopPropagation()}});function te(){var C;const r=((C=a.value.$el)==null?void 0:C.querySelector(".sortableTable")).querySelector(".el-table__body-wrapper tbody");p.value=ka.create(r,{disabled:!f.value,handle:".draggable-item",onEnd({newIndex:$,oldIndex:ie}){const M=U.cloneDeep(e.tableData),T=M.splice(ie,1)[0];M.splice($,0,T),e.tableData=[...M]}})}function ge(){if(e.isLoading=!0,e.isHandling=!1,e.file=null,k.dialogType===u.ADD){if(e.editData=U.cloneDeep(e.initData),_!=null&&_())e.editData.type=U.cloneDeep(_==null?void 0:_());else{const l=m.value.find(r=>r.isDefault);e.editData.type=U.cloneDeep(l)}e.editData.type[A.value.label]=J.value.get(e.editData.type.id),e.tableData=[],e.isLoading=!1}else ye(k.curEditId);Te(()=>{var l;(l=K.value)==null||l.clearValidate()})}function ye(l){j.getTemplate(l).then(r=>{r.code==="0000"?(e.editData={type:null,cascaderValue:[],...U.cloneDeep(r.data)},oe(),delete e.editData.templateDataFieldList,e.tableData=r.data.templateDataFieldList||[],e.editData.cascaderValue=r.data.dataLayerType?[r.data.dataType,r.data.dataLayerType]:[r.data.dataType]):xe({type:"error",message:"获取信息失败"})}).catch(()=>{xe({type:"error",message:"获取信息错误"})}).finally(()=>{e.isLoading=!1})}function ce(){var l;return((l=e.editData)==null?void 0:l.id)||""}function he(l){const r=He,C=Xe;return l.dataLayerType?`${r[l.dataType]} / ${C[l.dataLayerType]}`:r[l.dataType]}function oe(){const l=i(m),r=ee(l,e.editData.catalogId);e.editData.type=U.cloneDeep(r)}function c(l){if(e.tableData=[],P.value){const r=l[0]==="ENTITYOBJECT"?de():g();e.tableData=[...r]}}function E(){const l=fe(),r=U.cloneDeep([...e.tableData,l]);e.tableData=[],Te(()=>{e.tableData=r}),setTimeout(()=>{D.value.querySelector("#anchorPoint").scrollIntoView()},20)}function I(l){var r;s(l)&&(e.tableData=e.tableData.filter(C=>C.id!==l.id),e.selection=e.selection.filter(C=>C!==l.id),e.selection.length===0&&((r=S.value)==null||r.clearSelection()))}function _e(){var l;e.tableData=e.tableData.filter(r=>e.selection.every(C=>r.id!==C)),e.selection=[],(l=S.value)==null||l.clearSelection()}function Q(){Y.value.click()}function X(l){return l.replace(/.+\./,"")}function be(l){const{files:r}=l.target;if(r.length===0)return;const C=r[0];e.isHandling=!0;const $=["xls","xlsx"],ie=X(C.name).toLowerCase();if($.includes(ie))e.file=new File([C],C.name);else{se.alert("上传失败，请选择正确的文件格式上传","提示",{confirmButtonText:"确定",type:"error"}),l.target.value="",e.isHandling=!1;return}ea(),l.target.value=""}function ea(){const l=new FormData;l.append("file",e.file),j.importTemplate(l).then(r=>{if(r.code==="0000"&&(r!=null&&r.data)){const C=r.data;C.forEach($=>{$.id=Je()}),e.tableData=U.cloneDeep(C)}else F({type:"error",title:"文件读取失败",message:r.message})}).catch(r=>{F({type:"error",title:"文件读取失败",message:r.message})}).finally(()=>{e.isHandling=!1})}function aa(l){e.selection=l.map(r=>r.id)}function Ie(){O("update:visible",!1)}function ta(){O("changeEdit")}function qe(l){return new Promise(r=>{l.validate(C=>{r(C)})})}function la(){const l=qe(K.value),r=qe(a.value);Promise.all([l,r]).then(([$,ie])=>{if($&&ie){const{aliasName:M,cascaderValue:T,description:Ke,id:Ce,name:re,type:L}=e.editData;if((T==null?void 0:T[0])==="ENTITYRELATIONSHIP"&&e.tableData[0].name!==Ne&&e.tableData[1].name!==Se){se.alert(`字段信息【${Ne}】和【${Se}】需分别排列在第一和第二行`,"提示",{confirmButtonText:"确定",type:"warning"});return}if(Va(e.tableData,"name")){se.alert("英文名称存在相同的值，需唯一，请检查后再保存","提示",{confirmButtonText:"确定",type:"warning"});return}const Ae=Aa.map(Z=>Z.toLocaleLowerCase());if(e.tableData.some(Z=>Ae.includes(Z.name.toLocaleLowerCase()))){se.alert("英文名称存在特殊关键词，请检查后再保存","提示",{confirmButtonText:"确定",type:"warning"});return}const $e={id:Ce,name:re,aliasName:M,catalogId:L.id,catalogName:L.name,dataType:T==null?void 0:T[0],dataLayerType:(T==null?void 0:T[1])||null,description:Ke,templateDataFieldList:U.cloneDeep(e.tableData)};e.submiting=!0,j.saveOrUpdateTemplate($e).then(Z=>{Z.code==="0000"?(F({type:"success",title:`${k.dialogType===u.ADD?"新增":"保存"}模板成功`}),O("save"),Ie()):F({type:"error",title:`${k.dialogType===u.ADD?"新增":"保存"}模板失败`,message:Z.message})}).catch(Z=>{F({type:"error",title:`${k.dialogType===u.ADD?"新增":"保存"}模板错误`,message:Z.message})}).finally(()=>{e.submiting=!1})}})}return(l,r)=>{const C=b("ArrowLeft"),$=b("el-icon"),ie=b("Loading"),M=b("el-input"),T=b("el-form-item"),Ke=b("el-cascader"),Ce=b("el-form"),re=b("el-button"),L=b("el-table-column"),Ae=b("QuestionFilled"),$e=b("el-tooltip"),Z=b("el-option"),na=b("el-select"),Le=b("el-checkbox"),Fe=b("el-input-number"),oa=b("Plus"),ia=Ve("action"),ra=Ve("loading");return d(),v(i(Ka),{id:"template-full-dialog",modelValue:e.dialogVisible,"onUpdate:modelValue":r[6]||(r[6]=ve=>e.dialogVisible=ve),class:"full-dialog common-full-dialog","append-to-dom":l.domId,"modal-append-to-body":!1,fullscreen:"","is-custom":"","close-on-press-escape":!1,onOpen:ge,onClosed:Ie},{default:t(()=>{var ve,Me;return[ae((d(),N("div",qa,[y("div",Fa,[n($,{onClick:Ie},{default:t(()=>[n(C)]),_:1}),y("span",null,R((i(We).get(l.dialogType)||"查看")+"模板"),1)]),y("div",{ref_key:"mainRef",ref:D,class:"main"},[y("div",Ma,[za,y("div",Ya,[n(Ce,{ref_key:"formRef",ref:K,class:"form edit-form",inline:"",model:e.editData,rules:e.rules,"label-width":"auto","label-position":"right"},{default:t(()=>[y("div",Ga,[n(T,{label:"模板标识",prop:"name"},{default:t(()=>[l.dialogType!==i(u).CHECK?(d(),v(M,{key:0,modelValue:e.editData.name,"onUpdate:modelValue":r[0]||(r[0]=o=>e.editData.name=o),type:"text",placeholder:"请输入模板标识",maxlength:"50","show-word-limit":""},da({_:2},[i(pe)?{name:"suffix",fn:t(()=>[n($,{class:"el-input__icon"},{default:t(()=>[n(ie)]),_:1})]),key:"0"}:void 0]),1032,["modelValue"])):(d(),N("span",ja,R(e.editData.name),1))]),_:1}),n(T,{label:"模板名称",prop:"aliasName"},{default:t(()=>[l.dialogType!==i(u).CHECK?(d(),v(M,{key:0,modelValue:e.editData.aliasName,"onUpdate:modelValue":r[1]||(r[1]=o=>e.editData.aliasName=o),type:"text",placeholder:"请输入模板名称",maxlength:"50","show-word-limit":""},null,8,["modelValue"])):(d(),N("span",Wa,R(e.editData.aliasName),1))]),_:1})]),y("div",Ja,[n(T,{label:"所属目录",prop:"type"},{default:t(()=>{var o,w;return[l.dialogType!==i(u).CHECK?(d(),v(i(Sa),{key:0,modelValue:e.editData.type,"onUpdate:modelValue":r[2]||(r[2]=le=>e.editData.type=le),"tree-props":i(A),"tree-data":i(m),"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"",onChange:i(ne)},null,8,["modelValue","tree-props","tree-data","onChange"])):(d(),N("span",Qa,R(((w=(o=e.editData)==null?void 0:o.type)==null?void 0:w[i(A).label])||""),1))]}),_:1}),n(T,{label:"数据类型",prop:"cascaderValue"},{default:t(()=>[l.dialogType!==i(u).CHECK?(d(),v(Ke,{key:0,modelValue:e.editData.cascaderValue,"onUpdate:modelValue":r[3]||(r[3]=o=>e.editData.cascaderValue=o),options:i(me),style:{width:"100%"},onChange:c},null,8,["modelValue","options"])):(d(),N("span",Xa,R(he(e.editData)),1))]),_:1})]),y("div",Za,[n(T,{label:"说明",prop:"description"},{default:t(()=>[l.dialogType!==i(u).CHECK?(d(),v(M,{key:0,modelValue:e.editData.description,"onUpdate:modelValue":r[4]||(r[4]=o=>e.editData.description=o),type:"text",placeholder:"请输入说明",clearable:"",maxlength:"100","show-word-limit":""},null,8,["modelValue"])):(d(),N("span",{key:1,class:Re(["description",e.editData.description?"":"empty"])},R(e.editData.description||"未说明"),3))]),_:1})]),l.dialogType!==i(u).ADD?(d(),N("div",et,[n(T,{label:"创建人",prop:"creator"},{default:t(()=>[y("span",null,R(e.editData.creator),1)]),_:1}),n(T,{label:"发布时间",prop:"createTime"},{default:t(()=>[y("span",null,R(e.editData.createTime),1)]),_:1})])):z("",!0)]),_:1},8,["model","rules"])])]),ae(y("div",at,[tt,l.dialogType!==i(u).CHECK?(d(),N("div",lt,[n(re,{type:"danger",disabled:e.selection.length===0,onClick:_e},{default:t(()=>[x(" 批量删除 ")]),_:1},8,["disabled"]),n(re,{type:"primary",loading:e.isHandling,onClick:Q},{default:t(()=>[x(" 导入 ")]),_:1},8,["loading"]),y("input",{ref_key:"uploadFile",ref:Y,style:{display:"none"},type:"file",class:"uploadFile",directory:"",nwdirectory:"",accept:".xls,.xlsx",onChange:be},null,544)])):z("",!0),y("div",nt,[n(Ce,{ref_key:"tableFormRef",ref:a,class:"table-form tableContainer",model:e},{default:t(()=>[n(i(ca),{ref_key:"tableRef",ref:S,class:"table commonTable sortableTable",data:e.tableData,"row-key":"id",onSelectionChange:aa},{default:t(()=>[f.value?(d(),v(L,{key:0,"class-name":"draggable-item",align:"center",label:"排序",width:"60"},{default:t(()=>[n($,null,{default:t(()=>[n(i(ua))]),_:1})]),_:1})):z("",!0),l.dialogType!==i(u).CHECK?(d(),v(L,{key:1,align:"center",type:"selection",label:"选中","reserve-selection":"",selectable:i(s)},null,8,["selectable"])):z("",!0),n(L,{prop:"name","min-width":"120"},{header:t(()=>[y("p",null,[ot,x(" 英文名称 "),n($e,{class:"item",effect:"dark",placement:"top"},{content:t(()=>[it]),default:t(()=>[n($,{style:{"margin-left":"4px",transform:"translateY(2px)"}},{default:t(()=>[n(Ae)]),_:1})]),_:1})])]),default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".name",rules:e.tableRules.name},{default:t(()=>{var w;return[n(M,{modelValue:o.row.name,"onUpdate:modelValue":le=>o.row.name=le,modelModifiers:{trim:!0},disabled:!i(s)(o.row)||l.dialogType===i(u).EDIT&&P.value&&!!((w=o.row)!=null&&w.templateDataId),placeholder:"请输入英文名称",onInput:le=>o.row.name=i(wa)(le)},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])]}),_:2},1032,["prop","rules"])):(d(),N("span",rt,R(o.row.name),1))]),_:1}),n(L,{prop:"aliasName","min-width":"120"},{header:t(()=>[st]),default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".aliasName",rules:e.tableRules.aliasName},{default:t(()=>[n(M,{modelValue:o.row.aliasName,"onUpdate:modelValue":w=>o.row.aliasName=w,placeholder:"请输入中文名称"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop","rules"])):(d(),N("span",dt,R(o.row.aliasName),1))]),_:1}),n(L,{prop:"type","min-width":"120"},{header:t(()=>[ct]),default:t(o=>[n(T,{prop:"tableData."+o.$index+".type",rules:e.tableRules.type},{default:t(()=>[n(na,{modelValue:o.row.type,"onUpdate:modelValue":w=>o.row.type=w,disabled:l.dialogType===i(u).CHECK||!i(s)(o.row),placeholder:"请选择"},{default:t(()=>[(d(!0),N(Ee,null,Ge(i(Ia),(w,le)=>(d(),v(Z,{key:le,label:w,value:le},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop","rules"])]),_:1}),P.value?z("",!0):(d(),v(L,{key:2,prop:"primaryKey",label:"主键","min-width":"60",align:"center"},{default:t(o=>[n(T,{class:"content-center",prop:"tableData."+o.$index+".primaryKey"},{default:t(()=>[n(Le,{modelValue:o.row.primaryKey,"onUpdate:modelValue":w=>o.row.primaryKey=w,disabled:l.dialogType===i(u).CHECK},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop"])]),_:1})),n(L,{prop:"length",label:"字段长度","min-width":"120"},{default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".length"},{default:t(()=>[n(Fe,{modelValue:o.row.length,"onUpdate:modelValue":w=>o.row.length=w,"controls-position":"right",min:0,max:255,disabled:i(B)(o.row)},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop"])):(d(),N("span",ut,R(o.row.length),1))]),_:1}),n(L,{prop:"decimal",label:"小数位数","min-width":"120"},{default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".decimal"},{default:t(()=>[n(Fe,{modelValue:o.row.decimal,"onUpdate:modelValue":w=>o.row.decimal=w,"controls-position":"right",min:0,max:255},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])):(d(),N("span",pt,R(o.row.decimal),1))]),_:1}),n(L,{prop:"required",label:"必填","min-width":"60",align:"center"},{default:t(o=>[n(T,{class:"content-center",prop:"tableData."+o.$index+".required"},{default:t(()=>[n(Le,{modelValue:o.row.required,"onUpdate:modelValue":w=>o.row.required=w,disabled:l.dialogType===i(u).CHECK||!i(s)(o.row)},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop"])]),_:1}),P.value?(d(),v(L,{key:3,prop:"indexYn",label:"索引","min-width":"60",align:"center"},{default:t(o=>[n(T,{class:"content-center",prop:"tableData."+o.$index+".indexYn"},{default:t(()=>[n(Le,{modelValue:o.row.indexYn,"onUpdate:modelValue":w=>o.row.indexYn=w,disabled:l.dialogType===i(u).CHECK||o.row.name===i(Qe)||i(B)(o.row)},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop"])]),_:1})):z("",!0),P.value?(d(),v(L,{key:4,prop:"initialValue",label:"初始值","min-width":"120"},{default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".initialValue"},{default:t(()=>[n(M,{modelValue:o.row.initialValue,"onUpdate:modelValue":w=>o.row.initialValue=w,disabled:!i(s)(o.row)},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop"])):(d(),N("span",mt,R(o.row.initialValue),1))]),_:1})):z("",!0),n(L,{prop:"description",label:"业务描述","min-width":"120"},{default:t(o=>[l.dialogType!==i(u).CHECK?(d(),v(T,{key:0,prop:"tableData."+o.$index+".description"},{default:t(()=>[n(M,{modelValue:o.row.description,"onUpdate:modelValue":w=>o.row.description=w,placeholder:"请输入业务描述"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])):(d(),N("span",ft,R(o.row.description),1))]),_:1}),l.dialogType!==i(u).CHECK?(d(),v(L,{key:5,width:"60px",label:"操作",align:"center",fixed:"right","class-name":"tableOperate"},{default:t(o=>[y("span",{class:Re(["delete",{disabled:!i(s)(o.row)}]),onClick:we(w=>I(o.row),["stop"])}," 删除 ",10,gt)]),_:1})):z("",!0)]),_:1},8,["data"])]),_:1},8,["model"])]),l.dialogType!==i(u).CHECK?(d(),N("div",yt,[y("div",{class:"addTableBtn",onClick:E},[n($,null,{default:t(()=>[n(oa)]),_:1}),x("新增参数 ")])])):z("",!0),ht],512),[[pa,((Me=(ve=e.editData)==null?void 0:ve.cascaderValue)==null?void 0:Me.length)>0]])],512),y("div",_t,[n(re,{onClick:r[5]||(r[5]=o=>e.dialogVisible=!1)},{default:t(()=>[x("取消")]),_:1}),l.dialogType!==i(u).CHECK?ae((d(),v(re,{key:0,type:"primary",loading:e.submiting,onClick:la},{default:t(()=>[x("保存")]),_:1},8,["loading"])),[[ia,"algorithm_template_saveOrUpdate"]]):(d(),v(re,{key:1,type:"primary",onClick:ta},{default:t(()=>[x("编辑")]),_:1}))])])),[[ra,e.isLoading]])]}),_:1},8,["modelValue","append-to-dom"])}}});function Tt(){const{cascaderOptions:h}=Ze(),V=ue({classifyTreeData:[],searchOptions:[{label:"关键字",key:"name",type:"text",placeholder:"模板标识/名称",span:6},{label:"模板类型",key:"cascaderValue",type:"cascader",options:h,clearable:!0,cascaderProps:{expandTrigger:"hover"},span:5}],columns:[{prop:"name",label:"模板标识",minWidth:120,slot:"name"},{prop:"aliasName",label:"模板名称",minWidth:120},{prop:"dataType",label:"模板类型",minWidth:120,formatter:O},{prop:"catalogId",label:"所属目录",minWidth:120,formatter:k},{prop:"creator",label:"创建人",minWidth:120},{prop:"createTime",label:"创建时间",minWidth:120}]});function O(_,D,K){const a=He,S=Xe;return _.dataLayerType?`${a[_.dataType]} / ${S[_.dataLayerType]}`:a[_.dataType]}function k(_,D,K){return Ue(V.classifyTreeData).value.get(`${_.catalogId}`)||"未知目录"}return{...Be(V)}}const Kt=Oe({__name:"index",setup(h){const{searchOptions:V,columns:O,classifyTreeData:k}=Tt(),_=q(),D=q(),K=q(),a=q(),S={catalogId:"#",dataType:"",dataLayerType:""},Y=De(()=>{var c;return(c=a.value)==null?void 0:c.$el}),{data:e,total:f,pageNo:p,pageSize:P,multipleSelection:W,loading:pe,handleSizeChange:me,handleCurrentChange:fe,handleSelectionChange:de,handleSearch:g,initData:s}=ya(j.getTemplatePageList,S);function B(c){if(c.cascaderValue){const[E,I]=c.cascaderValue;S.dataType=E,S.dataLayerType=I}else S.dataType="",S.dataLayerType="";g(c)}const m=ue({domId:"template-manage",dialogVisible:!1,dialogType:u.CHECK,curEditId:""});ze("getClassifyTreeData",A),ze("getCatalogNode",ne),Pe(()=>{s()});function A(){return k.value}function ne(){var c,E,I;return((I=(E=(c=K.value)==null?void 0:c.treeRef)==null?void 0:E.smartTreeRef)==null?void 0:I.getCurrentNode())||null}function H(c){k.value=c}function ee(c){S.catalogId=c,s()}function J(){m.curEditId="",m.dialogType=u.ADD,m.dialogVisible=!0}function te(c){m.curEditId=c.id,m.dialogType=u.EDIT,m.dialogVisible=!0}function ge(c){j.exportTemplate(c.id).then(E=>{const{data:I}=E;Ea(I.data,I.fileName)})}function ye(c){se.confirm(`删除【${c.name}】数据，是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{s.value=!0,j.deleteTemplate(c.id).then(E=>{s.value=!1,E.code==="0000"?(F({type:"success",title:"删除成功"}),s()):F({type:"warning",title:"删除失败，请重试"})}).catch(E=>{s.value=!1,F({type:"error",title:"删除错误",message:E.message||"服务有错"})})}).catch(()=>{})}function ce(){W.value.length<1||se.confirm("删除选中数据，是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{s.value=!0,j.deleteTemplate(W.value.map(c=>c.id).join(",")).then(c=>{s.value=!1,c.code==="0000"&&s()}).catch(()=>{s.value=!1})}).catch(()=>{})}function he(){m.dialogType=u.EDIT}function oe(c){m.curEditId=c.id,m.dialogType=u.CHECK,m.dialogVisible=!0}return(c,E)=>{const I=b("el-button"),_e=b("el-link"),Q=Ve("action");return d(),N(Ee,null,[n(i(Ye),{id:"template-manage",background:""},{default:t(()=>[n(i(ha),{ref_key:"asideRef",ref:a},{default:t(()=>[n(Ba,{ref_key:"catalogTreeRef",ref:K,onChange:ee,onSetData:H},null,512)]),_:1},512),n(i(Ye),{id:"template-setting",ref_key:"mainContainerRef",ref:D},{default:t(()=>[n(i(_a),{target:Y.value},null,8,["target"]),n(i(ba),{padding:"1 1 0",border:""},{default:t(()=>[n(i(Ta),{ref_key:"SmartSearchRef",ref:_,options:i(V),onHandleSearch:B},null,8,["options"])]),_:1}),n(i(Da),null,{default:t(()=>[n(i(Ca),{ref:"baseTable","operation-width":"220",columns:i(O),"table-data":i(e),"current-page":i(p),"page-size":i(P),total:i(f),"pagination-is-need":!0,"operation-is-need":!0,loading:i(pe),"search-form-ref":_.value,"selection-is-need":!0,"index-is-need":!1,onSizeChange:i(me),onCurrentChange:i(fe),onSelectionChange:i(de)},{"smart-table_operation":t(()=>[n(I,{type:"primary",onClick:J},{default:t(()=>[x(" 新增模板 ")]),_:1})]),"smart-table_batch-operation":t(()=>[n(I,{link:"",type:"danger",icon:i(ma),onClick:ce},{default:t(()=>[x(" 批量删除 ")]),_:1},8,["icon"])]),name:t(({scope:X})=>[n(_e,{type:"primary",onClick:be=>oe(X.row)},{default:t(()=>[x(R(X.row.name),1)]),_:2},1032,["onClick"])]),operation:t(({scope:X})=>[ae((d(),v(I,{link:"",type:"primary",onClick:be=>te(X.row)},{default:t(()=>[x(" 编辑 ")]),_:2},1032,["onClick"])),[[Q,"algorithm_template_saveOrUpdate"]]),ae((d(),v(I,{link:"",type:"primary",onClick:be=>ge(X.row)},{default:t(()=>[x(" 下载 ")]),_:2},1032,["onClick"])),[[Q,"algorithm_template_export"]]),ae((d(),v(I,{link:"",type:"danger",onClick:be=>ye(X.row)},{default:t(()=>[x(" 删除 ")]),_:2},1032,["onClick"])),[[Q,"algorithm_template_delete"]])]),_:1},8,["columns","table-data","current-page","page-size","total","loading","search-form-ref","onSizeChange","onCurrentChange","onSelectionChange"])]),_:1})]),_:1},512)]),_:1}),n(bt,{visible:m.dialogVisible,"onUpdate:visible":E[0]||(E[0]=X=>m.dialogVisible=X),"dom-id":m.domId,"dialog-type":m.dialogType,"cur-edit-id":m.curEditId,onSave:i(s),onChangeEdit:he},null,8,["visible","dom-id","dialog-type","cur-edit-id","onSave"])],64)}}});export{Kt as default};
