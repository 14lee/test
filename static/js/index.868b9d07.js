import{b as xt,o as Pt,a as $t,_ as Ut,w as Ot}from"./login.a4e9287e.js";import{d as oa,b as ee,r as Ye,w as Ie,i as ea,c as xe,e as h,o as c,x as j,k as o,g as i,j as t,l as ae,A as Va,f as A,F as we,y as Me,u as E,n as Ue,ai as De,S as Fa,z as de,aj as oe,a4 as Ma,p as Xe,bc as ja,t as Ta,U as He,ad as va,B as Oe,v as Fe,bq as Aa,br as Ra,ae as Da,V as qa,N as ga,ak as ra,T as It,bb as At,c4 as Rt,c5 as Bt,c6 as Ft,$ as Ja,a1 as Ga,b5 as Mt,c7 as jt,c8 as qt,a0 as Wa,b$ as Jt,bo as Gt,Q as Xa,R as Wt,L as Xt,bX as Kt,c9 as Yt}from"./element-plus.59ccb443.js";import{v as zt,q as k}from"./lodash.22f463b4.js";import{D as Se,d as Qt,h as je,b as Ca,i as sa,f as Ka,t as Ht,G as Zt,C as el,a as al}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{i as fa,c as Ya}from"./index-a95bb620.js";import{W as Ba,_ as tl,a as ll,b as ol}from"./jointPrepare.318e4ddb.js";import{b as nl}from"./config.d740378b.js";import{W as La}from"./WorkTypeForm.285ddc00.js";import{u as il}from"./error.229cea25.js";import{S as sl}from"./serviceManage.8c46f250.js";import"../../app-config.js";import"./echarts.39e3cf74.js";import"./wujie-vue3.9ecbe737.js";import"./smartweb3.2d5e4c59.js";import"./smart-ui.e8e0134c.js";import"./useTableAndPagination.0c6e0294.js";const rl={class:"classify-work-scheme"},ul={class:"item-wrap"},dl={class:"item-wrap"},cl={class:"item-wrap"},pl={class:"dialog-footer"},ml=oa({__name:"ClassifyDialog",props:{visible:{type:Boolean,default:!1},dialogType:{default:Se.ADD},curItem:{default:()=>{}}},emits:["update:visible","save"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=ee(),_e=ee(!1),x=Ye({submiting:!1,defaultData:{name:"",pid:"#",description:""},editData:{},rules:{name:[{required:!0,message:"分组名称不能为空",trigger:["change","blur"]},{min:0,max:10,message:"长度在 10 个字符以内",trigger:["blur","change"]}],pid:[{required:!0,message:"上级分组不能为空",trigger:["change"]}]}});Ie(()=>b.visible,le=>{_e.value=le});const te=ea("getClassifyTreeData"),s=xe(()=>(te==null?void 0:te())||[]),V=xe(()=>{if(!s.value||s.value.length===0)return[{value:"#",label:"/"}];{let le=s.value.map(Q=>({value:Q.id,label:Q.name}));return b.dialogType===Se.EDIT&&(le=le.filter(Q=>Q.value!==x.editData.id)),x.editData.level===1&&x.editData.children&&x.editData.children.length>0&&x.editData.children.some(Q=>Q.type===0)?[{value:"#",label:"/"}]:[{value:"#",label:"/"},...le]}});function d(){const{dialogType:le,curItem:Q}=b;le===Se.ADD?(x.editData=zt(x.defaultData),x.editData.pid=Q.pid):le===Se.EDIT&&(x.editData={...Q}),Ue(()=>{var H;(H=a.value)==null||H.clearValidate()})}function W(){ge("update:visible",!1)}function ie(){var le;(le=a.value)==null||le.validate(Q=>{if(Q){const{dialogType:H}=b,C=H===Se.ADD?"新增":"编辑",Z=H===Se.ADD?"addClassify":"modifyClassify",p={...x.editData};H!==Se.ADD&&(delete p.children,delete p.level),x.submiting=!0,je[Z](p).then(R=>{x.submiting=!1,R.code==="0000"?(De({type:"success",title:`${C}分组成功`}),W(),ge("save")):De({type:"error",title:`${C}分组失败`,message:R.message})}).catch(R=>{x.submiting=!1,De({type:"error",title:`${C}分组失败`,message:R.message})})}})}return(le,Q)=>{const H=h("el-input"),C=h("el-form-item"),Z=h("el-option"),p=h("el-select"),R=h("el-form"),Y=h("el-button"),U=h("el-dialog");return c(),j(U,{modelValue:_e.value,"onUpdate:modelValue":Q[4]||(Q[4]=e=>_e.value=e),class:"center-dialog",title:(E(Qt).get(le.dialogType)||"新增")+"分组","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:d,onClosed:W},{footer:o(()=>[i("span",pl,[t(Y,{onClick:Q[3]||(Q[3]=e=>_e.value=!1)},{default:o(()=>[ae("取 消")]),_:1}),t(Y,{type:"primary",loading:x.submiting,onClick:ie},{default:o(()=>[ae("确 定")]),_:1},8,["loading"])])]),default:o(()=>[i("div",rl,[t(R,{ref_key:"editFormRef",ref:a,class:"edit-form",inline:"",model:x.editData,rules:x.rules,"label-width":"100px","label-position":"right",onKeyup:Va(ie,["enter"])},{default:o(()=>[i("div",ul,[t(C,{label:"分组名称：",prop:"name"},{default:o(()=>[t(H,{modelValue:x.editData.name,"onUpdate:modelValue":Q[0]||(Q[0]=e=>x.editData.name=e),type:"text",placeholder:"请输入分组名称",maxlength:"10","show-word-limit":""},null,8,["modelValue"])]),_:1})]),i("div",dl,[t(C,{label:"上级分组：",prop:"pid"},{default:o(()=>[t(p,{modelValue:x.editData.pid,"onUpdate:modelValue":Q[1]||(Q[1]=e=>x.editData.pid=e),placeholder:"请选择上级分组",style:{width:"100%"}},{default:o(()=>[(c(!0),A(we,null,Me(V.value,e=>(c(),j(Z,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),i("div",cl,[t(C,{label:"描述：",prop:"description"},{default:o(()=>[t(H,{modelValue:x.editData.description,"onUpdate:modelValue":Q[2]||(Q[2]=e=>x.editData.description=e),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","title"])}}});function Pa(ke,Ee){const ge=ee(ke),b=Ye({treeProps:{label:"name",children:"children",disabled:"no"},classifyTreeData:[]}),a=ea("getClassifyTreeData");b.classifyTreeData=xe(()=>{const V=k.cloneDeep((a==null?void 0:a())||[]);return V.forEach(d=>{var W;d.type===0&&((W=d==null?void 0:d.children)==null?void 0:W.length)>0&&(d.children=d.children.filter(ie=>ie.type!==1),d.children.forEach(ie=>{var le;ie.type===0&&((le=ie==null?void 0:ie.children)==null?void 0:le.length)>0&&(ie.children=ie.children.filter(Q=>Q.type!==1))}))}),V});function _e(V){if(typeof V!="object")ge.value.type=null;else{const d=k.cloneDeep(V),W={[b.treeProps.label]:d[b.treeProps.label],id:d.id};if(d.pid!=="#"){const ie=b.classifyTreeData.find(le=>le.id===d.pid);W[b.treeProps.label]=`${ie[b.treeProps.label]} / ${d[b.treeProps.label]}`}ge.value.type={...x(d)}}Ee&&Ee(k.cloneDeep(ge.value.type))}function x(V){const d={[b.treeProps.label]:V[b.treeProps.label],id:V.id};if(V.pid!=="#"){const W=b.classifyTreeData.find(ie=>ie.id===V.pid);W?d[b.treeProps.label]=`${W[b.treeProps.label]} / ${V[b.treeProps.label]}`:d[b.treeProps.label]=`未知分组 / ${V[b.treeProps.label]}`}return k.cloneDeep(d)}function te(V,d){for(const W of V){if(W.id===d)return W;if(W.children){const ie=te(W.children,d);if(ie)return ie}}return null}function s(V){return new Promise((d,W)=>{V.value.validate(ie=>{d(ie)})})}return{...Fa(b),handleTypeChange:_e,getTypeObj:x,findTreeNodeById:te,currentEditData:ge,checkFormPass:s}}const fl={class:"add-work-scheme"},gl={class:"item-wrap"},hl={class:"item-wrap"},yl={class:"item-wrap"},bl=i("span",{style:{"margin-right":"12px"}},"删除过程数据",-1),_l=i("div",null,"开启后，系统将自动删除任务运行过程中产生的所有数据，",-1),vl=i("div",null,"重新运行任务只能从第一个节点开始运行",-1),Dl={class:"item-wrap"},Tl={class:"item-wrap"},Vl={class:"setting--dialog-content"},Cl={class:"dialog-footer"},kl={class:"dialog-footer"},wl=oa({__name:"CopySchemeDialog",props:{visible:{type:Boolean,required:!0,default:!1},copyData:{type:Object,default:()=>{}}},emits:["update:visible","save"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=Ye({submiting:!1,editData:{name:"",type:null,remark:"",clearData:!0,workType:"SINGLE",expression:"",autoDependence:!1,cancelWhenFailed:!0,effectStartTime:"",effectEndTime:""},rules:{name:[{required:!0,message:"方案名称不能为空",trigger:["change","blur"]},{min:0,max:20,message:"长度在 20 个字符以内",trigger:["blur","change"]}],type:[{required:!0,message:"方案分组不能为空",trigger:["change"]}]},copyScheme:"",tableConfigList:""}),{classifyTreeData:_e,treeProps:x,handleTypeChange:te,currentEditData:s}=Pa(a.editData),V=ee(!1),d=ee(),W=ee(!1),ie=ee();Ie(()=>s,e=>{a.editData.type=e.value.type},{deep:!0}),Ie(()=>b.visible,()=>{V.value=b.visible});function le(){var e;Q((e=b.copyData)==null?void 0:e.id),a.editData.name="",a.editData.remark="",Ue(()=>{var _;(_=d.value)==null||_.clearValidate()})}function Q(e){je.getSchemeInfo(e).then(_=>{var r,pe,D,f,P;_.code==="0000"?(a.copyScheme=_.data.scheme,a.tableConfigList=_.data.tableConfigList,a.editData.type={id:_.data.catalogId,[x.value.label]:_.data.catalog},a.editData.clearData=_.data.clearData,a.editData.workType=_.data.workType,a.editData.expression=(r=_.data)==null?void 0:r.expression,a.editData.autoDependence=((pe=_.data)==null?void 0:pe.autoDependence)??!1,a.editData.cancelWhenFailed=((D=_.data)==null?void 0:D.cancelWhenFailed)??!0,a.editData.effectStartTime=((f=_.data)==null?void 0:f.effectStartTime)??"",a.editData.effectEndTime=((P=_.data)==null?void 0:P.effectEndTime)??""):(oe({type:"warning",message:"获取方案复制信息失败"}),H())}).catch(_=>{oe({type:"error",message:`${_.message}  获取方案复制信息有误`}),H()})}function H(){a.copyScheme=JSON.stringify({cells:[]}),a.editData.type=null,a.editData.clearData=!0,a.tableConfigList=JSON.stringify([]),a.editData.workType="SINGLE",a.editData.expression="",a.editData.autoDependence=!1,a.editData.cancelWhenFailed=!0,a.editData.effectStartTime="",a.editData.effectEndTime=""}function C(){ge("update:visible",!1)}function Z(){var e;(e=d.value)==null||e.validate(_=>{if(_){const{name:r,type:pe,remark:D,workType:f,expression:P,clearData:ce,autoDependence:se,cancelWhenFailed:Ve,effectStartTime:Pe,effectEndTime:Le}=a.editData;if(f==="CYCLE"&&!P){oe({type:"warning",message:"请正确设置周期调度参数"});return}const y={name:r,catalog:pe[x.value.label],catalogId:pe.id,remark:D,status:1,scheme:a.copyScheme,tableConfigList:a.tableConfigList,workType:f,expression:f==="SINGLE"?"":P,clearData:ce??!0};f!=="SINGLE"&&(y.autoDependence=se,y.cancelWhenFailed=Ve,y.effectStartTime=Pe,Le&&(y.effectEndTime=Le)),a.submiting=!0,je.addWorkScheme(y).then(v=>{a.submiting=!1,v.code==="0000"?(De({type:"success",title:"复制方案成功"}),C(),ge("save")):De({type:"error",title:"复制方案失败",message:v.message})}).catch(v=>{a.submiting=!1,De({type:"error",title:"复制方案失败",message:v.message})})}})}function p(){W.value=!0,Ue(()=>{var _;const e={type:a.editData.workType,formData:{...a.editData}};(_=ie.value)==null||_.formatData(e)})}function R(){}function Y(){W.value=!1}function U(){var e;(e=ie.value)==null||e.validData().then(_=>{if(_){const{expression:r,autoDependence:pe,cancelWhenFailed:D,effectStartTime:f,effectEndTime:P}=_.formData;a.editData.expression=r,a.editData.autoDependence=pe,a.editData.cancelWhenFailed=D,a.editData.effectStartTime=f,a.editData.effectEndTime=P,Y()}})}return(e,_)=>{const r=h("el-input"),pe=h("el-form-item"),D=h("el-checkbox"),f=h("QuestionFilled"),P=h("el-icon"),ce=h("el-tooltip"),se=h("el-radio"),Ve=h("el-radio-group"),Pe=h("el-button"),Le=h("el-form"),y=h("el-dialog");return c(),j(y,{modelValue:V.value,"onUpdate:modelValue":_[7]||(_[7]=v=>V.value=v),class:"center-dialog",title:"复制方案","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:le,onClosed:C},{footer:o(()=>[i("span",kl,[t(Pe,{onClick:_[6]||(_[6]=v=>V.value=!1)},{default:o(()=>[ae("取 消")]),_:1}),t(Pe,{type:"primary",loading:a.submiting,onClick:Z},{default:o(()=>[ae("确 定")]),_:1},8,["loading"])])]),default:o(()=>[i("div",fl,[t(Le,{ref_key:"editFormRef",ref:d,class:"edit-form",inline:"",model:a.editData,rules:a.rules,"label-width":"100px","label-position":"right",onKeyup:Va(Z,["enter"])},{default:o(()=>[i("div",gl,[t(pe,{label:"方案名称：",prop:"name"},{default:o(()=>[t(r,{modelValue:a.editData.name,"onUpdate:modelValue":_[0]||(_[0]=v=>a.editData.name=v),type:"text",placeholder:"请输入方案名称",maxlength:"20","show-word-limit":""},null,8,["modelValue"])]),_:1})]),i("div",hl,[t(pe,{label:"方案分组：",prop:"type"},{default:o(()=>[t(E(Ca),{modelValue:a.editData.type,"onUpdate:modelValue":_[1]||(_[1]=v=>a.editData.type=v),"tree-props":E(x),"tree-data":E(_e),"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"",onChange:E(te)},null,8,["modelValue","tree-props","tree-data","onChange"])]),_:1})]),i("div",yl,[t(pe,{label:"任务属性：",prop:"clearData"},{default:o(()=>[bl,t(D,{modelValue:a.editData.clearData,"onUpdate:modelValue":_[2]||(_[2]=v=>a.editData.clearData=v)},null,8,["modelValue"]),t(ce,{class:"item",effect:"dark",placement:"top"},{content:o(()=>[_l,vl]),default:o(()=>[t(P,{style:{"margin-left":"12px"}},{default:o(()=>[t(f)]),_:1})]),_:1})]),_:1})]),i("div",Dl,[t(pe,{label:"任务类型：",prop:"workType"},{default:o(()=>[t(Ve,{modelValue:a.editData.workType,"onUpdate:modelValue":_[3]||(_[3]=v=>a.editData.workType=v)},{default:o(()=>[t(se,{label:"SINGLE"},{default:o(()=>[ae("单次调度")]),_:1}),t(se,{label:"CYCLE"},{default:o(()=>[ae("周期调度")]),_:1})]),_:1},8,["modelValue"]),a.editData.workType==="CYCLE"?(c(),j(Pe,{key:0,size:"small",style:{"margin-left":"86px"},onClick:p},{default:o(()=>[ae(" 设置 ")]),_:1})):de("",!0)]),_:1})]),i("div",Tl,[t(pe,{label:"描述：",prop:"remark"},{default:o(()=>[t(r,{modelValue:a.editData.remark,"onUpdate:modelValue":_[4]||(_[4]=v=>a.editData.remark=v),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"]),t(y,{modelValue:W.value,"onUpdate:modelValue":_[5]||(_[5]=v=>W.value=v),class:"setting-work-type-dialog",title:"周期调度设置","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"350px",onOpen:R,onClosed:Y},{footer:o(()=>[i("span",Cl,[t(Pe,{onClick:Y},{default:o(()=>[ae("取 消")]),_:1}),t(Pe,{type:"primary",onClick:U},{default:o(()=>[ae("保 存")]),_:1})])]),default:o(()=>[i("div",Vl,[t(La,{ref_key:"workTypeFormRef",ref:ie,"hide-type":""},null,512)])]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])}}});function El(){const ke=Ye({defaultSchemeData:{name:"",type:null,remark:"",status:1,workType:"SINGLE",expression:"",clearData:!0},editSchemeData:{},schemeRules:{name:[{required:!0,message:"方案名称不能为空",trigger:["change","blur"]},{min:0,max:20,message:"长度在 20 个字符以内",trigger:["blur","change"]}],type:[{required:!0,message:"方案分组不能为空",trigger:["change"]}],workType:[{required:!0,message:"任务类型不能为空",trigger:["change"]}]},curAlgorithmItem:{name:"",catalog:""},curAlgorithmVersionLabel:"",isLoadingAlgorithmInfo:!1,paramsConfigList:[],relationsList:[],curAlgorithmType:"JOB",tableConfigList:[],curAlgorithmNodeType:0}),Ee=new Map([[0,"普通计算"],[1,"分组计算"],[2,"收集计算"],[3,"重分配计算"]]),ge=()=>ke.curAlgorithmItem,b=()=>ke.relationsList;return{...Fa(ke),getCurAlgorithmItem:ge,getRelationsList:b,nodeTypeMap:Ee}}const Sl={class:"add-work-scheme"},Nl={class:"item-wrap"},Ll={class:"item-wrap"},xl={class:"item-wrap"},Pl=i("span",{style:{"margin-right":"12px"}},"删除过程数据",-1),$l=i("div",null,"开启后，系统将自动删除任务运行过程中产生的所有数据，",-1),Ul=i("div",null,"重新运行任务只能从第一个节点开始运行",-1),Ol={class:"item-wrap"},Il={class:"item-wrap"},Al={class:"setting--dialog-content"},Rl={class:"dialog-footer"},Bl={class:"dialog-footer"},Fl=oa({__name:"SaveAsDialog",props:{visible:{type:Boolean,default:!1},copyData:{default:()=>({name:"",type:null,remark:"",clearData:!0,workTypeData:{workType:"SINGLE"}})}},emits:["update:visible","save"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=ee(),_e=ee(!1),x=ee(!1),te=ee(!1),s=ee(),V=Ye({editData:{name:"",type:null,remark:"",workType:"SINGLE",expression:"",clearData:!0,autoDependence:!1,cancelWhenFailed:!0,effectStartTime:"",effectEndTime:""},rules:{name:[{required:!0,message:"方案名称不能为空",trigger:["change","blur"]},{min:0,max:20,message:"长度在 20 个字符以内",trigger:["blur","change"]}],type:[{required:!0,message:"方案分组不能为空",trigger:["change"]}]}}),{classifyTreeData:d,treeProps:W,handleTypeChange:ie,currentEditData:le}=Pa(V.editData);Ie(()=>le,U=>{V.editData.type=U.value.type},{deep:!0}),Ie(()=>b.visible,U=>{_e.value=U});function Q(){const{copyData:{name:U,type:e,clearData:_,workTypeData:r}}=b;V.editData.name=`${U}-副本`,V.editData.remark="",V.editData.type=k.cloneDeep(e),V.editData.clearData=_??!0,V.editData.workType=r==null?void 0:r.workType,V.editData.expression=(r==null?void 0:r.expression)??"",V.editData.autoDependence=(r==null?void 0:r.autoDependence)??!1,V.editData.cancelWhenFailed=(r==null?void 0:r.cancelWhenFailed)??!0,V.editData.effectStartTime=(r==null?void 0:r.effectStartTime)??"",V.editData.effectEndTime=(r==null?void 0:r.effectEndTime)??"",Ue(()=>{var pe;(pe=a.value)==null||pe.clearValidate()})}function H(){ge("update:visible",!1)}function C(){var U;(U=a.value)==null||U.validate(e=>{if(e){const{copyData:_}=b,{name:r,type:pe,remark:D,workType:f,expression:P,clearData:ce,autoDependence:se,cancelWhenFailed:Ve,effectStartTime:Pe,effectEndTime:Le}=V.editData;if(f==="CYCLE"&&!P){oe({type:"warning",message:"请正确设置周期调度参数"});return}const y={taskInfo:{name:r,catalog:pe[W.value.label],catalogId:pe.id,remark:D,status:1,scheme:JSON.stringify(_.scheme),tableConfigList:JSON.stringify(_.tableConfigList),workType:f,expression:f==="SINGLE"?"":P,clearData:ce},userVars:_.userVars};f!=="SINGLE"&&(y.taskInfo.autoDependence=se,y.taskInfo.cancelWhenFailed=Ve,y.taskInfo.effectStartTime=Pe,Le&&(y.taskInfo.effectEndTime=Le)),x.value=!0,je.saveAsWorkScheme(y).then(v=>{x.value=!1,v.code==="0000"?(De({type:"success",title:"方案另存成功"}),H(),ge("save")):De({type:"error",title:"方案另存失败",message:v.message})}).catch(v=>{x.value=!1,De({type:"error",title:"方案另存失败",message:v.message})})}})}function Z(){te.value=!0,Ue(()=>{var e;const U={type:V.editData.workType,formData:{...V.editData}};(e=s.value)==null||e.formatData(U)})}function p(){}function R(){te.value=!1}function Y(){var U;(U=s.value)==null||U.validData().then(e=>{if(e){const{expression:_,autoDependence:r,cancelWhenFailed:pe,effectStartTime:D,effectEndTime:f}=e.formData;V.editData.expression=_,V.editData.autoDependence=r,V.editData.cancelWhenFailed=pe,V.editData.effectStartTime=D,V.editData.effectEndTime=f,R()}})}return(U,e)=>{const _=h("el-input"),r=h("el-form-item"),pe=h("el-checkbox"),D=h("QuestionFilled"),f=h("el-icon"),P=h("el-tooltip"),ce=h("el-radio"),se=h("el-radio-group"),Ve=h("el-button"),Pe=h("el-form"),Le=h("el-dialog");return c(),j(Le,{modelValue:_e.value,"onUpdate:modelValue":e[7]||(e[7]=y=>_e.value=y),class:"center-dialog",title:"另存为","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:Q,onClosed:H},{footer:o(()=>[i("span",Bl,[t(Ve,{onClick:e[6]||(e[6]=y=>_e.value=!1)},{default:o(()=>[ae("取 消")]),_:1}),t(Ve,{type:"primary",loading:x.value,onClick:C},{default:o(()=>[ae("确 定")]),_:1},8,["loading"])])]),default:o(()=>[i("div",Sl,[t(Pe,{ref_key:"editFormRef",ref:a,class:"edit-form",inline:"",model:V.editData,rules:V.rules,"label-width":"100px","label-position":"right",onKeyup:Va(C,["enter"])},{default:o(()=>[i("div",Nl,[t(r,{label:"方案名称：",prop:"name"},{default:o(()=>[t(_,{modelValue:V.editData.name,"onUpdate:modelValue":e[0]||(e[0]=y=>V.editData.name=y),type:"text",placeholder:"请输入方案名称",maxlength:"20","show-word-limit":""},null,8,["modelValue"])]),_:1})]),i("div",Ll,[t(r,{label:"方案分组：",prop:"type"},{default:o(()=>[t(E(Ca),{modelValue:V.editData.type,"onUpdate:modelValue":e[1]||(e[1]=y=>V.editData.type=y),"tree-props":E(W),"tree-data":E(d),"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"",onChange:E(ie)},null,8,["modelValue","tree-props","tree-data","onChange"])]),_:1})]),i("div",xl,[t(r,{label:"任务属性：",prop:"clearData"},{default:o(()=>[Pl,t(pe,{modelValue:V.editData.clearData,"onUpdate:modelValue":e[2]||(e[2]=y=>V.editData.clearData=y)},null,8,["modelValue"]),t(P,{class:"item",effect:"dark",placement:"top"},{content:o(()=>[$l,Ul]),default:o(()=>[t(f,{style:{"margin-left":"12px"}},{default:o(()=>[t(D)]),_:1})]),_:1})]),_:1})]),i("div",Ol,[t(r,{label:"任务类型：",prop:"workType"},{default:o(()=>[t(se,{modelValue:V.editData.workType,"onUpdate:modelValue":e[3]||(e[3]=y=>V.editData.workType=y)},{default:o(()=>[t(ce,{label:"SINGLE"},{default:o(()=>[ae("单次调度")]),_:1}),t(ce,{label:"CYCLE"},{default:o(()=>[ae("周期调度")]),_:1})]),_:1},8,["modelValue"]),V.editData.workType==="CYCLE"?(c(),j(Ve,{key:0,size:"small",style:{"margin-left":"86px"},onClick:Z},{default:o(()=>[ae(" 设置 ")]),_:1})):de("",!0)]),_:1})]),i("div",Il,[t(r,{label:"描述：",prop:"remark"},{default:o(()=>[t(_,{modelValue:V.editData.remark,"onUpdate:modelValue":e[4]||(e[4]=y=>V.editData.remark=y),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"]),t(Le,{modelValue:te.value,"onUpdate:modelValue":e[5]||(e[5]=y=>te.value=y),class:"setting-work-type-dialog",title:"周期调度设置","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"350px",onOpen:p,onClosed:R},{footer:o(()=>[i("span",Rl,[t(Ve,{onClick:R},{default:o(()=>[ae("取 消")]),_:1}),t(Ve,{type:"primary",onClick:Y},{default:o(()=>[ae("保 存")]),_:1})])]),default:o(()=>[i("div",Al,[t(La,{ref_key:"workTypeFormRef",ref:s,"hide-type":""},null,512)])]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])}}});const Ml={class:"add-custom-variable-dialog"},jl={class:"item-wrap"},ql={class:"item-wrap"},Jl={class:"item-wrap"},Gl={class:"item-wrap"},Wl={class:"item-wrap"},Xl={class:"item-wrap"},Kl={class:"dialog-footer"},Yl=oa({__name:"CustomVariableDialog",props:{visible:{type:Boolean,default:!1},dialogType:{default:Se.ADD},taskId:{default:""},curEditVarName:{default:""}},emits:["update:visible","success"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=ea("getCustomVariableList"),_e=xe(()=>(a==null?void 0:a())||[]),x=ee(),te=ee(!1),s=ee(!1);Ie(()=>b.visible,D=>{te.value=D});const V=Ma({id:"",name:"",type:"TEXT",alisaName:"",description:"",value:"",published:!0}),d=Ye({editData:{},rules:{type:[{required:!0,message:"类型不能为空",trigger:["change"]}],name:[{required:!0,message:"变量名不能为空",trigger:["change","blur"]},{validator:pe,trigger:"blur",message:"该变量名已存在"}],value:[{required:!0,message:"请正确填写变量值",trigger:["change","blur"]}]},datasourceOptions:[],layerOptions:[],datasourceData:{datasource:"",layer:""},srsOptions:[],treeProps:{label:"name",children:"children"},groupIdentify:{key:"type",value:0},templateOptions:[]});function W(){d.datasourceData.datasource="",d.datasourceData.layer="",d.datasourceOptions=[],d.layerOptions=[]}function ie(){W();const{dialogType:D,curEditVarName:f}=b;if(D===Se.ADD)d.editData=k.cloneDeep(V);else{d.editData=k.cloneDeep(_e.value.find(se=>se.name===f));for(const se in d.editData)V.hasOwnProperty(se)||delete d.editData[se];const{type:P,value:ce}=d.editData;P==="NUMBER"?d.editData.value=k.isNumber(ce)?ce:Number(ce):P==="DATASOURCE"?(C(),[d.datasourceData.datasource,d.datasourceData.layer]=ce.split(","),Y({id:ce.split(",")[0]})):P==="SRS"?U():P==="TEMPLATE"&&(d.editData.value=JSON.parse(d.editData.value),e())}Ue(()=>{var P;(P=x.value)==null||P.clearValidate()})}function le(){ge("update:visible",!1)}function Q(D){d.editData.value="",D==="NUMBER"?d.editData.value=0:D==="DATASOURCE"?(W(),C()):D==="SRS"?U():D==="TEMPLATE"&&(d.editData.value=null,e()),x.value.clearValidate(["value","name"])}function H(D){if(D=D.replace(/[`~!@#$%^&*()\-+=<>?:"{}|,./;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]|[\u4E00-\u9FA5]|[\uFE30-\uFFA0]/g,"").replace(/\s/g,""),D){const f=/[a-zA-Z]/,P=D.match(f);P?D=D.substring(P.index):D=""}return D}function C(){sa.getDataSourceList("MYSQL,ORACLE,POSTGIS,POSTGREPSQL").then(D=>{D.code==="0000"?d.datasourceOptions=D.data:(d.datasourceOptions=[],oe({type:"error",message:"获取数据库列表失败"}))}).catch(()=>{d.datasourceOptions=[],oe({type:"error",message:"获取数据库列表失败"})})}function Z(D){Y({id:D}),d.datasourceData.layer="",d.editData.value=""}function p(){const{datasource:D,layer:f}=d.datasourceData;d.editData.value=`${D},${f}`,x.value.validateField("value")}function R(){_(d.editData.value.id,D=>{D&&(d.editData.value=k.cloneDeep(D))})}function Y(D){sa.getTablesList(D).then(f=>{if(f.code==="0000"){const{success:P=!1,tables:ce=[]}=f.data;P?d.layerOptions=ce.map(se=>({value:se,label:se})):d.layerOptions=[]}else d.layerOptions=[],oe({type:"error",message:"获取表名数据失败"})}).catch(()=>{d.layerOptions=[],oe({type:"error",message:"获取表名数据失败"})})}function U(){Ka.getSrsList().then(D=>{D.code==="0000"?d.srsOptions=D.data:(d.srsOptions=[],oe({type:"error",message:"获取坐标系统失败"}))}).catch(()=>{d.srsOptions=[],oe({type:"error",message:"获取坐标系统错误"})})}function e(){sa.getTemplateTreeData().then(D=>{D.code==="0000"?d.templateOptions=D.data:(d.templateOptions=[],oe({type:"error",message:"获取模板数据失败"}))}).catch(()=>{d.templateOptions=[],oe({type:"error",message:"获取模板数据失败"})})}function _(D,f){sa.getTemplateById(D).then(P=>{P.code==="0000"?f(P.data):(oe({type:"error",message:"获取模板信息失败"}),f())}).catch(()=>{oe({type:"error",message:"获取模信息失败"}),f()})}function r(){x.value.validate(D=>{if(D){const{taskId:f,dialogType:P}=b,ce={taskId:f,...d.editData};d.editData.type==="TEMPLATE"&&(ce.value=JSON.stringify(d.editData.value)),s.value=!0;const se=P===Se.ADD?"新增":"编辑";je.addOrUpdateCustomVariable(k.cloneDeep(ce)).then(Ve=>{s.value=!1,Ve.code==="0000"?(De({type:"success",title:`${se}自定义变量成功`}),le(),ge("success",Ve.data)):De({type:"error",title:`${se}自定义变量失败`})}).catch(()=>{s.value=!1,De({type:"error",title:`${se}自定义变量失败`})})}})}function pe(D,f,P){let ce=k.cloneDeep(_e.value);if(b.dialogType===Se.EDIT&&(ce=ce.filter(Ve=>Ve.id!==d.editData.id)),ce.some(Ve=>Ve.name===f))return P(new Error);P()}return(D,f)=>{const P=h("el-option"),ce=h("el-select"),se=h("el-form-item"),Ve=h("el-input"),Pe=h("el-input-number"),Le=h("el-switch"),y=h("el-form"),v=h("el-button"),re=h("el-dialog");return c(),j(re,{modelValue:te.value,"onUpdate:modelValue":f[14]||(f[14]=S=>te.value=S),class:"center-dialog custom-variable-dialog",title:`${D.dialogType===E(Se).ADD?"新增":"编辑"}自定义变量`,"append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:ie,onClosed:le},{footer:o(()=>[i("span",Kl,[t(v,{onClick:f[13]||(f[13]=S=>te.value=!1)},{default:o(()=>[ae("取 消")]),_:1}),t(v,{type:"primary",loading:s.value,onClick:r},{default:o(()=>[ae("确 定")]),_:1},8,["loading"])])]),default:o(()=>[i("div",Ml,[t(y,{ref_key:"editFormRef",ref:x,class:"edit-form",inline:"",model:d.editData,rules:d.rules,"label-width":"100px","label-position":"right",onKeyup:Va(r,["enter"])},{default:o(()=>[i("div",jl,[t(se,{label:"类型：",prop:"type"},{default:o(()=>[t(ce,{modelValue:d.editData.type,"onUpdate:modelValue":f[0]||(f[0]=S=>d.editData.type=S),placeholder:"请选择类型",style:{width:"100%"},onChange:Q},{default:o(()=>[t(P,{label:"文本值",value:"TEXT"}),t(P,{label:"数值",value:"NUMBER"}),t(P,{label:"数据库",value:"DATASOURCE"}),t(P,{label:"模板",value:"TEMPLATE"}),t(P,{label:"坐标系",value:"SRS"}),t(P,{label:"SQL表达式",value:"SQL"}),t(P,{label:"正则表达式",value:"REGULAR"})]),_:1},8,["modelValue"])]),_:1})]),i("div",ql,[t(se,{label:"变量名：",prop:"name"},{default:o(()=>[t(Ve,{modelValue:d.editData.name,"onUpdate:modelValue":f[1]||(f[1]=S=>d.editData.name=S),type:"text",placeholder:"以英文字母开头，支持字母、数字和下划线",maxlength:"50","show-word-limit":"",onInput:f[2]||(f[2]=S=>d.editData.name=H(S))},null,8,["modelValue"])]),_:1})]),i("div",Jl,[t(se,{label:"变量别名：",prop:"alisaName"},{default:o(()=>[t(Ve,{modelValue:d.editData.alisaName,"onUpdate:modelValue":f[3]||(f[3]=S=>d.editData.alisaName=S),type:"text",placeholder:"请填写变量别名",maxlength:"30","show-word-limit":""},null,8,["modelValue"])]),_:1})]),i("div",Gl,[t(se,{label:"提示：",prop:"description"},{default:o(()=>[t(Ve,{modelValue:d.editData.description,"onUpdate:modelValue":f[4]||(f[4]=S=>d.editData.description=S),placeholder:"请输入提示"},null,8,["modelValue"])]),_:1})]),i("div",Wl,[t(se,{label:"变量值：",prop:"value"},{default:o(()=>[d.editData.type==="TEXT"?(c(),j(Ve,{key:0,modelValue:d.editData.value,"onUpdate:modelValue":f[5]||(f[5]=S=>d.editData.value=S),placeholder:"请输入变量值"},null,8,["modelValue"])):de("",!0),d.editData.type==="NUMBER"?(c(),j(Pe,{key:1,modelValue:d.editData.value,"onUpdate:modelValue":f[6]||(f[6]=S=>d.editData.value=S),style:{width:"100%"},"controls-position":"right",placeholder:"请输入数值"},null,8,["modelValue"])):de("",!0),d.editData.type==="SRS"?(c(),j(ce,{key:2,modelValue:d.editData.value,"onUpdate:modelValue":f[7]||(f[7]=S=>d.editData.value=S),style:{width:"100%"},filterable:"","allow-create":"",placeholder:"请输入或选择坐标系统"},{default:o(()=>[(c(!0),A(we,null,Me(d.srsOptions,S=>(c(),j(P,{key:S.value,label:S.label,value:S.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):de("",!0),d.editData.type==="SQL"||d.editData.type==="REGULAR"?(c(),j(Ve,{key:3,modelValue:d.editData.value,"onUpdate:modelValue":f[8]||(f[8]=S=>d.editData.value=S),type:"textarea",placeholder:"请输入",rows:4},null,8,["modelValue"])):de("",!0),d.editData.type==="TEMPLATE"?(c(),j(E(Ca),{key:4,modelValue:d.editData.value,"onUpdate:modelValue":f[9]||(f[9]=S=>d.editData.value=S),"tree-props":d.treeProps,"tree-data":d.templateOptions,"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":d.groupIdentify,onChange:R},null,8,["modelValue","tree-props","tree-data","group-identify"])):de("",!0),d.editData.type==="DATASOURCE"?(c(),j(se,{key:5,class:"innerFormItem mb",label:"数据库","label-width":"80px",prop:"datasource"},{default:o(()=>[t(ce,{modelValue:d.datasourceData.datasource,"onUpdate:modelValue":f[10]||(f[10]=S=>d.datasourceData.datasource=S),style:{width:"248px"},placeholder:"请选择",filterable:"",onChange:Z},{default:o(()=>[(c(!0),A(we,null,Me(d.datasourceOptions,S=>(c(),j(P,{key:S.value,label:S.label,value:S.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):de("",!0),d.editData.type==="DATASOURCE"?(c(),j(se,{key:6,class:"innerFormItem",label:"表名","label-width":"80px",prop:"layer"},{default:o(()=>[t(ce,{modelValue:d.datasourceData.layer,"onUpdate:modelValue":f[11]||(f[11]=S=>d.datasourceData.layer=S),style:{width:"248px"},placeholder:"请选择",filterable:"",onChange:p},{default:o(()=>[(c(!0),A(we,null,Me(d.layerOptions,S=>(c(),j(P,{key:S.value,label:S.label,value:S.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):de("",!0)]),_:1})]),i("div",Xl,[t(se,{label:"发布变量：",prop:"published"},{default:o(()=>[t(Le,{modelValue:d.editData.published,"onUpdate:modelValue":f[12]||(f[12]=S=>d.editData.published=S)},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","title"])}}});const zl={class:"my-header"},Ql={class:"run-task-dialog","element-loading-text":"正在获取运行参数..."},Hl=i("div",{class:"sub-title"},[i("span",{class:"text"},"任务信息"),i("span",{class:"line"},[i("span")])],-1),Zl={class:"item-wrap"},eo={key:1},ao={class:"sub-title"},to=i("span",{class:"text"},"参数赋值",-1),lo=i("span",{class:"line"},[i("span")],-1),oo=["title"],no={key:2},io={class:"sub-title"},so=i("span",{class:"text"},"变量赋值",-1),ro=i("span",{class:"line"},[i("span")],-1),uo=["title"],co={class:"work-type-content"},po={class:"dialog-footer"},mo=oa({__name:"RunTaskDialog",props:{visible:{type:Boolean,default:!1},dagData:{default:()=>({})},schemeData:{default:()=>({})},isFirstRun:{type:Boolean,default:!0},isService:{type:Boolean,default:!1},workTypeParams:{default:()=>({type:"SINGLE"})}},emits:["update:visible","success"],setup(ke,{emit:Ee}){const ge=Ee,b=ke;Xe("getCellData",Le),Xe("getControlInfo",Pe),Xe("getCustomVariableList",R);const a=ee(),_e=ee(),x=ee([]),te=N=>{N&&x.value.every($=>$.controlName!==N.controlName)&&x.value.push(N)};ja(()=>{x.value=[]});const s=ee(!1),V=ee(!1),d=ee(!1),W=ee(!0),ie=ee(!0),le=ee(!1),Q=ee(!1),H=xe(()=>{var N;return((N=b.workTypeParams)==null?void 0:N.type)==="CYCLE"});Ie(()=>b.visible,N=>{s.value=N});const C=Ye({editData:{name:""},rules:{name:[{required:!0,message:"任务名称不能为空",trigger:["change","blur"]},{validator:Ae,trigger:"blur",message:"该任务名称已存在"}],type:[{required:!0,message:"任务类型不能为空",trigger:["change"]}]},publishConfigList:[],cellData:[],curEditCustomVarList:[],srsOptions:[]}),Z=xe(()=>{const N=k.get(b.dagData,"dag");return N?k.cloneDeep(JSON.parse(N).cells):[]}),p=xe(()=>{const N=k.get(b.dagData,"customVarList");return N?k.cloneDeep(N):[]});Ie(()=>Z.value,N=>{const $=k.cloneDeep(N);b.isFirstRun&&$.forEach(J=>{J.customVarEnums&&J.customVarEnums instanceof Array&&(J.customVarEnums=J.customVarEnums.filter(q=>q.isUsed))}),C.cellData=k.cloneDeep($)});function R(){return p.value||[]}function Y(){Q.value=!1,d.value=!0,e(),C.publishConfigList=[],_(),W.value=!0,ie.value=!0,se(),C.curEditCustomVarList=k.cloneDeep(R()),C.curEditCustomVarList.forEach(N=>{const{type:$,value:J}=N;$==="NUMBER"&&(N.value=k.isNumber(J)?J:Number(J))}),le.value=C.curEditCustomVarList.filter(N=>N.published).length>0,b.isFirstRun&&(C.editData={name:""},Ue(()=>{var N;(N=_e.value)==null||N.clearValidate()}))}function U(){C.curEditCustomVarList=[],ge("update:visible",!1)}function e(){Ue(()=>{var N,$;b.workTypeParams.type==="SINGLE"?(N=a.value)==null||N.init():($=a.value)==null||$.formatData(b.workTypeParams)})}function _(){const N=C.cellData.filter($=>$.type==="algorithm.Element"&&$.publishParamList&&$.publishParamList.length>0);if(N.length>0){const $=Array(N.length).fill(void 0);N.forEach((q,ne)=>{$[ne]=r(q.version.id,q.id)}),Promise.all($).then(q=>{q.some(ne=>!ne)?(oe({type:"warning",message:"获取运行参数失败！请检查算法版本后重试"}),setTimeout(()=>{U()},1e3)):(d.value=!1,C.publishConfigList=k.cloneDeep(q),N.forEach(ne=>{ce(ne),C.publishConfigList.forEach(he=>{he.uid===ne.id&&(ne.publishParamList.forEach(ve=>{he.pubulishData[ve]=ne.data[ve]}),he.name=ne.name)})}),C.publishConfigList.forEach(ne=>{ne.paramsConfigList=ne.paramsConfigList.filter(he=>ne.pubulishData.hasOwnProperty(he.paramName)),ne.relations=ne.relations.filter(he=>ne.pubulishData.hasOwnProperty(he.source)&&ne.pubulishData.hasOwnProperty(he.target))}))})}else d.value=!1}function r(N,$){return new Promise((J,q)=>{je.getAlgorithmDetailInfo(N).then(ne=>{if(ne.code==="0000"){const{data:he}=ne,{name:ve,paramsConfig:u}=he;if(fa(u)){const w=JSON.parse(u),z={paramsConfigList:w.config||[],relations:w.relations||[],type:w.type||"JOB",name:ve,uid:$,pubulishData:{}};setTimeout(()=>{J(k.cloneDeep(z))},100)}else J(!1)}else J(!1)}).catch(()=>{J(!1)})})}function pe(N,$,J){const q=Le(J);q.data[$]=N,ce(q)}function D(N,$,J){const q=Le(J);q.customVarEnums.forEach(ne=>{ne.key===$&&(ne.isUsed=N)}),ce(q)}function f(N,$){C.curEditCustomVarList.forEach(J=>{J.name===$&&(J.value=N)})}function P(N,$){C.curEditCustomVarList.forEach(J=>{J.name===$&&(J.value=JSON.stringify(N))})}function ce(N){const{data:$={},requiredParamList:J=[],customVarEnums:q=[],paramTypeEnums:ne={}}=N;let he=!0;for(let ve=0,u=J.length;ve<u;ve++){if($[J[ve]]===void 0||$[J[ve]]===null||$[J[ve]]===""){const m=q.find(w=>w.key===J[ve]);if(m){if(!m.isUsed){he=!1;break}}else{he=!1;break}}if(ne[J[ve]]==="GEO_SRS")if(fa($[J[ve]])){const m=JSON.parse($[J[ve]]);if(!Array.isArray(m)||Array.isArray(m)&&m.length===0){he=!1;break}else if(m.some(w=>!(w!=null&&w.coordinateName)||!(w!=null&&w.geodeticDatum))){he=!1;break}}else{he=!1;break}}N.isPassValid=he}function se(){Ka.getSrsList().then(N=>{N.code==="0000"?C.srsOptions=N.data:(C.srsOptions=[],oe({type:"error",message:"获取坐标系统失败"}))}).catch(()=>{C.srsOptions=[],oe({type:"error",message:"获取坐标系统错误"})})}function Ve(N,$){const J=x.value.find(q=>q.controlName===N&&q.uid===$);return J||null}function Pe(N,$){const J=Ve(N,$);return J?J.allParam:null}function Le(N){return C.cellData.find($=>$.id===N)}function y(){const N=k.cloneDeep(C.cellData);return new Promise(($,J)=>{let q=!0;for(let ne=0,he=N.length;ne<he;ne++){const ve=N[ne];if(ve.type==="algorithm.Element"&&(ve.isError||!ve.isPassValid)){q=!1;break}}$(!!q)})}function v(N){return new Promise(($,J)=>{N.value?N.value.validate(q=>{$(q)}):$(!1)})}function re(){const N=k.cloneDeep(C.curEditCustomVarList);return new Promise(($,J)=>{let q=!0;for(let ne=0,he=N.length;ne<he;ne++){const ve=N[ne];if(ve.value!==0&&!ve.value){q=!1;break}}$(!!q)})}function S(){b.isFirstRun?Be():Je()}function Be(){var he;const N=v(_e),$=y(),J=re(),q=(he=a.value)==null?void 0:he.validData();Promise.all([N,$,J,q]).then(([ve,u,m,w])=>{if((!ve||!u||!m||!w)&&oe({type:"warning",message:`请正确填写 ${ve?"":"【任务信息】"}  ${u?"":"【参数赋值】"}  ${m?"":"【变量赋值】"}  ${w?"":"【调度配置】"}`}),ve&&u&&m&&w){const{workType:z,formData:me}=w,{expression:O,autoDependence:F,cancelWhenFailed:X,effectStartTime:Ce,effectEndTime:Ne}=me,{taskName:ze,taskCatalog:ya}=b.dagData,{clearData:Re,id:G=""}=b.schemeData,ha={cells:k.cloneDeep(C.cellData)},ua={name:C.editData.name,clearData:Re??!0,workType:z,expression:z==="SINGLE"?"":O,dag:JSON.stringify(ha),taskName:ze,taskCatalog:ya,customVarList:k.cloneDeep(C.curEditCustomVarList)};z!=="SINGLE"&&(ua.autoDependence=F,ua.cancelWhenFailed=X,ua.effectStartTime=Ce,Ne&&(ua.effectEndTime=Ne)),G&&(ua.taskId=G),V.value=!0,je.runTask(ua).then(wa=>{V.value=!1,wa.code==="0000"?(U(),ge("success",wa.data,z)):De({type:"error",title:"任务运行失败"})}).catch(()=>{V.value=!1,De({type:"error",title:"任务运行失败"})})}})}function Je(){const N=y(),$=re();Promise.all([N,$]).then(([q,ne])=>{if((!q||!ne)&&oe({type:"warning",message:`请正确填写 ${q?"":"【参数赋值】"}  ${ne?"":"【变量赋值】"}`}),q&&ne){const he={cells:k.cloneDeep(C.cellData)},ve=[{id:b.dagData.taskId,dag:JSON.stringify(he),customVarList:k.cloneDeep(C.curEditCustomVarList)}];V.value=!0,(b.isService?sl.republishService:Ba.rerunWorker)(ve).then(m=>{V.value=!1,m.code==="0000"?(De({type:"success",title:"任务重新运行中"}),ge("success"),U()):De({type:"error",title:"任务重新运行失败"})}).catch(()=>{V.value=!1,De({type:"error",title:"任务重新运行失败"})})}})}function Ae(N,$,J){Ba.checkname($).then(q=>{if(!q.data)return J(new Error);J()})}Xe("getCellById",da);function da(N){var J;const $=(J=C.cellData)==null?void 0:J.find(q=>q.id===N);return $?{attributes:$}:{}}return(N,$)=>{const J=h("el-input"),q=h("el-form-item"),ne=h("el-form"),he=h("el-icon"),ve=h("el-input-number"),u=h("el-option"),m=h("el-select"),w=h("el-button"),z=h("el-dialog"),me=Ta("loading");return c(),j(z,{modelValue:s.value,"onUpdate:modelValue":$[6]||($[6]=O=>s.value=O),class:"task-dialog",title:(N.isFirstRun?"":"重新")+"运行任务","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,top:"8vh",width:"580px",onOpen:Y,onClosed:U},{header:o(()=>[i("div",zl,[i("div",{class:He(["label-box",{active:!Q.value}]),onClick:$[0]||($[0]=va(O=>Q.value=!1,["stop"]))},Oe((N.isFirstRun?"":"重新")+"运行任务信息"),3),H.value?(c(),A("div",{key:0,class:He(["label-box",{active:Q.value}]),onClick:$[1]||($[1]=va(O=>Q.value=!0,["stop"]))}," 任务调度属性 ",2)):de("",!0)])]),footer:o(()=>[i("span",po,[t(w,{disabled:d.value,onClick:$[5]||($[5]=O=>s.value=!1)},{default:o(()=>[ae("取 消")]),_:1},8,["disabled"]),t(w,{type:"primary",loading:V.value,disabled:d.value,onClick:S},{default:o(()=>[ae(" 确 定 ")]),_:1},8,["loading","disabled"])])]),default:o(()=>[Fe((c(),A("div",Ql,[N.isFirstRun?(c(),j(ne,{key:0,ref_key:"editFormRef",ref:_e,class:"edit-form",inline:"",model:C.editData,rules:C.rules,"label-width":"150px","label-position":"right",onKeyup:Va(S,["enter"])},{default:o(()=>[Hl,i("div",Zl,[t(q,{label:"任务名称：",prop:"name"},{default:o(()=>[t(J,{modelValue:C.editData.name,"onUpdate:modelValue":$[2]||($[2]=O=>C.editData.name=O),type:"text",placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])):de("",!0),C.publishConfigList.length>0?(c(),A("div",eo,[i("div",ao,[to,i("span",{class:"icon",onClick:$[3]||($[3]=O=>W.value=!W.value)},[W.value?(c(),j(he,{key:0},{default:o(()=>[t(E(Aa))]),_:1})):(c(),j(he,{key:1},{default:o(()=>[t(E(Ra))]),_:1}))]),lo]),i("div",{class:He(["publish-main-box",W.value?"height-full":"height-none"])},[(c(!0),A(we,null,Me(C.publishConfigList,O=>(c(),A("div",{key:O.uid,class:"publish-form-box"},[i("div",{class:"p-title",title:O.name},Oe(O.name),9,oo),t(ne,{class:"publish-params-form",inline:"",model:O.pubulishData,"label-width":"100px","label-position":"right"},{default:o(()=>[(c(!0),A(we,null,Me(O.paramsConfigList,(F,X)=>(c(),A("div",{key:F.paramName,class:"item-wrap"},[(c(),j(q,{key:F.paramName+X,prop:F.paramName,"label-width":F.controlType==="CHECK_BOX_XX"?"":"150px",label:F.paramLabel+"：",required:F.required,rules:{required:F.required,message:`${F.paramLabel}不能为空`}},{default:o(()=>[t(tl,{ref_for:!0,ref:te,modelValue:O.pubulishData[F.paramName],"onUpdate:modelValue":Ce=>O.pubulishData[F.paramName]=Ce,"control-name":F.paramName,uid:O.uid,type:O.type,"all-param":F,relations:O.relations,onChange:pe,onChangeCustomVar:D},null,8,["modelValue","onUpdate:modelValue","control-name","uid","type","all-param","relations"])]),_:2},1032,["prop","label-width","label","required","rules"]))]))),128))]),_:2},1032,["model"])]))),128))],2)])):de("",!0),le.value?(c(),A("div",no,[i("div",io,[so,i("span",{class:"icon",onClick:$[4]||($[4]=O=>ie.value=!ie.value)},[ie.value?(c(),j(he,{key:0},{default:o(()=>[t(E(Aa))]),_:1})):(c(),j(he,{key:1},{default:o(()=>[t(E(Ra))]),_:1}))]),ro]),i("div",{class:He(["custom-var-main-box",ie.value?"height-full":"height-none"])},[t(ne,{class:"publish-params-form",inline:"","label-width":"100px","label-position":"right"},{default:o(()=>[(c(!0),A(we,null,Me(C.curEditCustomVarList,O=>(c(),A(we,null,[O.published?(c(),A("div",{key:O.id,class:"item-wrap"},[t(q,{"label-width":"150px"},{label:o(()=>[i("span",{class:He({labelBox:!0,isRequired:!0}),title:O.alisaName||O.name},Oe((O.alisaName||O.name)+"："),9,uo)]),default:o(()=>[O.type==="TEXT"?(c(),j(J,{key:0,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,type:"text",placeholder:"请输入变量值"},null,8,["modelValue","onUpdate:modelValue"])):O.type==="NUMBER"?(c(),j(ve,{key:1,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,style:{width:"100%"},"controls-position":"right",placeholder:"请输入数值"},null,8,["modelValue","onUpdate:modelValue"])):O.type==="SQL"||O.type==="REGULAR"?(c(),j(J,{key:2,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,type:"textarea",style:{width:"100%"},placeholder:"请输入",rows:4},null,8,["modelValue","onUpdate:modelValue"])):O.type==="SRS"?(c(),j(m,{key:3,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,style:{width:"100%"},filterable:"","allow-create":"",placeholder:"请输入或选择坐标系统"},{default:o(()=>[(c(!0),A(we,null,Me(C.srsOptions,F=>(c(),j(u,{key:F.value,label:F.label,value:F.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):O.type==="DATASOURCE"?(c(),j(ll,{key:4,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,"control-name":O.name,onChange:f},null,8,["modelValue","onUpdate:modelValue","control-name"])):O.type==="TEMPLATE"?(c(),j(ol,{key:5,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,"control-name":O.name,onChange:P},null,8,["modelValue","onUpdate:modelValue","control-name"])):(c(),j(J,{key:6,modelValue:O.value,"onUpdate:modelValue":F=>O.value=F,type:"text"},null,8,["modelValue","onUpdate:modelValue"]))]),_:2},1024)])):de("",!0)],64))),256))]),_:1})],2)])):de("",!0)])),[[Da,!Q.value],[me,d.value]]),Fe(i("div",co,[t(La,{ref_key:"workTypeFormRef",ref:a,"hide-type":""},null,512)],512),[[Da,Q.value]])]),_:1},8,["modelValue","title"])}}});function ka(ke){const ge=qa()["control-name"],b=["INPUT_BOX","INPUT_TEXTAREA","SELECT_TREE"],a=ea("getCurAlgorithmItem"),_e=ea("getRelationsList"),x=ea("getCellById"),te=ea("getNeighbors"),s=ea("getTableConfigList"),V=ea("getControlInfoByName"),d=ea("getCurAlgorithmType"),W=ea("getParamsConfigList"),ie=ea("getControlByName"),le=ea("getCustomVariableList"),Q=xe(()=>(a==null?void 0:a())||{}),H=xe(()=>{var _;return(x==null?void 0:x((_=Q.value)==null?void 0:_.curId))||null}),C=xe(()=>H.value.get("data")),Z=xe(()=>H.value?H.value.get("customVarEnums")||[]:[]),p=xe(()=>{const _=Z.value.find(r=>r.key===ge);return _?_.isUsed:!1}),R=xe(()=>d==null?void 0:d()),Y=xe(()=>le==null?void 0:le()),U=xe(()=>ke.allParam?b.includes(ke.allParam.controlType)?"control-main-box control-flex-box":"control-main-box":""),e=xe(()=>{if(!ke.allParam)return!1;const{controlType:_}=ke.allParam;return!!b.includes(_)});return{getCurAlgorithmItem:a,getRelationsList:_e,getCellById:x,getNeighbors:te,getTableConfigList:s,getControlInfoByName:V,getCurAlgorithmType:d,getParamsConfigList:W,getControlByName:ie,getCustomVariableList:le,curAlgorithmItem:Q,curCell:H,curCellData:C,curCustomVarEnums:Z,isUseCustomVal:p,curAlgorithmType:R,customVariableList:Y,controlClassName:U,includesCustomVarConfig:e}}const fo={class:"table-operate-container"},go={class:"dialog-footer"},ho=oa({__name:"AddTableControl",props:{initData:{default:()=>[]},controlName:{default:""}},emits:["changeTable"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=Ye({tableColumn:[],dialogVisible:!1,inputTableColumn:[],colDatas:[],tempTableColumn:[]}),{curCell:_e,getRelationsList:x,getControlByName:te}=ka({}),s=xe(()=>{var Z;return(Z=_e.value)==null?void 0:Z.get("data")}),V=xe(()=>a.inputTableColumn.length===0);Ie(()=>b.initData,Z=>{d()}),Ie(()=>s.value,Z=>{if(Z){const R=(x==null?void 0:x()).find(Y=>Y.source===b.controlName);R?setTimeout(()=>{const Y=te==null?void 0:te(R.target);if(Y?a.inputTableColumn=k.cloneDeep(Y.getInputTableColumn()):a.inputTableColumn=[],a.inputTableColumn.length>0){a.colDatas=[];for(const U in a.inputTableColumn[0])a.colDatas.push({prop:U,label:U})}else a.colDatas=[]},0):a.inputTableColumn=[]}else a.inputTableColumn=[]},{deep:!0}),ga(()=>{d()});function d(){Ue(()=>{a.tableColumn=k.cloneDeep(b.initData)})}function W(){a.tempTableColumn=k.cloneDeep(a.tableColumn),a.dialogVisible=!0}function ie(){const Z={colName:"",description:"",length:"",nullable:"false",primaryKey:"false",type:"varchar"};a.tableColumn.push(Z)}function le(Z){a.tableColumn=a.tableColumn.filter((p,R)=>R!==Z)}function Q(){a.dialogVisible=!1,a.tableColumn=k.cloneDeep(a.tempTableColumn),C()}function H(){const Z=a.inputTableColumn.concat(a.tableColumn);if(a.tableColumn.some(R=>R.colName==="")){ra.alert("存在colName值为空，请检查修改后再提交","提示",{confirmButtonText:"确定",type:"warning"});return}const p=k.uniqBy(Z,"colName");if(Z.length!==p.length){ra.alert("存在重复的colName值，请检查修改后再提交","提示",{confirmButtonText:"确定",type:"warning"});return}a.dialogVisible=!1,C()}function C(){const Z=a.inputTableColumn.concat(a.tableColumn);ge("changeTable",a.tableColumn,Z)}return(Z,p)=>{const R=h("el-button"),Y=h("el-input"),U=h("el-option"),e=h("el-select"),_=h("el-table-column"),r=h("el-table"),pe=h("el-dialog");return c(),A("div",null,[t(R,{style:{width:"100%"},disabled:V.value,onClick:W},{default:o(()=>[ae(" 点击新增字段 ")]),_:1},8,["disabled"]),t(pe,{modelValue:a.dialogVisible,"onUpdate:modelValue":p[0]||(p[0]=D=>a.dialogVisible=D),title:"新增字段","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"90%",class:"center-dialog","before-close":Q},{footer:o(()=>[i("span",go,[t(R,{onClick:Q},{default:o(()=>[ae("取 消")]),_:1}),t(R,{type:"primary",onClick:H},{default:o(()=>[ae("确 定")]),_:1})])]),default:o(()=>[i("div",fo,[i("div",null,[i("div",null,[t(R,{type:"primary",text:"",onClick:ie},{default:o(()=>[ae("添加")]),_:1})]),t(r,{ref:"table",class:"modify-table-column",height:500,data:a.tableColumn,border:""},{default:o(()=>[(c(!0),A(we,null,Me(a.colDatas,D=>(c(),j(_,{key:D.prop,prop:D.prop,label:D.label,align:"center","label-class-name":"header-label"},{default:o(f=>[D.prop==="colName"||D.prop==="description"?(c(),j(Y,{key:0,ref_for:!0,ref:"edit-input",modelValue:f.row[D.prop],"onUpdate:modelValue":P=>f.row[D.prop]=P,placeholder:`请输入${f.column.label}`},null,8,["modelValue","onUpdate:modelValue","placeholder"])):de("",!0),D.prop==="length"?(c(),j(Y,{key:1,modelValue:f.row[D.prop],"onUpdate:modelValue":P=>f.row[D.prop]=P,type:"text",placeholder:`请输入${f.column.label}`,oninput:"value=value.replace(/^\\.+|[^\\d.]/g,'')"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):de("",!0),D.prop==="nullable"||D.prop==="primaryKey"?(c(),j(e,{key:2,modelValue:f.row[D.prop],"onUpdate:modelValue":P=>f.row[D.prop]=P,placeholder:"请选择"},{default:o(()=>[t(U,{label:"true",value:"true"}),t(U,{label:"false",value:"false"})]),_:2},1032,["modelValue","onUpdate:modelValue"])):de("",!0),D.prop==="type"?(c(),j(e,{key:3,modelValue:f.row[D.prop],"onUpdate:modelValue":P=>f.row[D.prop]=P,placeholder:"请选择"},{default:o(()=>[t(U,{label:"varchar",value:"varchar"}),t(U,{label:"int",value:"int"}),t(U,{label:"float",value:"float"}),t(U,{label:"date",value:"date"}),t(U,{label:"timestamp",value:"timestamp"}),t(U,{label:"numeric",value:"numeric"}),t(U,{label:"bool",value:"bool"}),t(U,{label:"time",value:"time"})]),_:2},1032,["modelValue","onUpdate:modelValue"])):de("",!0)]),_:2},1032,["prop","label"]))),128)),t(_,{width:"100px",label:"操作",align:"center","class-name":"tableOperate"},{default:o(D=>[t(R,{type:"danger",plain:"",onClick:f=>le(D.$index)},{default:o(()=>[ae("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])])])]),_:1},8,["modelValue"])])}}}),yo={class:"dag-delete-control"},bo={class:"table-operate-container"},_o=i("div",{class:"tip"},"请勾选需要删除的字段",-1),vo={class:"dialog-footer"},Do=oa({__name:"DelTableControl",props:{initData:{default:()=>[]},controlName:{default:""}},emits:["changeTable"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=Ye({deleteNameList:[],tableColumn:[],dialogVisible:!1,inputTableColumn:[],colDatas:[],tempDeleteNameList:[]}),{curCell:_e,getRelationsList:x,getControlByName:te}=ka({}),s=xe(()=>{var C;return(C=_e.value)==null?void 0:C.get("data")}),V=xe(()=>a.inputTableColumn.length===0);Ie(()=>b.initData,()=>{d()}),Ie(()=>s.value,C=>{if(C){const p=(x==null?void 0:x()).find(R=>R.source===b.controlName);p?setTimeout(()=>{const R=te==null?void 0:te(p.target);if(R?a.inputTableColumn=k.cloneDeep(R.getInputTableColumn()):a.inputTableColumn=[],a.inputTableColumn.length>0){a.colDatas=[];for(const Y in a.inputTableColumn[0])a.colDatas.push({prop:Y,label:Y})}else a.colDatas=[]},0):a.inputTableColumn=[]}else a.inputTableColumn=[]},{deep:!0}),ga(()=>{d()});function d(){Ue(()=>{a.deleteNameList=k.cloneDeep(b.initData)})}function W(){a.tempDeleteNameList=k.cloneDeep(a.deleteNameList),a.tableColumn=k.cloneDeep(a.inputTableColumn),a.tableColumn.forEach(C=>{C.isDelete=a.deleteNameList.includes(C.colName)}),a.dialogVisible=!0}function ie(C,Z){a.tableColumn.forEach(p=>{p.colName===Z&&(p.isDelete=C)}),a.tableColumn.splice(a.tableColumn.length)}function le(){a.dialogVisible=!1,a.deleteNameList=k.cloneDeep(a.tempDeleteNameList),H()}function Q(){a.dialogVisible=!1,a.deleteNameList=a.tableColumn.filter(C=>C.isDelete).map(C=>C.colName),H()}function H(){const C=a.inputTableColumn.filter(Z=>a.deleteNameList.every(p=>p!==Z.colName));ge("changeTable",a.deleteNameList,C)}return(C,Z)=>{const p=h("el-button"),R=h("el-table-column"),Y=h("el-checkbox"),U=h("el-table"),e=h("el-dialog");return c(),A("div",yo,[t(p,{style:{width:"100%"},disabled:V.value,onClick:W},{default:o(()=>[ae(" 点击删除字段 ")]),_:1},8,["disabled"]),t(e,{modelValue:a.dialogVisible,"onUpdate:modelValue":Z[0]||(Z[0]=_=>a.dialogVisible=_),title:"删除字段","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"90%",class:"center-dialog","before-close":le},{footer:o(()=>[i("span",vo,[t(p,{onClick:le},{default:o(()=>[ae("取 消")]),_:1}),t(p,{type:"primary",onClick:Q},{default:o(()=>[ae("确 定")]),_:1})])]),default:o(()=>[i("div",bo,[i("div",null,[_o,t(U,{ref:"table",class:"modify-table-column",height:500,data:a.tableColumn,border:""},{default:o(()=>[(c(!0),A(we,null,Me(a.colDatas,_=>(c(),j(R,{key:_.prop,prop:_.prop,label:_.label,align:"center","label-class-name":"header-label"},null,8,["prop","label"]))),128)),t(R,{width:"100px",label:"勾选",align:"center","class-name":"tableOperate"},{default:o(_=>[t(Y,{modelValue:_.row.isDelete,"onUpdate:modelValue":r=>_.row.isDelete=r,onChange:r=>ie(_.row.isDelete,_.row.colName)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])])])]),_:1},8,["modelValue"])])}}});const To={class:"dag-delete-control"},Vo={class:"table-operate-container sql-operate"},Co={class:"list"},ko=i("div",{class:"title"},"colName：",-1),wo={class:"item-content"},Eo={class:"sql"},So=i("div",{class:"title"},"SQL表达式：",-1),No={class:"textarea"},Lo={class:"dialog-footer"},xo=oa({__name:"FilterTableControl",props:{initData:{default:()=>[]},controlName:{default:""}},emits:["changeSql"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=Ye({filterSql:"",tableColumn:[],dialogVisible:!1,inputTableColumn:[],tempFilterSql:""}),{curCell:_e,getRelationsList:x,getControlByName:te}=ka({}),s=xe(()=>{var H;return(H=_e.value)==null?void 0:H.get("data")}),V=xe(()=>a.inputTableColumn.length===0);Ie(()=>b.initData,()=>{d()}),Ie(()=>s.value,H=>{if(H){const Z=(x==null?void 0:x()).find(p=>p.source===b.controlName);Z?setTimeout(()=>{const p=te==null?void 0:te(Z.target);p?a.inputTableColumn=k.cloneDeep(p.getInputTableColumn()):a.inputTableColumn=[]},0):a.inputTableColumn=[]}else a.inputTableColumn=[]},{deep:!0}),ga(()=>{d()});function d(){Ue(()=>{a.filterSql=k.cloneDeep(b.initData)})}function W(){a.tempFilterSql=k.cloneDeep(a.filterSql),a.dialogVisible=!0}function ie(){a.dialogVisible=!1,a.filterSql=k.cloneDeep(a.tempFilterSql)}function le(){a.dialogVisible=!1,Q()}function Q(){ge("changeSql",a.filterSql)}return(H,C)=>{const Z=h("el-button"),p=h("el-input"),R=h("el-dialog");return c(),A("div",To,[t(Z,{style:{width:"100%"},disabled:V.value,onClick:W},{default:o(()=>[ae(" 点击数据过滤 ")]),_:1},8,["disabled"]),t(R,{modelValue:a.dialogVisible,"onUpdate:modelValue":C[1]||(C[1]=Y=>a.dialogVisible=Y),title:"数据过滤","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"900px",class:"center-dialog","before-close":ie},{footer:o(()=>[i("span",Lo,[t(Z,{onClick:ie},{default:o(()=>[ae("取 消")]),_:1}),t(Z,{type:"primary",onClick:le},{default:o(()=>[ae("确 定")]),_:1})])]),default:o(()=>[i("div",Vo,[i("div",Co,[ko,i("div",wo,[(c(!0),A(we,null,Me(a.inputTableColumn,Y=>(c(),A("div",{key:Y.colName,class:"item"},Oe(Y.colName),1))),128))])]),i("div",Eo,[So,i("div",No,[t(p,{modelValue:a.filterSql,"onUpdate:modelValue":C[0]||(C[0]=Y=>a.filterSql=Y),type:"textarea",autosize:{minRows:8},placeholder:"请输入表达式"},null,8,["modelValue"])])])])]),_:1},8,["modelValue"])])}}});const Po={class:"dag-delete-control"},$o={class:"table-operate-container mapping-operate"},Uo=i("span",null," • ------------------ • ",-1),Oo={class:"dialog-footer"},Io=oa({__name:"MappingTableControl",props:{initData:{default:()=>[]},controlName:{default:""}},emits:["changeMap"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=Ye({mappingData:[],tableColumn:[],dialogVisible:!1,inputTableColumn:[],sourceValue:"",sourceType:"",targetValue:"",targetType:"",tableData:[],sourceTreeData:[],treeProps:{label:"title",children:"children"},groupIdentify:{key:"type",value:0}}),{curCell:_e,getRelationsList:x,getControlByName:te,getCellById:s}=ka({}),V=xe(()=>{var U;return(U=_e.value)==null?void 0:U.get("data")}),d=xe(()=>!a.sourceValue||!a.targetValue);Ie(()=>b.initData,()=>{W()}),Ie(()=>V.value,U=>{var e,_,r;if(((e=_e.value)==null?void 0:e.get("paramTypeEnums")[b.controlName])==="MAPPING"&&U){const D=(x==null?void 0:x()).find(f=>f.source===b.controlName);if(D){const f=D.target.split(",");if(f.length===2){const P=U[f[0]];((_=P==null?void 0:P.split(","))==null?void 0:_.length)===2&&ie(P);const ce=U[f[1]];((r=ce==null?void 0:ce.split(","))==null?void 0:r.length)===2&&le(ce)}setTimeout(()=>{const P=te==null?void 0:te(D.target);P?a.inputTableColumn=k.cloneDeep(P.getInputTableColumn()):a.inputTableColumn=[]},0)}}},{deep:!0}),ga(()=>{W()});function W(){Ue(()=>{a.mappingData=k.cloneDeep(b.initData)})}function ie(U){const[e,_]=U.split(","),r=s==null?void 0:s(e),pe=r==null?void 0:r.get("ioRelation");let D="";if(Object.keys(pe).length!==0)for(const[f,P]of Object.entries(pe))P===_&&(D=f);a.sourceValue=r==null?void 0:r.get("data")[D],a.sourceType=r==null?void 0:r.get("paramTypeEnums")[D]}function le(U){const[e,_]=U.split(","),r=s==null?void 0:s(e),pe=r==null?void 0:r.get("ioRelation");let D="";if(Object.keys(pe).length!==0)for(const[f,P]of Object.entries(pe))P===_&&(D=f);a.targetValue=r==null?void 0:r.get("data")[D],a.targetType=r==null?void 0:r.get("paramTypeEnums")[D]}function Q(){if(a.targetType==="TEMPLATE"){const U=JSON.parse(a.targetValue),e=k.cloneDeep((U==null?void 0:U.templateDataFieldList)||[]);e.forEach(_=>{_.sourceValueObj=null}),a.tableData=k.cloneDeep(e),a.mappingData.forEach(_=>{a.tableData.forEach(r=>{r.name===_.target&&(r.sourceValueObj={id:_.source,title:_.source})})})}a.sourceType==="TEXT"&&H(),a.dialogVisible=!0}function H(){sa.getRestApiJsonTree(a.sourceValue).then(U=>{U.code==="0000"?a.sourceTreeData=U.data:a.sourceTreeData=[]}).catch(()=>{a.sourceTreeData=[]})}function C(U){return Ht[U.type]}function Z(){a.dialogVisible=!1}function p(){const e=a.tableData.filter(_=>_.sourceValueObj).map(_=>({source:_.sourceValueObj.title,target:_.name}));R(e),a.dialogVisible=!1}function R(U){ge("changeMap",U)}function Y(){}return(U,e)=>{const _=h("el-button"),r=h("el-table-column"),pe=h("el-table"),D=h("el-dialog");return c(),A("div",Po,[t(_,{style:{width:"100%"},disabled:d.value,onClick:Q},{default:o(()=>[ae(" 设置映射关系 ")]),_:1},8,["disabled"]),t(D,{modelValue:a.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=f=>a.dialogVisible=f),title:"字段映射","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"1200px",class:"center-dialog","before-close":Z},{footer:o(()=>[i("span",Oo,[t(_,{onClick:Z},{default:o(()=>[ae("取 消")]),_:1}),t(_,{type:"primary",onClick:p},{default:o(()=>[ae("确 定")]),_:1})])]),default:o(()=>[i("div",$o,[t(pe,{data:a.tableData,style:{width:"100%"}},{default:o(()=>[t(r,{prop:"sourceValueObj",align:"center",label:"源字段"},{default:o(f=>[t(E(Ca),{modelValue:f.row.sourceValueObj,"onUpdate:modelValue":P=>f.row.sourceValueObj=P,"tree-props":a.treeProps,"tree-data":a.sourceTreeData,"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",filterable:"",clearable:"","only-click-child":"","group-identify":a.groupIdentify,onChange:Y},null,8,["modelValue","onUpdate:modelValue","tree-props","tree-data","group-identify"])]),_:1}),t(r,{align:"center",width:"280"},{default:o(()=>[Uo]),_:1}),t(r,{type:"index",align:"center",label:"序号",width:"80"}),t(r,{prop:"name",align:"center",label:"目标字段",width:"180"}),t(r,{prop:"aliasName",align:"center",label:"中文名称",width:"180"}),t(r,{prop:"type",align:"center",label:"数据类型",width:"180"},{default:o(f=>[i("span",null,Oe(C(f.row)),1)]),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"])])}}});const Ao={class:"flex-item"},Ro=i("span",{class:"label-name"},"fx",-1),Bo={class:"flex-item"},Fo=i("span",{class:"label-name"},"数据库",-1),Mo={class:"flex-item"},jo=i("span",{class:"label-name"},"表名",-1),qo={key:0,class:"flex-item"},Jo=i("span",{class:"label-name"},"字段名",-1),Go={key:1,style:{width:"210px"}},Wo={style:{"margin-left":"10px"}},Xo={key:0,style:{"overflow-wrap":"break-word"}},Ko={style:{width:"100%","margin-bottom":"8px"}},Yo={class:"custom-var-btn"},zo={class:"custom-var-btn"},Qo=oa({__name:"ControlTemplate",props:{modelValue:{},allParam:{default:()=>({})},isTesting:{type:Boolean,default:!1}},emits:["change","updateTable","changeConfig"],setup(ke,{expose:Ee,emit:ge}){const b=ge,a=ke,_e=qa(),x=ee(),te=ee(),s=_e["control-name"],{curAlgorithmItem:V,curAlgorithmType:d,curCell:W,isUseCustomVal:ie,curCustomVarEnums:le,controlClassName:Q,customVariableList:H,includesCustomVarConfig:C,getRelationsList:Z,getControlByName:p,getParamsConfigList:R,getNeighbors:Y,getTableConfigList:U}=ka(a);Xe("$uid",xe(()=>V.value.curId));const e=Ye({options:[],cascaderKey:1,bindValue:"",dataSourceValue:"",layerValue:"",fieldValue:"",enumValue:"",layerOptions:[],treeProps:{label:"name",children:"children"},groupIdentify:{},tableColumn:[],inputTableColumn:[],customBindValue:"",showCustomSelect:!1,includesCustomVarList:["INPUT_BOX","INPUT_TEXTAREA","SELECT_TREE"]});a.allParam.controlType==="SELECT_TREE"?e.bindValue={}:a.allParam.paramTypeEnums==="NUMBER"&&(e.bindValue=0),Ie(()=>a.modelValue,()=>{_()});function _(){const{controlType:u,paramTypeEnums:m,dataSourceItems:w=[],multiple:z,editable:me,requestUrl:O="",paramLabel:F}=a.allParam;if(u==="SELECT"&&(m==="TEXT"||m==="NUMBER")?e.bindValue="":e.bindValue=k.cloneDeep(a.modelValue),u==="DATASOURCE"?r(()=>{if(typeof a.modelValue!="string")e.dataSourceValue="",e.layerValue="";else{const X=a.modelValue.split(",");X.length===1?(e.dataSourceValue="",e.layerValue=""):([e.dataSourceValue,e.layerValue]=X,se())}Ve()}):u==="SELECT"&&m==="DATASOURCE"?(e.bindValue="",r(()=>{z?(a.modelValue?typeof a.modelValue=="string"?e.bindValue=a.modelValue.split(",").filter(X=>X):e.bindValue=[]:e.bindValue=[],me||(e.bindValue=e.bindValue.filter(X=>e.options.some(Ce=>Ce.value===X)))):typeof a.modelValue!="string"?e.bindValue="":(e.bindValue=k.cloneDeep(a.modelValue),me||e.options.every(X=>X.value!==e.bindValue)&&(e.bindValue=""))})):u==="SELECT"&&(m==="TEXT"||m==="NUMBER")?pe(O,w,F).then(Ce=>{e.options=k.cloneDeep(Ce),e.bindValue=k.cloneDeep(a.modelValue),z?(a.modelValue?typeof a.modelValue=="string"?e.bindValue=a.modelValue.split(",").filter(Ne=>Ne):e.bindValue=[]:e.bindValue=[],me||(e.bindValue=e.bindValue.filter(Ne=>e.options.some(ze=>ze.value===Ne)))):m!=="NUMBER"&&typeof a.modelValue!="string"?e.bindValue="":me||e.options.every(Ne=>Ne.value!==e.bindValue)&&(e.bindValue="")}):u==="SELECT"&&m==="FIELD"?setTimeout(()=>{const Ce=(Z==null?void 0:Z()).find(Ne=>Ne.source===s);if(Ce){const Ne=p==null?void 0:p(Ce.target);Ne&&(e.options=k.cloneDeep(Ne.getInputTableColumn()).map(ze=>({label:ze.colName,value:ze.colName})))}z?(a.modelValue?typeof a.modelValue=="string"?e.bindValue=a.modelValue.split(",").filter(Ne=>Ne):e.bindValue=[]:e.bindValue=[],me||(e.bindValue=e.bindValue.filter(Ne=>e.options.some(ze=>ze.value===Ne)))):typeof a.modelValue!="string"?e.bindValue="":me||e.options.every(Ne=>Ne.value!==e.bindValue)&&(e.bindValue="")},30):u==="SELECT_TREE"&&m==="TEMPLATE"?(e.groupIdentify={key:"type",value:0},e.options=[],a.modelValue&&fa(a.modelValue)?e.bindValue=JSON.parse(a.modelValue):e.bindValue={},v()):u==="CASCADER"?(++e.cascaderKey,e.options=[],a.modelValue?typeof a.modelValue=="string"?e.bindValue=a.modelValue.split(",").filter(X=>X):e.bindValue=[]:e.bindValue=[],S(!0)):u==="TABLE"?d.value==="COLUMNS_ADD"||d.value==="COLUMNS_DEL"||m==="MAPPING"?a.modelValue?fa(a.modelValue)?e.bindValue=JSON.parse(a.modelValue):e.bindValue=[]:e.bindValue=[]:d.value==="FILTER_SQL"&&(a.modelValue?typeof a.modelValue!="string"&&(e.bindValue=""):e.bindValue=""):u==="INPUT_BOX"&&m==="GATEWAY"&&Je(xt),ie.value){const X=le.value.find(Ce=>Ce.key===s);e.customBindValue=X?X.id:"",e.showCustomSelect=X.isUsed}else e.customBindValue="",e.showCustomSelect=!1;Be()}function r(u){sa.getDataSourceList("MYSQL,ORACLE,POSTGIS,POSTGREPSQL").then(m=>{m.code==="0000"?(e.options=m.data,u&&u()):(e.options=[],u&&u(),oe({type:"error",message:"获取数据库数据失败"}))}).catch(()=>{e.options=[],u&&u(),oe({type:"error",message:"获取数据库数据失败"})})}function pe(u,m,w){return new Promise(z=>{u?sa.getDataByUrl(u).then(me=>{var O,F;me.code==="0000"?Array.isArray(me==null?void 0:me.data)&&((O=me.data[0])!=null&&O.label)&&((F=me.data[0])!=null&&F.value)?z(me.data):z([]):(z([]),oe({type:"error",message:`获取 " ${w} " 下拉选项数据失败`}))}).catch(()=>{z([]),oe({type:"error",message:`获取 " ${w} " 下拉选项数据失败`})}):z(m)})}function D(u){if(u){const m=k.cloneDeep(H.value.find(w=>w.id===u));m.isUsed=!0,b("change","",s,!0,m)}else b("change","",s,!0)}function f(){e.layerValue="",b("change","",s),se()}function P(){const u=`${e.dataSourceValue},${e.layerValue}`;b("change",u,s),Ve()}function ce(){const u=`${e.dataSourceValue},${e.layerValue},${e.fieldValue}`;b("change",u,s)}function se(){sa.getTablesList({id:e.dataSourceValue}).then(u=>{if(u.code==="0000"){const{success:m=!1,tables:w=[]}=u.data;m?e.layerOptions=w.map(z=>({value:z,label:z})):e.layerOptions=[]}else e.layerOptions=[],oe({type:"error",message:"获取表数据失败"})}).catch(()=>{e.layerOptions=[],oe({type:"error",message:"获取表数据失败"})})}function Ve(){if(e.layerValue&&e.dataSourceValue)Pe(e.dataSourceValue,e.layerValue);else if(e.customBindValue){const u=k.cloneDeep(H.value.find(m=>m.id===e.customBindValue));if(u&&u.type==="DATASOURCE")if(typeof u.value!="string")e.tableColumn=[],Le();else{const m=u.value.split(",");m.length===1?(e.tableColumn=[],Le()):Pe(m[0],m[1])}else e.tableColumn=[],Le()}}function Pe(u,m){sa.getTableColumnsInfo({id:u,tableName:m}).then(w=>{w.code==="0000"?e.tableColumn=w.data:(e.tableColumn=[],oe({type:"error",message:"获取表结构失败"})),Le()}).catch(()=>{e.tableColumn=[],oe({type:"error",message:"获取表结构失败"}),Le()})}function Le(){const m={name:y(),table:e.tableColumn};b("updateTable",V.value.curId,m)}function y(){const u=R==null?void 0:R().find(m=>m.paramDirection==="OUTPUT");return u?u.paramName:null}function v(){sa.getTemplateTreeData().then(u=>{u.code==="0000"?e.options=u.data:(e.options=[],oe({type:"error",message:"获取模板数据失败"}))}).catch(()=>{e.options=[],oe({type:"error",message:"获取模板数据失败"})})}function re(u,m){sa.getTemplateById(u).then(w=>{w.code==="0000"?m(w.data):(oe({type:"error",message:"获取模板信息失败"}),m())}).catch(()=>{oe({type:"error",message:"获取模信息失败"}),m()})}function S(u){if(u){e.options=[];const m=[],{paramDirection:w}=a.allParam;if(w==="INPUT"){const z=Y==null?void 0:Y(W.value,{inbound:!0});z.length>0&&z.forEach(me=>{const O=me.get("paramDirection"),F=me.get("data"),X=new Map;for(const Ce in O)O[Ce]==="OUTPUT"&&F[Ce]&&X.set(Ce,F[Ce]);if(X.size>0){const Ce={label:me.get("name"),value:me.get("id"),children:[]};for(const[Ne,ze]of X)Ce.children.push({label:`${ze}`,value:Ne});m.push(Ce)}})}e.options=[...m]}}function Be(){var u;if(a.allParam.paramDirection==="INPUT"){if(a.allParam.paramTypeEnums==="TEMPLATE")return;if(!e.bindValue)e.inputTableColumn=[];else{const[m,w]=e.bindValue,me=(U==null?void 0:U()).find(O=>O.id===m);if(((u=me==null?void 0:me.tableList)==null?void 0:u.length)>0){const O=me.tableList.find(F=>F.name===w);if(O!=null&&O.table){const F=me.tableList.find(X=>X.name===w).table;e.inputTableColumn=k.cloneDeep(F)}else e.inputTableColumn=[]}else e.inputTableColumn=[]}if(d.value==="COLUMNS_ADD"){const m=R==null?void 0:R().find(F=>F.paramTypeEnums==="COLUMN_ADD").paramName;let w=W.value.get("data")[m];w?fa(w)?w=JSON.parse(w):w=[]:w=[];const z=y(),me=k.cloneDeep(e.inputTableColumn).concat(w),O={name:z,table:me};b("updateTable",V.value.curId,O)}else if(d.value==="COLUMNS_DEL"){const m=R==null?void 0:R().find(F=>F.paramTypeEnums==="COLUMN_DEL").paramName;let w=W.value.get("data")[m];w?fa(w)?w=JSON.parse(w):w=[]:w=[];const z=y(),me=k.cloneDeep(e.inputTableColumn).filter(F=>w.every(X=>X!==F.colName)),O={name:z,table:me};b("updateTable",V.value.curId,O)}else if(d.value==="FILTER_SQL"){const m=y(),w=k.cloneDeep(e.inputTableColumn),z={name:m,table:w};b("updateTable",V.value.curId,z)}else if(d.value==="JOB"){const m=y();if(m){const w=k.cloneDeep(e.inputTableColumn),z={name:m,table:w};b("updateTable",V.value.curId,z)}}}}function Je(u){a.allParam.controlType==="CASCADER"&&++e.cascaderKey,e.bindValue=k.cloneDeep(u),Ae()}function Ae(){const{controlType:u,paramTypeEnums:m,multiple:w}=a.allParam;u==="SELECT_TREE"&&m==="TEMPLATE"?re(e.bindValue.id,z=>{z?b("change",JSON.stringify(z),s):b("change",JSON.stringify(e.bindValue),s)}):u==="CASCADER"?(e.bindValue&&b("change",e.bindValue.join(","),s),Be()):w?b("change",e.bindValue.join(","),s):b("change",e.bindValue,s),u==="DATASOURCE"&&Ve()}function da(){const u=x.value;u&&(a.allParam.paramTypeEnums==="NUMBER"?u.$refs.input.$refs.input.blur():u.blur())}function N(){const u=le.value.find(m=>m.key===s);if(e.showCustomSelect=!e.showCustomSelect,e.showCustomSelect){if(u){e.customBindValue=u.id;const m=k.cloneDeep(H.value.find(w=>w.id===u.id));m.isUsed=!0,b("change","",s,!0,m)}else b("change","",s,!0);setTimeout(()=>{var m;(m=te.value)==null||m.focus()},20)}else if(u){const m=k.cloneDeep(H.value.find(w=>w.id===u.id));m.isUsed=!1,b("change","",s,!0,m)}else b("change","",s,!0)}function $(u){e.bindValue=k.cloneDeep(u),b("change",e.bindValue,s)}function J(u,m){e.bindValue=k.cloneDeep(u),b("change",JSON.stringify(e.bindValue),s);const z={name:y(),table:m};b("updateTable",V.value.curId,z)}function q(u){e.bindValue=k.cloneDeep(u),b("change",JSON.stringify(e.bindValue),s)}function ne(u){b("changeConfig",u,s)}function he(u){const m=e.bindValue.split(",");m.splice(u,1),e.bindValue=m.join(","),b("change",e.bindValue,s)}function ve(){let u=[];e.bindValue?(u=e.bindValue.split(","),u.push(e.enumValue)):(u=[],u.push(e.enumValue)),e.bindValue=u.join(","),e.enumValue="",b("change",e.bindValue,s)}return Ee({controlName:s,allParam:a.allParam,getInputTableColumn:()=>e.inputTableColumn,updateBindValue:Je,blurInputControl:da}),(u,m)=>{const w=h("el-option"),z=h("el-select"),me=h("el-input"),O=h("el-input-number"),F=h("el-color-picker"),X=h("el-tag"),Ce=h("el-button"),Ne=h("SsSelectTree"),ze=h("el-checkbox"),ya=h("el-date-picker"),Re=h("el-cascader");return c(),A("div",{class:He(E(Q))},[u.allParam.controlType==="DATASOURCE"?(c(),A(we,{key:0},[i("div",Ao,[Ro,t(z,{modelValue:e.customBindValue,"onUpdate:modelValue":m[0]||(m[0]=G=>e.customBindValue=G),style:{width:"200px"},placeholder:"请选择自定义变量",filterable:"",clearable:"",onChange:D},{default:o(()=>[(c(!0),A(we,null,Me(E(H),G=>(c(),j(w,{key:G.id,label:G.alisaName,value:G.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),i("div",Bo,[Fo,t(z,{modelValue:e.dataSourceValue,"onUpdate:modelValue":m[1]||(m[1]=G=>e.dataSourceValue=G),style:{width:"200px"},placeholder:"请选择数据库",filterable:"",clearable:"",onChange:f},{default:o(()=>[(c(!0),A(we,null,Me(e.options,G=>(c(),j(w,{key:G.value,label:G.label,value:G.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),i("div",Mo,[jo,t(z,{modelValue:e.layerValue,"onUpdate:modelValue":m[2]||(m[2]=G=>e.layerValue=G),style:{width:"200px"},placeholder:e.dataSourceValue?"请选择表名":"请先选择数据库",filterable:"","allow-create":"",clearable:"","default-first-option":"",onChange:P},{default:o(()=>[(c(!0),A(we,null,Me(e.layerOptions,G=>(c(),j(w,{key:G.value,label:G.label,value:G.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),u.allParam.paramTypeEnums==="DATASOURCEWITHFIELD"?(c(),A("div",qo,[Jo,t(z,{modelValue:e.fieldValue,"onUpdate:modelValue":m[3]||(m[3]=G=>e.fieldValue=G),style:{width:"200px"},placeholder:"请选择字段名",filterable:"",clearable:"",onChange:ce},{default:o(()=>[(c(!0),A(we,null,Me(e.tableColumn,G=>(c(),j(w,{key:G.colName,label:G.colName,value:G.colName},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])):de("",!0)],64)):u.allParam.controlType==="SELECT"?(c(),j(z,{key:1,modelValue:e.bindValue,"onUpdate:modelValue":m[4]||(m[4]=G=>e.bindValue=G),style:{width:"100%"},placeholder:u.allParam.paramTip,multiple:u.allParam.multiple,filterable:"","allow-create":u.allParam.editable,onChange:Ae},{default:o(()=>[(c(!0),A(we,null,Me(e.options,G=>(c(),j(w,{key:G.value,label:G.label,value:G.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","multiple","allow-create"])):u.allParam.controlType==="INPUT_BOX"?(c(),A(we,{key:2},[u.allParam.paramTypeEnums==="GATEWAY"?(c(),j(me,{key:0,ref_key:"inputBoxRef",ref:x,modelValue:e.bindValue,"onUpdate:modelValue":m[5]||(m[5]=G=>e.bindValue=G),style:{width:"250px"},disabled:""},null,8,["modelValue"])):(c(),A(we,{key:1},[e.showCustomSelect?de("",!0):(c(),A(we,{key:0},[u.allParam.paramTypeEnums==="NUMBER"?(c(),j(O,{key:0,ref_key:"inputBoxRef",ref:x,modelValue:e.bindValue,"onUpdate:modelValue":m[6]||(m[6]=G=>e.bindValue=G),style:{width:"210px"},"controls-position":"right",max:E(k.isNumber)(u.allParam.max)?u.allParam.max:1/0,min:E(k.isNumber)(u.allParam.min)?u.allParam.min:-1/0,placeholder:u.allParam.paramTip,onBlur:Ae,onChange:Ae},null,8,["modelValue","max","min","placeholder"])):u.allParam.paramTypeEnums==="COLOR"?(c(),A("div",Go,[t(F,{modelValue:e.bindValue,"onUpdate:modelValue":m[7]||(m[7]=G=>e.bindValue=G),"color-format":"rgb","show-alpha":!0,onChange:Ae},null,8,["modelValue"]),i("span",Wo,Oe(e.bindValue),1)])):u.allParam.paramTypeEnums==="ENUM"?(c(),A(we,{key:2},[e.bindValue?(c(),A("div",Xo,[(c(!0),A(we,null,Me(e.bindValue.split(","),(G,ha)=>(c(),j(X,{key:G,closable:"",type:G.type,onClose:ua=>he(ha)},{default:o(()=>[ae(Oe(G),1)]),_:2},1032,["type","onClose"]))),128))])):de("",!0),i("div",Ko,[t(me,{ref_key:"inputBoxRef",ref:x,modelValue:e.enumValue,"onUpdate:modelValue":m[8]||(m[8]=G=>e.enumValue=G),clearable:"",placeholder:u.allParam.paramTip,onBlur:Ae},null,8,["modelValue","placeholder"])]),i("div",Yo,[t(Ce,{style:{width:"100%"},type:"primary",onClick:ve},{default:o(()=>[ae(" 确认 ")]),_:1})])],64)):(c(),j(me,{key:3,ref_key:"inputBoxRef",ref:x,modelValue:e.bindValue,"onUpdate:modelValue":m[9]||(m[9]=G=>e.bindValue=G),style:{width:"210px"},placeholder:u.allParam.paramTip,onBlur:Ae},null,8,["modelValue","placeholder"]))],64))],64))],64)):u.allParam.controlType==="INPUT_TEXTAREA"?(c(),A(we,{key:3},[e.showCustomSelect?de("",!0):(c(),j(me,{key:0,ref_key:"inputBoxRef",ref:x,modelValue:e.bindValue,"onUpdate:modelValue":m[10]||(m[10]=G=>e.bindValue=G),type:"textarea",style:{width:"210px"},rows:4,placeholder:u.allParam.paramTip,onBlur:Ae},null,8,["modelValue","placeholder"]))],64)):u.allParam.controlType==="SELECT_TREE"?(c(),A(we,{key:4},[e.showCustomSelect?de("",!0):(c(),j(Ne,{key:0,modelValue:e.bindValue,"onUpdate:modelValue":m[11]||(m[11]=G=>e.bindValue=G),"tree-props":e.treeProps,"tree-data":e.options,"node-key":"id",icon:"iconCls",style:{width:"210px"},"expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":e.groupIdentify,disabled:u.isTesting,onChange:Ae},null,8,["modelValue","tree-props","tree-data","group-identify","disabled"]))],64)):u.allParam.controlType==="CHECK_BOX"?(c(),j(ze,{key:5,modelValue:e.bindValue,"onUpdate:modelValue":m[12]||(m[12]=G=>e.bindValue=G),onChange:Ae},null,8,["modelValue"])):u.allParam.controlType==="DATETIMEPICKER"?(c(),j(ya,{key:6,modelValue:e.bindValue,"onUpdate:modelValue":m[13]||(m[13]=G=>e.bindValue=G),style:{width:"100%"},type:"datetime",placeholder:u.allParam.paramTip,"value-format":"YYYY-MM-DD HH:mm:ss",onChange:Ae,onBlur:Ae},null,8,["modelValue","placeholder"])):u.allParam.controlType==="CASCADER"?(c(),j(Re,{key:e.cascaderKey,modelValue:e.bindValue,"onUpdate:modelValue":m[14]||(m[14]=G=>e.bindValue=G),style:{width:"100%"},props:{multiple:u.allParam.multiple},options:e.options,onChange:Ae,onVisibleChange:S},null,8,["modelValue","props","options"])):u.allParam.controlType==="TABLE"?(c(),A(we,{key:8},[u.allParam.paramTypeEnums==="COLUMN_ADD"?(c(),j(ho,{key:0,"init-data":e.bindValue,"control-name":u.allParam.paramName,onChangeTable:J},null,8,["init-data","control-name"])):de("",!0),u.allParam.paramTypeEnums==="COLUMN_DEL"?(c(),j(Do,{key:1,"init-data":e.bindValue,"control-name":u.allParam.paramName,onChangeTable:J},null,8,["init-data","control-name"])):de("",!0),u.allParam.paramTypeEnums==="SQLFILTER"?(c(),j(xo,{key:2,"init-data":e.bindValue,"control-name":u.allParam.paramName,onChangeSql:$},null,8,["init-data","control-name"])):de("",!0),u.allParam.paramTypeEnums==="MAPPING"?(c(),j(Io,{key:3,"init-data":e.bindValue,"control-name":u.allParam.paramName,onChangeMap:q},null,8,["init-data","control-name"])):de("",!0),u.allParam.paramTypeEnums==="GEO_SRS"?(c(),j(E(Zt),{key:4,"init-data":e.bindValue,"control-name":u.allParam.paramName,"control-params":u.allParam,"is-config":!0,onChangeConfig:ne,onChangeTable:q},null,8,["init-data","control-name","control-params"])):de("",!0),u.allParam.paramTypeEnums==="COORDINATE_PARAMS"?(c(),j(E(el),{key:5,"control-name":u.allParam.paramName,"control-params":u.allParam,onChangeTable:q},null,8,["control-name","control-params"])):de("",!0)],64)):de("",!0),E(C)&&u.allParam.paramTypeEnums!=="GATEWAY"?(c(),A(we,{key:9},[e.showCustomSelect?(c(),j(z,{key:0,ref_key:"customSelectRef",ref:te,modelValue:e.customBindValue,"onUpdate:modelValue":m[15]||(m[15]=G=>e.customBindValue=G),style:{width:"210px"},placeholder:"请选择自定义变量",filterable:"",clearable:"",onChange:D},{default:o(()=>[(c(!0),A(we,null,Me(E(H),G=>(c(),j(w,{key:G.id,label:G.alisaName||G.name,value:G.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):de("",!0),i("div",zo,[t(Ce,{class:"click-btn",plain:!e.showCustomSelect,type:e.showCustomSelect?"primary":"info",onClick:N},{default:o(()=>[ae("fx")]),_:1},8,["plain","type"])])],64)):de("",!0)],2)}}});const Ho={id:"dagEditorContainer",class:"dagEditorContainer"},Zo={class:"dagToolbar"},en={class:"left"},an={class:"dagName"},tn={class:"toolgroup"},ln=i("span",null,"运行任务",-1),on={key:0},nn=i("span",null,"另存为",-1),sn=i("span",null,"导出",-1),rn=i("span",null,"验证",-1),un={class:"dagEditMain"},dn={class:"algorithm-tree common-tree","element-loading-text":"拼命加载中..."},cn={class:"common-tree__header tree-header"},pn=["onMousedown"],mn={class:"text"},fn={class:"dag-edit-content"},gn={class:"main-editor-conttainer"},hn={class:"operate-btns-group"},yn={class:"dag-info"},bn={key:0,class:"title"},_n={key:1,class:"title",style:{padding:"0"}},vn={key:2,class:"info-form"},Dn={class:"item-wrap"},Tn={class:"item-wrap"},Vn={class:"item-wrap"},Cn={class:"item-wrap"},kn={class:"form-part-container"},wn={class:"subTitle"},En=i("div",{class:"text"},"任务属性",-1),Sn={id:"task-props-content",class:"expand-content"},Nn={class:"item-wrap"},Ln=i("div",null,"开启后，系统将自动删除任务运行过程中产生的所有数据，",-1),xn=i("div",null,"重新运行任务只能从第一个节点开始运行",-1),Pn={class:"custom-variable-container"},$n={key:0,class:"tips"},Un=["title"],On={class:"var-operate"},In={key:3,class:"info-form"},An={class:"form-part-container"},Rn=i("div",{class:"subTitle"},[i("div",{class:"text"},"算法参数")],-1),Bn={class:"expand-content"},Fn=["title"],Mn={key:0,class:He({displayBox:!0})},jn={class:"form-part-container"},qn=i("div",{class:"subTitle"},[i("div",{class:"text"},"高级属性")],-1),Jn={class:"expand-content"},Gn={class:"item-wrap"},Wn=i("span",null,"节点超时：",-1),Xn=i("div",null,"如果节点运行时长超过超时时间，",-1),Kn=i("div",null,"节点将置为失败状态",-1),Yn={class:"custom-timeout-raido"},zn=i("span",{class:"text"},"小时",-1),ba=180,_a=40,Qn=oa({__name:"index",props:{visible:{type:Boolean,default:!1},groupType:{default:()=>({})},schemeType:{default:Se.ADD},editId:{default:""}},emits:["update:visible","save","changeToEdit","getDag"],setup(ke,{emit:Ee}){const ge=Ee,b=ke,a=il(),_e=ee(),x=ee(),te=ee(),s=ee(),V=ee([]),d=ee(),W=ee(),ie=n=>{n&&V.value.every(l=>l.controlName!==n.controlName)&&V.value.push(n)};ja(()=>{V.value=[]});const le=ee(!1),Q=ee(!1),H=ee(!1);Ie(()=>b.visible,n=>{Q.value=n});const C=Ye({isLoadingTree:!1,algorithmTreeData:[],filterText:""});Ie(()=>C.filterText,n=>{var l;(l=_e.value)==null||l.filter(n)});const Z=ee(!1),p=Ye({paper:null,graph:null,commandManager:null,halo:null,keyboard:null,copyCell:null,draggingDom:null}),R=ee(!1),Y=ee("schemeProperties"),{defaultSchemeData:U,editSchemeData:e,schemeRules:_,curAlgorithmItem:r,curAlgorithmVersionLabel:pe,isLoadingAlgorithmInfo:D,paramsConfigList:f,relationsList:P,curAlgorithmType:ce,tableConfigList:se,getCurAlgorithmItem:Ve,getRelationsList:Pe,curAlgorithmNodeType:Le,nodeTypeMap:y}=El(),{classifyTreeData:v,treeProps:re,handleTypeChange:S,currentEditData:Be,checkFormPass:Je}=Pa(e,Ne);Ie(()=>Be,n=>{e.value.type=n.value.type},{deep:!0});const Ae=ee(!1),da=ee({name:"",type:null,remark:"",clearData:!0}),N=ee(!1),$=ee({taskName:"",taskCatalog:"",dag:"",customVarList:[]}),J=ee({type:"SINGLE"}),q=ee(!1),ne=ee(""),he=ee(null),ve=ee(!1);Ie(()=>q.value,n=>{p.paper.setInteractivity(!n)});const u=ee(!1),m=ee(Se.ADD),w=ee([]),z=ee("");Xe("getCurAlgorithmItem",Ve),Xe("getRelationsList",Pe),Xe("getCellById",Re),Xe("getConnectedLinks",G),Xe("getNeighbors",ha),Xe("getTableConfigList",ua),Xe("getControlInfoByName",wa),Xe("getControlByName",ma),Xe("getCurAlgorithmType",ze),Xe("getParamsConfigList",ya),Xe("getCustomVariableList",za);const me=k.debounce(()=>{const n=document.querySelector(".main-editor-conttainer");te.value.style.maxWidth=`${n.clientWidth}px`,te.value.style.maxHeight=`${n.clientHeight}px`},200);ga(()=>{p.paper=null,p.graph=null,p.commandManager=null,Z.value=!1}),It(()=>{p.keyboard=null});function O(){R.value=!0,Y.value="schemeProperties",se.value=[],r.value={name:"",catalog:"",originalName:""},f.value=[],V.value=[],P.value=[],ce.value="JOB",q.value=!1,ne.value="",he.value=null,H.value=!1,p.copyCell=null,w.value=[]}function F(){Qa(),O(),Z.value?p.graph&&p.graph.clear():Ue(()=>{Za()});const{schemeType:n,groupType:l,editId:L}=b;n===Se.ADD?(e.value=k.cloneDeep(U.value),e.value.type=k.cloneDeep(l),Ue(()=>{var g;(g=W.value)==null||g.init()})):n===Se.EDIT&&(Ha(L),xa(L)),Pt(window,"resize",me,!1),Ue(()=>{var g;(g=x.value)==null||g.clearValidate(),me()})}function X(){ge("update:visible",!1),clearInterval(he.value),he.value=null,$t(window,"resize",me),setTimeout(()=>{var n,l;(n=p.graph)==null||n.clear(),(l=p.commandManager)==null||l.reset()},200)}function Ce(){H.value?ra.confirm("检测到编辑操作未保存，是否在离开页面前保存修改？","提示",{distinguishCancelAndClose:!0,confirmButtonText:"保存",cancelButtonText:"放弃修改"}).then(()=>{Y.value="schemeProperties",Ia(!0)}).catch(n=>{n==="cancel"&&X()}):X()}function Ne(n){H.value=!0}function ze(){return ce.value}function ya(){return f.value}function Re(n){return p.graph.getCell(n)}function G(n,l={}){return p.graph.getConnectedLinks(n,{...l})}function ha(n,l={}){return p.graph.getNeighbors(n,{...l})}function ua(){return se.value}function wa(n){const l=V.value.find(L=>L.controlName===n);return l?Wt(l.allParam):null}function ma(n){const l=V.value.find(L=>L.controlName===n);return l||null}function za(){return w.value||[]}function Qa(){C.isLoadingTree=!0,al.getClassifyTree(!0).then(n=>{n.code==="0000"?C.algorithmTreeData=n.data||[]:oe({type:"warning",message:"获取算法分类数据有误"}),C.isLoadingTree=!1}).catch(n=>{C.isLoadingTree=!1,oe({type:"error",message:n.message||"获取算法分类数据错误"})})}function Ha(n){je.getSchemeInfo(n).then(l=>{var L;if(l.code==="0000"){e.value={type:null,...k.cloneDeep(l.data)},e.value.clearData=((L=l.data)==null?void 0:L.clearData)??!0,Ue(()=>{var B,I,T,M,ue,fe;(fe=W.value)==null||fe.formatData({type:l.data.workType,formData:{expression:((B=l.data)==null?void 0:B.expression)??"",autoDependence:((I=l.data)==null?void 0:I.autoDependence)??!1,cancelWhenFailed:((T=l.data)==null?void 0:T.cancelWhenFailed)??!0,effectStartTime:((M=l.data)==null?void 0:M.effectStartTime)??"",effectEndTime:((ue=l.data)==null?void 0:ue.effectEndTime)??""}})}),e.value.type={id:l.data.catalogId,[re.value.label]:l.data.catalog};const g=JSON.parse(l.data.scheme);delete e.value.scheme,se.value=JSON.parse(l.data.tableConfigList),delete e.value.tableConfigList,p.graph.clear(),p.graph.fromJSON(g)}else oe({type:"warning",message:"获取方案信息有误"})}).catch(l=>{oe({type:"error",message:l.message||"获取方案信息错误"})})}function xa(n){je.getTaskCustomVariable(n).then(l=>{l.code==="0000"?w.value=k.cloneDeep(l.data||[]):oe({type:"warning",message:"获取方案自定义变量有误"})}).catch(l=>{oe({type:"error",message:l.message||"获取方案自定义变量错误"})})}function Za(){p.graph=new window.joint.dia.Graph,p.paper=new window.joint.dia.Paper({el:s.value,model:p.graph,width:"100%",height:"100%",gridSize:10,defaultLink:new window.joint.shapes.app.Link,interactive:!0,async:!0,sorting:window.joint.dia.Paper.sorting.APPROX}),Z.value=!0,window.joint.dia.Link,p.commandManager=new window.joint.dia.CommandManager({graph:p.graph}),p.paper.on("blank:pointerdown",(n,l,L)=>{p.paper.removeTools(),p.keyboard.isActive("shift",n)&&console.log("evt :>> ",n)}),p.paper.on("blank:pointerup",(n,l,L)=>{var g,B,I,T,M;f.value.forEach(ue=>{if(ue.controlType==="INPUT_BOX"||ue.controlType==="INPUT_TEXTAREA"){const fe=ma(ue.paramName);fe&&fe.blurInputControl()}}),(g=r.value)!=null&&g.timeoutLimit&&((M=(T=(I=(B=d.value)==null?void 0:B.input)==null?void 0:I.input)==null?void 0:T.blur)==null||M.call(T)),R.value||(Y.value="schemeProperties",R.value=!0,V.value=[]),r.value={name:"",catalog:"",originalName:""}}),p.paper.on("cell:pointerup",(n,l,L)=>{var B,I,T,M,ue,fe;const g=n.model;if(g.isElement()){if(g.id!==r.value.curId&&!R.value&&f.value.forEach(Te=>{if(Te.controlType==="INPUT_BOX"||Te.controlType==="INPUT_TEXTAREA"){const $e=ma(Te.paramName);$e&&$e.blurInputControl()}}),g.id!==r.value.curId&&((B=r.value)!=null&&B.timeoutLimit)&&((ue=(M=(T=(I=d.value)==null?void 0:I.input)==null?void 0:T.input)==null?void 0:M.blur)==null||ue.call(M)),p.paper.removeTools(),window.joint.ui.Halo.clear(p.paper),R.value=!1,et(n),g.id===r.value.curId)return;D.value=!0,f.value=[],V.value=[],r.value={name:"",catalog:"",originalName:""},r.value.curId=g.id,r.value.name=g.get("name"),r.value.timeoutLimit=g.get("timeoutLimit"),r.value.timeout=g.get("timeout"),pe.value=(fe=g.get("version"))==null?void 0:fe.label,$a(g.prop("version/id"),({paramsConfigListArr:Te=[],relations:$e=[],type:na="JOB",...aa},ta=!1)=>{if(ta)g.set("isError",!0);else{if(g.set("isError",!1),g.get("isInit")){r.value={...r.value,...g.get("data")};const qe=g.get("publishParamList")||[];f.value.forEach(Ke=>{Ke.published=qe.includes(Ke.paramName)})}else{g.set("algorithmType",na),g.set("nodeType",aa.nodeType);const qe={},Ke={},la={},ia={},Ge={};(Te==null?void 0:Te.length)>0&&Te.forEach(be=>{be.paramTypeEnums==="TEXT"?qe[be.paramName]=be.paramValue||"":qe[be.paramName]=be.paramValue,be.paramDirection==="OUTPUT"&&(qe[be.paramName]=`${be.paramName}_tmp`),Ke[be.paramName]=be.paramDirection,la[be.paramName]=be.paramTypeEnums,be.outputMode&&(ia[be.paramName]=be.outputMode),Ge[be.paramName]=be.controlType}),g.set("data",qe),g.set("paramDirection",Ke),g.set("paramTypeEnums",la),g.set("outputMode",ia),g.set("controlTypeEnums",Ge),g.set("customVarEnums",[]),g.set("commonConfig",{});const ye=[];(Te==null?void 0:Te.length)>0&&Te.forEach(be=>{be.required&&ye.push(be.paramName)}),g.set("requiredParamList",ye);const Ze=[];(Te==null?void 0:Te.length)>0&&Te.forEach(be=>{be.publishDisplay&&be.published&&Ze.push(be.paramName)}),g.set("publishParamList",Ze);const We={};Te.forEach(be=>{be.paramDirection==="OUTPUT"&&$e.filter(Qe=>Qe.source===be.paramName).forEach(Qe=>{Te.find(pa=>pa.paramName===Qe.target).paramDirection==="INPUT"&&(We[Qe.target]=Qe.source)})}),g.set("ioRelation",We),g.set("isInit",!0),r.value={...r.value,...qe}}ve.value=!0,ca(g)}D.value=!1})}else p.graph.getLinks().forEach($e=>{p.paper.findViewByModel($e).removeTools()}),at(n)}),p.paper.on("link:mouseenter",n=>{}),p.graph.on("change:source change:target",k.debounce(n=>{if(n.get("source").id&&n.get("target").id){n.attr("line/stroke","#ccc");const l=n.get("source").id,L=n.get("target").id;Vt(l,L)}else n.attr("line/stroke","#f5355e")},300)),p.graph.on("add",n=>{H.value=!0}),p.graph.on("change ",k.debounce(n=>{H.value=!0},300)),p.graph.on("change:position ",n=>{n.isElement()&&(n.prop("position/x")<25&&n.prop("position/x",25),n.prop("position/y")<20&&n.prop("position/y",20))}),p.graph.on("remove",n=>{if(Q.value&&(H.value=!0,n.isLink())){const l=Re(n.target().id);if(!l)return;const g=Re(n.source().id).attributes,B=[];for(const T in g.paramDirection)g.paramDirection[T]==="OUTPUT"&&B.push(T);const I=l.attributes;for(const T in I.paramDirection)if(I.paramDirection[T]==="INPUT"&&I.data[T]&&typeof I.data[T]=="string"&&I.data[T].includes(",")){const M=I.data[T].split(",");if(B.includes(M[1])&&(I.data[T]="",r.value.curId===l.id)){const ue=ma(T);ue==null||ue.updateBindValue([])}}for(const T in I.paramDirection)if(I.paramDirection[T]==="OUTPUT"&&(I.data[T]="",r.value.curId===l.id)){const M=ma(T);M==null||M.updateBindValue("")}r.value.curId===l.id&&(r.value={...r.value,...I.data}),ca(l),Oa(l)}}),p.paper.on("cell:mouseover",n=>{n.model.isElement()&&n.$box[0].querySelector(".name").classList.add("show")}),p.paper.on("cell:mouseout",n=>{n.model.isElement()&&n.$box[0].querySelector(".name").classList.remove("show")}),p.keyboard=new window.joint.ui.Keyboard,p.keyboard.on({"ctrl+c":function(){if(r.value.curId){const n=Re(r.value.curId);p.copyCell=n.clone(),p.copyCell.translate(20,20)}else p.copyCell=null},"ctrl+v":function(){p.copyCell&&(p.graph.addCell(p.copyCell),p.copyCell=p.copyCell.clone(),p.copyCell.translate(20,20))},"ctrl+x shift+delete":function(){if(r.value.curId){const n=Re(r.value.curId);p.copyCell=n.clone(),p.copyCell.translate(20,20),p.graph.removeCells([n]),r.value={name:"",catalog:""},R.value=!0}else p.copyCell=null},"delete backspace":function(n){if(n.preventDefault(),r.value.curId){const l=Re(r.value.curId);p.graph.removeCells([l]),r.value={name:"",catalog:""},R.value=!0}},"ctrl+z":function(){var n;(n=p.commandManager)!=null&&n.hasUndo()&&!q.value&&ft()},"ctrl+y":function(){var n;(n=p.commandManager)!=null&&n.hasRedo()&&!q.value&&gt()},"ctrl+a":function(n){n.preventDefault()},"keydown:shift":function(n){},"keyup:shift":function(){}},{})}function et(n){const l=window.joint.elementTools,L=new window.joint.dia.ToolsView({name:"element-pointerdown",tools:[new l.Boundary({padding:5})]});n.addTools(L),q.value?p.halo=new window.joint.ui.Halo({cellView:n,handles:[],useModelGeometry:!0}).render():p.halo=new window.joint.ui.Halo({cellView:n,useModelGeometry:!0}).render(),p.halo.on("action:removeCell:pointerdown",g=>{Tt(g.get("id")),R.value=!0}),p.halo.on("action:link:add",g=>{(!g.get("source").id||!g.get("target").id)&&g.remove()})}function $a(n,l){je.getAlgorithmDetailInfo(n).then(L=>{if(L.code==="0000"){const{data:{name:g,catalog:B,paramsConfig:I,nodeType:T}}=L;if(Le.value=T??0,fa(I)){const ue=JSON.parse(I),{config:fe=[],relations:Te=[],type:$e="JOB"}=ue;console.log(ue),ve.value=!1,f.value=k.cloneDeep(fe),P.value=k.cloneDeep(Te),Ue(()=>{r.value.originalName=g,r.value.catalog=B,ce.value=$e,l&&l instanceof Function&&l({paramsConfigListArr:fe,relations:Te,type:$e,nodeType:T})})}else oe({type:"warning",message:"获取算子信息失败"}),f.value=[],V.value=[],P.value=[],r.value={name:"",catalog:"",originalName:""},ce.value="JOB",l&&l instanceof Function&&l({},!0)}else oe({type:"warning",message:`获取算子信息失败,${L.message}`}),f.value=[],V.value=[],P.value=[],r.value={name:"",catalog:"",originalName:""},ce.value="JOB",l&&l instanceof Function&&l({},!0)}).catch(()=>{oe({type:"warning",message:"获取算子信息失败"}),f.value=[],V.value=[],P.value=[],r.value={name:"",catalog:"",originalName:""},ce.value="JOB",l&&l instanceof Function&&l({},!0)})}function at(n){if(q.value)return;const l=window.joint.linkTools,L=new window.joint.dia.ToolsView({name:"link-pointerdown",tools:[new l.Vertices,new l.SourceAnchor,new l.TargetAnchor,new l.TargetArrowhead,new l.Segments,new l.Boundary({padding:15}),new l.Remove({offset:-20,distance:40})]});n.addTools(L)}function tt(){R.value=!0,Ue(()=>{var B;const n=Na(!0),l=Je(x),L=(B=W.value)==null?void 0:B.validData();Promise.all([n,l,L]).then(([I,T,M])=>{if((!T||!M)&&(oe({type:"warning",message:"请正确填写方案信息和调度配置"}),e.value.name&&e.value.type?Y.value="dispatchConfig":Y.value="schemeProperties"),I&&T&&M){const{workType:ue,formData:{expression:fe,autoDependence:Te,cancelWhenFailed:$e,effectStartTime:na,effectEndTime:aa}}=M,{name:ta="",type:qe,remark:Ke="",status:la=1,clearData:ia}=e.value,Ge={name:ta,catalog:qe[re.value.label],catalogId:qe.id,remark:Ke,status:la,scheme:I,tableConfigList:JSON.stringify(se.value),workType:ue,expression:ue==="SINGLE"?"":fe,userVars:k.cloneDeep(w.value),clearData:ia};ue!=="SINGLE"&&(Ge.autoDependence=Te,Ge.cancelWhenFailed=$e,Ge.effectStartTime=na,aa&&(Ge.effectEndTime=aa)),b.schemeType===Se.ADD||(Ge.id=e.value.id);const Ze=JSON.stringify(Ge,null,2),We=`data:text/csv;charset=utf-8,\uFEFF${encodeURIComponent(Ze)}`,be=document.createElement("a");be.href=We,be.download=`${Ge.name}.json`,document.body.appendChild(be),be.click(),document.body.removeChild(be)}})})}function lt(){window.joint.layout.DirectedGraph.layout(p.graph,{dagre:window.dagre,graphlib:window.graphlib,nodeSep:30,rankDir:"TB",setLinkVertices:!0,marginX:100,marginY:100})}function ot(){}function nt(n,l){q.value||n.type!==1||(l=Ea(l),p.draggingDom=null,p.draggingDom=window.$(`<div class="html-element dragging-dom">
          <span class="name"></span>
        </div>`),p.draggingDom.find(".name").text(n.name),p.draggingDom.css({width:ba,height:_a,left:l.clientX-ba/2,top:l.clientY-_a/2,background:"#ffffffde",zIndex:1e4}),p.draggingDom.appendTo(document.body),it(n))}function Ea(n){return n||(n=window.event,n.target=n.srcElement,n.layerX=n.offsetX,n.layerY=n.offsetY),n.mx=n.pageX||n.clientX+document.body.scrollLeft,n.my=n.pageY||n.clientY+document.body.scrollTop,n}function it(n){document.body.style.cursor="move",document.onmousemove=l=>{l=Ea(l),p.draggingDom.css({left:l.clientX-ba/2,top:l.clientY-_a/2})},document.onmouseup=l=>{if(l=Ea(l),document.body.style.cursor="auto",document.onmousemove=null,document.onmouseup=null,p.draggingDom.remove(),st(l)){const g=te.value,{scrollLeft:B,scrollTop:I}=g,T=new window.joint.shapes.algorithm.Element({position:{x:l.offsetX+B-ba/2,y:l.offsetY+I-_a/2},size:{width:ba,height:_a},name:n.name,algorithmId:n.id,version:{id:n.versionId,label:n.version}});$a(n.versionId,({paramsConfigListArr:M=[],relations:ue=[],type:fe="JOB",...Te},$e=!1)=>{if($e)T.set("isError",!0);else{T.set("isError",!1),T.set("algorithmType",fe),T.set("nodeType",Te.nodeType);const na=[];(M==null?void 0:M.length)>0&&M.forEach(ye=>{ye.required&&na.push(ye.paramName)}),T.set("requiredParamList",na);const aa=[];(M==null?void 0:M.length)>0&&M.forEach(ye=>{ye.publishDisplay&&ye.published&&aa.push(ye.paramName)}),T.set("publishParamList",aa);const ta={};M.forEach(ye=>{ye.paramDirection==="OUTPUT"&&ue.filter(We=>We.source===ye.paramName).forEach(We=>{M.find(be=>be.paramName===We.target).paramDirection==="INPUT"&&(ta[We.target]=We.source)})}),T.set("ioRelation",ta);const qe={},Ke={},la={},ia={},Ge={};(M==null?void 0:M.length)>0&&M.forEach(ye=>{ye.paramTypeEnums==="TEXT"?qe[ye.paramName]=ye.paramValue||"":qe[ye.paramName]=ye.paramValue,ye.paramDirection==="OUTPUT"&&(qe[ye.paramName]=`${ye.paramName}_tmp`),Ke[ye.paramName]=ye.paramDirection,la[ye.paramName]=ye.paramTypeEnums,ye.outputMode&&(ia[ye.paramName]=ye.outputMode),Ge[ye.paramName]=ye.controlType}),T.set("data",qe),T.set("paramDirection",Ke),T.set("paramTypeEnums",la),T.set("outputMode",ia),T.set("controlTypeEnums",Ge),T.set("customVarEnums",[]),T.set("commonConfig",{}),T.set("isInit",!0)}ca(T),p.graph.addCell(T)})}}}function st(n){n=Ea(n);const l=te.value,L=n.clientX,g=n.clientY,B=l.getClientRects()[0],{left:I,width:T,top:M,height:ue}=B;return!(L<I||L>I+T||g<M||g>M+ue)}function rt(n,l,L){return n?Ya(n,l,L,re.value.label):!0}function ut(){q.value||(Y.value="schemeProperties",R.value=!0,r.value.curId="",p.paper.removeTools(),window.joint.ui.Halo.clear(p.paper),Ue(()=>{var B;const n=Na(),l=Je(x),L=(B=W.value)==null?void 0:B.validData();Promise.all([n,l,L]).then(([I,T,M])=>{if((!T||!M)&&(oe({type:"warning",message:"请正确填写方案信息和调度配置"}),e.value.name&&e.value.type?Y.value="dispatchConfig":Y.value="schemeProperties"),I&&T&&M){const{name:ue="",type:fe}=e.value;$.value={taskName:ue,taskCatalog:fe[re.value.label],dag:I,customVarList:k.cloneDeep(w.value)||[]};const{workType:Te,formData:$e}=M;J.value={type:Te,formData:$e},N.value=!0}})}))}function dt(n,l="SINGLE"){l==="SINGLE"?(De({type:"success",title:"任务运行中",onClick:()=>{a.push({path:"/dataCenter/SingleTaskManage"})}}),q.value=!0,ne.value=n,p.graph.getElements().forEach(g=>{g.prop("testStatus/isWaiting",!0)}),ct()):l==="CYCLE"&&De({type:"success",customClass:"custom-relese-notification",title:"任务运行中，前往查看",onClick:()=>{a.push({name:"/dataCenter/CycleTaskManage"})}})}function ct(){he.value=setInterval(()=>{pt()},3e3)}function Sa(){clearInterval(he.value),he.value=null,setTimeout(()=>{q.value=!1,ne.value="",p.graph.getElements().forEach(l=>{l.removeProp("testStatus")})},2e3)}function pt(){const n={isWaiting:!1,isRunning:!1,isSuccess:!1,isFail:!1};je.getTaskStatuslist(ne.value).then(l=>{if(l.code==="0000"){const{jobInfo:L,nodesInfo:g}=l.data;g.forEach(B=>{const I=Re(B.id);let T=k.cloneDeep(n);B.status===-1?T={...T,isWaiting:!0}:B.status===1?T={...T,isRunning:!0}:B.status===0?T={...T,isSuccess:!0}:B.status===2&&(T={...T,isFail:!0}),I.prop("testStatus",T)}),L.status===0?(De({type:"success",title:"任务运行成功"}),Sa()):L.status===2&&(De({type:"error",title:"任务运行失败"}),Sa())}else De({type:"error",title:"任务运行失败"}),Sa()}).catch(()=>{le.value=!1,De({type:"error",title:"任务运行失败"}),Sa()})}function mt(){var n;(n=p.graph)==null||n.clear()}function ft(){if(p.commandManager){if(p.commandManager.undo(),r.value.curId){const l=Re(r.value.curId);l?r.value={...r.value,...l.get("data")}:(R.value=!0,r.value={name:"",catalog:""})}p.graph.getElements().forEach(l=>{ca(l)})}}function gt(){if(p.commandManager){if(p.commandManager.redo(),r.value.curId){const l=Re(r.value.curId);l?r.value={...r.value,...l.get("data")}:(R.value=!0,r.value={name:"",catalog:"",originalName:""})}p.graph.getElements().forEach(l=>{ca(l)})}}function ca(n){const{data:l={},requiredParamList:L=[],customVarEnums:g=[]}=n.attributes;let B=!0;for(let I=0,T=L.length;I<T;I++)if(l[L[I]]===void 0||l[L[I]]===null||l[L[I]]===""){const M=g.find(ue=>ue.key===L[I]);if(M){if(!M.isUsed){B=!1;break}}else{B=!1;break}}n.set("isPassValid",B)}function ht(){H.value=!0;const{curId:n="",originalName:l,name:L}=r.value,g=Re(n);g&&g.prop("name",L||l)}function yt(){H.value=!0;const{curId:n="",timeoutLimit:l}=r.value;l?r.value.timeout=1:r.value.timeout=0;const L=Re(n);L&&(L.prop("timeoutLimit",l),L.prop("timeout",r.value.timeout))}function Ua(){H.value=!0;const{curId:n="",timeout:l}=r.value;if(!n)return;const L=Re(n);L&&L.prop("timeout",l)}function bt(n,l,L=!1,g=null){H.value=!0;const{curId:B=""}=r.value,I=Re(B);if(!L)I.prop(`data/${l}`,n);else{let T=k.cloneDeep(I.prop("customVarEnums"));if(T.some(ue=>ue.key===l)&&(T=T.filter(ue=>ue.key!==l)),g){const{id:ue,isUsed:fe}=g,Te={key:l,id:ue,isUsed:fe};T.push(Te)}I.prop("customVarEnums",T)}ca(I)}function _t(n,l){H.value=!0;const{curId:L=""}=r.value;Re(L).prop(`commonConfig/${l}`,n,{rewrite:!0})}function vt(n,l){const{curId:L=""}=r.value,g=Re(L);g.get("publishParamList")||g.set("publishParamList",[]);let B=k.cloneDeep(g.get("publishParamList"));B&&(n?B.includes(l)||B.push(l):B=B.filter(I=>I!==l),g.set("publishParamList",B))}function Dt(n,l){const L=se.value.find(g=>g.id===n);if(L){const g=L.tableList.find(B=>B.name===l.name);g?g.table=k.cloneDeep(l.table):L.tableList.push(l)}else{const g=[];g.push(l),se.value.push({id:n,tableList:g})}}function Tt(n){se.value=se.value.filter(l=>l.id!==n)}function Oa(n){const l=n.attributes,L=[];for(const B in l.paramDirection)l.paramDirection[B]==="OUTPUT"&&L.push(B);const g=ha(n,{outbound:!0});g.length>0&&g.forEach(B=>{const I=B.attributes;for(const T in I.paramDirection)if(I.paramDirection[T]==="INPUT"&&I.data[T]&&typeof I.data[T]=="string"&&I.data[T].includes(",")){const M=I.data[T].split(",");if(L.includes(M[1])&&(I.data[T]="",r.value.curId===B.id)){const ue=ma(T);ue==null||ue.updateBindValue([])}}for(const T in I.paramDirection)if(I.paramDirection[T]==="OUTPUT"&&(I.data[T]="",r.value.curId===B.id)){const M=ma(T);M==null||M.updateBindValue("")}r.value.curId===B.id&&(r.value={...r.value,...I.data}),ca(B),Oa(B)})}function Vt(n,l){const L=Re(n),g=Re(l),B=k.values(L.get("paramDirection")).filter(T=>T==="OUTPUT"),I=k.values(g.get("paramDirection")).filter(T=>T==="INPUT");if(B.length===1&&I.length===1){const T=k.findKey(g.get("paramDirection"),fe=>fe==="INPUT");if(g.prop(`data/${T}`))return;const M=k.findKey(L.get("paramDirection"),fe=>fe==="OUTPUT"),ue=`${L.get("id")},${M}`;g.prop(`data/${T}`,ue),ca(g)}}function Ct(){m.value=Se.ADD,z.value="",u.value=!0}function kt(n){m.value=Se.EDIT,z.value=n.name,u.value=!0}function wt(n){je.deleteCustomVariable(n.id).then(l=>{l.code==="0000"?(De({type:"success",title:"删除自定义变量成功"}),xa(e.value.id)):De({type:"error",title:"删除自定义变量失败",message:l.message})}).catch(l=>{oe({type:"error",message:l.message||"删除自定义变量错误"})})}function Et(){xa(e.value.id)}function Na(n=!1){const l=k.cloneDeep(p.graph.toJSON()),{cells:L}=l;return L.filter(B=>B.type==="algorithm.Element").forEach(B=>{delete B.testStatus}),new Promise(B=>{if(n){B(JSON.stringify(l));return}if(l.cells.length>0){let I=!1;for(let T=0,M=l.cells.length;T<M;T++)if(l.cells[T].type==="algorithm.Element"){I=!0;break}if(I){let T=!0;for(let M=0,ue=l.cells.length;M<ue;M++){const fe=l.cells[M];if(fe.type==="algorithm.Element"&&(fe.isError||!fe.isPassValid)){T=!1;break}}T?B(JSON.stringify(l)):(oe({type:"warning",message:"存在错误或未通过验证的算法，请正确配置"}),B(!1))}else oe({type:"warning",message:"流程图至少需要一个算法，请正确绘制"}),B(!1)}else oe({type:"warning",message:"未绘制流程图，请绘制"}),B(!1)})}function St(){const{cells:n}=p.graph.toJSON(),l=n.filter(L=>L.type==="algorithm.Element");console.log("customVariableList",w.value),console.log("cell list :>> ",l),se.value=se.value.filter(L=>l.some(g=>g.id===L.id)),console.log("tableConfigList.value :>> ",se.value)}function Nt(){Na(!0).then(l=>{var L;if(l){const g=k.cloneDeep(p.graph.toJSON()),{cells:B}=g;B.filter($e=>$e.type==="algorithm.Element").forEach($e=>{delete $e.testStatus});const T=(L=W.value)==null?void 0:L.getData(),{name:M,type:ue,remark:fe,clearData:Te}=e.value;da.value={name:M||"",type:ue,scheme:g,tableConfigList:se.value,userVars:k.cloneDeep(w.value),remark:fe||"",clearData:Te??!0,workTypeData:T},Ae.value=!0}})}function Lt(){ge("save")}function Ia(n=!1){R.value=!0,r.value={name:"",catalog:"",originalName:""},p.paper.removeTools(),window.joint.ui.Halo.clear(p.paper),Ue(()=>{var I;const l=Na(!0),L=Je(x),g=(I=W.value)==null?void 0:I.validData();Promise.all([l,L,g]).then(([T,M,ue])=>{if((!M||!ue)&&(oe({type:"warning",message:"请正确填写方案信息和调度配置"}),e.value.name&&e.value.type?Y.value="dispatchConfig":Y.value="schemeProperties"),T&&M&&ue){const{workType:fe,formData:{expression:Te,autoDependence:$e,cancelWhenFailed:na,effectStartTime:aa,effectEndTime:ta}}=ue,{name:qe,type:Ke,remark:la,status:ia,clearData:Ge}=e.value,ye={name:qe,catalog:Ke[re.value.label],catalogId:Ke.id,remark:la,status:ia,scheme:T,tableConfigList:JSON.stringify(se.value),workType:fe,expression:fe==="SINGLE"?"":Te,clearData:Ge};fe!=="SINGLE"&&(ye.autoDependence=$e,ye.cancelWhenFailed=na,ye.effectStartTime=aa,ta&&(ye.effectEndTime=ta));const Ze=b.schemeType===Se.ADD,We=Ze?"新增":"修改",be=Ze?"addWorkScheme":"updateWorkScheme";Ze||(ye.id=e.value.id,ye.needUpdate=!1),le.value=!0,je[be](ye).then(K=>{le.value=!1,K.code==="0000"?(De({type:"success",title:`${We}方案成功`}),Ze&&(e.value.id=K.data.id),ge("save"),ge("changeToEdit"),Ze||ge("getDag",ye.id),H.value=!1,n&&X()):De({type:"error",title:`${We}方案失败`,message:K.message})}).catch(K=>{le.value=!1,De({type:"error",title:`${We}方案失败`,message:K.message})})}})})}function Ci(n){const l=x.value.$el.querySelector(`#${n}`);l!=null&&l.classList.contains("hide")?l.classList.remove("hide"):l.classList.add("hide")}return(n,l)=>{const L=h("ArrowLeftBold"),g=h("el-icon"),B=h("el-button"),I=h("el-input"),T=h("el-scrollbar"),M=h("el-tab-pane"),ue=h("el-tabs"),fe=h("el-form-item"),Te=h("el-switch"),$e=h("ArrowUpBold"),na=h("el-checkbox"),aa=h("QuestionFilled"),ta=h("el-tooltip"),qe=h("el-popconfirm"),Ke=h("el-form"),la=h("el-radio"),ia=h("el-input-number"),Ge=h("el-radio-group"),ye=h("el-dialog"),Ze=Ta("action"),We=Ta("loading");return c(),j(ye,{modelValue:Q.value,"onUpdate:modelValue":l[16]||(l[16]=be=>Q.value=be),class:"dag-editor-dialog",title:"DAG","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,fullscreen:"","show-close":!1,onOpened:F,onClosed:X},{default:o(()=>{var be;return[i("div",Ho,[i("div",Zo,[i("div",en,[i("div",{class:"back-icon",onClick:Ce},[t(g,null,{default:o(()=>[t(L)]),_:1})]),i("div",an,Oe(E(e).id?E(e).name||"未填写":"未保存"),1)]),i("div",tn,[i("ul",null,[i("li",null,[i("div",{class:He(["btn",{disabled:q.value}]),onClick:ut},[t(g,null,{default:o(()=>[t(E(At))]),_:1}),ln],2)]),n.schemeType===E(Se).EDIT?(c(),A("li",on,[i("div",{class:"btn",onClick:Nt},[t(g,null,{default:o(()=>[t(E(Rt))]),_:1}),nn])])):de("",!0),i("li",null,[i("div",{class:"btn",onClick:tt},[t(g,null,{default:o(()=>[t(E(Bt))]),_:1}),sn])]),i("li",null,[i("div",{class:"btn",onClick:St},[t(g,null,{default:o(()=>[t(E(Ft))]),_:1}),rn])])]),Fe((c(),j(B,{class:"save-btn",type:"primary",loading:le.value,onClick:l[0]||(l[0]=K=>Ia(!1))},{default:o(()=>[ae(" 保存 ")]),_:1},8,["loading"])),[[Ze,"algorithm_task_import"]])])]),i("div",un,[Fe((c(),A("div",dn,[i("div",cn,[t(I,{modelValue:C.filterText,"onUpdate:modelValue":l[1]||(l[1]=K=>C.filterText=K),placeholder:"请输入关键字搜索","prefix-icon":E(Ja),clearable:""},null,8,["modelValue","prefix-icon"])]),t(T,{class:"common-tree__wrapper"},{default:o(()=>[t(E(Ga),{ref_key:"treeRef",ref:_e,data:C.algorithmTreeData,props:E(re),"node-key":"id","empty-text":"暂无数据","default-expand-all":"","filter-node-method":rt,"expand-on-click-node":!1,onCurrentChange:ot},{default:o(({node:K,data:Qe})=>[i("span",{class:He(["custom-tree-node",Qe.type===1?"joint-element":""]),onMousedown:pa=>nt(Qe,pa)},[i("span",{class:He(["node-label",Qe.type===1?"childTitle":""])},[Qe.type===0?(c(),j(g,{key:0,class:"el-icon-folder"},{default:o(()=>[t(E(Mt))]),_:1})):de("",!0),i("span",mn,Oe(K.label),1)],2)],42,pn)]),_:1},8,["data","props"])]),_:1})])),[[We,C.isLoadingTree]]),i("div",fn,[i("div",gn,[i("div",hn,[t(B,{class:"opt-btn",icon:E(jt),size:"small",title:"清空",disabled:q.value,onClick:mt},null,8,["icon","disabled"]),t(B,{class:"opt-btn",icon:E(qt),size:"small",title:"格式化布局",disabled:q.value,onClick:lt},null,8,["icon","disabled"])]),i("div",{ref_key:"dagContainerRef",ref:te,class:"dagContainer"},[i("div",{id:"dagCanvas",ref_key:"canvas",ref:s,class:"canvas"},null,512)],512)])]),Fe((c(),A("div",yn,[R.value?(c(),A("div",_n,[t(ue,{modelValue:Y.value,"onUpdate:modelValue":l[2]||(l[2]=K=>Y.value=K),class:"tabTitle",stretch:"",onTabClick:l[3]||(l[3]=K=>R.value=!0)},{default:o(()=>[t(M,{label:"方案信息",name:"schemeProperties"},{default:o(()=>[ae("方案信息")]),_:1}),t(M,{label:"调度配置",name:"dispatchConfig"},{default:o(()=>[ae("调度配置")]),_:1}),t(M,{label:"方案变量",name:"customVariable"},{default:o(()=>[ae("方案变量")]),_:1})]),_:1},8,["modelValue"])])):(c(),A("div",bn,Oe(((be=E(r))==null?void 0:be.originalName)||"算法信息"),1)),R.value?(c(),A("div",vn,[t(Ke,{ref_key:"editSchemeFormRef",ref:x,class:"edit-form scheme common-form",inline:"",model:E(e),rules:E(_),disabled:q.value,"label-width":"110px","label-position":"left"},{default:o(()=>[Fe(i("div",null,[i("div",Dn,[t(fe,{class:"block-item",label:"方案名称：",prop:"name"},{default:o(()=>[t(I,{modelValue:E(e).name,"onUpdate:modelValue":l[4]||(l[4]=K=>E(e).name=K),type:"text",placeholder:"请输入方案名称",maxlength:"20","show-word-limit":"",style:{width:"260px"},onInput:Ne},null,8,["modelValue"])]),_:1})]),i("div",Tn,[t(fe,{class:"block-item",label:"方案分组：",prop:"type"},{default:o(()=>[t(E(Ca),{modelValue:E(e).type,"onUpdate:modelValue":l[5]||(l[5]=K=>E(e).type=K),"tree-props":E(re),"tree-data":E(v),"node-key":"id",icon:"iconCls",style:{width:"260px"},"expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"",disabled:q.value,onChange:E(S)},null,8,["modelValue","tree-props","tree-data","disabled","onChange"])]),_:1})]),i("div",Vn,[t(fe,{class:"block-item",label:"描述：",prop:"remark"},{default:o(()=>[t(I,{modelValue:E(e).remark,"onUpdate:modelValue":l[6]||(l[6]=K=>E(e).remark=K),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":"",style:{width:"260px"},onInput:Ne},null,8,["modelValue"])]),_:1})]),i("div",Cn,[t(fe,{label:"发布状态：",prop:"status"},{default:o(()=>[t(Te,{modelValue:E(e).status,"onUpdate:modelValue":l[7]||(l[7]=K=>E(e).status=K),class:"swith-btn","active-value":1,"inactive-value":0,onChange:Ne},null,8,["modelValue"])]),_:1})])],512),[[Da,Y.value==="schemeProperties"]]),Fe(i("div",null,[i("div",kn,[i("div",wn,[En,de("",!0)]),i("div",Sn,[i("div",Nn,[t(fe,{label:"删除过程数据：",prop:"clearData"},{default:o(()=>[t(na,{modelValue:E(e).clearData,"onUpdate:modelValue":l[9]||(l[9]=K=>E(e).clearData=K)},null,8,["modelValue"]),t(ta,{class:"item",effect:"dark",placement:"top"},{content:o(()=>[Ln,xn]),default:o(()=>[t(g,{style:{"margin-left":"12px"}},{default:o(()=>[t(aa)]),_:1})]),_:1})]),_:1})])])]),t(La,{ref_key:"workTypeFormRef",ref:W,"need-reaction":"",onChange:Ne},null,512)],512),[[Da,Y.value==="dispatchConfig"]]),Fe(i("div",null,[i("div",Pn,[t(B,{class:"add-btn",type:"primary",icon:E(Wa),plain:"",disabled:!E(e).id,onClick:Ct},{default:o(()=>[ae("新增自定义变量")]),_:1},8,["icon","disabled"]),E(e).id?de("",!0):(c(),A("div",$n,"请先保存方案")),(c(!0),A(we,null,Me(w.value,K=>(c(),A("div",{key:K.id,class:"custom-var-box"},[i("div",{class:"var-name",title:K.alisaName||K.name},Oe(K.alisaName||K.name),9,Un),i("div",On,[t(g,{class:"edit",onClick:Qe=>kt(K)},{default:o(()=>[t(E(Jt))]),_:2},1032,["onClick"]),t(qe,{title:"确定删除该自定义变量吗？",onConfirm:Qe=>wt(K)},{reference:o(()=>[t(g,{class:"delete"},{default:o(()=>[t(E(Gt))]),_:1})]),_:2},1032,["onConfirm"])])]))),128))])],512),[[Da,Y.value==="customVariable"]])]),_:1},8,["model","rules","disabled"])])):de("",!0),R.value?de("",!0):(c(),A("div",In,[t(Ke,{ref:"editAlgorithmForm",class:"edit-form common-form",model:E(r),disabled:q.value,"label-position":"left"},{default:o(()=>[t(fe,{label:"节点名称：",prop:"name","label-width":"85px"},{default:o(()=>[t(I,{modelValue:E(r).name,"onUpdate:modelValue":l[10]||(l[10]=K=>E(r).name=K),placeholder:"请输入节点名称",onInput:ht},null,8,["modelValue"])]),_:1}),t(fe,{label:"算法版本：","label-width":"85px"},{default:o(()=>[i("span",null,Oe(E(pe)),1)]),_:1}),t(fe,{label:"算法类型：","label-width":"85px"},{default:o(()=>[i("span",null,Oe(E(y).get(E(Le))),1)]),_:1}),i("div",An,[Rn,i("div",Bn,[E(f).length>0?(c(!0),A(we,{key:0},Me(E(f),(K,Qe)=>(c(),j(fe,{key:K.paramName+Qe,prop:K.paramName,class:"param-main-content","label-width":K.controlType==="CHECK_BOX_XX"?"":"250px"},{label:o(()=>[i("span",{class:He({labelBox:!0,isRequired:K.required}),title:K.paramLabel},Oe(K.paramLabel+"："),11,Fn),ve.value&&K.publishDisplay?(c(),A("span",Mn,[t(na,{modelValue:K.published,"onUpdate:modelValue":pa=>K.published=pa,onChange:pa=>vt(K.published,K.paramName)},{default:o(()=>[ae(" 发布 ")]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])):de("",!0)]),default:o(()=>[t(Qo,{ref_for:!0,ref:ie,modelValue:E(r)[K.paramName],"onUpdate:modelValue":pa=>E(r)[K.paramName]=pa,"control-name":K.paramName,"all-param":K,style:Xa({width:K.controlType==="CHECK_BOX_XX"?"auto":"250px"}),"is-testing":q.value,onChange:bt,onChangeConfig:_t,onUpdateTable:Dt},null,8,["modelValue","onUpdate:modelValue","control-name","all-param","style","is-testing"])]),_:2},1032,["prop","label-width"]))),128)):de("",!0)])]),i("div",jn,[qn,i("div",Jn,[i("div",Gn,[t(fe,{class:"block-item",prop:"timeoutLimit"},{label:o(()=>[Wn,t(ta,{class:"item",effect:"dark",placement:"top"},{content:o(()=>[Xn,Kn]),default:o(()=>[t(g,{style:{transform:"translateY(2px)"}},{default:o(()=>[t(aa)]),_:1})]),_:1})]),default:o(()=>[t(Ge,{modelValue:E(r).timeoutLimit,"onUpdate:modelValue":l[12]||(l[12]=K=>E(r).timeoutLimit=K),class:"timeout-group",onChange:yt},{default:o(()=>[i("div",null,[t(la,{label:!1},{default:o(()=>[ae("无限制")]),_:1})]),i("div",Yn,[t(la,{label:!0},{default:o(()=>[ae("自定义")]),_:1}),E(r).timeoutLimit?(c(),A(we,{key:0},[t(ia,{ref_key:"timeoutInputRef",ref:d,modelValue:E(r).timeout,"onUpdate:modelValue":l[11]||(l[11]=K=>E(r).timeout=K),style:{width:"120px"},min:.1,"controls-position":"right",placeholder:"请输入数值",onBlur:Ua,onChange:Ua},null,8,["modelValue"]),zn],64)):de("",!0)])]),_:1},8,["modelValue"])]),_:1})])])])]),_:1},8,["model","disabled"])]))])),[[We,E(D)]])]),t(Fl,{visible:Ae.value,"onUpdate:visible":l[13]||(l[13]=K=>Ae.value=K),"copy-data":da.value,onSave:Lt},null,8,["visible","copy-data"]),t(mo,{visible:N.value,"onUpdate:visible":l[14]||(l[14]=K=>N.value=K),"dag-data":$.value,"scheme-data":E(e),"work-type-params":J.value,onSuccess:dt},null,8,["visible","dag-data","scheme-data","work-type-params"]),t(Yl,{visible:u.value,"onUpdate:visible":l[15]||(l[15]=K=>u.value=K),"dialog-type":m.value,"task-id":E(e).id,"cur-edit-var-name":z.value,onSuccess:Et},null,8,["visible","dialog-type","task-id","cur-edit-var-name"])])]}),_:1},8,["modelValue"])}}});const Hn={id:"work-scheme-manage",class:"dataContainer"},Zn={class:"common-tree__header"},ei={class:"custom-tree-node"},ai={key:1,class:"status-text"},ti=["src"],li=["title"],oi={class:"tree-node__toolbar"},ni=["onClick"],ii=["onClick"],si=["onClick"],ri={key:0,class:"btn"},ui={class:"btn"},di={class:"btn"},ci={key:0,class:"btn"},pi={class:"btn"},mi={class:"btn"},fi={id:"scheme-section-container-wrap"},gi={class:"section-container-title"},hi={key:0,class:"tips"},yi={key:1,class:"flex-container"},bi={class:"btns"},_i={class:"section-container-content"},vi={class:"info"},Di={class:"info-box"},Ti={key:0,class:"empty-status"},Vi={class:"text"},Mi=oa({__name:"index",setup(ke){const Ee=ee(),ge=xe(()=>Ee.value),b=ee(),a=ee(),_e=ee(),x=ee(),te=Ma({paper:null,graph:null}),s=Ye({isLoadingTree:!1,classifyTreeData:[],filterText:"",treeProps:{label:"name",children:"children"},defaultExpandedkeys:[],curActiveKey:"",classifyDialogVisible:!1,classifyDialogType:Se.ADD,curClassifyData:{},copyDialogVisible:!1,copyData:{},curEditType:{},schemeType:Se.ADD,curEditSchemeId:"",showEditorDialog:!1,isLoadingScheme:!1,editSchemeData:null,showTips:!0,importData:{}});ga(()=>{Ut(()=>import("./jointPlug.cfec54db.js"),["./jointPlug.cfec54db.js","./jointPrepare.318e4ddb.js","./element-plus.59ccb443.js","./lodash.22f463b4.js","../css/element-plus-a5bc9350.css","./login.a4e9287e.js","./error.229cea25.js","../css/error-ab7d0c80.css","../../app-config.js","../css/login-8a4effaf.css","./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js","./index-a95bb620.js","./echarts.39e3cf74.js","./wujie-vue3.9ecbe737.js","./smartweb3.2d5e4c59.js","../css/smartweb3-f9bf067f.css","./smart-ui.e8e0134c.js","../css/smart-ui-6d875ea0.css","../css/index-fc6a8528.css","../css/index-05133815.css","./useTableAndPagination.0c6e0294.js","../css/jointPrepare-41e4096f.css"],import.meta.url).then(()=>{Ue(()=>{V()})})}),ga(()=>{W(!0)}),Xe("getClassifyTreeData",d),Ie(()=>s.filterText,y=>{var v;(v=b.value)==null||v.filter(y)}),Xt(()=>{});function V(){te.graph=new window.joint.dia.Graph,te.paper=new window.joint.dia.Paper({el:x.value,model:te.graph,width:"100%",height:"100%",gridSize:10,defaultLink:new window.joint.shapes.app.Link,interactive:!1,async:!0,sorting:window.joint.dia.Paper.sorting.APPROX})}function d(){return s.classifyTreeData}function W(y=!1){s.isLoadingTree=!0,je.getClassifyTree().then(v=>{v.code==="0000"?(s.classifyTreeData=v.data||[],y||Ue(()=>{var re;(re=b.value)==null||re.setCurrentKey(s.curActiveKey)})):oe({type:"warning",message:"获取方案分类数据有误"}),s.isLoadingTree=!1}).catch(v=>{s.isLoadingTree=!1,oe({type:"error",message:v.message||"获取方案分类数据错误"})})}function ie(){s.curClassifyData={pid:"#"},s.classifyDialogType=Se.ADD,s.classifyDialogVisible=!0}function le(){s.curEditType=null,s.schemeType=Se.ADD,s.showEditorDialog=!0}function Q(y,v){var re,S;if(y.type===1){if(s.curActiveKey=y.id,((re=s.editSchemeData)==null?void 0:re.id)===y.id)return;Y(y.id)}else s.curActiveKey||(s.curActiveKey=null);s.curActiveKey&&((S=b.value)==null||S.setCurrentKey(s.curActiveKey))}function H(y,v,re){return y?Ya(y,v,re,s.treeProps.label):!0}function C(y){const v=f(y);s.curEditType={id:v.catalogId,[s.treeProps.label]:v.catalog},s.schemeType=Se.ADD,s.showEditorDialog=!0}function Z(y){s.curClassifyData=k.cloneDeep(y),s.classifyDialogType=Se.EDIT,s.classifyDialogVisible=!0}function p(y){s.curEditSchemeId=y.id,s.schemeType=Se.EDIT,s.showEditorDialog=!0}function R(y){var v;((v=s.editSchemeData)==null?void 0:v.id)===y&&Y(y)}function Y(y){s.isLoadingScheme=!0,je.getSchemeInfo(y).then(v=>{if(v.code==="0000"){s.editSchemeData=v.data;const{workType:re="SINGLE",expression:S=""}=v.data;re==="SINGLE"?s.editSchemeData.workTypeText="单次任务":re==="CYCLE"?(s.editSchemeData.workTypeText="固定频率",s.editSchemeData.interval=S):s.editSchemeData.workTypeText="表达式",U()}else oe({type:"warning",message:"获取方案信息有误"}),s.isLoadingScheme=!1}).catch(v=>{s.isLoadingScheme=!1,oe({type:"error",message:v.message||"获取方案信息错误"})})}function U(){te.graph.clear(),s.showTips=!1,te.graph.fromJSON(JSON.parse(s.editSchemeData.scheme)),s.isLoadingScheme=!1}function e(y){s.curClassifyData={pid:y.id},s.classifyDialogType=Se.ADD,s.classifyDialogVisible=!0}function _(y){ra.confirm(`将删除【${y.name}】方案，是否继续？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",draggable:!0}).then(()=>{je.deleteScheme(y.id).then(v=>{v.code==="0000"?(De({type:"success",title:"删除方案成功"}),s.curActiveKey===y.id&&(s.curActiveKey=null,te.graph.clear(),s.showTips=!0,s.editSchemeData={}),W()):De({type:"warning",title:"删除方案失败，请重试"})}).catch(v=>{De({type:"error",title:"删除方案错误",message:v.message||"服务有错"})})}).catch(()=>{})}function r(y){s.copyData=k.cloneDeep(y),s.copyDialogVisible=!0}function pe(y){je.getSchemeInfo(y.id).then(v=>{if(v.code==="0000"){let re=[];je.getTaskCustomVariable(y.id).then(S=>{S.code==="0000"&&(re=k.cloneDeep(S.data||[])),v.data.userVars=re,D(v.data)}).catch(()=>{v.data.userVars=re,D(v.data)})}else oe({type:"warning",message:"导出方案失败"})}).catch(v=>{oe({type:"error",message:v.message||"获取方案错误"})})}function D(y){const v=JSON.stringify(y,null,2),re=`data:text/csv;charset=utf-8,\uFEFF${encodeURIComponent(v)}`,S=document.createElement("a");S.href=re,S.download=`${y.name}.json`,document.body.appendChild(S),S.click(),document.body.removeChild(S)}function f(y){const v={};v.catalogId=y.id;let re=y[s.treeProps.label];if(y.pid!=="#"){const S=s.classifyTreeData.find(Be=>Be.id===y.pid);S&&(re=`${S[s.treeProps.label]} / ${re}`)}return v.catalog=re,v}function P(y){s.importData={...f(y)},a.value.click()}function ce(y){const{files:v}=y.target;if(v.length===0)return;const re=v[0],S=Ve(re.name).toLowerCase();if(!["json"].includes(S)){ra.alert("请选择json文件上传！","提示",{confirmButtonText:"确定",type:"error"}),y.target.value="";return}se(re,Be=>{Pe(Be)}),y.target.value=""}function se(y,v){const re=new FileReader;re.readAsText(y),re.onload=S=>{const Be=S.target.result;if(typeof Be=="string")try{const Je=JSON.parse(Be);if(typeof Je=="object"&&Je){if(!Je.scheme||!Je.name){ra.alert("文件内容缺失！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}v&&v(Je)}else ra.alert("文件内容格式不正确！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"})}catch{ra.alert("文件内容格式不正确！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"})}else ra.alert("文件内容格式不正确！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"})}}function Ve(y){return y.replace(/.+\./,"")}function Pe(y){const v={taskInfo:{name:y.name,catalog:s.importData.catalog,catalogId:s.importData.catalogId,remark:y.remark||"",status:y.status||1,scheme:y.scheme,tableConfigList:y.tableConfigList,workType:y.workType||"SINGLE",expression:y.expression||"",clearData:y.clearData??!0},userVars:y.userVars||[]};je.saveAsWorkScheme(v).then(re=>{re.code==="0000"?(De({type:"success",title:"导入方案成功"}),W(),s.importData={}):De({type:"error",title:"导入方案失败",message:re.message})}).catch(re=>{De({type:"error",title:"导入方案失败",message:re.message})})}function Le(y){ra.confirm(`删除分组【${y.name}】，将一并删除其下的所有方案，是否继续？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",draggable:!0}).then(()=>{var S;const v=(S=b.value)==null?void 0:S.getNode(s.curActiveKey);let re=!1;v&&(v.parent.data.id===y.id||v.parent.data.pid===y.id)&&(re=!0),je.deleteClassify(y.id).then(Be=>{Be.code==="0000"?(De({type:"success",title:"删除分组成功"}),re&&(s.curActiveKey=null,te.graph.clear(),s.showTips=!0,s.editSchemeData={}),W()):De({type:"warning",title:"删除分组失败，请重试"})}).catch(Be=>{De({type:"error",title:"删除分组错误",message:Be.message||"服务有错"})})}).catch(()=>{})}return(y,v)=>{var O;const re=h("el-input"),S=h("el-button"),Be=h("el-dropdown-item"),Je=h("el-dropdown-menu"),Ae=h("el-dropdown"),da=h("Warning"),N=h("el-icon"),$=h("circle-plus"),J=h("ElIcon"),q=h("ElTooltip"),ne=h("Edit"),he=h("el-popover"),ve=h("el-scrollbar"),u=h("el-form-item"),m=h("el-switch"),w=h("el-form"),z=Ta("action"),me=Ta("loading");return c(),A("div",Hn,[Fe((c(),A("div",{ref_key:"treeAsideRef",ref:Ee,class:"dataContainer__leftAside common-tree","element-loading-text":"拼命加载中..."},[i("div",Zn,[t(re,{modelValue:s.filterText,"onUpdate:modelValue":v[0]||(v[0]=F=>s.filterText=F),placeholder:"请输入关键字搜索","prefix-icon":E(Ja),clearable:""},null,8,["modelValue","prefix-icon"]),t(Ae,{trigger:"click",placement:"bottom-start"},{dropdown:o(()=>[t(Je,null,{default:o(()=>[Fe((c(),j(Be,{onClick:le},{default:o(()=>[ae(" 新建方案 ")]),_:1})),[[z,"algorithm_task_add"]]),Fe((c(),j(Be,{onClick:ie},{default:o(()=>[ae(" 新建分组 ")]),_:1})),[[z,"algorithm_task_addCatalog"]])]),_:1})]),default:o(()=>[Fe(t(S,{class:"common-tree__header-btn",type:"primary",title:"新增",icon:E(Wa),plain:"",onClick:()=>{}},null,8,["icon"]),[[z,["algorithm_task_addCatalog","algorithm_task_add"]]])]),_:1})]),t(ve,{class:"common-tree__wrapper"},{default:o(()=>[t(E(Ga),{ref_key:"treeRef",ref:b,data:s.classifyTreeData,props:s.treeProps,"node-key":"id","empty-text":"暂无数据","default-expand-all":"","default-expanded-keys":s.defaultExpandedkeys,"highlight-current":"","current-node-key":s.curActiveKey,"expand-on-click-node":!1,"filter-node-method":H,onCurrentChange:Q},{default:o(({node:F,data:X})=>[i("span",ei,[i("span",{class:He(["node-label",X.pid?"childTitle":""])},[X.type===1&&!X.dataType?(c(),A("span",{key:0,class:He(["status-icon",X.status===1?"open":"closed"])},null,2)):de("",!0),X.type===1&&X.dataType?(c(),A("span",ai,"默认")):de("",!0),X.imagePath?(c(),A("img",{key:2,class:"image",src:E(nl)+X.imagePath},null,8,ti)):de("",!0),i("span",{class:He(["text",[X.type===1&&X.needUpdate?"warning":""]]),title:F.label},Oe(F.label),11,li),X.type===1&&X.needUpdate?(c(),j(N,{key:3,class:"update-warning",title:"方案更新"},{default:o(()=>[t(da)]),_:1})):de("",!0)],2),i("span",oi,[X.type===0?(c(),A("span",{key:0,onClick:va(Ce=>C(X),["stop"])},[t(q,{content:"新建方案",placement:"bottom"},{default:o(()=>[t(J,{size:"16",color:"var(--el-color-primary)"},{default:o(()=>[t($)]),_:1})]),_:1})],8,ni)):de("",!0),X.type===0?Fe((c(),A("span",{key:1,onClick:va(Ce=>Z(X),["stop"])},[t(q,{content:"编辑",placement:"bottom"},{default:o(()=>[t(J,{size:"16",color:"var(--el-color-primary)"},{default:o(()=>[t(ne)]),_:1})]),_:1})],8,ii)),[[z,"algorithm_task_updateCatalog"]]):de("",!0),X.type===1?Fe((c(),A("span",{key:2,onClick:va(Ce=>p(X),["stop"])},[t(q,{content:"编辑",placement:"bottom"},{default:o(()=>[t(J,{size:"16",color:"var(--el-color-primary)"},{default:o(()=>[t(ne)]),_:1})]),_:1})],8,si)),[[z,"algorithm_task_update"]]):de("",!0),t(he,{placement:"right",width:88,trigger:"hover","popper-class":"more-operate-poper"},{reference:o(()=>[t(N,{class:"more-icon-btn"},{default:o(()=>[t(E(Kt))]),_:1})]),default:o(()=>[X.type===1?(c(),A(we,{key:0},[X.dataType?de("",!0):Fe((c(),A("div",ri,[t(S,{type:"primary",text:"",onClick:Ce=>_(X)},{default:o(()=>[ae(" 删除方案 ")]),_:2},1032,["onClick"])])),[[z,"algorithm_task_delete"]]),i("div",ui,[t(S,{type:"primary",text:"",onClick:Ce=>r(X)},{default:o(()=>[ae(" 复制方案 ")]),_:2},1032,["onClick"])]),Fe((c(),A("div",di,[t(S,{type:"primary",text:"",onClick:Ce=>pe(X)},{default:o(()=>[ae(" 导出方案 ")]),_:2},1032,["onClick"])])),[[z,"algorithm_task_import"]])],64)):(c(),A(we,{key:1},[X.pid==="#"?Fe((c(),A("div",ci,[t(S,{type:"primary",text:"",onClick:Ce=>e(X)},{default:o(()=>[ae(" 新建分组 ")]),_:2},1032,["onClick"])])),[[z,"algorithm_task_addCatalog"]]):de("",!0),Fe((c(),A("div",pi,[t(S,{type:"primary",text:"",onClick:Ce=>P(X)},{default:o(()=>[ae(" 导入方案 ")]),_:2},1032,["onClick"])])),[[z,"algorithm_task_import"]]),Fe((c(),A("div",mi,[t(S,{type:"primary",text:"",onClick:Ce=>Le(X)},{default:o(()=>[ae(" 删除分组 ")]),_:2},1032,["onClick"])])),[[z,"algorithm_task_deleteCatalog"]])],64))]),_:2},1024)])])]),_:1},8,["data","props","default-expanded-keys","current-node-key"])]),_:1})])),[[me,s.isLoadingTree]]),i("div",fi,[t(E(Ot),{target:ge.value},null,8,["target"]),i("div",gi,[s.showTips?(c(),A("div",hi,"未选择方案")):(c(),A("div",yi,[i("div",null,Oe((O=s==null?void 0:s.editSchemeData)==null?void 0:O.name),1),i("div",bi,[t(S,{type:"primary",plain:"",onClick:v[1]||(v[1]=F=>p(s.editSchemeData))},{default:o(()=>[ae(" 方案编辑 ")]),_:1}),t(S,{plain:"",onClick:v[2]||(v[2]=F=>r(s.editSchemeData))},{default:o(()=>[ae(" 复制 ")]),_:1}),t(S,{plain:"",onClick:v[3]||(v[3]=F=>pe(s.editSchemeData))},{default:o(()=>[ae(" 导出 ")]),_:1}),t(S,{type:"danger",plain:"",onClick:v[4]||(v[4]=F=>_(s.editSchemeData))},{default:o(()=>[ae(" 删除 ")]),_:1})])]))]),i("div",_i,[Fe((c(),A("div",{id:"scheme-container",ref_key:"schemeContainerRef",ref:_e,class:"scheme-container"},[i("div",{id:"dagCanvas",ref_key:"canvas",ref:x,class:"canvas view-dag"},null,512),i("div",vi,[i("div",Di,[s.showTips?(c(),A("div",Ti,[i("span",Vi,[t(N,null,{default:o(()=>[t(E(Yt))]),_:1}),ae("请在左侧新建或选择方案 ")])])):(c(),j(w,{key:1,ref:"ruleForm",model:s.editSchemeData,inline:"","label-width":"95px","label-position":"right"},{default:o(()=>[t(u,{class:"block-item",label:"方案名称：",prop:"name"},{default:o(()=>[i("span",null,Oe(s.editSchemeData.name),1)]),_:1}),t(u,{class:"block-item",label:"方案分组：",prop:"catalog"},{default:o(()=>[i("span",null,Oe(s.editSchemeData.catalog),1)]),_:1}),t(u,{class:"block-item",label:"方案描述：",prop:"remark"},{default:o(()=>[i("span",{style:Xa({color:s.editSchemeData.remark?"":"#ccc"})},Oe(s.editSchemeData.remark||"未描述"),5)]),_:1}),t(u,{label:"发布状态：",prop:"status"},{default:o(()=>[t(m,{modelValue:s.editSchemeData.status,"onUpdate:modelValue":v[5]||(v[5]=F=>s.editSchemeData.status=F),class:"swith-btn",disabled:"","active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),t(u,{label:"创建人：",prop:"creator"},{default:o(()=>[i("span",null,Oe(s.editSchemeData.creator),1)]),_:1}),t(u,{label:"创建时间：",prop:"createTime"},{default:o(()=>[i("span",null,Oe(s.editSchemeData.createTime),1)]),_:1}),t(u,{label:"更新时间：",prop:"updateTime"},{default:o(()=>[i("span",null,Oe(s.editSchemeData.updateTime),1)]),_:1})]),_:1},8,["model"]))])])])),[[me,s.isLoadingScheme]])])]),i("input",{ref_key:"uploadFileRef",ref:a,style:{display:"none"},type:"file",class:"uploadFile",accept:".json",onChange:ce},null,544),t(ml,{visible:s.classifyDialogVisible,"onUpdate:visible":v[6]||(v[6]=F=>s.classifyDialogVisible=F),"dialog-type":s.classifyDialogType,"cur-item":s.curClassifyData,onSave:W},null,8,["visible","dialog-type","cur-item"]),t(wl,{visible:s.copyDialogVisible,"onUpdate:visible":v[7]||(v[7]=F=>s.copyDialogVisible=F),"copy-data":s.copyData,onSave:W},null,8,["visible","copy-data"]),t(Qn,{visible:s.showEditorDialog,"onUpdate:visible":v[8]||(v[8]=F=>s.showEditorDialog=F),"group-type":s.curEditType,"scheme-type":s.schemeType,"edit-id":s.curEditSchemeId,onSave:W,onGetDag:R,onChangeToEdit:v[9]||(v[9]=F=>s.schemeType=E(Se).EDIT)},null,8,["visible","group-type","scheme-type","edit-id"])])}}});export{Mi as default};
