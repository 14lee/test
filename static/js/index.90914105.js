import{r as A,u as H,s as R,o as ee,a as te,P as U}from"./login.a4e9287e.js";import{d as B,b as F,e as O,o as C,f as N,g as s,j as T,k as se,U as E,B as _,l as oe,Z as z,_ as G,r as $,w as Z,c as ne,E as j,N as K,n as ae,L as Q,aj as S,F as ie,y as ce,x as re,u as J}from"./element-plus.59ccb443.js";import{_ as V}from"./error.229cea25.js";import{q as le}from"./lodash.22f463b4.js";import{s as P}from"./dataType.8bfa5e6a.js";import{u as de,i as ue,b as me,c as pe,d as _e,f as fe,g as he}from"./echarts.39e3cf74.js";import"../../app-config.js";function ve(){return A.doGetPromise("/algorithm/manager/monitor/workerMachineMonitor")}function we(i){return A.doPostPromiseJson("/algorithm/manager/monitor/taskMonitor",i,{})}var L=(i=>(i.SINGLE="SINGLE",i.CYCLE="CYCLE",i))(L||{});const W=i=>(z("data-v-4828288b"),i=i(),G(),i),be={class:"computer-info-box"},ke={class:"name-item first"},ge={class:"name-item"},ye={class:"name-item"},$e={class:"name-item"},Se={class:"info-item"},Ie=W(()=>s("span",{class:"label"},"操作系统（版本）：",-1)),De={class:"value"},Ce={class:"info-item"},Te=W(()=>s("span",{class:"label"},"处理器：",-1)),Le={class:"value"},Ne={class:"info-item"},We=W(()=>s("span",{class:"label"},"显卡：",-1)),Me={class:"value"},Ye={class:"info-item"},xe=W(()=>s("span",{class:"label"},"显存：",-1)),Ee={class:"value"},Oe=B({__name:"ComputerInfo",props:{info:{default:()=>({})}},setup(i){const f=F(!0);return(c,d)=>{var k,v,p,h,t,r,l,w,m,I,o,e;const a=O("ArrowDown"),n=O("el-icon");return C(),N("div",be,[s("div",{class:"header",onClick:d[0]||(d[0]=u=>f.value=!f.value)},[T(n,{title:f.value?"点击收起":"点击展开"},{default:se(()=>[T(a,{class:E(["icon",{"is-open":f.value}])},null,8,["class"])]),_:1},8,["title"]),s("span",ke,"主机名："+_(((k=c.info)==null?void 0:k.hostName)||"获取错误"),1),s("span",ge,"IP："+_(((v=c.info)==null?void 0:v.address)||"获取错误"),1),s("span",ye,[oe(" 运行状态： "),s("span",{class:E([c.info.status==="0"?"free":"running"])},_(((p=c.info)==null?void 0:p.status)==="0"?"空闲":"正在运行"),3)]),s("span",$e,"当前任务数："+_(((h=c.info)==null?void 0:h.jobCount)||0),1)]),s("div",{class:E(["main",{"is-open":f.value}])},[s("div",Se,[Ie,s("span",De,_((r=(t=c.info)==null?void 0:t.monitorInfo)==null?void 0:r.os),1)]),s("div",Ce,[Te,s("span",Le,_((w=(l=c.info)==null?void 0:l.monitorInfo)==null?void 0:w.cpu),1)]),s("div",Ne,[We,s("span",Me,_((I=(m=c.info)==null?void 0:m.monitorInfo)==null?void 0:I.cuda),1)]),s("div",Ye,[xe,s("span",Ee,_((e=(o=c.info)==null?void 0:o.monitorInfo)==null?void 0:e.vram),1)])],2)])}}});const Be=V(Oe,[["__scopeId","data-v-4828288b"]]),ze=i=>(z("data-v-acc817ee"),i=i(),G(),i),Ge={class:"header"},Ve={class:"name-item first"},je={class:"time"},Je=ze(()=>s("div",{class:"main"},[s("div",{id:"chartBox",class:"chart-container"})],-1)),Pe=B({__name:"TaskInfo",props:{type:{default:L.SINGLE}},setup(i){de([ue,me,pe,_e,fe]);const f=H(),{userInfo:c}=R(f),d=F(),a=$({chartDom:null,myChart:null,option:{}}),n=$({websocket:null});Z(()=>c.value.id,o=>{var e;o?w():window.WebSocket&&((e=n.websocket)==null||e.close())});const k={tooltip:{trigger:"item",formatter:"{a} <br/>{b}  {d}%"},legend:{top:"center",right:"6%",show:!0,orient:"vertical"},series:[{name:"状态",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},left:"-20%",emphasis:{label:{show:!0,fontSize:20,fontWeight:"bold"}},labelLine:{show:!1},data:[{value:0,name:"运行中"},{value:0,name:"成功"},{value:0,name:"等待中"},{value:0,name:"失败"},{value:0,name:"已取消"}]}]},v=[{text:"最近一周",value:()=>{const o=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,o]}},{text:"最近一个月",value:()=>{const o=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,o]}},{text:"最近三个月",value:()=>{const o=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,o]}}],p=i,h=ne(()=>p.type===L.SINGLE),t=$({value:[`${j().subtract(1,"month").format("YYYY-MM-DD hh:mm:ss").slice(0,-8)}00:00:00`,`${j().format("YYYY-MM-DD hh:mm:ss").slice(0,-8)}23:59:59`],defaultTime:[new Date(2022,1,1,0,0,0),new Date(2022,2,1,23,59,59)]});K(()=>{ae(()=>{var o;r(t.value),a.chartDom=(o=d.value)==null?void 0:o.querySelector("#chartBox"),a.myChart=he(a.chartDom),a.option=le.cloneDeep(k),a.myChart.setOption(a.option),ee(window,"resize",I),w()})}),Q(()=>{var o;te(window,"resize",I),window.WebSocket&&((o=n.websocket)==null||o.close())});function r(o){if(o){const e=[{beginTime:o[0],endTime:o[1],workerType:p.type}];l(e),m(e)}else{const e=[{workerType:p.type}];l(e),m(e)}}function l(o){we(o).then(e=>{var u,g,b;if(e.code==="0000"){if((u=e.data)!=null&&u[0]){const D=[];((b=(g=e.data)==null?void 0:g[0])==null?void 0:b.counts).forEach(y=>{D.push({name:`${P[y.status]} (${y.num})`,value:y.num})});const Y=a.myChart.getOption();Y.series[0].data=D,a.option=Y,a.myChart.setOption(a.option)}}else S({type:"error",message:e.message||`获取${h.value?"单次":"周期"}任务运行情况失败`})}).catch(e=>{S({type:"error",message:e.message||`获取${h.value?"单次":"周期"}任务运行情况错误`})})}function w(){var o,e;window.WebSocket&&((o=n.websocket)==null||o.close()),(e=c.value)!=null&&e.id&&window.WebSocket&&(n.websocket=new WebSocket(`${U}/algorithm/websocket/jobMonitorRefresh?userId=${c.value.id}&type=${p.type}`),n.websocket.onopen=()=>{if(t.value){const u=[{beginTime:t.value[0],endTime:t.value[1],workerType:p.type}];m(u)}else{const u=[{workerType:p.type}];m(u)}},n.websocket.onclose=()=>{},n.websocket.onmessage=u=>{var D;const g=JSON.parse(u.data),{jobMonitorRefresh:b}=g;if(b){const M=[];((D=b==null?void 0:b[0])==null?void 0:D.counts).forEach(x=>{M.push({name:`${P[x.status]} (${x.num})`,value:x.num})});const y=a.myChart.getOption();y.series[0].data=M,a.option=y,a.myChart.setOption(a.option)}},n.websocket.onerror=()=>{S({type:"error",message:"websocket连接错误！"})})}function m(o){var e,u;((e=n==null?void 0:n.websocket)==null?void 0:e.readyState)===1&&((u=n.websocket)==null||u.send(JSON.stringify(o)))}function I(){var o;a.myChart&&((o=a.myChart)==null||o.resize())}return(o,e)=>{const u=O("el-date-picker");return C(),N("div",{ref_key:"mainRef",ref:d,class:"task-info-box"},[s("div",Ge,[s("span",Ve,_(h.value?"单次":"周期")+"任务运行情况",1),s("span",je,[T(u,{modelValue:t.value,"onUpdate:modelValue":e[0]||(e[0]=g=>t.value=g),type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:v,"value-format":"YYYY-MM-DD HH:mm:ss","default-time":t.defaultTime,onChange:r},null,8,["modelValue","default-time"])])]),Je],512)}}});const q=V(Pe,[["__scopeId","data-v-acc817ee"]]),X=i=>(z("data-v-9b89527b"),i=i(),G(),i),qe={class:"resource-monitor-container"},Ae={class:"count-container container"},He=X(()=>s("div",{class:"label"},"计算资源总览",-1)),Re={class:"value"},Ue={class:"item"},Fe={class:"item"},Ze={class:"item"},Ke={class:"computer-container"},Qe={class:"task-container"},Xe=X(()=>s("div",{class:"empty"},null,-1)),et=B({__name:"index",setup(i){const f=H(),{userInfo:c}=R(f),d=$({total:0,running:0,free:0}),a=$({computerList:[]}),n=$({websocket:null});Z(()=>c.value.id,t=>{var r;t?p():window.WebSocket&&((r=n.websocket)==null||r.close())}),K(()=>{k(),p()}),Q(()=>{var t;window.WebSocket&&((t=n.websocket)==null||t.close())});function k(){ve().then(t=>{t.code==="0000"?(a.computerList=t.data||[],v(t.data)):S({type:"error",message:t.message||"获取计算资源总览数据失败"})}).catch(t=>{S({type:"error",message:t.message||"获取计算资源总览数据错误"})})}function v(t){var r;d.total=(t==null?void 0:t.length)??0,d.running=(r=t==null?void 0:t.filter(l=>l.status==="1"))==null?void 0:r.length,d.free=d.total-d.running}function p(){var t,r;window.WebSocket&&((t=n.websocket)==null||t.close()),(r=c.value)!=null&&r.id&&window.WebSocket&&(n.websocket=new WebSocket(`${U}/algorithm/websocket/workerMachineMonitorRefresh?userId=${c.value.id}`),n.websocket.onopen=()=>{h()},n.websocket.onclose=()=>{},n.websocket.onmessage=l=>{const w=JSON.parse(l.data),{workerMachineMonitorRefresh:m}=w;(m==null?void 0:m.code)==="0000"&&(a.computerList=m.data||[],v(m.data))},n.websocket.onerror=()=>{S({type:"error",message:"websocket连接错误！"})})}function h(){var r,l;const t={};t.userId=c.value.id,((r=n.websocket)==null?void 0:r.readyState)===1&&((l=n.websocket)==null||l.send(JSON.stringify(t)))}return(t,r)=>(C(),N("div",qe,[s("div",Ae,[He,s("div",Re,[s("div",Ue,"计算节点在线总量："+_(d.total),1),s("div",Fe,"计算节点运行数量："+_(d.running),1),s("div",Ze,"计算节点空闲数量："+_(d.free),1)])]),s("div",Ke,[(C(!0),N(ie,null,ce(a.computerList,l=>(C(),re(Be,{key:l.hostName+t.index,info:l},null,8,["info"]))),128))]),s("div",Qe,[T(q,{type:J(L).SINGLE},null,8,["type"]),Xe,T(q,{type:J(L).CYCLE},null,8,["type"])])]))}});const rt=V(et,[["__scopeId","data-v-9b89527b"]]);export{rt as default};
