import{d as ue,b as j,r as se,c as oe,w as _e,N as fe,n as re,e as b,t as ne,v as P,o as v,f as $,g,j as a,u as t,$ as xe,a0 as Ve,k as l,a1 as Se,B,ad as de,z as ae,l as U,A as $e,F as ye,y as be,x as J,ak as ce,ai as E,aj as W,i as De,S as ke,bW as Ne,bm as Le,U as Ee,p as he}from"./element-plus.59ccb443.js";import{q as te,v as pe}from"./lodash.22f463b4.js";import{t as Ae,D as Ie,v as ve,w as Re,x as Fe,y as Ue,z as Ke,A as ze}from"./login.a4e9287e.js";import{A as z}from"./stylesManage.d0073bf5.js";import{D as x,d as ge,S as Be}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{c as He,j as Ce,S as Te}from"./index-a95bb620.js";import{_ as Me}from"./error.229cea25.js";import"../../app-config.js";import"./echarts.39e3cf74.js";import"./wujie-vue3.9ecbe737.js";import"./smartweb3.2d5e4c59.js";import"./smart-ui.e8e0134c.js";const Pe={class:"common-tree__header"},Oe={class:"common-tree__checkbox"},qe={class:"tree-node"},We={class:"tree-node__label"},je={class:"text"},Ge={key:0,class:"tree-node__toolbar"},Je=["onClick"],Qe=["onClick"],Xe=["onClick"],Ye={class:"classify-data"},Ze={class:"item-wrap"},et={class:"item-wrap"},tt={class:"item-wrap"},at={class:"dialog-footer"},lt=ue({__name:"CatalogTree",emits:["change","setData"],setup(G,{expose:H,emit:F}){const u=F,K=j(),f=j(),M=j(),e=se({isLoadingTree:!0,classifyTreeData:[],filterText:"",treeProps:{label:"name",children:"children"},defaultExpandedkeys:[],curActiveKey:"#",checkAll:!0,selectText:"所有数据",dialogType:x.ADD,curClassifyData:{},dialogVisible:!1,submiting:!1,defaultData:{name:"",pid:"#",description:""},editData:{},rules:{name:[{required:!0,message:"目录名称不能为空",trigger:["change","blur"]},{min:0,max:10,message:"长度在 10 个字符以内",trigger:["blur","change"]}],pid:[{required:!0,message:"上级目录不能为空",trigger:["change"]}]}}),N=oe(()=>{if(e.classifyTreeData.length===0)return[{value:"#",label:"/"}];{let o=[{value:"#",label:"/",idx:0}];const p=(s,d,y)=>{s.forEach(k=>{var m;const n=k.pid==="#"?k.name:`${d} / ${k.name}`,c=k.pid==="#"?1:y;o.push({value:k.id,label:n,idx:c}),((m=k==null?void 0:k.children)==null?void 0:m.length)>0&&p(k.children,n,c+1)})},L=te.cloneDeep(e.classifyTreeData).filter(s=>!s.isDefault);return p(L,"",1),e.dialogType===x.EDIT&&(o=o.filter(s=>s.value!==e.editData.id)),o=o.filter(s=>s.idx<=3),o}});_e(()=>e.filterText,o=>{f.value.filter(o)}),fe(()=>{i()});function A(o){if(o)e.curActiveKey="#",f.value.setCurrentKey(null),e.selectText="所有数据",u("change",e.curActiveKey);else{const p=e.classifyTreeData.find(L=>L.isDefault);e.curActiveKey=p.id,f.value.setCurrentKey(e.curActiveKey),e.selectText=p.name,u("change",e.curActiveKey)}}function i(o=!1){e.isLoadingTree=!0,z.getClassifyTree().then(p=>{p.code==="0000"&&(e.classifyTreeData=te.cloneDeep(p.data)||[],u("setData",te.cloneDeep(e.classifyTreeData)),o?re(()=>{e.curActiveKey=e.classifyTreeData[0].id,f.value.setCurrentKey(e.curActiveKey),u("change",e.curActiveKey),e.selectText=e.classifyTreeData[0].name}):re(()=>{f.value.setCurrentKey(e.curActiveKey)}))}).catch(()=>{}).finally(()=>{e.isLoadingTree=!1})}function Q(){e.curClassifyData={pid:"#"},e.dialogType=x.ADD,e.dialogVisible=!0}function r(o,p,L){return o?He(o,p,L,e.treeProps.label):!0}function le(o,p){o&&(e.curActiveKey=o.id,e.selectText=o.name,e.checkAll=!1,f.value.setCurrentKey(e.curActiveKey),u("change",e.curActiveKey))}function X(o){e.curClassifyData={pid:o.id},e.dialogType=x.ADD,e.dialogVisible=!0}function O(o){e.curClassifyData=te.cloneDeep(o),e.dialogType=x.EDIT,e.dialogVisible=!0}function ie(o){Y(o.id,!0).then(p=>{const L=p?`删除【${o[e.treeProps.label]}】
        分类将一并删除其下的所有样式，当前分类下部分样式正在被服务引用，是否确定删除？`:`删除【${o[e.treeProps.label]}】分类将一并删除其下的所有样式，是否继续？`;ce.confirm(L,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{z.deleteClassify(o.id).then(s=>{s.code==="0000"?(E({type:"success",title:"删除成功"}),i(e.curActiveKey===o.id)):E({type:"error",title:"删除失败"})}).catch(s=>{E({type:"error",title:"删除失败",message:s.message||"服务连接有错"})})}).catch(()=>{})}).catch(()=>{})}function Y(o,p=!1){const L=p?"checkCatalogIsStylesUsed":"checkStylesIsUsed";return new Promise((s,d)=>{z[L](o).then(y=>{y.code==="0000"?s(y.data):(W({type:"warning",message:"检查样式是否被使用失败，请重试"}),d())}).catch(()=>{W({type:"error",message:"检查样式是否被使用失败，请重试"}),d()})})}function Z(){e.dialogType===x.ADD?(e.editData=te.cloneDeep(e.defaultData),e.editData.pid=e.curClassifyData.pid):e.dialogType===x.EDIT&&(e.editData={...e.curClassifyData}),re(()=>{K.value.clearValidate()})}function ee(){K.value.validate(o=>{if(o){const p=e.dialogType===x.ADD?"新增":"编辑",L=e.dialogType===x.ADD?"addClassify":"modifyClassify",s={...e.editData};e.dialogType!==x.ADD&&(delete s.children,delete s.level),e.submiting=!0,z[L](s).then(d=>{e.submiting=!1,d.code==="0000"?(E({type:"success",title:`${p}目录成功`}),e.dialogVisible=!1,i()):E({type:"error",title:`${p}目录失败`,message:d.message})}).catch(d=>{e.submiting=!1,E({type:"error",title:`${p}目录失败`,message:d.message})})}})}return H({treeRef:f,treeAsideRef:M}),(o,p)=>{const L=b("el-input"),s=b("el-button"),d=b("el-checkbox"),y=b("circle-plus"),k=b("ElIcon"),n=b("ElTooltip"),c=b("Edit"),m=b("Delete"),h=b("el-scrollbar"),V=b("el-form-item"),q=b("el-option"),S=b("el-select"),T=b("el-form"),_=b("el-dialog"),w=ne("action"),I=ne("loading");return P((v(),$("div",{ref_key:"treeAsideRef",ref:M,class:"common-tree","element-loading-text":"拼命加载中..."},[g("div",Pe,[a(L,{modelValue:e.filterText,"onUpdate:modelValue":p[0]||(p[0]=D=>e.filterText=D),placeholder:"请输入关键字搜索","prefix-icon":t(xe),clearable:""},null,8,["modelValue","prefix-icon"]),P(a(s,{class:"common-tree__header-btn",type:"primary",title:"新增",icon:t(Ve),plain:"",onClick:Q},null,8,["icon"]),[[w,"mapserver_styles_addcatalog"]])]),g("div",Oe,[a(d,{modelValue:e.checkAll,"onUpdate:modelValue":p[1]||(p[1]=D=>e.checkAll=D),label:"查看所有",size:"large",onChange:p[2]||(p[2]=D=>A(e.checkAll))},null,8,["modelValue"])]),a(h,{class:"common-tree__wrapper"},{default:l(()=>[a(t(Se),{ref_key:"treeRef",ref:f,data:e.classifyTreeData,props:e.treeProps,"node-key":"id","empty-text":"暂无数据","default-expand-all":"","default-expanded-keys":e.defaultExpandedkeys,"highlight-current":"","current-node-key":e.curActiveKey,"expand-on-click-node":!1,"filter-node-method":r,onCurrentChange:le},{default:l(({node:D,data:R})=>[g("span",qe,[g("span",We,[g("span",je,B(D.label),1)]),e.curActiveKey===R.id?(v(),$("div",Ge,[!R.isDefault&&R.level<4?P((v(),$("span",{key:0,onClick:de(C=>X(R),["stop"])},[a(n,{content:"添加子目录",placement:"bottom"},{default:l(()=>[a(k,{size:"16",color:"var(--el-color-primary)"},{default:l(()=>[a(y)]),_:1})]),_:1})],8,Je)),[[w,"mapserver_styles_addcatalog"]]):ae("",!0),R.isDefault?ae("",!0):P((v(),$("span",{key:1,onClick:de(C=>O(R),["stop"])},[a(n,{content:"编辑",placement:"bottom"},{default:l(()=>[a(k,{size:"16",color:"var(--el-color-primary)"},{default:l(()=>[a(c)]),_:1})]),_:1})],8,Qe)),[[w,"mapserver_styles_updatecatalog"]]),R.isDefault?ae("",!0):P((v(),$("span",{key:2,onClick:de(C=>ie(R),["stop"])},[a(n,{content:"删除",placement:"bottom"},{default:l(()=>[a(k,{size:"16",color:"var(--el-color-danger)"},{default:l(()=>[a(m)]),_:1})]),_:1})],8,Xe)),[[w,"mapserver_styles_deletecatalog"]])])):ae("",!0)])]),_:1},8,["data","props","default-expanded-keys","current-node-key"])]),_:1}),a(_,{modelValue:e.dialogVisible,"onUpdate:modelValue":p[7]||(p[7]=D=>e.dialogVisible=D),class:"center-dialog",title:(t(ge).get(e.dialogType)||"新增")+"目录","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:Z,onClosed:p[8]||(p[8]=D=>e.dialogVisible=!1)},{footer:l(()=>[g("span",at,[a(s,{onClick:p[6]||(p[6]=D=>e.dialogVisible=!1)},{default:l(()=>[U("取 消")]),_:1}),a(s,{type:"primary",loading:e.submiting,onClick:ee},{default:l(()=>[U(" 确 定 ")]),_:1},8,["loading"])])]),default:l(()=>[g("div",Ye,[a(T,{ref_key:"editForm",ref:K,class:"edit-form",inline:"",model:e.editData,rules:e.rules,"label-width":"100px","label-position":"right",onKeyup:$e(ee,["enter"])},{default:l(()=>[g("div",Ze,[a(V,{label:"目录名称：",prop:"name"},{default:l(()=>[a(L,{modelValue:e.editData.name,"onUpdate:modelValue":p[3]||(p[3]=D=>e.editData.name=D),type:"text",placeholder:"请输入目录名称",maxlength:"10","show-word-limit":""},null,8,["modelValue"])]),_:1})]),g("div",et,[a(V,{label:"上级目录：",prop:"pid"},{default:l(()=>[a(S,{modelValue:e.editData.pid,"onUpdate:modelValue":p[4]||(p[4]=D=>e.editData.pid=D),placeholder:"请选择上级目录",style:{width:"100%"}},{default:l(()=>[(v(!0),$(ye,null,be(N.value,D=>(v(),J(q,{key:D.value,label:D.label,value:D.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),g("div",tt,[a(V,{label:"描述：",prop:"description"},{default:l(()=>[a(L,{modelValue:e.editData.description,"onUpdate:modelValue":p[5]||(p[5]=D=>e.editData.description=D),type:"textarea",placeholder:"请输入描述",clearable:"",rows:6,maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","title"])])),[[I,e.isLoadingTree]])}}});const it=Me(lt,[["__scopeId","data-v-409e3de2"]]);function we(){const G=De("getClassifyTreeData"),H=se({treeProps:{label:"name",children:"children"},editData:{type:null}}),F=oe(()=>G==null?void 0:G()),u=oe(()=>Ce(F.value).value);function K(e){if(typeof e!="object")H.editData.type=null;else{const N=pe(e);H.editData.type={...f(N)}}}function f(e){const N={[H.treeProps.label]:u.value.get(e.id),id:e.id};return pe(N)}function M(e,N){for(const A of e){if(A.id===N)return A;if(A.children){const i=M(A.children,N);if(i)return i}}return null}return{...ke(H),classifyTreeData:F,handleTypeChange:K,getTypeObj:f,findTreeNodeById:M,catalogNameMap:u}}const ot={class:"main-content","element-loading-text":"数据获取中"},nt={class:"title"},st=g("span",null,"编辑样式",-1),rt={class:"main"},dt={class:"card"},ct=g("div",{class:"subtitle"},"数据信息",-1),pt={class:"content-wrap"},ut={class:"item-wrap item2"},ft={class:"item-wrap item2"},mt={class:"item-wrap"},gt={class:"card"},_t=g("div",{class:"subtitle"},"样式编码",-1),yt={class:"content-no-wrap"},ht={class:"file--container"},vt={class:"file-name"},bt={class:"file-tools"},Dt={style:{"min-height":"20px"}},kt=["src"],Ct=["accept"],Tt={class:"file-content"},wt={class:"footer"},xt=ue({__name:"EditStyleDialog",props:{visible:{type:Boolean,default:!1},domId:{default:""},curEditId:{default:""}},emits:["update:visible","save"],setup(G,{emit:H}){const F=G,u=H,{treeProps:K,editData:f,classifyTreeData:M,catalogNameMap:e}=we(),N=j(),A=j(),i=se({dialogVisible:!1,isLoadingData:!1,submiting:!1,checkNameing:!1,checkTimer:null,rules:{type:[{required:!0,message:"请选择所属目录",trigger:["change"]}],name:[{min:0,max:30,message:"长度在 30 个字符以内",trigger:["blur","change"]},{validator:O,trigger:["change","blur"]}]},acceptList:".sld",isHandling:!1,fileMaxSize:100,file:null,isSavingFile:!1,previewUrl:"",isLoadingImg:!1});_e(()=>F.visible,s=>{i.dialogVisible=s}),fe(()=>{});function Q(){i.isLoadingData=!0,i.previewUrl="",le(F.curEditId),re(()=>{var s;(s=N.value)==null||s.clearValidate()})}function r(){u("update:visible",!1)}function le(s){z.getStylesInfo(s).then(d=>{d.code==="0000"?(f.value={type:null,fileName:"",...te.cloneDeep(d.data)},f.value.name=X(f.value.name),i.acceptList=f.value.format.toLowerCase()==="sld"?".sld":".workspace",f.value.type={id:d.data.catalogId,[K.value.label]:e.value.get(d.data.catalogId)}):(W({type:"error",message:"获取信息失败"}),r())}).catch(()=>{W({type:"error",message:"获取信息错误"}),r()}).finally(()=>{i.isLoadingData=!1})}function X(s){return s=s.replace(/[`~!@#$%^&*()\-+=<>?:"{}|,./;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]/g,"").replace(/\s/g,""),s}function O(s,d,y){d?(i.checkNameing=!0,i.checkTimer&&clearTimeout(i.checkTimer),i.checkTimer=setTimeout(()=>{z.checkName(d,f.value.id||"").then(k=>{var n;i.checkNameing=!1,k.code==="0000"?(n=k.data)!=null&&n.exist?y(new Error("该样式名称已被使用")):y():y(new Error("后台验证失败，无法通过"))}).catch(()=>{i.checkNameing=!1,W({type:"error",message:"验证样式名称是否唯一请求失败"}),y(new Error("后台验证失败，无法通过"))})},500)):(i.checkTimer&&clearTimeout(i.checkTimer),i.checkNameing=!1,y())}function ie(s){return s.replace(/.+\./,"")}function Y(){A.value.click()}function Z(s){const{files:d}=s.target;if(d.length===0)return;const y=d[0];if(i.isHandling=!0,ie(y.name).toLowerCase()!==f.value.format.toLowerCase()){ce.alert("上传失败，请选择与原文件相同格式的文件上传","提示",{confirmButtonText:"确定",type:"error"}),s.target.value="",i.isHandling=!1;return}if(y.size&&y.size/1024/1024>i.fileMaxSize){ce.alert(`文件超过${i.fileMaxSize}MB! 无法上传`,"提示",{confirmButtonText:"确定",type:"error"}),s.target.value="",i.isHandling=!1;return}i.file=new File([y],y.name),i.isHandling=!1,s.target.value="",ee()}function ee(){const s=new FormData;s.append("file",i.file),i.isHandling=!0,z.getStyleFileContent(s).then(d=>{d.code==="0000"?(E({type:"success",title:"上传样式文件成功"}),f.value.content=d.data):E({type:"error",title:"上传样式文件失败",message:d.data})}).catch(d=>{E({type:"error",title:"上传样式文件失败",message:d.message})}).finally(()=>{i.isHandling=!1})}function o(){const{id:s,content:d}=f.value,y={id:s,content:d};i.isSavingFile=!0,z.saveStyleContent(y).then(k=>{k.code==="0000"?E({type:"success",title:"保存成功"}):E({type:"error",title:"保存失败",message:k.data})}).catch(k=>{E({type:"error",title:"保存失败",message:k.message})}).finally(()=>{i.isSavingFile=!1})}function p(){const{id:s}=f.value,d={styleId:s};i.isLoadingImg=!0,z.legendGraphicPreview(d).then(y=>{i.previewUrl=window.URL.createObjectURL(y.data.data)}).catch(y=>{i.previewUrl="",E({type:"error",title:"预览失败",message:y.message})}).finally(()=>{i.isLoadingImg=!1})}function L(){N.value.validate(s=>{if(s){const{name:d,type:y,description:k,content:n,id:c}=f.value,m={id:c,name:d,catalog:y[K.value.label],catalogId:y.id,description:k,content:n};i.submiting=!0,z.updateStyles(m).then(h=>{i.submiting=!1,h.code==="0000"?(E({type:"success",title:"编辑样式成功"}),r(),u("save")):E({type:"error",title:"编辑样式失败",message:h.data})}).catch(h=>{i.submiting=!1,E({type:"error",title:"编辑样式失败",message:h.message})})}})}return(s,d)=>{const y=b("ArrowLeft"),k=b("el-icon"),n=b("el-input"),c=b("el-form-item"),m=b("el-form"),h=b("el-button"),V=b("el-popover"),q=ne("loading");return v(),J(t(Be),{id:"edit-style-dialog",modelValue:i.dialogVisible,"onUpdate:modelValue":d[5]||(d[5]=S=>i.dialogVisible=S),class:"full-dialog common-full-dialog","append-to-dom":s.domId,"modal-append-to-body":!1,fullscreen:"","is-custom":"","close-on-press-escape":!1,onOpen:Q,onClosed:r},{default:l(()=>[P((v(),$("div",ot,[g("div",nt,[a(k,{onClick:r},{default:l(()=>[a(y)]),_:1}),st]),g("div",rt,[g("div",dt,[ct,g("div",pt,[a(m,{ref_key:"editForm",ref:N,class:"form edit-form",inline:"",model:t(f),rules:i.rules,"label-width":"auto","label-position":"right"},{default:l(()=>[g("div",ut,[a(c,{label:"样式名称",prop:"name"},{default:l(()=>[a(n,{modelValue:t(f).name,"onUpdate:modelValue":d[0]||(d[0]=S=>t(f).name=S),type:"text",placeholder:"请输入样式名称",maxlength:"30","show-word-limit":"","suffix-icon":i.checkNameing?t(Ne):"",onInput:d[1]||(d[1]=S=>t(f).name=X(S))},null,8,["modelValue","suffix-icon"])]),_:1}),a(c,{label:"所属目录",prop:"type"},{default:l(()=>[a(t(Te),{modelValue:t(f).type,"onUpdate:modelValue":d[2]||(d[2]=S=>t(f).type=S),"tree-props":t(K),"tree-data":t(M),"value-key":"id",clearable:"",style:{width:"100%"}},null,8,["modelValue","tree-props","tree-data"])]),_:1})]),g("div",ft,[a(c,{label:"创建人",prop:"creator"},{default:l(()=>[g("span",null,B(t(f).creator),1)]),_:1}),a(c,{label:"创建时间",prop:"createTime"},{default:l(()=>[g("span",null,B(t(f).createTime),1)]),_:1})]),g("div",mt,[a(c,{label:"样式说明",prop:"description"},{default:l(()=>[a(n,{modelValue:t(f).description,"onUpdate:modelValue":d[3]||(d[3]=S=>t(f).description=S),type:"text",placeholder:"请输入样式说明",clearable:""},null,8,["modelValue"])]),_:1})])]),_:1},8,["model","rules"])])]),g("div",gt,[_t,g("div",yt,[g("div",ht,[g("div",vt,B(t(f).fileName),1),g("div",bt,[a(h,{type:"primary",text:"",disabled:i.isHandling,onClick:Y},{default:l(()=>[U(" 上传 ")]),_:1},8,["disabled"]),a(h,{type:"primary",text:"",disabled:i.isSavingFile,onClick:o},{default:l(()=>[U(" 保存 ")]),_:1},8,["disabled"]),a(V,{trigger:"click",placement:"bottom",width:200,onShow:p},{reference:l(()=>[a(h,{type:"primary",text:""},{default:l(()=>[U("预览")]),_:1})]),default:l(()=>[P((v(),$("div",Dt,[i.previewUrl?(v(),$("img",{key:0,src:i.previewUrl,alt:""},null,8,kt)):ae("",!0)])),[[q,i.isLoadingImg]])]),_:1})]),g("input",{ref_key:"uploadFileRef",ref:A,style:{display:"none"},type:"file",class:"uploadFile",directory:"",nwdirectory:"",accept:i.acceptList,onChange:Z},null,40,Ct)]),g("div",Tt,[a(n,{modelValue:t(f).content,"onUpdate:modelValue":d[4]||(d[4]=S=>t(f).content=S),type:"textarea",autosize:{minRows:6,maxRows:10},style:{width:"100%"}},null,8,["modelValue"])])])])]),g("div",wt,[a(h,{onClick:r},{default:l(()=>[U("取消")]),_:1}),a(h,{type:"primary",loading:i.submiting,onClick:L},{default:l(()=>[U("保存")]),_:1},8,["loading"])])])),[[q,i.isLoadingData]])]),_:1},8,["modelValue","append-to-dom"])}}});const Vt={class:"style-register-content"},St={key:0,class:"item-wrap"},$t=["title"],Nt={key:1,class:"item-wrap"},Lt={key:2,class:"item-wrap tips"},Et={class:"item-wrap"},At={key:0},It={key:1},Rt={class:"item-wrap"},Ft={key:1},Ut={class:"item-wrap"},Kt={key:3,class:"item-wrap"},zt={key:4,class:"item-wrap"},Bt={class:"dialog-footer"},Ht=ue({__name:"StyleInfoDialog",props:{visible:{type:Boolean,default:!1},dialogType:{default:x.ADD},editId:{default:""}},emits:["update:visible","changeEdit","save"],setup(G,{emit:H}){const{treeProps:F,editData:u,classifyTreeData:K,catalogNameMap:f}=we(),M=G,e=H,N=De("getCatalogNode"),A=j(),i=j(),Q=j(),r=se({dialogVisible:!1,isLoading:!1,submiting:!1,defaultEditData:{name:"",type:null,description:"",fileName:""},rules:{type:[{required:!0,message:"请选择所属目录",trigger:["change"]}],fileName:[{required:!0,message:"请上传样式文件",trigger:["change"]}],name:[{min:0,max:30,message:"长度在 30 个字符以内",trigger:["blur","change"]},{validator:le,trigger:["change","blur"]}]},fileMaxSize:100,isHandling:!1,acceptList:".zip, .sld, .workspace",checkNameing:!1,checkTimer:null,fileList:[]});_e(()=>M.visible,n=>{r.dialogVisible=n});function le(n,c,m){c?(r.checkNameing=!0,r.checkTimer&&clearTimeout(r.checkTimer),r.checkTimer=setTimeout(()=>{z.checkName(c,u.value.id||"").then(h=>{var V;r.checkNameing=!1,h.code==="0000"?(V=h.data)!=null&&V.exist?m(new Error("该样式名称已被使用")):m():m(new Error("后台验证失败，无法通过"))}).catch(()=>{r.checkNameing=!1,W({type:"error",message:"验证样式名称是否唯一请求失败"}),m(new Error("后台验证失败，无法通过"))})},500)):(r.checkTimer&&clearTimeout(r.checkTimer),r.checkNameing=!1,m())}function X(){var n,c;if(r.isLoading=!0,(n=Q.value)==null||n.clearFiles(),r.fileList=[],r.isHandling=!1,M.dialogType===x.ADD){if(u.value=pe(r.defaultEditData),N!=null&&N())u.value.type={id:(c=N==null?void 0:N())==null?void 0:c.id,[F.value.label]:""};else{const m=K.value.find(h=>h.isDefault);u.value.type={id:m==null?void 0:m.id,[F.value.label]:""}}u.value.type[F.value.label]=f.value.get(u.value.type.id),r.isLoading=!1}else Y(M.editId);re(()=>{var m;(m=A.value)==null||m.clearValidate()})}function O(){e("update:visible",!1),u.value={}}function ie(){O(),e("changeEdit")}function Y(n){z.getStylesInfo(n).then(c=>{c.code==="0000"?(u.value={type:null,fileName:"",...pe(c.data)},u.value.name=ee(u.value.name),u.value.type={id:c.data.catalogId,[F.value.label]:f.value.get(c.data.catalogId)}):W({type:"error",message:"获取信息失败"})}).catch(()=>{W({type:"error",message:"获取信息错误"})}).finally(()=>{r.isLoading=!1})}function Z(n){return n.replace(/.+\./,"")}function ee(n){return n=n.replace(/[`~!@#$%^&*()\-+=<>?:"{}|,./;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]/g,"").replace(/\s/g,""),n}function o(){A.value.validate(n=>{if(n){const{name:c,type:m,description:h}=u.value,V={name:c,catalog:m[F.value.label],catalogId:m.id,description:h},q=ge.get(M.dialogType);r.submiting=!0,V.files=[];for(let T=0;T<r.fileList.length;T++)V.files.push(r.fileList[T].raw);const S=new FormData;for(const T in V)if(T==="files")for(let _=0;_<V[T].length;_++)S.append("files",V[T][_]);else S.append(T,V[T]);z.registerStyles(S).then(T=>{r.submiting=!1,T.code==="0000"?(E({type:"success",title:`${q}样式成功`}),O(),e("save")):E({type:"error",title:`${q}样式失败`,message:T.data})}).catch(T=>{r.submiting=!1,E({type:"error",title:`${q}样式失败`,message:T.message})})}})}function p(n,c){}function L(n,c){var m;r.fileList=c,u.value.fileName=c.length===0?"":"fileName",(m=A.value)==null||m.validateField("fileName"),s()}function s(){const n=["sld","workspace","zip"];for(let c=0,m=r.fileList.length;c<m;c++){const h=r.fileList[c],V=Z(h.name).toLowerCase();n.includes(V)?h.size&&h.size/1024/1024>r.fileMaxSize&&(W({type:"error",message:`【${h.name}】文件超过${r.fileMaxSize}MB，无法上传，已自动过滤`}),y(h)):(W({type:"error",message:`【${h.name}】文件格式不符合，已自动过滤`}),y(h))}}function d(n){}function y(n){var c,m,h;r.fileList=r.fileList.filter(V=>V.uid!==n.uid),u.value.fileName=r.fileList.length===0?"":"fileName",(c=A.value)==null||c.validateField("fileName"),Q.value.handleRemove(n),r.fileList.length===0&&((h=(m=t(i).popperRef)==null?void 0:m.triggerRef)==null||h.click())}const k=oe(()=>n=>{var c;return((c=n==null?void 0:n.type)==null?void 0:c[F.value.label])||""});return(n,c)=>{const m=b("el-button"),h=b("el-upload"),V=b("Close"),q=b("el-icon"),S=b("el-popover"),T=b("el-form-item"),_=b("el-input"),w=b("el-form"),I=b("el-dialog"),D=ne("loading"),R=ne("action");return v(),J(I,{modelValue:r.dialogVisible,"onUpdate:modelValue":c[3]||(c[3]=C=>r.dialogVisible=C),class:"center-dialog",title:(t(ge).get(n.dialogType)||"新增")+"样式","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"500px",onOpen:X,onClosed:O},{footer:l(()=>[g("span",Bt,[a(m,{onClick:c[2]||(c[2]=C=>r.dialogVisible=!1)},{default:l(()=>[U("取 消")]),_:1}),n.dialogType!==t(x).CHECK?P((v(),J(m,{key:0,type:"primary",disabled:r.isHandling,loading:r.submiting,onClick:o},{default:l(()=>[U("确 定")]),_:1},8,["disabled","loading"])),[[R,"mapserver_styles_update"]]):P((v(),J(m,{key:1,type:"primary",onClick:ie},{default:l(()=>[U(" 编辑 ")]),_:1})),[[R,"mapserver_styles_update"]])])]),default:l(()=>[P((v(),$("div",Vt,[a(w,{ref_key:"editFormRef",ref:A,class:"edit-form",inline:"",model:t(u),rules:r.rules,"label-width":"100px","label-position":"right"},{default:l(()=>[n.dialogType===t(x).ADD?(v(),$("div",St,[a(T,{label:"样式文件：",prop:"fileName",class:"zipUploadItem"},{default:l(()=>[a(h,{ref_key:"uploadRef",ref:Q,class:"upload-demo",action:"fakeaction",multiple:"",accept:r.acceptList,"on-change":L,"on-remove":p,"file-list":r.fileList,"auto-upload":!1,"show-file-list":!1,"http-request":d},{trigger:l(()=>[a(m,{type:"primary",icon:t(Le)},{default:l(()=>[U("选取文件")]),_:1},8,["icon"])]),_:1},8,["accept","file-list"]),a(S,{ref_key:"popoverRef",ref:i,"popper-class":"algorithm-filelist-popover",placement:"bottom-end",width:"400px","hide-after":0,trigger:"click"},{reference:l(()=>[a(m,{class:"listBtn",disabled:r.fileList.length===0},{default:l(()=>[U(" 已选取 "+B(r.fileList.length)+" 个文件，点击查看 ",1)]),_:1},8,["disabled"])]),default:l(()=>[(v(!0),$(ye,null,be(r.fileList,C=>(v(),$("div",{key:C.uid,class:"text item"},[g("span",{class:"fileName",title:C.name},B(C.name),9,$t),a(q,{class:"delete",title:"移除",onClick:me=>y(C)},{default:l(()=>[a(V)]),_:2},1032,["onClick"])]))),128))]),_:1},512)]),_:1})])):(v(),$("div",Nt,[a(T,{label:"样式文件：",prop:"fileName"},{default:l(()=>[g("span",null,B(t(u).fileName),1)]),_:1})])),n.dialogType!==t(x).CHECK?(v(),$("div",Lt,B(n.dialogType===t(x).EDIT?"仅支持上传与原文件相同格式的文件":"支持扩展名：.workspace .sld .zip；sld样式携带svg/png等文件时请使用.zip压缩包进行上传；文件不超过100MB"),1)):ae("",!0),g("div",Et,[a(T,{label:"样式名称：",prop:"name"},{default:l(()=>[n.dialogType===t(x).ADD?(v(),$("span",At,"默认为文件对应的名称")):(v(),$("span",It,B(t(u).name),1))]),_:1})]),g("div",Rt,[a(T,{label:"所属目录：",prop:"type"},{default:l(()=>[n.dialogType!==t(x).CHECK?(v(),J(t(Te),{key:0,modelValue:t(u).type,"onUpdate:modelValue":c[0]||(c[0]=C=>t(u).type=C),"tree-props":t(F),"tree-data":t(K),"value-key":"id",clearable:"",style:{width:"100%"}},null,8,["modelValue","tree-props","tree-data"])):(v(),$("span",Ft,B(k.value(t(u))),1))]),_:1})]),g("div",Ut,[a(T,{label:"样式说明：",prop:"description"},{default:l(()=>[n.dialogType!==t(x).CHECK?(v(),J(_,{key:0,modelValue:t(u).description,"onUpdate:modelValue":c[1]||(c[1]=C=>t(u).description=C),type:"textarea",placeholder:"请输入样式说明",clearable:"",rows:3,maxlength:"100","show-word-limit":""},null,8,["modelValue"])):(v(),$("span",{key:1,class:Ee(["description",t(u).description?"":"empty"])},B(t(u).description||"未说明"),3))]),_:1})]),n.dialogType===t(x).CHECK?(v(),$("div",Kt,[a(T,{label:"创建人：",prop:"creator"},{default:l(()=>[g("span",null,B(t(u).creator),1)]),_:1})])):ae("",!0),n.dialogType===t(x).CHECK?(v(),$("div",zt,[a(T,{label:"创建时间：",prop:"createTime"},{default:l(()=>[g("span",null,B(t(u).createTime),1)]),_:1})])):ae("",!0)]),_:1},8,["model","rules"])])),[[D,r.isLoading]])]),_:1},8,["modelValue","title"])}}});function Mt(){const G=se({searchOptions:[{label:"关键字",key:"name",type:"text",placeholder:"样式名称",span:5},{label:"文件格式",key:"format",type:"select",options:[{label:"所有",value:""},{label:"SLD",value:"SLD"},{label:"workspace",value:"WORKSPACE"}],clearable:!0,span:5}],columns:[{prop:"name",label:"样式名称",minWidth:120,slot:"name"},{prop:"catalog",label:"所属目录",minWidth:120,slot:"catalog"},{prop:"format",label:"文件格式",minWidth:120},{prop:"description",label:"样式描述",minWidth:120},{prop:"creator",label:"创建人",minWidth:120},{prop:"createTime",label:"创建时间",minWidth:120}]}),H=async()=>{};return fe(async()=>{H()}),{...ke(G)}}const ta=ue({__name:"index",setup(G){const{searchOptions:H,columns:F}=Mt(),u=j(),K={catalogId:"#"},{data:f,total:M,pageNo:e,pageSize:N,multipleSelection:A,loading:i,handleSizeChange:Q,handleCurrentChange:r,handleSelectionChange:le,handleSearch:X,initData:O}=Ae(z.getStylesPageList,K),ie=j(),Y=j(),Z=j(),ee=oe(()=>{var _;return(_=Z.value)==null?void 0:_.$el}),o=se({domId:"styles-manage-wrap",classifyTreeData:[],infoDialogVisible:!1,infoDialogType:x.ADD,editStyleId:"",editDialogVisible:!1});he("getClassifyTreeData",d),he("getCatalogNode",y);const p=oe(()=>Ce(o.classifyTreeData).value);fe(()=>{O()});function L(_){o.classifyTreeData=_}function s(_){return p.value.get(`${_.catalogId}`)||"未知目录"}function d(){const _=te.cloneDeep(o.classifyTreeData);return!_||_.length===0?[]:_}function y(){var _,w;return((w=(_=Y.value)==null?void 0:_.treeRef)==null?void 0:w.getCurrentNode())||null}function k(_){K.catalogId!==_&&(K.catalogId=_,X())}function n(){o.infoDialogType=x.ADD,o.editStyleId="",o.infoDialogVisible=!0}function c(_){o.editStyleId=_.id,o.infoDialogType=x.CHECK,o.infoDialogVisible=!0}function m(_){o.editStyleId=_.id,o.editDialogVisible=!0}function h(){o.editDialogVisible=!0}function V({id:_,name:w}){S(_).then(I=>{const D=I?`样式【${w}】被服务引用中，是否确定删除？`:`删除【${w}】样式, 是否继续？`;T(_,D)}).catch(()=>{})}function q(){const w=te.cloneDeep(A.value).map(I=>I.id).join(",");S(w).then(I=>{T(w,I?"存在被服务引用的样式，是否确定批量删除选中数据？":"是否批量删除选中数据？",!0)}).catch(()=>{})}function S(_,w=!1){const I=w?"checkCatalogIsStylesUsed":"checkStylesIsUsed";return new Promise((D,R)=>{z[I](_).then(C=>{C.code==="0000"?D(C.data):(W({type:"warning",message:"检查样式是否被使用失败，请重试"}),R())}).catch(()=>{W({type:"error",message:"检查样式是否被使用失败，请重试"}),R()})})}function T(_,w,I=!1){ce.confirm(w,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{i.value=!0,z.deleteStyles(_).then(D=>{i.value=!1,D.code==="0000"&&(O(),I&&(A.value=[]))}).catch(()=>{i.value=!1})}).catch(()=>{})}return(_,w)=>{const I=b("el-button"),D=b("el-link"),R=ne("action");return v(),$(ye,null,[a(t(ve),{id:"styles-manage-wrap",background:""},{default:l(()=>[a(t(Ie),{ref_key:"asideRef",ref:Z,padding:""},{default:l(()=>[a(it,{ref_key:"catalogTreeRef",ref:Y,onChange:k,onSetData:L},null,512)]),_:1},512),a(t(ve),{id:"styles-setting",ref_key:"mainContainerRef",ref:ie},{default:l(()=>[a(t(Re),{target:ee.value},null,8,["target"]),a(t(Fe),{padding:"1 1 0",border:""},{default:l(()=>[a(t(Ue),{ref_key:"SmartSearchRef",ref:u,options:t(H),onHandleSearch:t(X)},null,8,["options","onHandleSearch"])]),_:1}),a(t(Ke),null,{default:l(()=>[a(t(ze),{ref:"baseTable","operation-width":"220",columns:t(F),"table-data":t(f),"current-page":t(e),"page-size":t(N),total:t(M),"pagination-is-need":!0,"operation-is-need":!0,loading:t(i),"search-form-ref":u.value,"selection-is-need":!0,"index-is-need":!1,onSizeChange:t(Q),onCurrentChange:t(r),onSelectionChange:t(le)},{"smart-table_operation":l(()=>[P((v(),J(I,{type:"primary",onClick:n},{default:l(()=>[U(" 新增样式 ")]),_:1})),[[R,"mapserver_styles_add"]])]),"smart-table_batch-operation":l(()=>[a(I,{link:"",type:"danger",onClick:q},{default:l(()=>[U(" 批量删除 ")]),_:1})]),name:l(({scope:C})=>[a(D,{type:"primary",onClick:me=>c(C.row)},{default:l(()=>[U(B(C.row.name),1)]),_:2},1032,["onClick"])]),catalog:l(({scope:C})=>[g("span",null,B(s(C.row)),1)]),operation:l(({scope:C})=>[P((v(),J(I,{type:"primary",link:"",onClick:de(me=>m(C.row),["stop"])},{default:l(()=>[U(" 编辑 ")]),_:2},1032,["onClick"])),[[R,"mapserver_styles_update"]]),P((v(),J(I,{type:"danger",link:"",onClick:de(me=>V(C.row),["stop"])},{default:l(()=>[U(" 删除 ")]),_:2},1032,["onClick"])),[[R,"mapserver_styles_delete"]])]),_:1},8,["columns","table-data","current-page","page-size","total","loading","search-form-ref","onSizeChange","onCurrentChange","onSelectionChange"])]),_:1})]),_:1},512)]),_:1}),a(Ht,{visible:o.infoDialogVisible,"onUpdate:visible":w[0]||(w[0]=C=>o.infoDialogVisible=C),"dialog-type":o.infoDialogType,"edit-id":o.editStyleId,onSave:t(O),onChangeEdit:h},null,8,["visible","dialog-type","edit-id","onSave"]),a(xt,{visible:o.editDialogVisible,"onUpdate:visible":w[1]||(w[1]=C=>o.editDialogVisible=C),"dom-id":o.domId,"cur-edit-id":o.editStyleId,onSave:t(O)},null,8,["visible","dom-id","cur-edit-id","onSave"])],64)}}});export{ta as default};
