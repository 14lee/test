import{d as Oe,i as we,b as ee,r as Fe,w as Ke,N as Xe,aj as oe,e as y,t as ea,o as t,f as c,g as r,j as a,u as l,$ as ga,v as ze,x as k,k as e,F as ae,y as ve,U as Re,B as z,z as G,l as q,a6 as ta,Z as Va,_ as Ca,W as Wa,A as wa,c as Se,S as ra,ai as he,ag as Fa,V as it,p as Be,bc as ua,n as He,bm as Ea,ak as Le,bV as Ba,bE as za,bG as ja,X as $a,ae as Ga,b1 as Oa,bH as Ha,ad as la,b3 as rt,al as Qe,aK as dt,bW as ut,bI as Ka,bF as ct,bo as pt}from"./element-plus.59ccb443.js";import{_ as ya,u as _a,e as mt}from"./error.229cea25.js";import{D as Ja,v as fa,x as ha,z as Ya,b as Xa,u as ft,t as gt,w as yt,y as _t,A as bt}from"./login.a4e9287e.js";import{S as xe}from"./serviceManage.8c46f250.js";import{f as qa,i as pa,b as Ye,G as vt,C as ht,h as va,D as De,d as Tt,S as It}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{l as Dt}from"./loseImg1.511f080c.js";import{_ as Za}from"./CatalogTree.vue_vue_type_script_setup_true_lang.900e7dde.js";import{u as kt,_ as St}from"./useReleaseForm.629f3403.js";import{m as We,i as Qa,h as Vt,S as xa,a4 as Ra,a5 as La,j as Ct,k as et}from"./index-a95bb620.js";import{D as wt}from"./index.533bb29b.js";import{q as Ie,v as Je}from"./lodash.22f463b4.js";import{A as da,S as ma,s as Ft,u as at,f as tt,j as Ta,a as ia,b as Ia,d as sa,c as Da,e as ka,g as Et,D as Ze,k as Sa}from"./useLayerGroupCommon.69b653b4.js";import{u as ba}from"./useTableAndPagination.0c6e0294.js";import{S as Aa}from"./index.cc7bef78.js";import"../../app-config.js";import"./SmartMap.vue_vue_type_style_index_0_lang.6bf21d60.js";import"./smart3d.ce055bc9.js";import"./echarts.39e3cf74.js";import"./wujie-vue3.9ecbe737.js";import"./smartweb3.2d5e4c59.js";import"./smart-ui.e8e0134c.js";const $t=re=>(Va("data-v-93be214e"),re=re(),Ca(),re),Ot={class:"top toolbar"},xt={class:"commonSearchForm"},Rt={class:"table center"},Lt=$t(()=>r("div",null,"选中",-1)),At={key:0,class:"delete-icon"},Nt={key:0},Ut={key:1},Pt={key:2},Mt={class:"bottom pagination"},Bt={key:1},zt=Oe({__name:"LayerGroup",emits:["cancel","publish"],setup(re,{expose:te,emit:h}){const I=we("originalDataType"),A=h,b=ee(),n=ee(),v=ee(),T=[{prop:"name",label:"数据名称"},{prop:"dataType",label:"数据类型"},{prop:"creator",label:"创建人"},{prop:"createTime",label:"创建时间"}],C=ee(""),w=Fe({isLoadingTable:!1,colDatas:[{prop:"name",label:"数据集名称",minWidth:180},{prop:"dataType",label:"数据类型",width:180},{prop:"creator",label:"创建人",minWidth:120},{prop:"createTime",label:"创建时间",minWidth:200}],tableData:[],form:{keywords:"",dataType:""}}),{currentPage:R,pageSize:U,pageSizes:H,total:f,handleSizeChange:p,handleCurrentPageChange:pe}=ba(b,n,S);Ke(I,s=>{w.form.dataType=s,S()}),Xe(()=>{w.form.dataType=I.value,S()});function S(){w.isLoadingTable=!0;const s={page:R.value,rows:U.value,...w.form};da.getResourcesetPageList(s).then($=>{w.isLoadingTable=!1,$.code==="0000"?(w.tableData=$.data?$.data.records:[],w.tableData||(w.tableData=[]),f.value=$.data?$.data.total:0):oe({type:"error",message:$.message||"获取数据失败"})}).catch($=>{w.isLoadingTable=!1,w.tableData=[],f.value=w.tableData.length})}function u(){R.value=1,S()}const g=Ie.debounce(u,200),o=()=>{var s;w.form.keywords="",C.value="",v.value={},(s=n.value)==null||s.setCurrentRow()};function d(s){v.value=s,C.value=(s==null?void 0:s.id)??""}return te({reset:o}),(s,$)=>{var W;const E=y("el-input"),i=y("el-radio"),L=y("el-table-column"),P=y("el-table"),m=y("el-pagination"),le=y("el-button"),se=ea("loading");return t(),c("div",{ref_key:"mainContainerRef",ref:b,class:"container common-flex-container"},[r("div",Ot,[r("div",xt,[a(E,{modelValue:w.form.keywords,"onUpdate:modelValue":$[0]||($[0]=D=>w.form.keywords=D),class:"search-input",clearable:"",placeholder:"数据集标识/名称","prefix-icon":l(ga),onClear:u,onInput:l(g)},null,8,["modelValue","prefix-icon","onInput"])])]),r("div",Rt,[ze((t(),k(P,{ref_key:"tableRef",ref:n,"class-name":"layerGroupTable data-table","element-loading-text":"拼命加载中...",style:{width:"100%"},data:w.tableData,stripe:"","row-key":"id","max-height":500,border:"","highlight-current-row":"","default-expand-all":"",onCurrentChange:d},{default:e(()=>[a(L,{align:"center",label:"选中",width:"55px","class-name":"radio-column"},{default:e(D=>{var J;return[a(i,{modelValue:C.value,"onUpdate:modelValue":$[1]||($[1]=Y=>C.value=Y),label:(J=D.row)==null?void 0:J.id},{default:e(()=>[Lt]),_:2},1032,["modelValue","label"])]}),_:1}),a(L,{type:"expand"},{default:e(D=>[a(P,{class:"expandTable",data:D.row.resourceDatas,border:!1},{default:e(()=>[(t(),c(ae,null,ve(T,J=>a(L,{key:J.prop,prop:J.prop,label:J.label,align:"center"},{default:e(Y=>{var M,N,ue,me,K,X;return[J.prop==="dataType"?(t(),c("span",{key:0,class:Re({is_delete:((M=Y.row)==null?void 0:M.delFlag)===1})},z((N=Y.row)==null?void 0:N.dataTypeAliasName)+" / "+z((me=(ue=Y.row)==null?void 0:ue.dataFormat)==null?void 0:me.toLowerCase()),3)):(t(),c("span",{key:1,class:Re({is_delete:((K=Y.row)==null?void 0:K.delFlag)===1})},[J.prop==="name"&&((X=Y.row)==null?void 0:X.delFlag)===1?(t(),c("i",At)):G("",!0),q(" "+z(Y.row[J.prop]),1)],2))]}),_:2},1032,["prop","label"])),64))]),_:2},1032,["data"])]),_:1}),(t(!0),c(ae,null,ve(w.colDatas,D=>(t(),k(L,{key:D.prop,prop:D.prop,label:D.label,width:D.width,"min-width":D.minWidth,align:"center"},{default:e(J=>{var Y,M,N;return[D.prop==="dataType"?(t(),c("span",Nt,z((Y=J.row)==null?void 0:Y.dataTypeAliasName)+" / "+z((N=(M=J.row)==null?void 0:M.dataFormat)==null?void 0:N.toLowerCase()),1)):D.prop==="publishStatus"?(t(),c("span",Ut,[r("i",{class:Re(["status-icon",{not_publish:J.row[D.prop]===l(ma).NOT_PUBLISH,published:J.row[D.prop]===l(ma).PUBLISHED,publishing:J.row[D.prop]===l(ma).PUBLISHING,publish_fail:J.row[D.prop]===l(ma).PUBLISH_FAIL}])},null,2),q(" "+z(l(Ft).get(J.row[D.prop])||"未知状态"),1)])):(t(),c("span",Pt,z(J.row[D.prop]),1))]}),_:2},1032,["prop","label","width","min-width"]))),128))]),_:1},8,["data"])),[[se,w.isLoadingTable]])]),r("div",Mt,[l(f)&&l(f)>0?(t(),k(m,{key:0,"current-page":l(R),"onUpdate:currentPage":$[2]||($[2]=D=>ta(R)?R.value=D:null),"page-size":l(U),"onUpdate:pageSize":$[3]||($[3]=D=>ta(U)?U.value=D:null),layout:"sizes, prev, pager, next, total","page-sizes":l(H),total:l(f),onSizeChange:l(p),onCurrentChange:l(pe)},null,8,["current-page","page-size","page-sizes","total","onSizeChange","onCurrentChange"])):(t(),c("div",Bt)),r("div",null,[a(le,{onClick:$[4]||($[4]=D=>A("cancel"))},{default:e(()=>[q("取消")]),_:1}),a(le,{type:"primary",disabled:!((W=v.value)!=null&&W.id),onClick:$[5]||($[5]=D=>A("publish",v.value))},{default:e(()=>[q(" 确定 ")]),_:1},8,["disabled"])])])],512)}}});const Gt=ya(zt,[["__scopeId","data-v-93be214e"]]),qt=re=>(Va("data-v-c9991af0"),re=re(),Ca(),re),Wt={class:"top toolbar"},jt={class:"commonSearchForm"},Ht={class:"table center"},Kt=qt(()=>r("div",null,"选中",-1)),Jt={key:0},Yt=["title"],Xt={class:"bottom pagination"},Zt={key:1},Qt=Oe({__name:"ResultData",emits:["cancel","publish"],setup(re,{expose:te,emit:h}){const I=we("originalDataType"),A=h,b=ee(),n=ee(),v=ee(),T=[{prop:"name",label:"数据名称",minWidth:160},{prop:"dataTypeAliasName",label:"数据类型",minWidth:130},{prop:"dataSize",label:"数据大小",width:110},{prop:"creator",label:"切片人",width:110},{prop:"createTime",label:"切片时间",minWidth:165}],C=ee(""),w=Fe({isLoadingTable:!1,colDatas:T,tableData:[],form:{keyword:"",status:"",dataType:""}}),{currentPage:R,pageSize:U,pageSizes:H,total:f,handleSizeChange:p,handleCurrentPageChange:pe}=ba(b,n,S);Ke(I,E=>{w.form.dataType=E,S()}),Xe(()=>{w.form.dataType=I.value,S()});function S(){w.isLoadingTable=!0;const E={page:R.value,rows:U.value,...w.form,resultData:!0};We.getDataPageList(E).then(i=>{w.isLoadingTable=!1,i.code==="0000"?(w.tableData=i.data?i.data.records:[],w.tableData||(w.tableData=[]),f.value=i.data?i.data.total:0):oe({type:"error",message:i.message||"获取表格数据失败"})}).catch(i=>{w.isLoadingTable=!1,oe({type:"error",message:i.message||"获取表格数据错误"})})}function u(){R.value=1,S()}function g(E,i,L){let P=0,m=0;return E[L.prop]&&(P=Number(E[L.prop].replace("M",""))),i[L.prop]&&(m=Number(i[L.prop].replace("M",""))),P-m}function o(E,i){const L=new Map;L.set("SLICING",0),L.set("UPLOAD_FAIL",1),L.set("NOT_PROCESS",2),L.set("PROCESSED",3),L.set("PUBLISHED",4),L.set("UPLOADING",5),L.set("PROCESSING",6);const P=L.get(E.status)||0,m=L.get(i.status)||0;return P-m}const d=Ie.debounce(u,200),s=()=>{var E;w.form.keyword="",C.value="",v.value={},(E=n.value)==null||E.setCurrentRow()};function $(E){v.value=E,C.value=(E==null?void 0:E.resourceId)??""}return te({reset:s}),(E,i)=>{var J;const L=y("el-input"),P=y("el-radio"),m=y("el-table-column"),le=y("el-table"),se=y("el-pagination"),W=y("el-button"),D=ea("loading");return t(),c("div",{ref_key:"mainContainerRef",ref:b,class:"container common-flex-container"},[r("div",Wt,[r("div",jt,[a(L,{modelValue:w.form.keyword,"onUpdate:modelValue":i[0]||(i[0]=Y=>w.form.keyword=Y),class:"search-input",clearable:"",placeholder:"数据名称/创建者","prefix-icon":l(ga),onClear:u,onInput:l(d)},null,8,["modelValue","prefix-icon","onInput"])])]),r("div",Ht,[ze((t(),k(le,{ref_key:"tableRef",ref:n,class:"data-table","element-loading-text":"拼命加载中...",style:{width:"100%"},data:w.tableData,"max-height":500,"row-key":"resourceId",border:"",stripe:"","highlight-current-row":"",onCurrentChange:$},{default:e(()=>[a(m,{align:"center",label:"选中",width:"55px","class-name":"radio-column"},{default:e(Y=>{var M;return[a(P,{modelValue:C.value,"onUpdate:modelValue":i[1]||(i[1]=N=>C.value=N),label:(M=Y.row)==null?void 0:M.resourceId},{default:e(()=>[Kt]),_:2},1032,["modelValue","label"])]}),_:1}),(t(!0),c(ae,null,ve(w.colDatas,Y=>(t(),k(m,Wa({key:Y.prop,ref_for:!0},Y,{sortable:!0,"sort-method":Y.prop==="dataSize"?(M,N)=>g(M,N,Y):void 0,align:"center"}),{default:e(M=>[Y.prop==="resourceType"?(t(),c("span",Jt,z(M.row.resourceType==="DB"?M.row.storagetype:"文件上传"),1)):(t(),c("span",{key:1,class:Re({ellipsis1:Y.prop==="name"}),title:M.row[Y.prop]},[Y.prop==="dataSize"?(t(),c(ae,{key:0},[q(z(M.row[Y.prop]||"--"),1)],64)):(t(),c(ae,{key:1},[q(z(M.row[Y.prop]),1)],64))],10,Yt))]),_:2},1040,["sort-method"]))),128)),a(m,{label:"数据状态",width:"110px","header-align":"center",align:"center",fixed:"right",sortable:"","sort-method":o},{default:e(Y=>[r("span",{class:Re(["data-status",Y.row.status])},z(Y.row.status==="PUBLISHED"?"已发布":"未发布"),3)]),_:1})]),_:1},8,["data"])),[[D,w.isLoadingTable]])]),r("div",Xt,[l(f)&&l(f)>0?(t(),k(se,{key:0,"current-page":l(R),"onUpdate:currentPage":i[2]||(i[2]=Y=>ta(R)?R.value=Y:null),"page-size":l(U),"onUpdate:pageSize":i[3]||(i[3]=Y=>ta(U)?U.value=Y:null),layout:"sizes, prev, pager, next, total","page-sizes":l(H),total:l(f),onSizeChange:l(p),onCurrentChange:l(pe)},null,8,["current-page","page-size","page-sizes","total","onSizeChange","onCurrentChange"])):(t(),c("div",Zt)),r("div",null,[a(W,{onClick:i[4]||(i[4]=Y=>A("cancel"))},{default:e(()=>[q("取消")]),_:1}),a(W,{type:"primary",disabled:!((J=v.value)!=null&&J.resourceId),onClick:i[5]||(i[5]=Y=>A("publish",v.value))},{default:e(()=>[q(" 确定 ")]),_:1},8,["disabled"])])])],512)}}});const el=ya(Qt,[["__scopeId","data-v-c9991af0"]]),al=re=>(Va("data-v-c6a51cf4"),re=re(),Ca(),re),tl=al(()=>r("div",null,"选中",-1)),ll={key:0},ol=["title"],nl=Oe({__name:"DataResource",emits:["select"],setup(re,{expose:te,emit:h}){const I=we("originalDataType"),A=h,b=ee(),n=ee(),v=ee(),T=ee(),C=[{prop:"name",label:"数据名称",minWidth:160},{prop:"dataTypeAliasName",label:"数据类型",minWidth:130},{prop:"dataSize",label:"数据大小",width:110},{prop:"creator",label:"创建人",width:110},{prop:"createTime",label:"创建时间",width:165}],w=ee(""),R=Fe({isLoadingTable:!1,colDatas:C,tableData:[],curCatalogId:"#",form:{keyword:"",status:"PROCESSED",dataType:"",catalogId:"",resultData:!1}}),{currentPage:U,pageSize:H,pageSizes:f,total:p,handleSizeChange:pe,handleCurrentPageChange:S}=ba(b,v,u);Ke(I,i=>{R.form.dataType=i,u()}),Xe(()=>{R.form.dataType=I.value,u()});function u(){R.isLoadingTable=!0;const i={page:U.value,rows:H.value,...R.form};We.getDataPageList(i).then(L=>{R.isLoadingTable=!1,L.code==="0000"?(R.tableData=L.data?L.data.records:[],R.tableData||(R.tableData=[]),p.value=L.data?L.data.total:0):oe({type:"error",message:L.message||"获取表格数据失败"})}).catch(L=>{R.isLoadingTable=!1,oe({type:"error",message:L.message||"获取表格数据错误"})})}function g(i=""){i==="changeServiceType"&&(R.tableData=[]),U.value=1,u()}function o(i,L,P){let m=0,le=0;return i[P.prop]&&(m=Number(i[P.prop].replace("M",""))),L[P.prop]&&(le=Number(L[P.prop].replace("M",""))),m-le}function d(i){R.curCatalogId=i,R.form.catalogId!==i&&(R.form.catalogId=i,g())}const s=()=>{var i,L;R.curCatalogId="#",R.form.keyword="",w.value="",T.value={},(i=v.value)==null||i.setCurrentRow(),(L=n.value)==null||L.resetFilter()};function $(i){var L;return`${i.dataTypeAliasName} / ${((L=i.dataFormat)==null?void 0:L.toLocaleLowerCase())??"--"}`}function E(i){T.value=i,w.value=(i==null?void 0:i.resourceId)??"",A("select",T.value)}return te({reset:s}),(i,L)=>{const P=y("el-input"),m=y("el-form-item"),le=y("el-form"),se=y("el-radio"),W=y("el-table-column"),D=y("el-table"),J=y("el-pagination"),Y=ea("loading");return t(),k(l(fa),{ref_key:"mainContainerRef",ref:b},{default:e(()=>[a(l(Ja),null,{default:e(()=>[a(Za,{ref_key:"catalogTreeRef",ref:n,onChange:d},null,512)]),_:1}),a(l(fa),{style:{display:"flex",flex:"1","flex-direction":"column","padding-left":"20px"}},{default:e(()=>[a(l(ha),null,{default:e(()=>[a(le,{inline:!0,class:"commonSearchForm",style:{"min-width":"545px"},onKeyup:wa(g,["enter"])},{default:e(()=>[a(m,null,{default:e(()=>[a(P,{modelValue:R.form.keyword,"onUpdate:modelValue":L[0]||(L[0]=M=>R.form.keyword=M),class:"search-input",clearable:"",placeholder:"数据名称/创建者","prefix-icon":l(ga),onClear:g},null,8,["modelValue","prefix-icon"])]),_:1})]),_:1})]),_:1}),a(l(Ya),{padding:"0 0"},{default:e(()=>[ze((t(),k(D,{ref_key:"tableRef",ref:v,class:"data-table","element-loading-text":"拼命加载中...",style:{width:"100%"},data:R.tableData,"max-height":500,"row-key":"resourceId",stripe:"",height:"100%","highlight-current-row":"",onCurrentChange:E},{default:e(()=>[a(W,{align:"center",label:"选中",width:"55px","class-name":"radio-column"},{default:e(M=>{var N;return[a(se,{modelValue:w.value,"onUpdate:modelValue":L[1]||(L[1]=ue=>w.value=ue),label:(N=M.row)==null?void 0:N.resourceId},{default:e(()=>[tl]),_:2},1032,["modelValue","label"])]}),_:1}),(t(!0),c(ae,null,ve(R.colDatas,M=>(t(),k(W,Wa({key:M.prop,ref_for:!0},M,{sortable:!0,"sort-method":M.prop==="dataSize"?(N,ue)=>o(N,ue,M):void 0,align:"center"}),{default:e(N=>[M.prop==="dataTypeAliasName"?(t(),c("span",ll,z($(N.row)),1)):(t(),c("span",{key:1,title:N.row[M.prop]},[M.prop==="dataSize"?(t(),c(ae,{key:0},[q(z(N.row[M.prop]||"--"),1)],64)):(t(),c(ae,{key:1},[q(z(N.row[M.prop]),1)],64))],8,ol))]),_:2},1040,["sort-method"]))),128))]),_:1},8,["data"])),[[Y,R.isLoadingTable]])]),_:1}),a(l(ha),{justify:"end",padding:"1 0 0"},{default:e(()=>[l(p)&&l(p)>0?(t(),k(J,{key:0,"current-page":l(U),"onUpdate:currentPage":L[2]||(L[2]=M=>ta(U)?U.value=M:null),"page-size":l(H),"onUpdate:pageSize":L[3]||(L[3]=M=>ta(H)?H.value=M:null),layout:"sizes, prev, pager, next, total","page-sizes":l(f),total:l(p),onSizeChange:l(pe),onCurrentChange:l(S)},null,8,["current-page","page-size","page-sizes","total","onSizeChange","onCurrentChange"])):G("",!0)]),_:1})]),_:1})]),_:1},512)}}});const sl=ya(nl,[["__scopeId","data-v-c6a51cf4"]]);var qe=(re=>(re[re.DATARESOURCE=0]="DATARESOURCE",re[re.RESULTDATA=1]="RESULTDATA",re[re.DATASET=2]="DATASET",re))(qe||{});function Na(re,te){const h=_a(),I=Fe({submiting:!1,checkNameing:!1,checkTimer:null,includeStylesList:["IMAGEDATA","VECTOR","TERRAIN"],stylesList:[],includeGridSetslist:["IMAGEDATA","VECTOR","TERRAIN"],gridSetsList:[],srsOptions:[],srsCopyOptions:[],dataType:"",treeProps:{label:"name",children:"children"},groupIdentify:{key:"type",value:0}}),A=we("getDataInfo"),b=Se(()=>A==null?void 0:A());Ke(()=>b.value.resourceId,f=>{f&&re()}),Xe(()=>{I.dataType=b.value.dataType,b.value.resourceId&&re()});function n(f,p,pe){if(p&&(te!=null&&te())){const S=p.match(/[\W_]/);(S==null?void 0:S.length)>0?pe(new Error("服务标识不能输入汉字、空格和特殊符号!")):(I.checkNameing=!0,I.checkTimer&&clearTimeout(I.checkTimer),I.checkTimer=setTimeout(()=>{xe.checkServiceName(p,te==null?void 0:te()).then(u=>{I.checkNameing=!1,u.code==="0000"?u.data?pe(new Error("该服务标识已被使用")):pe():(oe({type:"warning",message:u.message}),pe(new Error("后台验证失败，无法通过")))}).catch(()=>{oe({type:"error",message:"验证是否重名接口失败"}),pe(new Error("后台验证失败，无法通过"))})},500))}else I.checkTimer&&clearTimeout(I.checkTimer),I.checkNameing=!1,pe()}function v(f){return new Promise(p=>{f.value?f.value.validate(pe=>{p(pe)}):p(!1)})}function T(f=0){h.push({name:"/ServiceManage",params:{serviceInitType:f}})}function C(){const{dataType:f}=b.value;I.includeStylesList.includes(f)&&w(),I.includeGridSetslist.includes(f)&&R(),U()}function w(){We.getStylesList().then(f=>{f.code==="0000"?I.stylesList=f.data||[]:he({type:"error",title:"获取样式列表失败",message:f.message})}).catch(f=>{he({type:"error",title:"获取样式列表错误",message:f.message})})}function R(){qa.getGridSetsList().then(f=>{f.code==="0000"?I.gridSetsList=f.data||[]:he({type:"error",title:"获取网格集数据失败",message:f.message})}).catch(f=>{he({type:"error",title:"获取网格集数据错误",message:f.message})})}function U(){qa.getSrsList().then(f=>{f.code==="0000"?(I.srsOptions=f.data,I.srsOptions.forEach(p=>{p.value=`EPSG:${p.value}`})):(I.srsOptions=[],oe({type:"error",message:"获取坐标系统失败"}))}).catch(()=>{I.srsOptions=[],oe({type:"error",message:"获取坐标系统错误"})}).finally(()=>{I.srsCopyOptions=Je(I.srsOptions)})}function H(f){f?I.srsOptions=Je(I.srsCopyOptions).filter(p=>p.label.toLowerCase().includes(f.toLowerCase())||p.value.toLowerCase().includes(f.toLowerCase())):I.srsOptions=Je(I.srsCopyOptions)}return{...ra(I),releseDataInfo:b,checkFormPass:v,checkServiceName:n,goToServiceManage:T,getListData:C,getStylesList:w,getGridSetsList:R,getSrsList:U,srsFilterFunc:H}}const il={class:"main-content"},rl={class:"main"},dl={class:"content-wrap"},ul={class:"item-wrap item2"},cl={class:"item-wrap item2"},pl={class:"footer"},lt=Oe({__name:"Serve3DTilesForm",setup(re){const{submiting:te,releseDataInfo:h}=Na(v,()=>h.value.dataType),I=ee(!1),A=Fe({dataInfoForm:{}}),b=we("handleClosed"),n=we("serviceId");function v(){T()}function T(){const{dataTypeAliasName:w,dataFormat:R,name:U,dataSize:H}=h.value;A.dataInfoForm.dataName=U,A.dataInfoForm.dataTypeAliasName=w,A.dataInfoForm.dataFormat=R,A.dataInfoForm.dataSize=H}function C(){const w={resourceId:h.value.resourceId,category:h.value.dataType,categoryAliasName:h.value.dataTypeAliasName,addVersion:!0,id:n.value},R=new FormData;for(const U in w)R.append(U,w[U]);te.value=!0,We.releaseService(R).then(U=>{te.value=!1,U.code==="0000"?(he({type:"success",customClass:"custom-relese-notification",title:"服务更新中",onClick:()=>{}}),b==null||b()):he({type:"error",title:"服务发布失败",message:U.message})}).catch(U=>{te.value=!1,he({type:"error",title:"服务发布错误",message:U.message})})}return(w,R)=>{const U=y("el-form-item"),H=y("el-form"),f=y("el-button"),p=y("el-checkbox");return t(),c("div",il,[r("div",rl,[r("div",dl,[a(H,{ref:"editDataInfoForm",class:"form edit-form",inline:"",model:A.dataInfoForm,"label-width":"100px","label-position":"right"},{default:e(()=>[r("div",ul,[a(U,{label:"数据名称：",prop:"dataName"},{default:e(()=>[r("span",null,z(A.dataInfoForm.dataName),1)]),_:1}),a(U,{label:"数据类型：",prop:"dataTypeAliasName"},{default:e(()=>[r("span",null,z(A.dataInfoForm.dataTypeAliasName)+" / "+z(A.dataInfoForm.dataFormat),1)]),_:1})]),r("div",cl,[a(U,{label:"数据大小：",prop:"dataSize"},{default:e(()=>[r("span",null,z(A.dataInfoForm.dataSize),1)]),_:1})])]),_:1},8,["model"])])]),(t(),k(Fa,{to:"#service-info-full-dialog .main-content"},[r("div",pl,[a(f,{onClick:l(b)},{default:e(()=>[q("取消")]),_:1},8,["onClick"]),a(f,{loading:l(te),type:"primary",disabled:!I.value,onClick:C},{default:e(()=>[q(" 保存 ")]),_:1},8,["loading","disabled"]),a(p,{modelValue:I.value,"onUpdate:modelValue":R[0]||(R[0]=pe=>I.value=pe),label:"更新完成后将替换原服务数据",style:{"margin-left":"12px"}},null,8,["modelValue"])])]))])}}}),ml={key:1,style:{width:"100%"}},fl={style:{"margin-left":"16px"}},gl={key:0,style:{"overflow-wrap":"break-word"}},yl={style:{width:"86%","margin-bottom":"8px"}},_l=Oe({__name:"SchemeParamControl",props:{modelValue:{},allParam:{default:()=>({})},relations:{default:()=>[]},defaultDataInfo:{default:()=>({srs:"",srsOrigin:"",rotate:0})},isBatchData:{type:Boolean,default:!1}},emits:["change","getDataList"],setup(re,{emit:te}){const h=re,I=te,A=it(),b=A["control-name"];Be("$uid",Se(()=>A.uid));const n=Fe({options:[],cascaderKey:1,dataSourceValue:"",layerValue:"",fieldValue:"",enumValue:"",layerOptions:[],fieldOptions:[],bindValue:"",treeProps:{label:"name",children:"children"},groupIdentify:{}});Ke(()=>h.modelValue,()=>{v()}),Xe(()=>{v()}),h.allParam.controlType==="SELECT_TREE"?n.bindValue={}:h.allParam.paramTypeEnums==="NUMBER"&&(n.bindValue=0);function v(){const{controlType:o,paramTypeEnums:d,dataSourceItems:s=[],multiple:$,paramDirection:E,requestUrl:i="",paramLabel:L}=h.allParam;o==="SELECT"&&(d==="TEXT"||d==="NUMBER")?n.bindValue="":n.bindValue=Ie.cloneDeep(h.modelValue),o==="SELECT"&&(d==="TEXT"||d==="NUMBER")?R(i,s,L).then(m=>{n.options=Ie.cloneDeep(m),n.bindValue=Ie.cloneDeep(h.modelValue),$?(h.modelValue?typeof h.modelValue=="string"?n.bindValue=h.modelValue.split(",").filter(le=>le):n.bindValue=[]:n.bindValue=[],n.bindValue=n.bindValue.filter(le=>n.options.some(se=>se.value===le))):(d!=="NUMBER"&&typeof h.modelValue!="string"||n.options.every(le=>le.value!==n.bindValue))&&(n.bindValue="")}):o==="SELECT"&&d==="FIELD"?$?(h.modelValue?typeof h.modelValue=="string"?n.bindValue=h.modelValue.split(",").filter(P=>P):n.bindValue=[]:n.bindValue=[],n.bindValue=n.bindValue.filter(P=>n.options.some(m=>m.value===P))):(typeof h.modelValue!="string"||n.options.every(P=>P.value!==n.bindValue))&&(n.bindValue=""):o==="SELECT"&&d==="DATASOURCE"||o==="SELECT"&&d==="LAYER"?typeof h.modelValue!="string"&&(n.bindValue=""):o==="SELECT_TREE"&&d==="TEMPLATE"?(n.groupIdentify={key:"type",value:0},n.options=[],h.modelValue&&Qa(h.modelValue)&&(n.bindValue=JSON.parse(h.modelValue))):o==="CASCADER"?(++n.cascaderKey,n.options=[],h.modelValue?typeof h.modelValue=="string"?n.bindValue=h.modelValue.split(",").filter(P=>P):n.bindValue=[]:n.bindValue=[],T(!0)):o==="TABLE"||o==="DATASOURCE"&&pe(()=>{if(h.modelValue)if(typeof h.modelValue=="string"){n.bindValue=h.modelValue.split(",");const P=n.bindValue;[n.dataSourceValue,n.layerValue,n.fieldValue]=P,S(),u()}else n.bindValue=[];else n.bindValue=[]})}function T(o){o&&(n.options=[])}function C(){const{controlType:o,paramTypeEnums:d,multiple:s}=h.allParam;o==="SELECT_TREE"&&d==="TEMPLATE"||(o==="DATASOURCE"?d==="DATASOURCEWITHFIELD"?(n.bindValue=`${n.dataSourceValue},${n.layerValue},${n.fieldValue}`,I("change",n.bindValue,b,A.uid)):(n.bindValue=`${n.dataSourceValue},${n.layerValue}`,I("change",n.bindValue,b,A.uid)):o==="CASCADER"?n.bindValue&&I("change",n.bindValue.join(","),b,A.uid):s?I("change",n.bindValue.join(","),b,A.uid):I("change",n.bindValue,b,A.uid))}function w(o){n.bindValue=Ie.cloneDeep(o),I("change",JSON.stringify(n.bindValue),b,A.uid)}function R(o,d,s){return new Promise($=>{o?pa.getDataByUrl(o).then(E=>{var i,L;E.code==="0000"?Array.isArray(E==null?void 0:E.data)&&((i=E.data[0])!=null&&i.label)&&((L=E.data[0])!=null&&L.value)?$(E.data):$([]):($([]),oe({type:"error",message:`获取 " ${s} " 下拉选项数据失败`}))}).catch(()=>{$([]),oe({type:"error",message:`获取 " ${s} " 下拉选项数据失败`})}):$(d)})}function U(o){const d=n.bindValue.split(",");d.splice(o,1),n.bindValue=d.join(","),I("change",n.bindValue,b,A.uid)}function H(o){I("getDataList",d=>{o(d)})}function f(){n.layerValue="",S()}function p(){u(),C()}function pe(o){pa.getDataSourceList("MYSQL,ORACLE,POSTGIS,POSTGREPSQL").then(d=>{d.code==="0000"?(n.options=d.data,o&&o()):(n.options=[],o&&o(),oe({type:"error",message:"获取数据库数据失败"}))}).catch(()=>{n.options=[],o&&o(),oe({type:"error",message:"获取数据库数据失败"})})}function S(){pa.getTablesList({id:n.dataSourceValue}).then(o=>{if(o.code==="0000"){const{success:d=!1,tables:s=[]}=o.data;d?n.layerOptions=s.map($=>({value:$,label:$})):n.layerOptions=[]}else n.layerOptions=[],oe({type:"error",message:"获取表数据失败"})}).catch(()=>{n.layerOptions=[],oe({type:"error",message:"获取表数据失败"})})}function u(){pa.getTableColumnsInfo({id:n.dataSourceValue,tableName:n.layerValue}).then(o=>{if(o.code==="0000"){const{success:d=!1}=o;d?n.fieldOptions=o.data:n.fieldOptions=[]}else n.fieldOptions=[],oe({type:"error",message:"获取表数据失败"})}).catch(()=>{n.fieldOptions=[],oe({type:"error",message:"获取表数据失败"})})}function g(){let o=[];n.bindValue?(o=n.bindValue.split(","),o.push(n.enumValue)):(o=[],o.push(n.enumValue)),n.bindValue=o.join(","),n.enumValue="",I("change",n.bindValue,b,A.uid)}return(o,d)=>{const s=y("el-option"),$=y("el-select"),E=y("el-input-number"),i=y("el-color-picker"),L=y("el-tag"),P=y("el-input"),m=y("el-button"),le=y("el-checkbox"),se=y("el-date-picker"),W=y("el-cascader");return t(),c("div",null,[o.allParam.controlType==="DATASOURCE"?(t(),c(ae,{key:0},[a($,{modelValue:n.dataSourceValue,"onUpdate:modelValue":d[0]||(d[0]=D=>n.dataSourceValue=D),placeholder:"请选择数据库",filterable:"",style:{"margin-right":"8px","margin-bottom":"8px"},onChange:f},{default:e(()=>[(t(!0),c(ae,null,ve(n.options,D=>(t(),k(s,{key:D.value,label:D.label,value:D.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a($,{modelValue:n.layerValue,"onUpdate:modelValue":d[1]||(d[1]=D=>n.layerValue=D),placeholder:n.dataSourceValue?"请选择表名":"请先选择数据库",style:{"margin-right":"8px","margin-bottom":"8px"},filterable:"","allow-create":"","default-first-option":"",onChange:p},{default:e(()=>[(t(!0),c(ae,null,ve(n.layerOptions,D=>(t(),k(s,{key:D.value,label:D.label,value:D.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),o.allParam.paramTypeEnums==="DATASOURCEWITHFIELD"?(t(),k($,{key:0,modelValue:n.fieldValue,"onUpdate:modelValue":d[2]||(d[2]=D=>n.fieldValue=D),placeholder:"请选择字段名",filterable:"",style:{"margin-right":"8px"},onChange:C},{default:e(()=>[(t(!0),c(ae,null,ve(n.fieldOptions,D=>(t(),k(s,{key:D.colName,label:D.colName,value:D.colName},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):G("",!0)],64)):G("",!0),o.allParam.controlType==="SELECT"?(t(),k($,{key:1,modelValue:n.bindValue,"onUpdate:modelValue":d[3]||(d[3]=D=>n.bindValue=D),style:{width:"100%"},placeholder:o.allParam.paramTip,multiple:o.allParam.multiple,filterable:"","allow-create":o.allParam.editable,onChange:C},{default:e(()=>[(t(!0),c(ae,null,ve(n.options,D=>(t(),k(s,{key:D.value,label:D.label,value:D.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","multiple","allow-create"])):o.allParam.controlType==="INPUT_BOX"?(t(),c(ae,{key:2},[o.allParam.paramTypeEnums==="NUMBER"?(t(),k(E,{key:0,ref:"inputBox",modelValue:n.bindValue,"onUpdate:modelValue":d[4]||(d[4]=D=>n.bindValue=D),style:{width:"100%"},"controls-position":"right",max:l(Ie.isNumber)(o.allParam.max)?o.allParam.max:1/0,min:l(Ie.isNumber)(o.allParam.min)?o.allParam.min:-1/0,placeholder:o.allParam.paramTip,onBlur:C,onChange:C},null,8,["modelValue","max","min","placeholder"])):o.allParam.paramTypeEnums==="COLOR"?(t(),c("div",ml,[a(i,{modelValue:n.bindValue,"onUpdate:modelValue":d[5]||(d[5]=D=>n.bindValue=D),"color-format":"rgb","show-alpha":!0,onChange:C},null,8,["modelValue"]),r("span",fl,z(n.bindValue),1)])):o.allParam.paramTypeEnums==="ENUM"?(t(),c(ae,{key:2},[n.bindValue?(t(),c("div",gl,[(t(!0),c(ae,null,ve(n.bindValue.split(","),(D,J)=>(t(),k(L,{key:D,closable:"",type:D.type,onClose:Y=>U(J)},{default:e(()=>[q(z(D),1)]),_:2},1032,["type","onClose"]))),128))])):G("",!0),r("div",yl,[a(P,{ref:"inputBoxRef",modelValue:n.enumValue,"onUpdate:modelValue":d[6]||(d[6]=D=>n.enumValue=D),placeholder:o.allParam.paramTip,onBlur:C},null,8,["modelValue","placeholder"]),a(m,{type:"primary",style:{position:"absolute",bottom:"8px"},onClick:g},{default:e(()=>[q(" 确认 ")]),_:1})])],64)):(t(),k(P,{key:3,ref:"inputBox",modelValue:n.bindValue,"onUpdate:modelValue":d[7]||(d[7]=D=>n.bindValue=D),style:{width:"100%"},placeholder:o.allParam.paramTip,onBlur:C},null,8,["modelValue","placeholder"]))],64)):o.allParam.controlType==="SELECT_TREE"?(t(),k(l(Ye),{key:3,modelValue:n.bindValue,"onUpdate:modelValue":d[8]||(d[8]=D=>n.bindValue=D),"tree-props":n.treeProps,"tree-data":n.options,"node-key":"id",icon:"iconCls",style:{width:"100%"},"expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":n.groupIdentify,onChange:C},null,8,["modelValue","tree-props","tree-data","group-identify"])):o.allParam.controlType==="CHECK_BOX"?(t(),k(le,{key:4,modelValue:n.bindValue,"onUpdate:modelValue":d[9]||(d[9]=D=>n.bindValue=D),onChange:C},null,8,["modelValue"])):o.allParam.controlType==="DATETIMEPICKER"?(t(),k(se,{key:5,modelValue:n.bindValue,"onUpdate:modelValue":d[10]||(d[10]=D=>n.bindValue=D),style:{width:"100%"},type:"datetime",placeholder:o.allParam.paramTip,"value-format":"YYYY-MM-DD HH:mm:ss",onChange:C,onBlur:C},null,8,["modelValue","placeholder"])):o.allParam.controlType==="CASCADER"?(t(),k(W,{key:n.cascaderKey,modelValue:n.bindValue,"onUpdate:modelValue":d[11]||(d[11]=D=>n.bindValue=D),style:{width:"100%"},props:{multiple:o.allParam.multiple},options:n.options,onChange:C,onVisibleChange:T},null,8,["modelValue","props","options"])):o.allParam.controlType==="TABLE"?(t(),c(ae,{key:7},[o.allParam.paramTypeEnums==="GEO_SRS"?(t(),k(l(vt),{key:0,"init-data":n.bindValue,"control-name":o.allParam.paramName,"control-params":o.allParam,"default-data-info":o.defaultDataInfo,"is-batch-data":o.isBatchData,onChangeTable:w,onGetDataList:H},null,8,["init-data","control-name","control-params","default-data-info","is-batch-data"])):G("",!0),o.allParam.paramTypeEnums==="COORDINATE_PARAMS"?(t(),k(l(ht),{key:1,"control-name":o.allParam.paramName,"control-params":o.allParam,onChangeTable:w},null,8,["control-name","control-params"])):G("",!0)],64)):G("",!0)])}}});function ot(re,te=!0){const h=Fe({defaultTileInfoForm:{taskInfo:[]},tileInfoForm:{taskInfo:[]},tileInfoFormRule:{taskInfo:[{required:!0,message:"切片方案不能为空",trigger:"change"}]},treeProps:{label:"name",children:"children"},taskTreeData:[],curTaskId:"",cellData:[],publishConfigList:[],isLoadingScheme:!1,showErrorTip:!1});function I(){h.tileInfoForm=Je(h.defaultTileInfoForm),h.curTaskId="",h.cellData=[],h.publishConfigList=[],h.isLoadingScheme=!1,h.showErrorTip=!1}function A(){va.getClassifyTree().then(S=>{S.code==="0000"?(h.taskTreeData=S.data,b()):(oe({type:"warning",message:"获取切片方案数据有误"}),h.taskTreeData=[])}).catch(S=>{oe({type:"error",message:S.message||"获取切片方案数据有误"}),h.taskTreeData=[]})}function b(){const S=u=>{var g;for(let o=0,d=u.length;o<d;o++)u[o].type===1&&u[o].dataType?u[o].name=`(默认) ${u[o].name}`:((g=u[o].children)==null?void 0:g.length)>0&&S(u[o].children)};S(h.taskTreeData),te&&n()}function n(){let S=null;const u=g=>{var o;for(let d=0,s=g.length;d<s;d++)if(g[d].type===1&&g[d].dataType&&g[d].dataType===re.value){S=g[d];break}else((o=g[d].children)==null?void 0:o.length)>0&&u(g[d].children)};u(h.taskTreeData),h.tileInfoForm.taskInfo=S,S&&T(S)}function v(S){let u=null;const g=o=>{var d;for(let s=0,$=o.length;s<$;s++)if(o[s].type===1&&o[s].id===S){u=o[s];break}else((d=o[s].children)==null?void 0:d.length)>0&&g(o[s].children)};g(h.taskTreeData),h.tileInfoForm.taskInfo=u,u&&(h.curTaskId=(u==null?void 0:u.id)||""),h.isLoadingScheme=!1}function T(S){S.id!==h.curTaskId&&(h.curTaskId=S.id,h.isLoadingScheme=!0,va.getSchemeInfo(h.curTaskId).then(u=>{if(u.code==="0000"){const g=JSON.parse(u.data.scheme).cells;h.cellData=Je(g),p();const o=h.cellData.filter(d=>{var s;return d.type==="algorithm.Element"&&d.algorithmType!=="READ_DATASOURCE"&&d.algorithmType!=="WRITE_DATASOURCE"&&((s=d.publishParamList)==null?void 0:s.length)>0});for(let d=0,s=o.length;d<s;d++)f(o[d]);R(g)}else h.isLoadingScheme=!1,oe({type:"warning",message:"获取方案信息有误"})}).catch(u=>{h.isLoadingScheme=!1,oe({type:"error",message:u.message||"获取方案信息错误"})}))}function C(S){h.isLoadingScheme=!0;const u=JSON.parse(S).cells;h.cellData=Je(u),p(),R(u)}function w(S){return h.cellData.find(u=>u.id===S)}function R(S){const u=S.filter(g=>{var o;return g.type==="algorithm.Element"&&g.algorithmType!=="READ_DATASOURCE"&&g.algorithmType!=="WRITE_DATASOURCE"&&((o=g.publishParamList)==null?void 0:o.length)>0});if(u.length>0){const g=Array(u.length).fill(null);u.forEach((d,s)=>{g[s]=U(d.version.id,d.id)}),Promise.all(g).then(d=>{d.some(s=>!s)?(oe({type:"warning",message:"获取参数失败！"}),h.publishConfigList=[]):(h.publishConfigList=Je(d),u.forEach(s=>{h.publishConfigList.forEach($=>{$.uid===s.id&&s.publishParamList.forEach(E=>{$.pubulishData[E]=s.data[E]})})}),h.publishConfigList.forEach(s=>{s.paramsConfigList=s.paramsConfigList.filter($=>s.pubulishData.hasOwnProperty($.paramName)&&$.paramDirection!=="INPUT"),s.relations=s.relations.filter($=>s.pubulishData.hasOwnProperty($.source)&&s.pubulishData.hasOwnProperty($.target))}),h.isLoadingScheme=!1)})}else h.publishConfigList=[],h.isLoadingScheme=!1}function U(S,u){return new Promise(g=>{va.getAlgorithmDetailInfo(S).then(o=>{if(o.code==="0000"){const{data:d}=o,{name:s,paramsConfig:$}=d;if(Qa($)){const i=JSON.parse($),L={paramsConfigList:i.config||[],relations:i.relations||[],type:i.type||"JOB",name:s,uid:u,pubulishData:{}};setTimeout(()=>{g(Je(L))},100)}else g(!1)}else g(!1)}).catch(()=>{g(!1),h.isLoadingScheme=!1})})}function H(S,u,g){const o=h.publishConfigList.find(s=>s.uid===g);o.pubulishData[u]=S;const d=w(g);d.data[u]=S,f(d),setTimeout(()=>{p()},100)}function f(S){const{data:u={},requiredParamList:g=[]}=S;let o=!0;for(let d=0,s=g.length;d<s;d++)if(u[g[d]]===void 0||u[g[d]]===null||u[g[d]]===""){o=!1;break}S.isPassValid=o}function p(S=!1){const u=Je(h.cellData);return new Promise(g=>{let o=!0;for(let d=0,s=u.length;d<s;d++){const $=u[d];if($.type==="algorithm.Element"&&($.isError||!$.isPassValid)){o=!1;break}}o?(g(!0),h.showErrorTip=!1):(S&&oe({type:"warning",message:"请正确填写参数赋值或选择正确的切片方案"}),g(!1),h.showErrorTip=!0)})}function pe(S){return new Promise(u=>{S.validate(g=>{u(g)})})}return{...ra(h),initSchemeData:I,getAllTask:A,formatTreeData:b,getDefaultTaskInfo:n,handleTaskChange:T,getCellData:w,createTileInfoForm:R,getParamConfigPromise:U,handleControlChange:H,setCellPassValid:f,checkDagScheme:p,checkSchemeForm:pe,getTaskInfoById:v,renderSchemeByDag:C}}const bl={class:"card"},vl=r("div",{class:"subtitle"},"数据信息",-1),hl={class:"content-wrap",style:{"margin-bottom":"18px"}},Tl={class:"content-wrap"},Il={key:0,class:"item-wrap"},Dl={class:"list-item"},kl=r("span",null," — — ",-1),Sl={class:"link-box"},Vl=r("input",{id:"importCoordinateFile",style:{display:"none"},type:"file",class:"importCoordinateFile",directory:"",nwdirectory:"",accept:".xml"},null,-1),Cl={key:1,class:"item-wrap origin-wrap"},wl={class:"origin"},Fl={key:2,class:"item-wrap"},El={class:"rotate"},$l={class:"card"},Ol={class:"subtitle"},xl={key:0,class:"tip"},Rl={"element-loading-text":"正在获取方案参数..."},Ll={class:"content-wrap"},Al={class:"item-wrap item2"},Nl=Oe({__name:"Common3DUpdateForm",setup(re,{expose:te}){const{treeProps:h,groupIdentify:I,srsOptions:A,dataType:b,releseDataInfo:n,checkFormPass:v,srsFilterFunc:T,getListData:C}=Na(m,()=>n.value.dataType),{tileInfoForm:w,cellData:R,showErrorTip:U,isLoadingScheme:H,tileInfoFormRule:f,taskTreeData:p,publishConfigList:pe,getAllTask:S,initSchemeData:u,checkDagScheme:g,handleTaskChange:o,handleControlChange:d}=ot(b),s=ee(),$=ee(),E=ee([]),i=Fe({includesSrs:["IMAGERY","POINTCLOUD","BIMMODEL","MODEL","IMAGEDATA","TERRAIN"],includesOrigin:["IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],includesRotate:["BIMMODEL","MODEL"],dataInfoForm:{srs:"",origin:{x:"",y:"",z:""},rotate:0},dataInfoFormRule:{srs:[{required:!0,message:"坐标系统不能为空",trigger:"change"}],origin:{type:"object",required:!0,fields:{x:{required:!0,validator:P,trigger:["blur","change"]},y:{required:!0,validator:P,trigger:["blur","change"]},z:{required:!0,validator:P,trigger:["blur","change"]}}}},dataInfoTableData:[],initDataInfo:{srs:"",srsOrigin:"",rotate:0}});Be("getCellById",L);function L(M){var ue;const N=(ue=R.value)==null?void 0:ue.find(me=>me.id===M);return N?{attributes:N}:{}}ua(()=>{E.value=[]});function P(M,N,ue){const me=!!i.dataInfoForm.origin.x,K=!!i.dataInfoForm.origin.y,X=!!i.dataInfoForm.origin.z;me&&K&&X?ue():ue(new Error(`请完整填写偏移量，${me?"":" X"}${K?"":" Y"}${X?"":" Z"}不能为空`))}function m(){He(()=>{var M;(M=$.value)==null||M.clearValidate()}),le(),C(),se(),S()}function le(){const{dataTypeAliasName:M,dataFormat:N,name:ue,dataSize:me,createTime:K}=n.value;i.dataInfoForm.dataName=ue,i.dataInfoForm.dataTypeAliasName=M,i.dataInfoForm.dataFormat=N,i.dataInfoForm.dataSize=me,i.dataInfoForm.createTime=K,i.dataInfoTableData=[i.dataInfoForm],u()}function se(){const M=()=>{i.dataInfoForm.origin={x:"",y:"",z:""}};We.getDataInfoById(n.value.resourceId).then(N=>{var ue,me,K;if(N.code==="0000")if(i.initDataInfo.srs=((ue=N==null?void 0:N.data)==null?void 0:ue.srs)??"EPSG:4326",i.initDataInfo.srsOrigin=((me=N==null?void 0:N.data)==null?void 0:me.srsOrigin)??"0,0,0",i.initDataInfo.rotate=((K=N==null?void 0:N.data)==null?void 0:K.rotate)??0,b.value=N.data.dataType,i.dataInfoForm.srs=N.data.srs||"EPSG:4326",N.data.srsOrigin){const X=N.data.srsOrigin.split(",");i.dataInfoForm.origin={x:X[0],y:X[1],z:X[2]}}else M();else i.dataInfoForm.srs="EPSG:4326",M()}).catch(()=>{i.dataInfoForm.srs="EPSG:4326",M()}).finally(()=>{i.dataInfoForm.rotate=0,S()})}function W(M){i.dataInfoForm.origin[M]=i.dataInfoForm.origin[M].replace(/^\.+|[^\d.]/g,"")}function D(){var M,N;(M=document.getElementById("importCoordinateFile"))==null||M.click(),(N=document.getElementById("importCoordinateFile"))==null||N.addEventListener("change",ue=>{const{files:me}=ue.target;if(me.length===0)return;const K=me[0];if(!/\.xml$/g.test(K.name)){Le.alert("仅支持导入xml格式！","提示",{confirmButtonText:"确定",type:"error"}),ue.target.value="";return}J(K,X=>{i.dataInfoForm.srs=X.system,i.includesOrigin.includes(n.value.dataType)&&(i.dataInfoForm.origin=X.origin),oe({type:"success",message:"坐标导入成功!"})}),ue.target.value=""})}function J(M,N){const ue=new FileReader;ue.onload=me=>{var _,ne;const K=me.target.result,X={},Q=K.match(/<SRS[^>]*>([\s\S]*?)<\/SRS>/);let B=K.match(/<SRSOrigin[^>]*>([\s\S]*?)<\/SRSOrigin>/);if(i.includesOrigin.includes(n.value.dataType)){if(!Q||!B){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}}else if(!Q){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}[,X.system]=Q,i.includesOrigin.includes(n.value.dataType)&&(B=(ne=(_=B[1])==null?void 0:_.replace(/\s*/g,""))==null?void 0:ne.split(","),X.origin={x:B[0],y:B[1],z:B[2]}),N&&N(X)},ue.readAsBinaryString(M)}function Y(){return new Promise(M=>{const N=E.value;if((N==null?void 0:N.length)>0){N==null||N.forEach(Q=>{Q==null||Q.validate()});const ue=v(s),me=v($),K=g(!0);Promise.all([ue,me,K]).then(([Q,B,_])=>{if(Q&&B&&_){const{srs:ne,origin:{x:ce,y:O,z:_e},rotate:V}=i.dataInfoForm,{taskInfo:be}=w.value,fe={};i.includesSrs.includes(n.value.dataType)&&(fe.srs=ne.replace("EPSG:","")),i.includesOrigin.includes(n.value.dataType)&&(fe.srsOrigin=`${ce},${O},${_e}`),i.includesRotate.includes(n.value.dataType)&&(fe.rotate=V);const $e={cells:Ie.cloneDeep(R.value)},Ce={resourceId:n.value.resourceId,tileConfig:JSON.stringify(fe),taskId:be.id,taskName:be.name,dag:JSON.stringify($e)};M(Ce)}else M(!1)})}else oe({type:"warning",message:"请选择正确的切片方案！"}),v(s),v($),M(!1)})}return te({handleSave:Y}),(M,N)=>{const ue=y("el-table-column"),me=y("el-table"),K=y("el-form"),X=y("el-option"),Q=y("el-select"),B=y("el-button"),_=y("el-tooltip"),ne=y("el-form-item"),ce=y("el-input"),O=y("el-input-number"),_e=ea("loading");return t(),c(ae,null,[r("div",bl,[vl,r("div",hl,[a(K,{ref:"tableFormRef",class:"table-form tableContainer",model:i},{default:e(()=>[a(me,{ref:"tableRef",class:"table commonTable sortableTable",data:i.dataInfoTableData},{default:e(()=>[a(ue,{prop:"dataName",label:"数据名称"}),a(ue,{prop:"dataTypeAliasName",label:"数据类型"}),a(ue,{prop:"dataFormat",label:"数据格式"}),a(ue,{prop:"createTime",label:"创建时间"})]),_:1},8,["data"])]),_:1},8,["model"])]),r("div",Tl,[a(K,{ref_key:"editDataInfoForm",ref:s,class:"form edit-form",inline:"",model:i.dataInfoForm,"label-width":"auto","label-position":"right",rules:i.dataInfoFormRule},{default:e(()=>[i.includesSrs.includes(l(n).dataType)?(t(),c("div",Il,[a(ne,{key:"srs",label:"坐标系统",prop:"srs",class:"srs-item"},{default:e(()=>[a(Q,{modelValue:i.dataInfoForm.srs,"onUpdate:modelValue":N[0]||(N[0]=V=>i.dataInfoForm.srs=V),style:{flex:"1"},"popper-class":"srs-select",filterable:"","filter-method":l(T),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(A),V=>(t(),k(X,{key:V.value,label:V.value,value:V.value},{default:e(()=>[r("div",Dl,[r("span",null,z(V.value),1),kl,r("span",null,z(V.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"]),r("div",Sl,[a(_,{content:"导入坐标文件",placement:"bottom"},{default:e(()=>[a(B,{type:"primary",link:"",icon:l(Ea),onClick:D},{default:e(()=>[q(" 导入 ")]),_:1},8,["icon"])]),_:1})]),Vl]),_:1})])):G("",!0),i.includesOrigin.includes(l(n).dataType)?(t(),c("div",Cl,[a(ne,{label:"偏移量",prop:"origin"},{default:e(()=>[r("div",wl,[a(ce,{modelValue:i.dataInfoForm.origin.x,"onUpdate:modelValue":N[1]||(N[1]=V=>i.dataInfoForm.origin.x=V),placeholder:"请输入X坐标",onInput:N[2]||(N[2]=V=>W("x"))},{prepend:e(()=>[q("X :")]),_:1},8,["modelValue"]),a(ce,{modelValue:i.dataInfoForm.origin.y,"onUpdate:modelValue":N[3]||(N[3]=V=>i.dataInfoForm.origin.y=V),placeholder:"请输入Y坐标",onInput:N[4]||(N[4]=V=>W("y"))},{prepend:e(()=>[q("Y :")]),_:1},8,["modelValue"]),a(ce,{modelValue:i.dataInfoForm.origin.z,"onUpdate:modelValue":N[5]||(N[5]=V=>i.dataInfoForm.origin.z=V),placeholder:"请输入Z坐标",onInput:N[6]||(N[6]=V=>W("z"))},{prepend:e(()=>[q("Z :")]),_:1},8,["modelValue"])])]),_:1})])):G("",!0),i.includesRotate.includes(l(n).dataType)?(t(),c("div",Fl,[a(ne,{label:"旋转角度",prop:"rotate"},{default:e(()=>[r("div",El,[a(O,{modelValue:i.dataInfoForm.rotate,"onUpdate:modelValue":N[7]||(N[7]=V=>i.dataInfoForm.rotate=V),placeholder:"请输入旋转角度","controls-position":"right",style:{width:"200px"}},null,8,["modelValue"])])]),_:1})])):G("",!0)]),_:1},8,["model","rules"])])]),r("div",$l,[r("div",Ol,[q(" 参数设置 "),l(U)?(t(),c("span",xl," 请正确设置切片参数 ")):G("",!0)]),ze((t(),c("div",Rl,[r("div",Ll,[a(K,{ref_key:"editTileInfoForm",ref:$,class:"form edit-form",inline:"",model:l(w),rules:l(f),"label-width":"auto","label-position":"right"},{default:e(()=>[r("div",Al,[a(ne,{label:"切片方案",prop:"taskInfo"},{default:e(()=>[a(l(Ye),{modelValue:l(w).taskInfo,"onUpdate:modelValue":N[8]||(N[8]=V=>l(w).taskInfo=V),style:{width:"100%"},"tree-props":l(h),"tree-data":l(p),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(I),onChange:l(o)},null,8,["modelValue","tree-props","tree-data","group-identify","onChange"])]),_:1}),a(ne)])]),_:1},8,["model","rules"])]),l(pe).length>0?(t(!0),c(ae,{key:0},ve(l(pe),(V,be)=>(t(),c("div",{key:V.uid,class:"content-wrap"},[a(K,{ref_for:!0,ref:fe=>{fe&&(E.value[be]=fe)},class:"form scheme-form__common",uid:V.uid,inline:"",model:V.pubulishData,"label-width":"auto","label-position":"right"},{default:e(()=>[(t(!0),c(ae,null,ve(V.paramsConfigList,(fe,$e)=>(t(),k(ne,{key:fe.paramName+$e,class:Re([{"scheme-form-item":!0,"is-left":$e%2===0}]),label:fe.paramLabel,prop:fe.paramName,required:fe.required,rules:{required:fe.required,message:`${fe.paramLabel}不能为空`}},{default:e(()=>[a(_l,{ref_for:!0,ref:"paramForm",modelValue:V.pubulishData[fe.paramName],"onUpdate:modelValue":Ce=>V.pubulishData[fe.paramName]=Ce,"control-name":fe.paramName,uid:V.uid,type:V.type,"all-param":fe,relations:V.relations,"default-data-info":i.initDataInfo,onChange:l(d)},null,8,["modelValue","onUpdate:modelValue","control-name","uid","type","all-param","relations","default-data-info","onChange"])]),_:2},1032,["class","label","prop","required","rules"]))),128))]),_:2},1032,["uid","model"])]))),128)):G("",!0)])),[[_e,l(H)]])])],64)}}});const Ul={class:"card"},Pl=r("div",{class:"subtitle"},"数据信息",-1),Ml={class:"content-wrap",style:{"margin-bottom":"18px"}},Bl={class:"content-wrap"},zl={class:"item-wrap"},Gl={class:"list-item"},ql=r("span",null," — — ",-1),Wl={class:"link-box"},jl=r("input",{id:"importCoordinateFile",style:{display:"none"},type:"file",class:"importCoordinateFile",directory:"",nwdirectory:"",accept:".xml"},null,-1),Hl={key:0,class:"item-wrap"},Kl={class:"card"},Jl=r("div",{class:"subtitle"},"参数设置",-1),Yl={key:0,class:"content-wrap"},Xl={key:0,class:"item-wrap item2"},Zl={class:"link-box"},Ql={class:"item-wrap"},eo={class:"list-item"},ao=r("span",null," — — ",-1),to={key:1,class:"item-wrap"},lo={key:1,class:"content-wrap"},oo={key:0,class:"item-wrap item2"},no={class:"link-box"},so={class:"item-wrap"},io={class:"list-item"},ro=r("span",null," — — ",-1),uo={key:1,class:"item-wrap"},co={class:"item-wrap"},po={class:"item-wrap item2"},mo=r("span",{style:{margin:"0 15px"}},"——",-1),fo=Oe({__name:"Common2DUpdateForm",setup(re,{expose:te}){const h=_a(),{treeProps:I,stylesList:A,groupIdentify:b,srsOptions:n,dataType:v,gridSetsList:T,releseDataInfo:C,checkFormPass:w,getListData:R,srsFilterFunc:U,getStylesList:H}=kt(s,()=>C.value.dataType),f=ee(),p=ee(),pe=ee(),S=ee(),u=ee(),g=ee([]),o=Fe({includesBandSettings:["TERRAIN","IMAGEDATA"],dataInfoForm:{srs:"",origin:{x:"",y:"",z:""},rotate:0,bandSettings:[]},dataInfoFormRule:{srs:[{required:!0,message:"坐标系统不能为空",trigger:"change"}]},bandTableData:[{prop:"name",label:"波段"},{prop:"nullValue",label:"空值"},{prop:"min",label:"最小范围"},{prop:"max",label:"最大范围"}],dataInfoTableData:[],initDataInfo:{srs:"",srsOrigin:"",rotate:0},wmsTileInfoForm:{cqlFilter:"",srs:"",styleInfo:null},wmtsTileInfoForm:{cqlFilter:"",srs:"",format:["png"],gridSets:"",level:["",""],styleInfo:null},levelRules:{type:"array",required:!0,trigger:"change",len:2,fields:{0:{type:"number",required:!0,message:"请完整填写切片级别"},1:{type:"number",required:!0,message:"请完整填写切片级别"}}},levelOptions:[]}),d=we("category");ua(()=>{g.value=[]});function s(){He(()=>{var se,W,D,J,Y;(se=f.value)==null||se.clearValidate(),(W=p.value)==null||W.clearValidate(),(D=pe.value)==null||D.clearValidate(),(J=S.value)==null||J.clearValidate(),(Y=u.value)==null||Y.clearValidate()}),$(),R(),E()}function $(){const{dataTypeAliasName:se,dataFormat:W,name:D,dataSize:J,createTime:Y}=C.value;o.dataInfoForm.dataName=D,o.dataInfoForm.dataTypeAliasName=se,o.dataInfoForm.dataFormat=W??"--",o.dataInfoForm.dataSize=J,o.dataInfoForm.createTime=Y,o.dataInfoForm.bandSettings=[{name:"RED_BAND",nullValue:"",min:"",max:""},{name:"GREEN_BAND",nullValue:"",min:"",max:""},{name:"BLUE_BAND",nullValue:"",min:"",max:""}],o.dataInfoTableData=[o.dataInfoForm],o.wmsTileInfoForm={cqlFilter:"",srs:"EPSG:4326",styleInfo:null},o.wmtsTileInfoForm={cqlFilter:"",srs:"EPSG:4326",format:["png"],gridSets:"",level:["",""],styleInfo:null}}function E(){const se=()=>{o.dataInfoForm.origin={x:"",y:"",z:""}};We.getDataInfoById(C.value.resourceId).then(W=>{var D,J,Y;if(W.code==="0000")if(o.initDataInfo.srs=((D=W==null?void 0:W.data)==null?void 0:D.srs)??"EPSG:4326",o.initDataInfo.srsOrigin=((J=W==null?void 0:W.data)==null?void 0:J.srsOrigin)??"0,0,0",o.initDataInfo.rotate=((Y=W==null?void 0:W.data)==null?void 0:Y.rotate)??0,v.value=W.data.dataType,o.dataInfoForm.srs=W.data.srs||"EPSG:4326",W.data.srsOrigin){const M=W.data.srsOrigin.split(",");o.dataInfoForm.origin={x:M[0],y:M[1],z:M[2]}}else se();else o.dataInfoForm.srs="EPSG:4326",se()}).catch(()=>{o.dataInfoForm.srs="EPSG:4326",se()}).finally(()=>{o.dataInfoForm.rotate=0})}function i(se){o.wmtsTileInfoForm.level[0]="",o.wmtsTileInfoForm.level[1]="";const W=T.value.find(J=>J.value===se),D=Array(W.max+1).fill(1);o.levelOptions=[],D.forEach((J,Y)=>{o.levelOptions.push({value:Y,lebel:Y})})}function L(){const se=h.resolve({path:"/dataCenter/StylesManage"});window.open(se.href,"_blank")}function P(){var se,W;(se=document.getElementById("importCoordinateFile"))==null||se.click(),(W=document.getElementById("importCoordinateFile"))==null||W.addEventListener("change",D=>{const{files:J}=D.target;if(J.length===0)return;const Y=J[0];if(!/\.xml$/g.test(Y.name)){Le.alert("仅支持导入xml格式！","提示",{confirmButtonText:"确定",type:"error"}),D.target.value="";return}m(Y,M=>{o.dataInfoForm.srs=M.system,["VECTOR","TERRAIN","IMAGEDATA"].includes(C.value.dataType)&&(o.dataInfoForm.origin=M.origin),oe({type:"success",message:"坐标导入成功!"})}),D.target.value=""})}function m(se,W){const D=new FileReader;D.onload=J=>{var me,K;const Y=J.target.result,M={},N=Y.match(/<SRS[^>]*>([\s\S]*?)<\/SRS>/);let ue=Y.match(/<SRSOrigin[^>]*>([\s\S]*?)<\/SRSOrigin>/);if(["VECTOR","TERRAIN","IMAGEDATA"].includes(C.value.dataType)){if(!N||!ue){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}}else if(!N){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}[,M.system]=N,["VECTOR","TERRAIN","IMAGEDATA"].includes(C.value.dataType)&&(ue=(K=(me=ue[1])==null?void 0:me.replace(/\s*/g,""))==null?void 0:K.split(","),M.origin={x:ue[0],y:ue[1],z:ue[2]}),W&&W(M)},D.readAsBinaryString(se)}function le(){return new Promise(se=>{const W=w(p);Promise.all([W]).then(([J])=>{if(J){const Y=[];d.value==="WMS"&&Y.push(w(S,"WMS")),d.value==="WMTS"&&Y.push(w(u,"WMTS")),Promise.all(Y).then(N=>{if(N.every(ue=>ue.valid)){const ue={resourceId:C.value.resourceId,publishService:!0},me={srs:o.dataInfoForm.srs.replace("EPSG:","")};C.value.dataType==="IMAGEDATA"&&(me.bandSettings=o.dataInfoForm.bandSettings),ue.dataInfo=JSON.stringify(me);const K={};d.value==="WMS"&&(K.srs=o.wmsTileInfoForm.srs.replace("EPSG:",""),K.styleId=o.wmsTileInfoForm.styleInfo?o.wmsTileInfoForm.styleInfo.id:null,K.cqlFilter=o.wmsTileInfoForm.cqlFilter),d.value==="WMTS"&&(K.srs=o.wmtsTileInfoForm.srs.replace("EPSG:",""),K.styleId=o.wmtsTileInfoForm.styleInfo?o.wmtsTileInfoForm.styleInfo.id:null,K.cqlFilter=o.wmtsTileInfoForm.cqlFilter,K.format=o.wmtsTileInfoForm.format.join(","),K.gridSets=o.wmtsTileInfoForm.gridSets,[K.zoomStart,K.zoomStop]=o.wmtsTileInfoForm.level),ue.tileConfig=JSON.stringify(K),se(ue)}else se(!1)})}else oe({type:"warning",message:"请正确数据信息！"}),se(!1)}).catch(()=>{se(!1)})})}return te({handleSave:le}),(se,W)=>{const D=y("el-table-column"),J=y("el-table"),Y=y("el-form"),M=y("el-option"),N=y("el-select"),ue=y("el-button"),me=y("el-tooltip"),K=y("el-form-item"),X=y("el-input"),Q=y("el-checkbox"),B=y("el-checkbox-group");return t(),c(ae,null,[r("div",Ul,[Pl,r("div",Ml,[a(Y,{ref:"tableFormRef",class:"table-form tableContainer",model:o},{default:e(()=>[a(J,{ref:"tableRef",class:"table commonTable sortableTable",data:o.dataInfoTableData},{default:e(()=>[a(D,{prop:"dataName",label:"数据名称"}),a(D,{prop:"dataTypeAliasName",label:"数据类型"}),a(D,{prop:"dataFormat",label:"数据格式"}),a(D,{prop:"createTime",label:"创建时间"})]),_:1},8,["data"])]),_:1},8,["model"])]),r("div",Bl,[a(Y,{ref_key:"editDataInfoForm",ref:p,class:"form edit-form",inline:"",model:o.dataInfoForm,"label-width":"auto","label-position":"right",rules:o.dataInfoFormRule},{default:e(()=>[r("div",zl,[a(K,{key:"srs",label:"坐标系统",prop:"srs",class:"srs-item"},{default:e(()=>[a(N,{modelValue:o.dataInfoForm.srs,"onUpdate:modelValue":W[0]||(W[0]=_=>o.dataInfoForm.srs=_),style:{flex:"1"},"popper-class":"srs-select",filterable:"","filter-method":l(U),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(n),_=>(t(),k(M,{key:_.value,label:_.value,value:_.value},{default:e(()=>[r("div",Gl,[r("span",null,z(_.value),1),ql,r("span",null,z(_.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"]),r("div",Wl,[a(me,{content:"导入坐标文件",placement:"bottom"},{default:e(()=>[a(ue,{type:"primary",link:"",icon:l(Ea),onClick:P},{default:e(()=>[q(" 导入 ")]),_:1},8,["icon"])]),_:1})]),jl]),_:1})]),l(C).dataType==="IMAGEDATA"?(t(),c("div",Hl,[a(K,{key:"bandSettings",label:"波段设置",prop:"bandSettings"},{default:e(()=>[a(J,{data:o.dataInfoForm.bandSettings,style:{width:"100%"}},{default:e(()=>[(t(!0),c(ae,null,ve(o.bandTableData,_=>(t(),k(D,{key:_.prop,prop:_.prop,label:_.label,align:"center"},{default:e(ne=>[a(X,{modelValue:ne.row[_.prop],"onUpdate:modelValue":ce=>ne.row[_.prop]=ce,class:"centerInput",type:"text",readonly:_.prop==="name"},null,8,["modelValue","onUpdate:modelValue","readonly"])]),_:2},1032,["prop","label"]))),128))]),_:1},8,["data"])]),_:1})])):G("",!0)]),_:1},8,["model","rules"])])]),r("div",Kl,[Jl,l(d)==="WMS"?(t(),c("div",Yl,[a(Y,{ref_key:"editWmsTileInfoForm",ref:S,class:"form edit-form",inline:"",model:o.wmsTileInfoForm,"label-width":"auto","label-position":"right"},{default:e(()=>[l(C).dataType==="VECTOR"?(t(),c("div",Xl,[a(K,{key:"styleInfo",class:"style-item",label:"样式设置",prop:"styleInfo"},{default:e(()=>[a(l(Ye),{modelValue:o.wmsTileInfoForm.styleInfo,"onUpdate:modelValue":W[1]||(W[1]=_=>o.wmsTileInfoForm.styleInfo=_),style:{width:"100%"},"tree-props":l(I),"tree-data":l(A),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(b)},null,8,["modelValue","tree-props","tree-data","group-identify"]),r("div",Zl,[a(ue,{type:"primary",link:"",icon:l(Ba),onClick:L},{default:e(()=>[q(" 样式管理 ")]),_:1},8,["icon"]),a(ue,{link:"",icon:l(za),onClick:W[2]||(W[2]=_=>l(H)())},{default:e(()=>[q(" 刷新 ")]),_:1},8,["icon"])])]),_:1}),a(K)])):G("",!0),r("div",Ql,[a(K,{key:"wmsTileInfoForm.srs",label:"输出坐标",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:e(()=>[a(N,{modelValue:o.wmsTileInfoForm.srs,"onUpdate:modelValue":W[3]||(W[3]=_=>o.wmsTileInfoForm.srs=_),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(U),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(n),_=>(t(),k(M,{key:_.value,label:_.value,value:_.value},{default:e(()=>[r("div",eo,[r("span",null,z(_.value),1),ao,r("span",null,z(_.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])]),_:1})]),l(C).dataType==="VECTOR"?(t(),c("div",to,[a(K,{label:"过滤条件",prop:"cqlFilter"},{default:e(()=>[a(X,{modelValue:o.wmsTileInfoForm.cqlFilter,"onUpdate:modelValue":W[4]||(W[4]=_=>o.wmsTileInfoForm.cqlFilter=_),type:"textarea",rows:2,placeholder:"请输入过滤条件"},null,8,["modelValue"])]),_:1})])):G("",!0)]),_:1},8,["model"])])):G("",!0),l(d)==="WMTS"?(t(),c("div",lo,[a(Y,{ref_key:"editWmtsTileInfoForm",ref:u,class:"form edit-form",inline:"",model:o.wmtsTileInfoForm,"label-width":"auto","label-position":"right"},{default:e(()=>[l(C).dataType==="VECTOR"?(t(),c("div",oo,[a(K,{key:"styleInfo",class:"style-item",label:"样式设置",prop:"styleInfo"},{default:e(()=>[a(l(Ye),{modelValue:o.wmtsTileInfoForm.styleInfo,"onUpdate:modelValue":W[5]||(W[5]=_=>o.wmtsTileInfoForm.styleInfo=_),style:{width:"100%"},"tree-props":l(I),"tree-data":l(A),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(b)},null,8,["modelValue","tree-props","tree-data","group-identify"]),r("div",no,[a(ue,{type:"primary",link:"",icon:l(Ba),onClick:L},{default:e(()=>[q(" 样式管理 ")]),_:1},8,["icon"]),a(ue,{link:"",icon:l(za),onClick:W[6]||(W[6]=_=>l(H)())},{default:e(()=>[q(" 刷新 ")]),_:1},8,["icon"])])]),_:1}),a(K)])):G("",!0),r("div",so,[a(K,{key:"wmtsTileInfoForm.srs",label:"输出坐标",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:e(()=>[a(N,{modelValue:o.wmtsTileInfoForm.srs,"onUpdate:modelValue":W[7]||(W[7]=_=>o.wmtsTileInfoForm.srs=_),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(U),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(n),_=>(t(),k(M,{key:_.value,label:_.value,value:_.value},{default:e(()=>[r("div",io,[r("span",null,z(_.value),1),ro,r("span",null,z(_.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])]),_:1})]),l(C).dataType==="VECTOR"?(t(),c("div",uo,[a(K,{label:"过滤条件",prop:"cqlFilter"},{default:e(()=>[a(X,{modelValue:o.wmtsTileInfoForm.cqlFilter,"onUpdate:modelValue":W[8]||(W[8]=_=>o.wmtsTileInfoForm.cqlFilter=_),type:"textarea",rows:2,placeholder:"请输入过滤条件"},null,8,["modelValue"])]),_:1})])):G("",!0),r("div",co,[a(K,{key:"wmtsTileInfoForm.format",label:"输出格式",prop:"format",rules:{required:!0,message:"至少选择一种输出格式",trigger:"change"}},{default:e(()=>[a(B,{modelValue:o.wmtsTileInfoForm.format,"onUpdate:modelValue":W[9]||(W[9]=_=>o.wmtsTileInfoForm.format=_)},{default:e(()=>[o.includesBandSettings.includes(l(C).dataType)?(t(),k(Q,{key:0,label:"gif"},{default:e(()=>[q("gif")]),_:1})):(t(),k(Q,{key:1,label:"geojson"},{default:e(()=>[q("geojson")]),_:1})),a(Q,{label:"jpeg"},{default:e(()=>[q("jpeg")]),_:1}),a(Q,{label:"png",disabled:""},{default:e(()=>[q("png")]),_:1}),a(Q,{label:"png8"},{default:e(()=>[q("png8")]),_:1})]),_:1},8,["modelValue"])]),_:1})]),r("div",po,[a(K,{key:"wmtsTileInfoForm.gridSets",label:"网格集",prop:"gridSets",rules:{required:!0,message:"网格集不能为空",trigger:"change"}},{default:e(()=>[a(N,{modelValue:o.wmtsTileInfoForm.gridSets,"onUpdate:modelValue":W[10]||(W[10]=_=>o.wmtsTileInfoForm.gridSets=_),style:{width:"100%"},filterable:"",placeholder:"请选择网格集",onChange:i},{default:e(()=>[(t(!0),c(ae,null,ve(l(T),_=>(t(),k(M,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(K,{key:"wmtsTileInfoForm.level",label:"切片级别",prop:"level",rules:o.levelRules},{default:e(()=>[a(N,{modelValue:o.wmtsTileInfoForm.level[0],"onUpdate:modelValue":W[11]||(W[11]=_=>o.wmtsTileInfoForm.level[0]=_),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(o.levelOptions,_=>(t(),k(M,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),mo,a(N,{modelValue:o.wmtsTileInfoForm.level[1],"onUpdate:modelValue":W[12]||(W[12]=_=>o.wmtsTileInfoForm.level[1]=_),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(o.levelOptions,_=>(t(),k(M,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["rules"])])]),_:1},8,["model"])])):G("",!0)])],64)}}});const go={class:"subtitle-main"},yo={class:"main"},_o={class:"main server-common-form"},bo={class:"footer"},vo=Oe({__name:"DataSelectDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue","select-data","success"],setup(re,{emit:te}){const h=te,I=we("category"),A=we("categoryAliasName"),b=we("serviceId"),n=ee(1),v=ee(!0),T=ee(!1),C=ee(qe.DATARESOURCE),w=ee(),R=ee(),U=ee(),H=Se(()=>({[qe.DATARESOURCE]:sl,[qe.RESULTDATA]:el,[qe.DATASET]:Gt})[C.value]),f=Fe({selectData:{},is3Dtiles:!1,is2D:!1}),p=Se(()=>{var E;return!!((E=f.selectData)!=null&&E.resourceId)});Be("getDataInfo",pe);function pe(){return f.selectData}const S=()=>{var E;C.value=qe.DATARESOURCE,(E=w.value)==null||E.reset()};function u(){h("update:modelValue",!1),n.value=1,f.selectData={},v.value=!0,T.value=!1}const g=E=>{f.selectData=E};function o(){d(),n.value=2}function d(){if(f.is3Dtiles=!1,f.is2D=!1,["WMS","WMTS"].includes(I.value)){f.is2D=!0;return}const{dataType:i,dataFormat:L,resultData:P}=f.selectData,m=["3DTILES","GEOJSON","TERRAIN","PNG","WEBP","PAK","ZNP"];(P||["MAPTILEPACKGE","MAPBOXTILE"].includes(i.toUpperCase())||m.includes(L.toUpperCase()))&&(f.is3Dtiles=!0)}function s(){var i,L,P,m;let E={id:b.value,resourceId:f.selectData.resourceId,publishService:!0,addVersion:!0,switchVersion:v.value,category:I.value,categoryAliasName:A.value};f.is3Dtiles?$(E):f.is2D?(L=(i=U.value)==null?void 0:i.handleSave)==null||L.call(i).then(le=>{E={...E,...le},$(E)}):(m=(P=R.value)==null?void 0:P.handleSave)==null||m.call(P).then(le=>{E={...E,...le},$(E)})}function $(E){T.value=!0,We.publishService([E]).then(i=>{T.value=!1,i.code==="0000"?(he({type:"success",title:"服务更新成功"}),h("success"),u==null||u()):he({type:"error",title:"服务更新失败",message:i.message})}).catch(i=>{T.value=!1,he({type:"error",title:"服务更新错误",message:i.message})})}return(E,i)=>{const L=y("el-step"),P=y("el-steps"),m=y("el-tab-pane"),le=y("el-tabs"),se=y("el-button"),W=y("el-checkbox"),D=y("el-dialog");return t(),k(D,{"model-value":E.modelValue,"close-on-click-modal":!1,class:"data-select-dialog center-dialog",title:"添加版本",width:"1160px",onOpen:S,onClose:u},{default:e(()=>[r("div",go,[a(P,{active:n.value,"align-center":!0,simple:!0},{default:e(()=>[a(L,{title:"选择数据",status:n.value===1?"finish":"success"},null,8,["status"]),a(L,{title:"参数设置",status:n.value===2?"finish":"wait"},null,8,["status"])]),_:1},8,["active"])]),ze(r("div",yo,[a(le,{modelValue:C.value,"onUpdate:modelValue":i[0]||(i[0]=J=>C.value=J),size:"large"},{default:e(()=>[a(m,{name:l(qe).DATARESOURCE,label:"数据资源池"},null,8,["name"]),a(m,{name:l(qe).DATASET,disabled:"",label:"数据集"},null,8,["name"])]),_:1},8,["modelValue"]),(t(),k(ja,null,[(t(),k($a(H.value),{ref:J=>w.value=J,onSelect:g},null,544))],1024))],512),[[Ga,n.value===1]]),ze(r("div",_o,[n.value===2&&p.value?(t(),c(ae,{key:0},[f.is3Dtiles?(t(),k(lt,{key:0})):f.is2D?(t(),k(fo,{key:1,ref_key:"common2dRef",ref:U},null,512)):(t(),k(Nl,{key:2,ref_key:"paramsRef",ref:R},null,512))],64)):G("",!0)],512),[[Ga,n.value===2]]),r("div",bo,[a(se,{onClick:u},{default:e(()=>[q("取消")]),_:1}),n.value===1?(t(),k(se,{key:0,type:"primary",disabled:!p.value,onClick:o},{default:e(()=>[q(" 下一步 ")]),_:1},8,["disabled"])):G("",!0),n.value===2?(t(),k(se,{key:1,type:"primary",onClick:i[1]||(i[1]=J=>n.value=1)},{default:e(()=>[q("上一步 ")]),_:1})):G("",!0),n.value===2?(t(),k(se,{key:2,type:"warning",onClick:s},{default:e(()=>[q("更新")]),_:1})):G("",!0),n.value===2?(t(),k(W,{key:3,modelValue:v.value,"onUpdate:modelValue":i[2]||(i[2]=J=>v.value=J),label:"更新完成后直接使用该版本",style:{"margin-left":"12px"}},null,8,["modelValue"])):G("",!0)])]),_:1},8,["model-value"])}}});const ho={class:"top"},To={class:"table center"},Io=["title"],Do={class:"dialog-footer"},ko={class:"operation"},nt=Oe({__name:"ImportDataDialog",props:{visible:{type:Boolean,default:!1},curDataType:{default:{dataType:[""],serviceType:""}}},emits:["update:visible","save"],setup(re,{emit:te}){const h=te,I=re,A=ee(),b=ee(),{currentPage:n,pageSize:v,pageSizes:T,total:C,handleSizeChange:w,handleCurrentPageChange:R}=ba(A,b,o,void 0),U=[{prop:"name",label:"数据名称",minWidth:160},{prop:"dataTypeAliasName",label:"数据类型",width:200},{prop:"dataSize",label:"数据大小",width:130},{prop:"creator",label:"创建者",width:130},{prop:"createTime",label:"创建时间",width:180}],H=Fe({dialogVisible:!1,tableData:[],isLoadingTable:!1,form:{keyword:"",status:"PROCESSED,PUBLISHED",dataType:"",dataFormat:"",catalogId:""},selection:[]}),f=we("getImportedList"),p=Se(()=>f==null?void 0:f());Ke(()=>I.visible,E=>{H.dialogVisible=E});function pe(){H.form.keyword="",[H.form.dataType,H.form.dataFormat]=I.curDataType.dataType,o(),He(()=>{var E;(E=p.value)==null||E.forEach(i=>{var L;(L=b.value)==null||L.toggleRowSelection(i,!0)})})}function S(){var E;H.selection=[],H.tableData=[],(E=b.value)==null||E.clearSelection(),h("update:visible",!1)}function u(E){var i;return!((i=p.value)!=null&&i.some(L=>L.resourceId===E.resourceId))}function g(){n.value=1,o()}function o(){H.isLoadingTable=!0;const E={page:n.value,rows:v.value,...H.form};We.getDataPageList(E).then(i=>{H.isLoadingTable=!1,i.code==="0000"?(H.tableData=i.data?i.data.records:[],H.tableData||(H.tableData=[]),C.value=i.data?i.data.total:0):oe({type:"error",message:i.message||"获取表格数据失败"})}).catch(i=>{H.isLoadingTable=!1,oe({type:"error",message:i.message||"获取表格数据错误"})})}function d(E){H.selection=E}function s(E){return`${E.dataTypeAliasName} / ${E.dataFormat}`}function $(){h("save",Ie.cloneDeep(H.selection)),S()}return(E,i)=>{const L=y("el-input"),P=y("el-table-column"),m=y("el-pagination"),le=y("el-button"),se=y("el-dialog"),W=ea("loading");return t(),k(se,{modelValue:H.dialogVisible,"onUpdate:modelValue":i[3]||(i[3]=D=>H.dialogVisible=D),class:"center-dialog import-data-dialog",width:"900px","append-to-body":!1,"close-on-click-modal":!1,"close-on-press-escape":!1,title:"导入数据",onOpen:pe,onClosed:S},{footer:e(()=>[r("div",Do,[r("div",ko,"共选中 "+z(H.selection.length)+" 条",1),l(C)&&l(C)>0?(t(),k(m,{key:0,"current-page":l(n),"onUpdate:currentPage":i[1]||(i[1]=D=>ta(n)?n.value=D:null),"page-size":l(v),"onUpdate:pageSize":i[2]||(i[2]=D=>ta(v)?v.value=D:null),layout:"total, sizes, prev, pager, next","page-sizes":l(T),total:l(C),onSizeChange:l(w),onCurrentChange:l(R)},null,8,["current-page","page-size","page-sizes","total","onSizeChange","onCurrentChange"])):G("",!0),r("div",null,[a(le,{onClick:S},{default:e(()=>[q("取 消")]),_:1}),a(le,{type:"primary",disabled:H.selection.length===0,onClick:$},{default:e(()=>[q(" 确 定 ")]),_:1},8,["disabled"])])])]),default:e(()=>[r("div",{ref_key:"mainContainerRef",ref:A,class:"main-import-content"},[r("div",ho,[a(L,{modelValue:H.form.keyword,"onUpdate:modelValue":i[0]||(i[0]=D=>H.form.keyword=D),class:"search-input",clearable:"",placeholder:"输入关键字查询","prefix-icon":l(ga),onClear:g,onChange:g},null,8,["modelValue","prefix-icon"])]),r("div",To,[ze((t(),k(l(Oa),{ref_key:"tableRef",ref:b,class:"data-table","element-loading-text":"拼命加载中...",style:{width:"100%"},data:H.tableData,"max-height":420,"row-key":"resourceId",stripe:"","highlight-current-row":"",onSelectionChange:d},{default:e(()=>[a(P,{align:"center",type:"selection",label:"选中","reserve-selection":"",selectable:u}),(t(),c(ae,null,ve(U,D=>a(P,{key:D.prop,prop:D.prop,label:D.label,width:D.width,"min-width":D.minWidth,align:"center"},{default:e(J=>[r("span",{title:`${J.row[D.prop]}`},[D.prop==="dataTypeAliasName"?(t(),c(ae,{key:0},[q(z(s(J.row)),1)],64)):D.prop==="dataSize"?(t(),c(ae,{key:1},[q(z(J.row[D.prop]||"--"),1)],64)):(t(),c(ae,{key:2},[q(z(J.row[D.prop]),1)],64))],8,Io)]),_:2},1032,["prop","label","width","min-width"])),64))]),_:1},8,["data"])),[[W,H.isLoadingTable]])])],512)]),_:1},8,["modelValue"])}}});const So={id:"lightweight-form-container"},Vo={class:"content-wrap"},Co={class:"subtitle"},wo=r("span",{class:"text"},"参数设置",-1),Fo={key:0,class:"tip"},Eo={class:"content-wrap","element-loading-text":"正在获取方案参数..."},$o={class:"item-wrap item2"},Oo={key:1},xo=Oe({__name:"LightweightForm",props:{type:{default:De.CHECK},curEditId:{default:""},submiting:{type:Boolean,default:!1},addTypeData:{default:{dataType:[""],serviceType:""}}},emits:["update:submiting","changeType","save"],setup(re,{expose:te,emit:h}){const I=h,A=re,b=we("serviceId"),n=we("handleClosed"),v=ee(),T=ee(),C=ee([]);Be("getImportedList",M);const{checkResourceSetName:w,allServiceOptions:R,treeProps:U,groupIdentify:H}=at(D,J),f=Fe({isLoading:!1,initData:{id:"",name:"",aliasName:"",curDataType:[""],serviceType:"",description:"",resourceDatas:[]},editData:{},rules:{name:[{required:!0,validator:w,trigger:["blur","change"]},{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]}],aliasName:[{required:!0,message:"数据集名称不能为空",trigger:["blur","change"]}]},isLinkSuccess:!0,selection:[],isLoadingTable:!1,curImportTypeData:{dataType:[""],serviceType:""},importDataDialogVisible:!1});ua(()=>{C.value=[]});const p=Se(()=>{var me;return((me=f.editData.curDataType)==null?void 0:me[0])||""}),pe=Se(()=>f.editData.serviceType||""),{tileInfoForm:S,cellData:u,showErrorTip:g,isLoadingScheme:o,tileInfoFormRule:d,taskTreeData:s,publishConfigList:$,getAllTask:E,checkDagScheme:i,handleTaskChange:L,handleControlChange:P,getTaskInfoById:m,renderSchemeByDag:le}=tt(p,!1);Ha(()=>{E()}),Xe(()=>{se()});function se(){if(A.type===De.ADD){f.editData=Ie.cloneDeep(f.initData);const{dataType:me,serviceType:K}=A.addTypeData;f.editData.curDataType=me,f.editData.serviceType=K,f.curImportTypeData.dataType=me,f.curImportTypeData.serviceType=K}else W(A.curEditId)}function W(me){f.isLoading=!0,da.getResourcesetById(me).then(K=>{if(K.code==="0000"){f.editData=Ie.cloneDeep(f.initData);for(const X in f.initData)f.editData[X]=K.data[X];f.editData.curDataType=[K.data.dataType,K.data.dataFormat],o.value=!0,setTimeout(()=>{var X,Q;(X=K.data)!=null&&X.taskId&&m(K.data.taskId),(Q=K.data)!=null&&Q.dag&&le(K.data.dag)},400),f.curImportTypeData.dataType=Ie.cloneDeep(f.editData.curDataType),f.curImportTypeData.serviceType=f.editData.serviceType}else oe({type:"error",message:"获取信息失败"})}).catch(()=>{oe({type:"error",message:"获取信息错误"})}).finally(()=>{f.isLoading=!1})}function D(){return pe.value}function J(){return f.editData.id}function Y(me){f.selection=me.map(K=>K.resourceId)}function M(){return f.editData.resourceDatas||[]}function N(me){f.editData.resourceDatas=[...me]}function ue(me=!0){const K=C.value;(K==null?void 0:K.length)>0?i(!0).then(Q=>{var B,_;if(Q&&((B=f.editData.resourceDatas)==null?void 0:B.length)>0){const ne=Ie.cloneDeep(f.editData);ne.addVersion=!0,ne.serviceId=b.value,[ne.dataType,ne.dataFormat]=f.editData.curDataType,Reflect.deleteProperty(ne,"curDataType"),ne.serviceTypeAliasName=(_=R.value.find(_e=>_e.code===ne.serviceType))==null?void 0:_.showValue;const{taskInfo:ce}=S.value;ne.taskId=ce.id;const O={cells:Ie.cloneDeep(u.value)};ne.dag=JSON.stringify(O),I("update:submiting",!0),da.publishResourceset(ne,{publishService:me}).then(_e=>{I("update:submiting",!1),_e.code==="0000"?(he({type:"success",title:`${A.type===De.ADD?"新增":"保存"}成功`}),I("save"),n==null||n()):he({type:"error",title:`${A.type===De.ADD?"新增":"保存"}失败`,message:_e.message})}).catch(_e=>{I("update:submiting",!1),he({type:"error",title:`${A.type===De.ADD?"新增":"保存"}错误`,message:_e.message})})}}):oe({type:"warning",message:"请选择正确的切片方案！"})}return te({handleSaveForm:ue}),(me,K)=>{const X=y("el-table-column"),Q=y("el-form"),B=y("el-form-item"),_=ea("loading");return ze((t(),c("div",So,[r("div",Vo,[a(Q,{ref_key:"tableForm",ref:v,class:"form edit-form",model:f.editData},{default:e(()=>[ze((t(),k(l(Oa),{ref_key:"dataListTable",ref:T,class:"dataListTable",data:f.editData.resourceDatas,"row-key":"resourceId",onSelectionChange:Y},{default:e(()=>[a(X,{align:"center",prop:"name",label:"数据名称"})]),_:1},8,["data"])),[[_,f.isLoadingTable]])]),_:1},8,["model"])]),r("div",Co,[wo,l(g)?(t(),c("span",Fo," 请正确设置方案参数 ")):G("",!0)]),ze((t(),c("div",Eo,[r("div",null,[a(Q,{ref:"editTileInfoForm",class:"form edit-form",inline:"",model:l(S),rules:l(d),"label-width":"120px","label-position":"right"},{default:e(()=>[r("div",$o,[a(B,{label:"切片方案：",prop:"taskInfo"},{default:e(()=>[me.type!==l(De).CHECK?(t(),k(l(Ye),{key:0,modelValue:l(S).taskInfo,"onUpdate:modelValue":K[0]||(K[0]=ne=>l(S).taskInfo=ne),style:{width:"100%"},"tree-props":l(U),"tree-data":l(s),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(H),onChange:l(L)},null,8,["modelValue","tree-props","tree-data","group-identify","onChange"])):(t(),c("span",Oo,z(l(S).taskInfo.name),1))]),_:1}),a(B)])]),_:1},8,["model","rules"]),l($).length>0?(t(!0),c(ae,{key:0},ve(l($),(ne,ce)=>(t(),k(Q,{ref_for:!0,ref:O=>{O&&(C.value[ce]=O)},key:ne.uid,class:"form scheme-form__common",uid:ne.uid,inline:"",model:ne.pubulishData,"label-width":"120px","label-position":"right"},{default:e(()=>[(t(!0),c(ae,null,ve(ne.paramsConfigList,(O,_e)=>(t(),k(B,{key:O.paramName+_e,class:Re([{"scheme-form-item":!0,"is-left":_e%2===0}]),label:O.paramLabel+"：",prop:O.paramName,required:O.required,rules:{required:O.required,message:`${O.paramLabel}不能为空`}},{default:e(()=>[a(l(Aa),{ref_for:!0,ref:"paramForm",modelValue:ne.pubulishData[O.paramName],"onUpdate:modelValue":V=>ne.pubulishData[O.paramName]=V,"control-name":O.paramName,uid:ne.uid,type:ne.type,"all-param":O,relations:ne.relations,onChange:l(P)},null,8,["modelValue","onUpdate:modelValue","control-name","uid","type","all-param","relations","onChange"])]),_:2},1032,["class","label","prop","required","rules"]))),128))]),_:2},1032,["uid","model"]))),128)):G("",!0)])])),[[_,l(o)]]),a(nt,{visible:f.importDataDialogVisible,"onUpdate:visible":K[1]||(K[1]=ne=>f.importDataDialogVisible=ne),"cur-data-type":f.curImportTypeData,onSave:N},null,8,["visible","cur-data-type"])])),[[_,f.isLoading]])}}});const Ro={key:0,class:"item-wrap"},Lo={class:"list-item"},Ao=r("span",null," — — ",-1),No={key:1,class:"item-wrap"},Uo={class:"origin"},Po={key:2,class:"item-wrap"},Mo={class:"rotate"},Bo={class:"dialog-footer"},zo=Oe({__name:"SettingDataDialog",props:{visible:{type:Boolean,default:!1},serviceType:{default:""},editId:{default:""}},emits:["update:visible","save"],setup(re,{emit:te}){const h=te,I=re,A=ee(),b=ee(),n=Fe({dialogVisible:!1,srsOptions:[],srsCopyOptions:[],editData:{srs:"",origin:{x:"",y:"",z:""},rotate:0},rules:{srs:[{required:!0,message:"坐标系统不能为空",trigger:"change"}],origin:{type:"object",required:!0,fields:{x:{required:!0,validator:f,trigger:["blur","change"]},y:{required:!0,validator:f,trigger:["blur","change"]},z:{required:!0,validator:f,trigger:["blur","change"]}}}}}),v=we("getImportedList"),T=we("getSrsOptions"),C=Se(()=>v==null?void 0:v());Ke(()=>I.visible,S=>{n.dialogVisible=S});function w(){var u,g;U();let S={};if(I.editId?S=(u=C.value)==null?void 0:u.find(o=>o.resourceId===I.editId):S=(g=C.value)==null?void 0:g[0],S){const{srs:o=sa,srsOrigin:d=Da,rotate:s=ka}=S;n.editData.srs=o;const $=d.split(",");n.editData.origin={x:$[0],y:$[1],z:$[2]},n.editData.rotate=s}He(()=>{b.value.clearValidate()})}function R(){h("update:visible",!1)}function U(){n.srsOptions=T==null?void 0:T(),n.srsCopyOptions=Ie.cloneDeep(n.srsOptions)}function H(S){S?n.srsOptions=Ie.cloneDeep(n.srsCopyOptions).filter(u=>u.label.toLowerCase().includes(S.toLowerCase())||u.value.toLowerCase().includes(S.toLowerCase())):n.srsOptions=Ie.cloneDeep(n.srsCopyOptions)}function f(S,u,g){const o=!!n.editData.origin.x,d=!!n.editData.origin.y,s=!!n.editData.origin.z;o&&d&&s?g():g(new Error(`请完整填写偏移量，${o?"":" X"}${d?"":" Y"}${s?"":" Z"}不能为空`))}function p(S){n.editData.origin[S]=n.editData.origin[S].replace(/^\.+|[^\d.]/g,"")}function pe(){b.value.validate(S=>{S&&(h("save",Ie.cloneDeep(n.editData),I.editId),R())})}return(S,u)=>{const g=y("el-option"),o=y("el-select"),d=y("el-form-item"),s=y("el-input"),$=y("el-input-number"),E=y("el-form"),i=y("el-button"),L=y("el-dialog");return t(),k(L,{modelValue:n.dialogVisible,"onUpdate:modelValue":u[8]||(u[8]=P=>n.dialogVisible=P),class:"center-dialog setting-data-dialog",width:"420px","append-to-body":!1,"close-on-click-modal":!1,"close-on-press-escape":!1,title:"批量设置",onOpen:w,onClosed:R},{footer:e(()=>[r("div",Bo,[a(i,{onClick:R},{default:e(()=>[q("取 消")]),_:1}),a(i,{type:"primary",onClick:pe},{default:e(()=>[q(" 确 定 ")]),_:1})])]),default:e(()=>[r("div",{ref_key:"mainContainerRef",ref:A,class:"main-container"},[a(E,{ref_key:"editForm",ref:b,class:"form edit-form",inline:"",model:n.editData,rules:n.rules,"label-width":"100px","label-position":"right"},{default:e(()=>[l(Ta).includes(S.serviceType)?(t(),c("div",Ro,[a(d,{key:"srs",label:"坐标系统：",prop:"srs"},{default:e(()=>[a(o,{modelValue:n.editData.srs,"onUpdate:modelValue":u[0]||(u[0]=P=>n.editData.srs=P),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":H,placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(n.srsOptions,P=>(t(),k(g,{key:P.value,label:P.value,value:P.value},{default:e(()=>[r("div",Lo,[r("span",null,z(P.value),1),Ao,r("span",null,z(P.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})])):G("",!0),l(ia).includes(S.serviceType)?(t(),c("div",No,[a(d,{label:"偏移量：",prop:"origin"},{default:e(()=>[r("div",Uo,[a(s,{modelValue:n.editData.origin.x,"onUpdate:modelValue":u[1]||(u[1]=P=>n.editData.origin.x=P),placeholder:"请输入X坐标",onInput:u[2]||(u[2]=P=>p("x"))},{prepend:e(()=>[q("X :")]),_:1},8,["modelValue"]),a(s,{modelValue:n.editData.origin.y,"onUpdate:modelValue":u[3]||(u[3]=P=>n.editData.origin.y=P),placeholder:"请输入Y坐标",onInput:u[4]||(u[4]=P=>p("y"))},{prepend:e(()=>[q("Y :")]),_:1},8,["modelValue"]),a(s,{modelValue:n.editData.origin.z,"onUpdate:modelValue":u[5]||(u[5]=P=>n.editData.origin.z=P),placeholder:"请输入Z坐标",onInput:u[6]||(u[6]=P=>p("z"))},{prepend:e(()=>[q("Z :")]),_:1},8,["modelValue"])])]),_:1})])):G("",!0),l(Ia).includes(S.serviceType)?(t(),c("div",Po,[a(d,{label:"旋转角度：",prop:"rotate"},{default:e(()=>[r("div",Mo,[a($,{modelValue:n.editData.rotate,"onUpdate:modelValue":u[7]||(u[7]=P=>n.editData.rotate=P),placeholder:"请输入旋转角度","controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])])]),_:1})])):G("",!0)]),_:1},8,["model","rules"])],512)]),_:1},8,["modelValue"])}}});const Go={id:"original-form-container"},qo={class:"content-wrap"},Wo={class:"common-container"},jo=r("div",{class:"lable"},"坐标系统：",-1),Ho={class:"list-item"},Ko=r("span",null," — — ",-1),Jo={key:1,class:"lable",style:{"margin-right":"50px"}},Yo=r("div",{class:"lable"},"全局样式：",-1),Xo={key:1,class:"lable",style:{"margin-right":"50px"}},Zo={class:"content-wrap"},Qo={key:1},en=["onClick"],an=["onClick"],tn={class:"subtitle"},ln=r("span",{class:"text"},"参数设置",-1),on={key:0,class:"tip"},nn={key:0,class:"content-wrap"},sn={class:"item-wrap"},rn={class:"list-item"},dn=r("span",null," — — ",-1),un={key:1},cn={key:0,class:"item-wrap"},pn={key:1,class:"item-wrap item2"},mn={key:1},fn=r("span",{style:{margin:"0 15px"}},"——",-1),gn=r("span",{style:{margin:"0 15px"}},"——",-1),yn={key:1,class:"content-wrap","element-loading-text":"正在获取方案参数..."},_n={class:"item-wrap item2"},bn={key:1},vn=Oe({__name:"OriginalForm",props:{type:{default:De.CHECK},curEditId:{default:""},submiting:{type:Boolean,default:!1},addTypeData:{default:{dataType:[""],serviceType:""}}},emits:["update:submiting","changeType","save"],setup(re,{expose:te,emit:h}){const I=h,A=re,b=we("serviceId"),n=we("handleClosed"),v=ee(),T=ee(),C=ee(),w=ee([]);Be("getImportedList",_e),Be("getSrsOptions",V);const{checkFormPass:R,checkResourceSetName:U,srsOptions:H,srsFilterFunc:f,stylesList:p,treeProps:pe,groupIdentify:S,gridSetsList:u,allServiceOptions:g,getGridSetsName:o,getStyleById:d}=at(_,ne),s=Fe({isLoading:!1,initData:{id:"",name:"",aliasName:"",curDataType:[""],serviceType:"",description:"",resourceDatas:[]},editData:{},rules:{name:[{required:!0,validator:U,trigger:["blur","change"]},{min:0,max:50,message:"长度在 50 个字符以内",trigger:["blur","change"]}],aliasName:[{required:!0,message:"数据集名称不能为空",trigger:["blur","change"]}]},selection:[],isLoadingTable:!1,curImportTypeData:{dataType:[""],serviceType:""},importDataDialogVisible:!1,settingDataDialogVisible:!1,curImportCoordinateId:"",curSettingDataId:"",commonSrs:"",commonStyleInfo:null,otherTileInfoForm:{srs:"",format:["png"],gridSets:"",level:["",""]},levelRules:{type:"array",required:!0,trigger:"change",len:2,fields:{0:{type:"number",required:!0,message:"请完整填写切片级别"},1:{type:"number",required:!0,message:"请完整填写切片级别"}}},levelOptions:[]});ua(()=>{w.value=[]});const $=Se(()=>{var F;return((F=s.editData.curDataType)==null?void 0:F[0])||""}),E=Se(()=>$.value==="VECTOR"),i=Se(()=>s.editData.serviceType||""),L=Se(()=>A.type!==De.CHECK&&(i.value==="WMS"||i.value==="WMTS")),P=ee(null);Ke(()=>L.value,F=>{var x,ie;F?j():(x=P.value)!=null&&x.el&&((ie=P.value)==null||ie.destroy())});const{tileInfoForm:m,cellData:le,showErrorTip:se,isLoadingScheme:W,tileInfoFormRule:D,taskTreeData:J,publishConfigList:Y,getAllTask:M,checkDagScheme:N,handleTaskChange:ue,handleControlChange:me,getTaskInfoById:K,renderSchemeByDag:X}=tt($,!1);Ha(()=>{M()}),Xe(()=>{Q()});function Q(){if(A.type===De.ADD){s.editData=Ie.cloneDeep(s.initData);const{dataType:F,serviceType:x}=A.addTypeData;s.editData.curDataType=F,s.editData.serviceType=x,s.curImportTypeData.dataType=F,s.curImportTypeData.serviceType=x}else B(A.curEditId);He(()=>{var F;(F=C.value)==null||F.clearValidate()})}function B(F){s.isLoading=!0,da.getResourcesetById(F).then(x=>{var ie,ge,Te,Ve;if(x.code==="0000"){s.editData=Ie.cloneDeep(s.initData);for(const ye in s.initData)s.editData[ye]=x.data[ye];if(s.editData.curDataType=[x.data.dataType,x.data.dataFormat],s.editData.resourceDatas.forEach(ye=>{let{dataInfo:Z}=ye;Z&&(Z=JSON.parse(Z)),ye.srs=Z!=null&&Z.srs?`EPSG:${Z.srs}`:sa,ye.srsOrigin=(Z==null?void 0:Z.srsOrigin)??Da,ye.rotate=(Z==null?void 0:Z.rotate)??ka,E.value&&setTimeout(()=>{let ke=null;Z!=null&&Z.styleId&&(ke=d(Z.styleId)),ye.styleInfo=ke},400)}),i.value!=="WMS"&&i.value!=="WMTS")W.value=!0,setTimeout(()=>{var ye,Z;(ye=x.data)!=null&&ye.taskId&&K(x.data.taskId),(Z=x.data)!=null&&Z.dag&&X(x.data.dag)},400);else{const ye=JSON.parse((ie=x.data)==null?void 0:ie.dataInfo);if(s.commonSrs=ye!=null&&ye.srs?`EPSG:${ye.srs}`:sa,E.value){const ke=JSON.parse((ge=x.data)==null?void 0:ge.dataInfo);setTimeout(()=>{let Ue=null;ke!=null&&ke.styleId&&(Ue=d(ke.styleId)),s.commonStyleInfo=Ue},300)}const Z=JSON.parse((Te=x.data)==null?void 0:Te.tileConfig)||{};if(Reflect.ownKeys(Z).length>0&&(s.otherTileInfoForm.srs=Z!=null&&Z.srs?`EPSG:${Z.srs}`:sa,s.otherTileInfoForm.format=((Ve=Z==null?void 0:Z.format)==null?void 0:Ve.split(","))||[],s.otherTileInfoForm.gridSets=(Z==null?void 0:Z.gridSets)??"",s.otherTileInfoForm.level=[(Z==null?void 0:Z.zoomStart)??"",(Z==null?void 0:Z.zoomStop)??""],Z!=null&&Z.gridSets)){const ke=u.value.find(je=>je.value===(Z==null?void 0:Z.gridSets)),Ue=Array(ke.max+1).fill(1);s.levelOptions=[],Ue.forEach((je,oa)=>{s.levelOptions.push({value:oa,lebel:oa})})}}s.curImportTypeData.dataType=Ie.cloneDeep(s.editData.curDataType),s.curImportTypeData.serviceType=s.editData.serviceType}else oe({type:"error",message:"获取信息失败"})}).catch(()=>{oe({type:"error",message:"获取信息错误"})}).finally(()=>{s.isLoading=!1})}function _(){return i.value}function ne(){return s.editData.id}function ce(F){s.selection=F.map(x=>x.resourceId)}function O(F){s.curImportCoordinateId=F,Ge()}function _e(){return s.editData.resourceDatas||[]}function V(){return H.value||[]}function be(F){s.curSettingDataId=F,s.settingDataDialogVisible=!0}function fe(F){s.isLoadingTable=!0;const x=Ie.cloneDeep(s.editData.resourceDatas);s.editData.resourceDatas=[],setTimeout(()=>{s.editData.resourceDatas=[...F],x.forEach(ie=>{const ge=s.editData.resourceDatas.find(Te=>Te.resourceId===ie.resourceId);ge&&(ge.srs=ie.srs,ge.srsOrigin=ie.srsOrigin,ge.rotate=ie.rotate,E.value&&(ge.styleInfo=ie.styleInfo))}),s.editData.resourceDatas.forEach(ie=>{ie.srs||(ie.srs=sa),ie.srsOrigin?ie.srsOrigin=ie.srsOrigin.replace(/\s*/g,""):ie.srsOrigin=Da,ie.rotate||(ie.rotate=ka),E.value&&!Reflect.has(ie,"styleInfo")&&(ie.styleInfo=null)}),(i.value==="WMS"||i.value==="WMTS")&&(s.commonSrs||(s.commonSrs=sa),s.editData.resourceDatas.forEach(ie=>{ie.srs=s.commonSrs,E.value&&!Reflect.has(ie,"styleInfo")&&(ie.styleInfo=null)})),s.isLoadingTable=!1},200)}function $e(){s.editData.resourceDatas.forEach(F=>{F.srs=s.commonSrs})}function Ce(F,x){const{srs:ie,origin:{x:ge,y:Te,z:Ve},rotate:ye}=F;x?s.editData.resourceDatas.forEach(Z=>{Z.resourceId===x&&(Z.srs=ie,Z.srsOrigin=`${ge},${Te},${Ve}`,Z.rotate=ye)}):s.editData.resourceDatas.forEach(Z=>{Z.srs=ie,Z.srsOrigin=`${ge},${Te},${Ve}`,Z.rotate=ye})}function Ge(){var F,x;(F=document.getElementById("importCoordinateFile"))==null||F.click(),(x=document.getElementById("importCoordinateFile"))==null||x.addEventListener("change",ie=>{const{files:ge}=ie.target;if(ge.length===0)return;const Te=ge[0];if(!/\.xml$/g.test(Te.name)){Le.alert("仅支持导入xml格式！","提示",{confirmButtonText:"确定",type:"error"}),ie.target.value="";return}Me(Te,Ve=>{const{system:ye,origin:{x:Z,y:ke,z:Ue}}=Ve;s.curImportCoordinateId?s.editData.resourceDatas.forEach(je=>{je.resourceId===s.curImportCoordinateId&&(je.srs=ye,je.srsOrigin=`${Z},${ke},${Ue}`)}):s.editData.resourceDatas.forEach(je=>{je.srs=ye,je.srsOrigin=`${Z},${ke},${Ue}`}),oe({type:"success",message:`导入${s.curImportCoordinateId?"":"全局"}文件成功!`})}),ie.target.value=""})}function Me(F,x){const ie=new FileReader;ie.onload=ge=>{var ke,Ue;const Te=ge.target.result,Ve={},ye=Te.match(/<SRS[^>]*>([\s\S]*?)<\/SRS>/);let Z=Te.match(/<SRSOrigin[^>]*>([\s\S]*?)<\/SRSOrigin>/);if(ia.includes(i.value)){if(!ye||!Z){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}}else if(!ye){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}[,Ve.system]=ye,ia.includes(i.value)&&(Z=(Ue=(ke=Z[1])==null?void 0:ke.replace(/\s*/g,""))==null?void 0:Ue.split(","),Ve.origin={x:Z[0],y:Z[1],z:Z[2]}),x&&x(Ve)},ie.readAsBinaryString(F)}function Ae(F){s.otherTileInfoForm.level[0]="",s.otherTileInfoForm.level[1]="";const x=u.value.find(ge=>ge.value===F),ie=Array(x.max+1).fill(1);s.levelOptions=[],ie.forEach((ge,Te)=>{s.levelOptions.push({value:Te,lebel:Te})})}function Ne(F=!0){if(i.value==="WMS"||i.value==="WMTS")R(C).then(x=>{var ie;if(x)if(((ie=s.editData.resourceDatas)==null?void 0:ie.length)>0){s.editData.resourceDatas.forEach(Ve=>{const ye={};Reflect.set(ye,"srs",Ve.srs.replace("EPSG:","")),E.value&&Reflect.set(ye,"styleId",Ve.styleInfo?Ve.styleInfo.id:null),Ve.dataInfo=JSON.stringify(ye)});const ge=Ie.cloneDeep(s.editData);[ge.dataType,ge.dataFormat]=s.editData.curDataType,Reflect.deleteProperty(ge,"curDataType");const Te={srs:s.otherTileInfoForm.srs.replace("EPSG:","")};i.value==="WMTS"&&(Te.format=s.otherTileInfoForm.format.join(","),Te.gridSets=s.otherTileInfoForm.gridSets,[Te.zoomStart,Te.zoomStop]=s.otherTileInfoForm.level),ge.tileConfig=JSON.stringify(Te),ge.dataInfo={srs:s.commonSrs.replace("EPSG:","")},E.value&&(ge.dataInfo.styleId=s.commonStyleInfo?s.commonStyleInfo.id:null),ge.dataInfo=JSON.stringify(ge.dataInfo),Ee(ge,F)}else oe({type:"warning",message:"请导入数据！"})}).catch(console.error);else{const x=w.value;(x==null?void 0:x.length)>0?N(!0).then(ie=>{var ge;if(ie)if(((ge=s.editData.resourceDatas)==null?void 0:ge.length)>0){s.editData.resourceDatas.forEach(Z=>{const ke={};Ta.includes(i.value)&&Reflect.set(ke,"srs",Z.srs.replace("EPSG:","")),ia.includes(i.value)&&Reflect.set(ke,"srsOrigin",Z.srsOrigin),Ia.includes(i.value)&&Reflect.set(ke,"rotate",Z.rotate),Z.dataInfo=JSON.stringify(ke)});const Te=Ie.cloneDeep(s.editData);Te.addVersion=!0,Te.serviceId=b.value,[Te.dataType,Te.dataFormat]=s.editData.curDataType,Reflect.deleteProperty(Te,"curDataType");const{taskInfo:Ve}=m.value;Te.taskId=Ve.id;const ye={cells:Ie.cloneDeep(le.value)};Te.dag=JSON.stringify(ye),Ee(Te,F)}else oe({type:"warning",message:"请导入数据！"})}):(oe({type:"warning",message:"请选择正确的切片方案！"}),R(C))}}function Ee(F,x){var ie;F.serviceTypeAliasName=(ie=g.value.find(ge=>ge.code===F.serviceType))==null?void 0:ie.showValue,I("update:submiting",!0),da.publishResourceset(F,{publishService:x}).then(ge=>{I("update:submiting",!1),ge.code==="0000"?(he({type:"success",title:`${A.type===De.ADD?"新增":"保存"}成功`}),I("save"),n==null||n()):he({type:"error",title:`${A.type===De.ADD?"新增":"保存"}失败`,message:ge.message})}).catch(ge=>{I("update:submiting",!1),he({type:"error",title:`${A.type===De.ADD?"新增":"保存"}错误`,message:ge.message})})}function aa(F){if(F){const x=F.split(",");return`X: ${x[0]}    Y: ${x[1]}    Z: ${x[2]}`}return"X: 0    Y: 0    Z: 0"}function j(){var ie;const x=((ie=v.value.$el)==null?void 0:ie.querySelector(".dataListTable")).querySelector(".el-table__body-wrapper tbody");P.value=Vt.create(x,{disabled:!1,onEnd({newIndex:ge,oldIndex:Te}){const Ve=Ie.cloneDeep(s.editData.resourceDatas),ye=Ve.splice(Te,1)[0];Ve.splice(ge,0,ye),s.editData.resourceDatas=[...Ve]}})}return te({handleSaveForm:Ne}),(F,x)=>{var Ua,Pa,Ma;const ie=y("el-option"),ge=y("el-select"),Te=y("Operation"),Ve=y("el-icon"),ye=y("el-table-column"),Z=y("el-form"),ke=y("el-form-item"),Ue=y("el-checkbox"),je=y("el-checkbox-group"),oa=ea("loading");return ze((t(),c("div",Go,[r("div",qo,[r("div",Wo,[i.value==="WMS"||i.value==="WMTS"?(t(),c(ae,{key:0},[jo,F.type!==l(De).CHECK?(t(),k(ge,{key:0,modelValue:s.commonSrs,"onUpdate:modelValue":x[0]||(x[0]=de=>s.commonSrs=de),style:{width:"200px","margin-right":"12px"},"popper-class":"srs-select",filterable:"","filter-method":l(f),disabled:((Ua=s.editData.resourceDatas)==null?void 0:Ua.length)===0,placeholder:"请选择",onChange:$e},{default:e(()=>[(t(!0),c(ae,null,ve(l(H),de=>(t(),k(ie,{key:de.value,label:de.value,value:de.value},{default:e(()=>[r("div",Ho,[r("span",null,z(de.value),1),Ko,r("span",null,z(de.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method","disabled"])):(t(),c("span",Jo,z(s.commonSrs),1)),E.value?(t(),c(ae,{key:2},[Yo,F.type!==l(De).CHECK?(t(),k(l(Ye),{key:0,modelValue:s.commonStyleInfo,"onUpdate:modelValue":x[1]||(x[1]=de=>s.commonStyleInfo=de),style:{width:"200px","margin-right":"12px"},"tree-props":l(pe),"tree-data":l(p),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"","only-click-child":"","show-group-icon":"",disabled:((Pa=s.editData.resourceDatas)==null?void 0:Pa.length)===0,"group-identify":l(S)},null,8,["modelValue","tree-props","tree-data","disabled","group-identify"])):(t(),c("span",Xo,z(((Ma=s.commonStyleInfo)==null?void 0:Ma.name)||"未选择"),1))],64)):G("",!0)],64)):G("",!0)])]),r("div",Zo,[a(Z,{ref_key:"tableForm",ref:v,class:"form edit-form",model:s.editData},{default:e(()=>[ze((t(),k(l(Oa),{ref_key:"dataListTable",ref:T,class:"dataListTable",data:s.editData.resourceDatas,"row-key":"resourceId",onSelectionChange:ce},{default:e(()=>[L.value?(t(),k(ye,{key:0,align:"center",label:"排序",width:"60"},{default:e(()=>[a(Ve,null,{default:e(()=>[a(Te)]),_:1})]),_:1})):G("",!0),F.type!==l(De).CHECK?(t(),k(ye,{key:1,align:"center",type:"selection",label:"选中","reserve-selection":"",selectable:()=>F.type!==l(De).CHECK},null,8,["selectable"])):G("",!0),a(ye,{align:"center",prop:"name",label:"数据名称"}),i.value!=="WMS"&&i.value!=="WMTS"&&l(Ta).includes(i.value)?(t(),k(ye,{key:2,align:"center",prop:"srs",label:"EPSG"})):G("",!0),i.value!=="WMS"&&i.value!=="WMTS"&&l(ia).includes(i.value)?(t(),k(ye,{key:3,align:"center",prop:"srsOrigin",label:"偏移量",width:"350"},{default:e(de=>[r("span",null,z(aa(de.row.srsOrigin)),1)]),_:1})):G("",!0),(i.value!=="WMS"||i.value!=="WMTS")&&l(Ia).includes(i.value)?(t(),k(ye,{key:4,align:"center",prop:"rotate",label:"旋转角度"})):G("",!0),E.value&&(i.value==="WMS"||i.value==="WMTS")?(t(),k(ye,{key:5,align:"center",prop:"styleInfo",label:"样式设置"},{default:e(de=>{var na,Pe;return[F.type!==l(De).CHECK?(t(),k(l(Ye),{key:0,modelValue:de.row.styleInfo,"onUpdate:modelValue":ca=>de.row.styleInfo=ca,style:{width:"200px"},"tree-props":l(pe),"tree-data":l(p),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"","only-click-child":"","show-group-icon":"",disabled:!!s.commonStyleInfo,"group-identify":l(S)},null,8,["modelValue","onUpdate:modelValue","tree-props","tree-data","disabled","group-identify"])):(t(),c("span",Qo,z((Pe=(na=de.row)==null?void 0:na.styleInfo)==null?void 0:Pe.name),1))]}),_:1})):G("",!0),F.type!==l(De).CHECK?(t(),k(ye,{key:6,width:"190px",label:"操作",align:"center",fixed:"right","class-name":"tableOperate"},{default:e(de=>[i.value!=="WMS"&&i.value!=="WMTS"&&i.value!=="PANORAMICIMAGE"?(t(),c("span",{key:0,class:"common",onClick:la(na=>O(de.row.resourceId),["stop"])},"导入文件",8,en)):G("",!0),i.value!=="WMS"&&i.value!=="WMTS"&&i.value!=="PANORAMICIMAGE"?(t(),c("span",{key:1,class:"common",onClick:la(na=>be(de.row.resourceId),["stop"])},"设置",8,an)):G("",!0)]),_:1})):G("",!0)]),_:1},8,["data"])),[[oa,s.isLoadingTable]])]),_:1},8,["model"])]),r("div",tn,[ln,i.value!=="WMS"&&i.value!=="WMTS"&&l(se)?(t(),c("span",on," 请正确设置方案参数 ")):G("",!0)]),i.value==="WMS"||i.value==="WMTS"?(t(),c("div",nn,[a(Z,{ref_key:"editTileInfoForm",ref:C,class:"form edit-form",inline:"",model:s.otherTileInfoForm,"label-width":"120px","label-position":"right"},{default:e(()=>[r("div",sn,[a(ke,{key:"otherTileInfoForm.srs",label:"输出坐标：",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:e(()=>[F.type!==l(De).CHECK?(t(),k(ge,{key:0,modelValue:s.otherTileInfoForm.srs,"onUpdate:modelValue":x[2]||(x[2]=de=>s.otherTileInfoForm.srs=de),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(f),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(H),de=>(t(),k(ie,{key:de.value,label:de.value,value:de.value},{default:e(()=>[r("div",rn,[r("span",null,z(de.value),1),dn,r("span",null,z(de.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])):(t(),c("span",un,z(s.otherTileInfoForm.srs),1))]),_:1})]),i.value==="WMTS"?(t(),c("div",cn,[a(ke,{key:"otherTileInfoForm.format",label:"输出格式：",prop:"format",rules:{required:!0,message:"至少选择一种输出格式",trigger:"change"}},{default:e(()=>[a(je,{modelValue:s.otherTileInfoForm.format,"onUpdate:modelValue":x[3]||(x[3]=de=>s.otherTileInfoForm.format=de),disabled:F.type===l(De).CHECK},{default:e(()=>[l(Et).includes($.value)?(t(),k(Ue,{key:0,label:"gif"},{default:e(()=>[q(" gif ")]),_:1})):(t(),k(Ue,{key:1,label:"geojson"},{default:e(()=>[q("geojson")]),_:1})),a(Ue,{label:"jpeg"},{default:e(()=>[q("jpeg")]),_:1}),a(Ue,{label:"png",disabled:""},{default:e(()=>[q("png")]),_:1}),a(Ue,{label:"png8"},{default:e(()=>[q("png8")]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})])):G("",!0),i.value==="WMTS"?(t(),c("div",pn,[a(ke,{key:"otherTileInfoForm.gridSets",label:"网格集：",prop:"gridSets",rules:{required:!0,message:"网格集不能为空",trigger:"change"}},{default:e(()=>[F.type!==l(De).CHECK?(t(),k(ge,{key:0,modelValue:s.otherTileInfoForm.gridSets,"onUpdate:modelValue":x[4]||(x[4]=de=>s.otherTileInfoForm.gridSets=de),style:{width:"100%"},filterable:"",placeholder:"请选择网格集",onChange:Ae},{default:e(()=>[(t(!0),c(ae,null,ve(l(u),de=>(t(),k(ie,{key:de.value,label:de.label,value:de.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):(t(),c("span",mn,z(l(o)(s.otherTileInfoForm.gridSets)),1))]),_:1}),a(ke,{key:"otherTileInfoForm.level",label:"切片级别：",prop:"level",rules:s.levelRules},{default:e(()=>[F.type!==l(De).CHECK?(t(),c(ae,{key:0},[a(ge,{modelValue:s.otherTileInfoForm.level[0],"onUpdate:modelValue":x[5]||(x[5]=de=>s.otherTileInfoForm.level[0]=de),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(s.levelOptions,de=>(t(),k(ie,{key:de.value,label:de.label,value:de.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),fn,a(ge,{modelValue:s.otherTileInfoForm.level[1],"onUpdate:modelValue":x[6]||(x[6]=de=>s.otherTileInfoForm.level[1]=de),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(s.levelOptions,de=>(t(),k(ie,{key:de.value,label:de.label,value:de.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])],64)):(t(),c(ae,{key:1},[r("span",null,z(s.otherTileInfoForm.level[0]),1),gn,r("span",null,z(s.otherTileInfoForm.level[1]),1)],64))]),_:1},8,["rules"])])):G("",!0)]),_:1},8,["model"])])):ze((t(),c("div",yn,[r("div",null,[a(Z,{ref_key:"editTileInfoForm",ref:C,class:"form edit-form",inline:"",model:l(m),rules:l(D),"label-width":"120px","label-position":"right"},{default:e(()=>[r("div",_n,[a(ke,{label:"切片方案：",prop:"taskInfo"},{default:e(()=>[F.type!==l(De).CHECK?(t(),k(l(Ye),{key:0,modelValue:l(m).taskInfo,"onUpdate:modelValue":x[7]||(x[7]=de=>l(m).taskInfo=de),style:{width:"100%"},"tree-props":l(pe),"tree-data":l(J),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(S),onChange:l(ue)},null,8,["modelValue","tree-props","tree-data","group-identify","onChange"])):(t(),c("span",bn,z(l(m).taskInfo.name),1))]),_:1}),a(ke)])]),_:1},8,["model","rules"]),l(Y).length>0?(t(!0),c(ae,{key:0},ve(l(Y),(de,na)=>(t(),k(Z,{ref_for:!0,ref:Pe=>{Pe&&(w.value[na]=Pe)},key:de.uid,class:"form scheme-form__common",uid:de.uid,inline:"",model:de.pubulishData,"label-width":"120px","label-position":"right"},{default:e(()=>[(t(!0),c(ae,null,ve(de.paramsConfigList,(Pe,ca)=>(t(),k(ke,{key:Pe.paramName+ca,class:Re([{"scheme-form-item":!0,"is-left":ca%2===0}]),label:Pe.paramLabel+"：",prop:Pe.paramName,required:Pe.required,rules:{required:Pe.required,message:`${Pe.paramLabel}不能为空`}},{default:e(()=>[a(l(Aa),{ref_for:!0,ref:"paramForm",modelValue:de.pubulishData[Pe.paramName],"onUpdate:modelValue":st=>de.pubulishData[Pe.paramName]=st,"control-name":Pe.paramName,uid:de.uid,type:de.type,"all-param":Pe,relations:de.relations,onChange:l(me)},null,8,["modelValue","onUpdate:modelValue","control-name","uid","type","all-param","relations","onChange"])]),_:2},1032,["class","label","prop","required","rules"]))),128))]),_:2},1032,["uid","model"]))),128)):G("",!0)])])),[[oa,l(W)]]),a(nt,{visible:s.importDataDialogVisible,"onUpdate:visible":x[8]||(x[8]=de=>s.importDataDialogVisible=de),"cur-data-type":s.curImportTypeData,onSave:fe},null,8,["visible","cur-data-type"]),a(zo,{visible:s.settingDataDialogVisible,"onUpdate:visible":x[9]||(x[9]=de=>s.settingDataDialogVisible=de),"service-type":s.editData.serviceType,"edit-id":s.curSettingDataId,onSave:Ce},null,8,["visible","service-type","edit-id"])])),[[oa,s.isLoading]])}}});const hn={class:"footer"},Tn=Oe({__name:"ReleaseDataset",props:{releseDataInfo:{default:()=>{}}},emits:["update:visible","changeEdit","save"],setup(re,{emit:te}){const h=te,I=re,A=Se(()=>{var f;return((f=I.releseDataInfo)==null?void 0:f.id)||""}),b=Se(()=>{var f;return((f=I.releseDataInfo)==null?void 0:f.dataType)||""}),n=ee(),v=ee(!1),T=Fe({dialogVisible:!1,submiting:!1,curTypeData:{dataType:[""],serviceType:""},renderType:Ze.NONE}),C=Se(()=>({[Ze.LIGHTWEIGHT]:xo,[Ze.ORIGINAL]:vn,[Ze.NONE]:null})[T.renderType]);function w(){T.curTypeData.dataType=[b.value],T.curTypeData.serviceType=I.releseDataInfo.serviceType,Sa.includes(b.value)?T.renderType=Ze.LIGHTWEIGHT:T.renderType=Ze.ORIGINAL}function R(f=!1){h("update:visible",!1),T.renderType=Ze.NONE,f&&h("save")}function U(f){var p,pe;T.curTypeData=Ie.cloneDeep(f),Sa.includes((pe=(p=T.curTypeData)==null?void 0:p.dataType)==null?void 0:pe[1])?T.renderType=Ze.LIGHTWEIGHT:T.renderType=Ze.ORIGINAL}function H(){var f;(f=n.value)==null||f.handleSaveForm(!0)}return Be("getAllServiceOptions",Ie.noop),Xe(()=>{w()}),(f,p)=>{const pe=y("el-button"),S=y("el-checkbox");return t(),c(ae,null,[(t(),k($a(C.value),{ref:u=>n.value=u,submiting:T.submiting,"onUpdate:submiting":p[0]||(p[0]=u=>T.submiting=u),name:T.renderType,"cur-edit-id":A.value,"add-type-data":T.curTypeData,type:l(De).EDIT,onChangeType:U,onSave:p[1]||(p[1]=u=>R(!0))},null,40,["submiting","name","cur-edit-id","add-type-data","type"])),r("div",hn,[a(pe,{onClick:p[2]||(p[2]=u=>T.dialogVisible=!1)},{default:e(()=>[q("取消")]),_:1}),a(pe,{type:"primary",disabled:!v.value,onClick:H},{default:e(()=>[q(" 保存 ")]),_:1},8,["disabled"]),a(S,{modelValue:v.value,"onUpdate:modelValue":p[3]||(p[3]=u=>v.value=u),label:"更新完成后将替换原服务数据",style:{"margin-left":"12px"}},null,8,["modelValue"])])],64)}}});const In={class:"common-release-form lzc"},Dn={key:0,class:"content-wrap"},kn={class:"item-wrap item2"},Sn=r("input",{id:"importCoordinateFile",style:{display:"none"},type:"file",class:"importCoordinateFile",directory:"",nwdirectory:"",accept:".xml"},null,-1),Vn={class:"item-wrap item2"},Cn={class:"list-item"},wn=r("span",null," — — ",-1),Fn={key:0,class:"item-wrap"},En={class:"list-item"},$n=r("span",null," — — ",-1),On={key:1,class:"item-wrap"},xn={class:"origin"},Rn={class:"item-wrap"},Ln={key:2,class:"item-wrap"},An={class:"rotate"},Nn={key:2,class:"item-wrap"},Un={class:"subtitle"},Pn=r("span",{class:"text"},"切片参数设置",-1),Mn={key:0,class:"tip"},Bn={key:0,class:"content-wrap","element-loading-text":"正在获取方案参数..."},zn={class:"item-wrap item2"},Gn={key:1,class:"content-wrap"},qn={class:"item-wrap"},Wn={class:"list-item"},jn=r("span",null," — — ",-1),Hn={key:0,class:"item-wrap"},Kn={key:1,class:"item-wrap item2"},Jn=r("span",{style:{margin:"0 14px"}},"——",-1),Yn={class:"footer"},Xn=Oe({__name:"CommonReleaseForm",setup(re){const{submiting:te,groupIdentify:h,treeProps:I,stylesList:A,srsOptions:b,dataType:n,gridSetsList:v,releseDataInfo:T,getListData:C,checkFormPass:w,srsFilterFunc:R}=Na(N,K),{tileInfoForm:U,cellData:H,showErrorTip:f,isLoadingScheme:p,tileInfoFormRule:pe,taskTreeData:S,publishConfigList:u,getAllTask:g,initSchemeData:o,checkDagScheme:d,handleTaskChange:s,handleControlChange:$}=ot(n),E=ee(),i=ee(),L=ee([]),P=ee(!1),m=Fe({includesCommon:["IMAGERY","POINTCLOUD","BIMMODEL","MODEL","PANORAMICIMAGE"],includesSrs:["TERRAIN","IMAGEDATA","IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],includesOrigin:["IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],includesRotate:["BIMMODEL","MODEL"],includesBandSettings:["TERRAIN","IMAGEDATA"],includesWFS:["VECTOR"],includesStyle:["VECTOR"],serviceInfoForm:{category:"",categoryAliasName:"",generateWFS:!1},dataInfoForm:{srs:"",isGbk:!1,origin:{x:"",y:"",z:""},rotate:0,styleInfo:null,bandSettings:[],cqlFilter:""},dataInfoFormRule:{srs:[{required:!0,message:"坐标系统不能为空",trigger:"change"}],origin:{type:"object",required:!0,fields:{x:{required:!0,validator:M,trigger:["blur","change"]},y:{required:!0,validator:M,trigger:["blur","change"]},z:{required:!0,validator:M,trigger:["blur","change"]}}}},bandTableData:[{prop:"name",label:"波段"},{prop:"nullValue",label:"空值"},{prop:"min",label:"最小范围"},{prop:"max",label:"最大范围"}],otherTileInfoForm:{srs:"",format:["png"],gridSets:"",level:["",""]},levelRules:{type:"array",required:!0,trigger:"change",len:2,fields:{0:{type:"number",required:!0,message:"请完整填写切片级别"},1:{type:"number",required:!0,message:"请完整填写切片级别"}}},levelOptions:[],initDataInfo:{srs:"",srsOrigin:"",rotate:0}});Be("getCellById",le);function le(ce){var _e;const O=(_e=H.value)==null?void 0:_e.find(V=>V.id===ce);return O?{attributes:O}:{}}const se=we("handleClosed"),W=we("serviceId"),D=we("aliasName"),J=we("category"),Y=we("categoryAliasName");ua(()=>{L.value=[]});function M(ce,O,_e){const V=!!m.dataInfoForm.origin.x,be=!!m.dataInfoForm.origin.y,fe=!!m.dataInfoForm.origin.z;V&&be&&fe?_e():_e(new Error(`请完整填写偏移量，${V?"":" X"}${be?"":" Y"}${fe?"":" Z"}不能为空`))}function N(){He(()=>{var ce,O;(ce=E.value)==null||ce.clearValidate(),(O=i.value)==null||O.clearValidate()}),ue(),C(),me(),g()}function ue(){const{dataTypeAliasName:ce,dataFormat:O,name:_e}=T.value;m.dataInfoForm.dataName=_e,m.dataInfoForm.dataTypeAliasName=ce,m.dataInfoForm.dataFormat=O,m.dataInfoForm.srs="EPSG:4326",m.dataInfoForm.isGbk=!1,m.dataInfoForm.styleInfo=null,m.dataInfoForm.bandSettings=[{name:"RED_BAND",nullValue:"",min:"",max:""},{name:"GREEN_BAND",nullValue:"",min:"",max:""},{name:"BLUE_BAND",nullValue:"",min:"",max:""}],m.dataInfoForm.cqlFilter="",m.serviceInfoForm.category=(J==null?void 0:J.value)==="WMS"||(J==null?void 0:J.value)==="WMTS"?J==null?void 0:J.value:"self",m.serviceInfoForm.categoryAliasName=Y==null?void 0:Y.value,m.otherTileInfoForm={srs:"EPSG:4326",format:["png"],gridSets:"",level:["",""]},o()}function me(){const ce=()=>{m.dataInfoForm.origin={x:"",y:"",z:""}};We.getDataInfoById(T.value.resourceId).then(O=>{var _e,V,be;if(O.code==="0000")if(m.initDataInfo.srs=((_e=O==null?void 0:O.data)==null?void 0:_e.srs)??"EPSG:4326",m.initDataInfo.srsOrigin=((V=O==null?void 0:O.data)==null?void 0:V.srsOrigin)??"0,0,0",m.initDataInfo.rotate=((be=O==null?void 0:O.data)==null?void 0:be.rotate)??0,n.value=O.data.dataType,m.dataInfoForm.srs=O.data.srs||"EPSG:4326",O.data.srsOrigin){const fe=O.data.srsOrigin.split(",");m.dataInfoForm.origin={x:fe[0],y:fe[1],z:fe[2]}}else ce();else m.dataInfoForm.srs="EPSG:4326",ce()}).catch(()=>{m.dataInfoForm.srs="EPSG:4326",ce()}).finally(()=>{m.dataInfoForm.rotate=0})}function K(){return m.serviceInfoForm.category==="self"?T.value.dataType:m.serviceInfoForm.category}function X(ce){m.otherTileInfoForm.level[0]="",m.otherTileInfoForm.level[1]="";const O=v.value.find(V=>V.value===ce),_e=Array(O.max+1).fill(1);m.levelOptions=[],_e.forEach((V,be)=>{m.levelOptions.push({value:be,lebel:be})})}function Q(){var ce,O;(ce=document.getElementById("importCoordinateFile"))==null||ce.click(),(O=document.getElementById("importCoordinateFile"))==null||O.addEventListener("change",_e=>{const{files:V}=_e.target;if(V.length===0)return;const be=V[0];if(!/\.xml$/g.test(be.name)){Le.alert("仅支持导入xml格式！","提示",{confirmButtonText:"确定",type:"error"}),_e.target.value="";return}B(be,fe=>{m.dataInfoForm.srs=fe.system,m.includesOrigin.includes(T.value.dataType)&&(m.dataInfoForm.origin=fe.origin),oe({type:"success",message:"坐标导入成功!"})}),_e.target.value=""})}function B(ce,O){const _e=new FileReader;_e.onload=V=>{var Ge,Me;const be=V.target.result,fe={},$e=be.match(/<SRS[^>]*>([\s\S]*?)<\/SRS>/);let Ce=be.match(/<SRSOrigin[^>]*>([\s\S]*?)<\/SRSOrigin>/);if(m.includesOrigin.includes(T.value.dataType)){if(!$e||!Ce){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}}else if(!$e){Le.alert("文件未包含必要信息！请检查后重新导入！","提示",{confirmButtonText:"确定",type:"error"});return}[,fe.system]=$e,m.includesOrigin.includes(T.value.dataType)&&(Ce=(Me=(Ge=Ce[1])==null?void 0:Ge.replace(/\s*/g,""))==null?void 0:Me.split(","),fe.origin={x:Ce[0],y:Ce[1],z:Ce[2]}),O&&O(fe)},_e.readAsBinaryString(ce)}function _(ce){m.dataInfoForm.origin[ce]=m.dataInfoForm.origin[ce].replace(/^\.+|[^\d.]/g,"")}function ne(){const{category:ce,generateWFS:O,categoryAliasName:_e}=m.serviceInfoForm;if(ce==="self"){const V=L.value;if((V==null?void 0:V.length)>0){const be=w(E),fe=w(i),$e=d(!0);Promise.all([be,fe,$e]).then(([Ge,Me,Ae])=>{if(Ge&&Me&&Ae){const{srs:Ne,origin:{x:Ee,y:aa,z:j},rotate:F}=m.dataInfoForm,{taskInfo:x}=U.value,ie={};m.includesSrs.includes(T.value.dataType)&&(ie.srs=Ne.replace("EPSG:","")),m.includesOrigin.includes(T.value.dataType)&&(ie.srsOrigin=`${Ee},${aa},${j}`),m.includesRotate.includes(T.value.dataType)&&(ie.rotate=F);const ge={cells:Je(H.value)},Te={id:W.value,aliasName:D.value,category:T.value.dataType,resourceId:T.value.resourceId,tileConfig:JSON.stringify(ie),taskId:x.id,dag:JSON.stringify(ge),addVersion:!0},Ve=new FormData;for(const ye in Te)Ve.append(ye,Te[ye]);te.value=!0,We.releaseService(Ve).then(ye=>{te.value=!1,ye.code==="0000"?(he({type:"success",customClass:"custom-relese-notification",title:"服务更新中",onClick:()=>{}}),se==null||se()):he({type:"error",title:"服务发布失败",message:ye.message})}).catch(ye=>{te.value=!1,he({type:"error",title:"服务发布错误",message:ye.message})})}})}else oe({type:"warning",message:"请选择正确的切片方案！"}),w(E),w(i)}else{const V=w(E),be=w(i);Promise.all([V,be]).then(([$e,Ce])=>{if($e&&Ce){const Ge={srs:m.dataInfoForm.srs.replace("EPSG:",""),styleId:m.dataInfoForm.styleInfo?m.dataInfoForm.styleInfo.id:null,cqlFilter:m.dataInfoForm.cqlFilter};m.includesBandSettings.includes(T.value.dataType)&&(Ge.bandSettings=m.dataInfoForm.bandSettings);const Me={id:W.value,aliasName:D.value,category:ce,categoryAliasName:_e,resourceId:T.value.resourceId,dataInfo:JSON.stringify(Ge),addVersion:!0},Ae={srs:m.otherTileInfoForm.srs.replace("EPSG:","")};ce==="WMTS"&&(Ae.format=m.otherTileInfoForm.format.join(","),Ae.gridSets=m.otherTileInfoForm.gridSets,[Ae.zoomStart,Ae.zoomStop]=m.otherTileInfoForm.level),Me.tileConfig=JSON.stringify(Ae),ce==="WMS"&&m.includesWFS.includes(n.value)&&(Me.generateWFS=O);const Ne=new FormData;for(const Ee in Me)Ne.append(Ee,Me[Ee]);te.value=!0,We.releaseService(Ne).then(Ee=>{te.value=!1,Ee.code==="0000"?(ce==="WMTS"?he({type:"success",customClass:"custom-relese-notification",title:"服务更新中",onClick:()=>{}}):he({type:"success",customClass:"custom-relese-notification",title:"服务更新中",onClick:()=>{}}),se==null||se()):he({type:"error",title:"服务发布失败",message:Ee.message})}).catch(Ee=>{te.value=!1,he({type:"error",title:"服务发布错误",message:Ee.message})})}})}}return(ce,O)=>{const _e=y("el-button"),V=y("el-form-item"),be=y("el-option"),fe=y("el-select"),$e=y("el-input"),Ce=y("el-input-number"),Ge=y("el-table-column"),Me=y("el-table"),Ae=y("el-form"),Ne=y("el-checkbox"),Ee=y("el-checkbox-group"),aa=ea("loading");return t(),c("div",In,[m.serviceInfoForm.category?(t(),c("div",Dn,[a(Ae,{ref_key:"editDataInfoForm",ref:E,class:"form edit-form",inline:"",model:m.dataInfoForm,"label-width":"auto","label-position":"right",rules:m.dataInfoFormRule},{default:e(()=>[r("div",kn,[a(V,null,{default:e(()=>[l(T).dataType!=="PANORAMICIMAGE"?(t(),k(_e,{key:0,link:"",type:"primary",class:"func-btn",onClick:O[0]||(O[0]=j=>Q())},{default:e(()=>[q("导入坐标文件")]),_:1})):G("",!0),Sn]),_:1})]),r("div",Vn,[a(V,{label:"数据名称",prop:"dataName"},{default:e(()=>[r("span",null,z(m.dataInfoForm.dataName),1)]),_:1}),a(V,{label:"数据类型",prop:"dataTypeAliasName"},{default:e(()=>[r("span",null,z(m.dataInfoForm.dataTypeAliasName)+" / "+z(m.dataInfoForm.dataFormat),1)]),_:1})]),m.serviceInfoForm.category!=="self"?(t(),c("div",{key:0,class:Re(["item-wrap",m.includesStyle.includes(l(n))?"item2":""])},[a(V,{key:"srs",label:"坐标系统",prop:"srs"},{default:e(()=>[a(fe,{modelValue:m.dataInfoForm.srs,"onUpdate:modelValue":O[1]||(O[1]=j=>m.dataInfoForm.srs=j),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(R),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(b),j=>(t(),k(be,{key:j.value,label:j.value,value:j.value},{default:e(()=>[r("div",Cn,[r("span",null,z(j.value),1),wn,r("span",null,z(j.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])]),_:1}),m.includesStyle.includes(l(n))?(t(),k(V,{key:"styleInfo",label:"样式设置",prop:"styleInfo"},{default:e(()=>[a(l(Ye),{modelValue:m.dataInfoForm.styleInfo,"onUpdate:modelValue":O[2]||(O[2]=j=>m.dataInfoForm.styleInfo=j),style:{width:"100%"},"tree-props":l(I),"tree-data":l(A),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",clearable:"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(h)},null,8,["modelValue","tree-props","tree-data","group-identify"])]),_:1})):G("",!0)],2)):(t(),c(ae,{key:1},[m.includesSrs.includes(l(T).dataType)?(t(),c("div",Fn,[a(V,{key:"srs",label:"坐标系统",prop:"srs"},{default:e(()=>[a(fe,{modelValue:m.dataInfoForm.srs,"onUpdate:modelValue":O[3]||(O[3]=j=>m.dataInfoForm.srs=j),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(R),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(b),j=>(t(),k(be,{key:j.value,label:j.value,value:j.value},{default:e(()=>[r("div",En,[r("span",null,z(j.value),1),$n,r("span",null,z(j.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])]),_:1})])):G("",!0),m.includesOrigin.includes(l(T).dataType)?(t(),c("div",On,[a(V,{label:"偏移量",prop:"origin"},{default:e(()=>[r("div",xn,[a($e,{modelValue:m.dataInfoForm.origin.x,"onUpdate:modelValue":O[4]||(O[4]=j=>m.dataInfoForm.origin.x=j),placeholder:"请输入X坐标",onInput:O[5]||(O[5]=j=>_("x"))},{prepend:e(()=>[q("X :")]),_:1},8,["modelValue"]),a($e,{modelValue:m.dataInfoForm.origin.y,"onUpdate:modelValue":O[6]||(O[6]=j=>m.dataInfoForm.origin.y=j),placeholder:"请输入Y坐标",onInput:O[7]||(O[7]=j=>_("y"))},{prepend:e(()=>[q("Y :")]),_:1},8,["modelValue"]),a($e,{modelValue:m.dataInfoForm.origin.z,"onUpdate:modelValue":O[8]||(O[8]=j=>m.dataInfoForm.origin.z=j),placeholder:"请输入Z坐标",onInput:O[9]||(O[9]=j=>_("z"))},{prepend:e(()=>[q("Z :")]),_:1},8,["modelValue"])])]),_:1})])):G("",!0),r("div",Rn,[a(V,{label:"过滤条件：",prop:"cqlFilter"},{default:e(()=>[a($e,{modelValue:m.dataInfoForm.cqlFilter,"onUpdate:modelValue":O[10]||(O[10]=j=>m.dataInfoForm.cqlFilter=j),type:"textarea",rows:2,placeholder:"请输入过滤条件"},null,8,["modelValue"])]),_:1})]),m.includesRotate.includes(l(T).dataType)?(t(),c("div",Ln,[a(V,{label:"旋转角度",prop:"rotate"},{default:e(()=>[r("div",An,[a(Ce,{modelValue:m.dataInfoForm.rotate,"onUpdate:modelValue":O[11]||(O[11]=j=>m.dataInfoForm.rotate=j),placeholder:"请输入旋转角度","controls-position":"right",style:{width:"200px"}},null,8,["modelValue"])])]),_:1})])):G("",!0)],64)),m.serviceInfoForm.category!=="self"&&m.includesBandSettings.includes(l(T).dataType)?(t(),c("div",Nn,[a(V,{key:"bandSettings",label:"波段设置",prop:"bandSettings"},{default:e(()=>[a(Me,{data:m.dataInfoForm.bandSettings,style:{width:"100%"}},{default:e(()=>[(t(!0),c(ae,null,ve(m.bandTableData,j=>(t(),k(Ge,{key:j.prop,prop:j.prop,label:j.label,align:"center"},{default:e(F=>[a($e,{modelValue:F.row[j.prop],"onUpdate:modelValue":x=>F.row[j.prop]=x,class:"centerInput",type:"text",readonly:j.prop==="name"},null,8,["modelValue","onUpdate:modelValue","readonly"])]),_:2},1032,["prop","label"]))),128))]),_:1},8,["data"])]),_:1})])):G("",!0)]),_:1},8,["model","rules"])])):G("",!0),m.serviceInfoForm.category?(t(),c(ae,{key:1},[r("div",Un,[Pn,m.serviceInfoForm.category==="self"&&l(f)?(t(),c("span",Mn," 请正确设置切片参数 ")):G("",!0)]),m.serviceInfoForm.category==="self"?ze((t(),c("div",Bn,[r("div",null,[a(Ae,{ref_key:"editTileInfoForm",ref:i,class:"form edit-form",inline:"",model:l(U),rules:l(pe),"label-width":"auto","label-position":"right"},{default:e(()=>[r("div",zn,[a(V,{label:"切片方案",prop:"taskInfo"},{default:e(()=>[a(l(Ye),{modelValue:l(U).taskInfo,"onUpdate:modelValue":O[12]||(O[12]=j=>l(U).taskInfo=j),style:{width:"100%"},"tree-props":l(I),"tree-data":l(S),"node-key":"id",icon:"iconCls","expand-on-click-node":!1,"default-expand-all":"",filterable:"","only-click-child":"","show-group-icon":"","group-identify":l(h),onChange:l(s)},null,8,["modelValue","tree-props","tree-data","group-identify","onChange"])]),_:1}),a(V)])]),_:1},8,["model","rules"]),l(u).length>0?(t(!0),c(ae,{key:0},ve(l(u),(j,F)=>(t(),k(Ae,{ref_for:!0,ref:x=>{x&&(L.value[F]=x)},key:j.uid,class:"form scheme-form__common",uid:j.uid,inline:"",model:j.pubulishData,"label-width":"auto","label-position":"right"},{default:e(()=>[(t(!0),c(ae,null,ve(j.paramsConfigList,(x,ie)=>(t(),k(V,{key:x.paramName+ie,class:Re([{"scheme-form-item":!0,"is-left":ie%2===0}]),label:x.paramLabel+"：",prop:x.paramName,required:x.required,rules:{required:x.required,message:`${x.paramLabel}不能为空`}},{default:e(()=>[a(l(Aa),{ref_for:!0,ref:"paramForm",modelValue:j.pubulishData[x.paramName],"onUpdate:modelValue":ge=>j.pubulishData[x.paramName]=ge,"control-name":x.paramName,uid:j.uid,type:j.type,"all-param":x,relations:j.relations,"default-data-info":m.initDataInfo,onChange:l($)},null,8,["modelValue","onUpdate:modelValue","control-name","uid","type","all-param","relations","default-data-info","onChange"])]),_:2},1032,["class","label","prop","required","rules"]))),128))]),_:2},1032,["uid","model"]))),128)):G("",!0)])])),[[aa,l(p)]]):(t(),c("div",Gn,[a(Ae,{ref_key:"editTileInfoForm",ref:i,class:"form edit-form",inline:"",model:m.otherTileInfoForm,"label-width":"auto","label-position":"right"},{default:e(()=>[r("div",qn,[a(V,{key:"otherTileInfoForm.srs",label:"输出坐标",prop:"srs",rules:{required:!0,message:"输出坐标不能为空",trigger:"change"}},{default:e(()=>[a(fe,{modelValue:m.otherTileInfoForm.srs,"onUpdate:modelValue":O[13]||(O[13]=j=>m.otherTileInfoForm.srs=j),style:{width:"100%"},"popper-class":"srs-select",filterable:"","filter-method":l(R),placeholder:"请选择坐标系统"},{default:e(()=>[(t(!0),c(ae,null,ve(l(b),j=>(t(),k(be,{key:j.value,label:j.value,value:j.value},{default:e(()=>[r("div",Wn,[r("span",null,z(j.value),1),jn,r("span",null,z(j.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","filter-method"])]),_:1})]),m.serviceInfoForm.category==="WMTS"?(t(),c("div",Hn,[a(V,{key:"otherTileInfoForm.format",label:"输出格式",prop:"format",rules:{required:!0,message:"至少选择一种输出格式",trigger:"change"}},{default:e(()=>[a(Ee,{modelValue:m.otherTileInfoForm.format,"onUpdate:modelValue":O[14]||(O[14]=j=>m.otherTileInfoForm.format=j)},{default:e(()=>[m.includesBandSettings.includes(l(T).dataType)?(t(),k(Ne,{key:0,label:"gif"},{default:e(()=>[q("gif ")]),_:1})):(t(),k(Ne,{key:1,label:"geojson"},{default:e(()=>[q("geojson")]),_:1})),a(Ne,{label:"jpeg"},{default:e(()=>[q("jpeg")]),_:1}),a(Ne,{label:"png",disabled:""},{default:e(()=>[q("png")]),_:1}),a(Ne,{label:"png8"},{default:e(()=>[q("png8")]),_:1})]),_:1},8,["modelValue"])]),_:1})])):G("",!0),m.serviceInfoForm.category==="WMTS"?(t(),c("div",Kn,[a(V,{key:"otherTileInfoForm.gridSets",label:"网格集",prop:"gridSets",rules:{required:!0,message:"网格集不能为空",trigger:"change"}},{default:e(()=>[a(fe,{modelValue:m.otherTileInfoForm.gridSets,"onUpdate:modelValue":O[15]||(O[15]=j=>m.otherTileInfoForm.gridSets=j),style:{width:"100%"},filterable:"",placeholder:"请选择网格集",onChange:X},{default:e(()=>[(t(!0),c(ae,null,ve(l(v),j=>(t(),k(be,{key:j.value,label:j.label,value:j.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(V,{key:"otherTileInfoForm.level",label:"切片级别",prop:"level",rules:m.levelRules},{default:e(()=>[a(fe,{modelValue:m.otherTileInfoForm.level[0],"onUpdate:modelValue":O[16]||(O[16]=j=>m.otherTileInfoForm.level[0]=j),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(m.levelOptions,j=>(t(),k(be,{key:j.value,label:j.label,value:j.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),Jn,a(fe,{modelValue:m.otherTileInfoForm.level[1],"onUpdate:modelValue":O[17]||(O[17]=j=>m.otherTileInfoForm.level[1]=j),style:{width:"38%"},filterable:"",placeholder:"请选择","no-data-text":"请先选择网格集"},{default:e(()=>[(t(!0),c(ae,null,ve(m.levelOptions,j=>(t(),k(be,{key:j.value,label:j.label,value:j.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["rules"])])):G("",!0)]),_:1},8,["model"])]))],64)):G("",!0),(t(),k(Fa,{to:"#service-info-full-dialog .main-content"},[r("div",Yn,[a(_e,{onClick:l(se)},{default:e(()=>[q("取消")]),_:1},8,["onClick"]),a(_e,{loading:l(te),type:"primary",disabled:!P.value,onClick:ne},{default:e(()=>[q(" 保存 ")]),_:1},8,["loading","disabled"]),a(Ne,{modelValue:P.value,"onUpdate:modelValue":O[18]||(O[18]=j=>P.value=j),label:"更新完成后将替换原服务数据",style:{"margin-left":"12px"}},null,8,["modelValue"])])]))])}}});const Zn=Oe({__name:"ReleaseDataResource",props:{releseDataInfo:{}},setup(re){const te=re;Be("getDataInfo",I);const h=Fe({is3Dtiles:!1});rt(()=>{var A;h.is3Dtiles=Sa.includes((A=te.releseDataInfo.dataFormat)==null?void 0:A.toUpperCase())});function I(){return te.releseDataInfo}return(A,b)=>h.is3Dtiles?(t(),k(lt,{key:0})):(t(),k(Xn,{key:1}))}}),Qn={class:"content-wrap"},es={class:"item-wrap item2"},as={class:"item-wrap item2"},ts={class:"item-wrap item2"},ls={key:0,class:"item-wrap"},os={class:"origin"},ns={key:1,class:"item-wrap"},ss={class:"footer"},is=Oe({__name:"ReleaseResultData",props:{releseDataInfo:{}},setup(re){const te=re,h=ee(!1),I=Fe({includesSrs:["VECTOR","IMAGEDATA","IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],includesOrigin:["IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],includesRotate:["BIMMODEL","MODEL"],includesBandSettings:["TERRAIN","IMAGEDATA"],submiting:!1,dataInfoForm:null,bandTableData:[{prop:"name",label:"波段"},{prop:"nullValue",label:"空值"},{prop:"min",label:"最小范围"},{prop:"max",label:"最大范围"}]}),A=we("handleClosed"),b=we("serviceId");Ke(()=>te.releseDataInfo,T=>{I.dataInfoForm=T},{immediate:!0});function n(){v()}function v(){const{dataInfoForm:T}=I;if(!T)return;const{resourceId:C,name:w}=T,R={id:b.value,resourceId:C,addVersion:!0,aliasName:w,category:I.dataInfoForm.dataType},U=new FormData;for(const[H,f]of Object.entries(R))U.append(H,f);We.releaseService(U).then(H=>{I.submiting=!1,H.code==="0000"?(he({type:"success",customClass:"custom-relese-notification",title:"服务发布成功"}),A==null||A()):he({type:"error",title:"服务发布失败",message:H.message})}).catch(H=>{I.submiting=!1,he({type:"error",title:"服务发布错误",message:H.message})})}return(T,C)=>{const w=y("el-form-item"),R=y("el-input"),U=y("el-table-column"),H=y("el-table"),f=y("el-form"),p=y("el-button"),pe=y("el-checkbox");return t(),c(ae,null,[r("div",Qn,[a(f,{class:"form edit-form",inline:"",model:I.dataInfoForm,"label-width":"100px","label-position":"right"},{default:e(()=>[r("div",es,[a(w,{label:"数据名称：",prop:"name"},{default:e(()=>[r("span",null,z(I.dataInfoForm.name),1)]),_:1}),a(w,{label:"数据类型：",prop:"dataTypeAliasName"},{default:e(()=>[r("span",null,z(I.dataInfoForm.dataTypeAliasName),1)]),_:1})]),r("div",as,[a(w,{label:"数据大小：",prop:"dataSize"},{default:e(()=>[r("span",null,z(I.dataInfoForm.dataSize||"--"),1)]),_:1})]),r("div",ts,[I.includesSrs.includes(I.dataInfoForm.dataType)?(t(),k(w,{key:0,label:"坐标系统：",prop:"srs"},{default:e(()=>[r("span",null,z(I.dataInfoForm.srs),1)]),_:1})):G("",!0),I.includesRotate.includes(I.dataInfoForm.dataType)?(t(),k(w,{key:1,label:"旋转角度：",prop:"rotate"},{default:e(()=>[r("span",null,z(I.dataInfoForm.rotate),1)]),_:1})):G("",!0)]),I.includesOrigin.includes(I.dataInfoForm.dataType)?(t(),c("div",ls,[I.dataInfoForm.origin?(t(),k(w,{key:0,label:"偏移量：",prop:"origin"},{default:e(()=>[r("div",os,[r("div",null,"X :"+z(I.dataInfoForm.origin.x),1),r("div",null,"Y :"+z(I.dataInfoForm.origin.y),1),r("div",null,"Z :"+z(I.dataInfoForm.origin.z),1)])]),_:1})):(t(),k(w,{key:1,label:"偏移量："},{default:e(()=>[q(" -- ")]),_:1}))])):G("",!0),I.includesBandSettings.includes(T.releseDataInfo.dataType)?(t(),c("div",ns,[a(w,{key:"bandSettings",label:"波段设置：",prop:"bandSettings"},{default:e(()=>[a(H,{data:I.dataInfoForm.bandSettings,style:{width:"100%"}},{default:e(()=>[(t(!0),c(ae,null,ve(I.bandTableData,S=>(t(),k(U,{key:S.prop,prop:S.prop,label:S.label,align:"center"},{default:e(u=>[a(R,{modelValue:u.row[S.prop],"onUpdate:modelValue":g=>u.row[S.prop]=g,class:"centerInput",type:"text",readonly:S.prop==="name"},null,8,["modelValue","onUpdate:modelValue","readonly"])]),_:2},1032,["prop","label"]))),128))]),_:1},8,["data"])]),_:1})])):G("",!0)]),_:1},8,["model"])]),(t(),k(Fa,{to:"#service-info-full-dialog .main-content"},[r("div",ss,[a(p,{onClick:l(A)},{default:e(()=>[q("取消")]),_:1},8,["onClick"]),a(p,{type:"primary",disabled:!h.value,onClick:n},{default:e(()=>[q(" 保存 ")]),_:1},8,["disabled"]),a(pe,{modelValue:h.value,"onUpdate:modelValue":C[0]||(C[0]=S=>h.value=S),label:"更新完成后将替换原服务数据",style:{"margin-left":"12px"}},null,8,["modelValue"])])]))],64)}}});const rs={class:"main-content"},ds={class:"title"},us={key:0},cs={key:1,class:"title--check",style:{display:"flex","align-items":"center"}},ps={key:0,class:"main"},ms={class:"card"},fs=r("div",{class:"subtitle"},"服务信息",-1),gs={class:"content-wrap"},ys={class:"item-wrap item2"},_s={key:1},bs={class:"item-wrap item2"},vs={class:"item-wrap item2"},hs={key:0,class:"item-wrap item2"},Ts={key:1},Is={class:"item-wrap item2"},Ds={key:1},ks={key:0},Ss={key:1,class:"item-wrap item2"},Vs={key:2,class:"item-wrap"},Cs={class:"link"},ws={class:"item-wrap item2"},Fs={key:1,class:"link"},Es={key:3,class:"item-wrap"},$s={key:0,class:"card"},Os={class:"subtitle btn-title"},xs={key:0,class:"btns"},Rs=r("div",{class:"version-tips"}," 添加版本时，点击“更新”按钮即可生效，修改当前使用版本或者删除版本时实时生效 ",-1),Ls={class:"operate-btns dataContainer__operator__btns"},As={key:1,class:"subtitle btn-title"},Ns={class:"content-wrap"},Us={key:0,class:"data-status PUBLISHED"},Ps={key:1},Ms={class:"ellipsis1"},Bs=["onClick"],zs=["onClick"],Gs={key:1,class:"card"},qs={class:"subtitle"},Ws=r("span",{class:"text"},"数据信息",-1),js={key:2,class:"card"},Hs=r("div",{class:"subtitle"},"版本信息",-1),Ks={class:"content-wrap"},Js={key:0,class:"data-status PUBLISHED"},Ys={key:1},Xs={class:"ellipsis1"},Zs=["onClick"],Qs=["onClick"],ei=["onClick"],ai={key:1,class:"main"},ti={key:2,class:"footer"},li=Oe({__name:"ServiceInfoDialog",props:{visible:{type:Boolean,default:!1},dialogType:{default:De.CHECK},domId:{default:""},curEditId:{default:""},curCatalogId:{default:""}},emits:["update:visible","changeCheck","changeEdit","changeUpdate","save"],setup(re,{emit:te}){const h=["WFS"],I=te,A=re,b=_a(),n=ee(),v=ee(),T=ee(),C=ee("details"),w=ee(0),R=ee(!1),U=ee(!1),H=ee(!1),f=ee(!1),p=Fe({loading:!1,submiting:!1,editData:{},rules:{aliasName:[{required:!0,message:"服务名称不能为空",trigger:["blur","change"]}]},dataInfoForm:null,currSelDataType:qe.DATARESOURCE,tableData:[],versionSelection:[],dynamicTags:[],inputVisible:!1,inputValue:"",classifyTreeData:[],catalogObj:null,treeProps:{label:"name",children:"children",disabled:"no"},treeValueKey:"id"}),pe=ee(),S=Se(()=>A.dialogType===De.CHECK),u=Se(()=>A.dialogType===De.EDIT),g=Se(()=>A.dialogType===De.UPDATE),o=Se(()=>({[qe.DATARESOURCE]:Zn,[qe.RESULTDATA]:is,[qe.DATASET]:Tn})[p.currSelDataType]);Be("serviceId",Se(()=>A.curEditId)),Be("aliasName",Se(()=>p.editData.aliasName)),Be("category",Se(()=>p.editData.category)),Be("categoryAliasName",Se(()=>p.editData.categoryAliasName)),Be("originalDataType",Se(()=>p.editData.dataType)),Be("handleClosed",P);async function d(){var B;U.value=A.dialogType===De.CHECK,C.value="details",p.dataInfoForm=null,p.tableData=[],p.classifyTreeData=await Ra(La.SERVICE),i(A.curEditId),se(),(B=n.value)==null||B.clearValidate(),R.value=!1}function s(){I("update:visible",!1)}const $=ee({});function E(){I("changeEdit"),U.value=!0}function i(B){p.loading=!0,xe.getServiceInfoById(B).then(_=>{if(p.loading=!1,_.code==="0000"){p.editData=_.data,$.value=Ie.cloneDeep(_.data),p.dynamicTags=_.data.label?_.data.label.split(","):[],p.editData.publishStatus!=="PUBLISHING"&&L();const ne=Ct(p.classifyTreeData);p.catalogObj={id:p.editData.catalogId,name:ne.value.get(p.editData.catalogId)}}else _.code==="0001"?(oe({type:"error",message:_.message||"数据不存在"}),s()):oe({type:"error",message:_.message||"获取服务信息失败"})}).catch(()=>{p.loading=!1,oe({type:"error",message:"获取服务信息错误"})})}function L(){xe.getSlicingLogById(A.curEditId).then(B=>{B.code==="0000"||oe({type:"error",message:`获取切片日志失败 【${B.message}】`||"获取切片日志失败"})}).catch(()=>{oe({type:"error",message:"获取切片日志错误"})})}function P(){f.value=!1,U.value&&!S.value?(n.value.resetFields(),p.editData=Ie.cloneDeep($.value),I("changeCheck"),U.value=!1):s(),w.value=0,H.value=!1,se()}function m(){var B;(B=n.value)==null||B.validate(_=>{_&&le()})}function le(B){p.submiting=!0;const{id:_,aliasName:ne,status:ce,description:O,realUrl:_e}=p.editData,V=p.dynamicTags.join(","),be={id:_,aliasName:ne,status:ce,description:O,label:V,realUrl:_e,catalogId:p.catalogObj.id,catalogName:p.catalogObj.name};B&&(be.tileConfig=JSON.stringify(B)),xe.updateServiceInfo(be).then(fe=>{p.submiting=!1,fe.code==="0000"?(he({type:"success",title:"编辑成功"}),s(),I("save")):he({type:"error",title:"服务编辑失败",message:fe.message})}).catch(fe=>{p.submiting=!1,he({type:"error",title:"服务编辑错误",message:fe.message})})}function se(){xe.getVersionList(A.curEditId).then(B=>{B.code==="0000"?p.tableData=B.data:oe({type:"error",message:`获取版本信息失败 【${B.message}】`})}).catch(()=>{oe({type:"error",message:"获取版本信息错误"})})}function W(B,_){if(_)return;const{id:ne}=B;xe.switchVersion(ne).then(ce=>{ce.code==="0000"?(he({type:"success",title:ce.message}),se()):oe({type:"error",message:`切换版本失败 【${ce.message}】`})}).catch(()=>{oe({type:"error",message:"切换版本错误"})})}function D(B,_){if(_)return;const{versionPreviewUrl:ne,category:ce,serviceName:O,latlonboundingbox:_e}=B,V={url:Xa+ne,category:ce,layerName:O,rectangle:_e},be=b.resolve({name:"ServicePreview",query:V});window.open(be.href,"_blank")}function J(B,_){if(_)return;const{id:ne}=B;xe.deleteVersion(ne).then(ce=>{ce.code==="0000"?(he({type:"success",title:ce.message}),se()):oe({type:"error",message:`删除失败 【${ce.message}】`})}).catch(()=>{oe({type:"error",message:"删除错误"})})}function Y(B){p.dynamicTags.splice(p.dynamicTags.indexOf(B),1)}function M(){p.inputValue&&p.dynamicTags.push(p.inputValue),p.inputValue="",p.inputVisible=!1}function N(){p.inputVisible=!0,He(()=>{pe.value.input.focus()})}function ue(){R.value=!0}function me(){if(p.versionSelection.length===0)return;const B=p.versionSelection.join(",");xe.batchDeleteVersion(B).then(_=>{var ne;_.code==="0000"?(he({type:"success",title:_.message}),se(),(ne=T.value)==null||ne.clearSelection()):oe({type:"error",message:`删除失败 【${_.message}】`})}).catch(()=>{oe({type:"error",message:"删除错误"})})}function K(B){p.versionSelection=B.map(_=>_.id)}function X(B){return B.useVersion!=="0"}function Q(){i(A.curEditId),se()}return(B,_)=>{const ne=y("ArrowLeft"),ce=y("el-icon"),O=y("el-tab-pane"),_e=y("el-tabs"),V=y("el-form-item"),be=y("el-switch"),fe=y("el-tag"),$e=y("CirclePlus"),Ce=y("el-button"),Ge=y("el-radio"),Me=y("el-radio-group"),Ae=y("el-form"),Ne=y("el-popconfirm"),Ee=y("el-table-column"),aa=y("el-table"),j=ea("loading");return t(),c(ae,null,[a(l(It),{id:"service-info-full-dialog","model-value":B.visible,class:"full-dialog common-full-dialog","append-to-dom":B.domId,"modal-append-to-body":!1,fullscreen:"","is-custom":"","close-on-press-escape":!1,onOpen:d,onClosed:s},{default:e(()=>[ze((t(),c("div",rs,[r("div",ds,[a(ce,{onClick:s},{default:e(()=>[a(ne)]),_:1}),S.value?(t(),c("div",cs,[a(_e,{modelValue:C.value,"onUpdate:modelValue":_[0]||(_[0]=F=>C.value=F),class:"db-tabs"},{default:e(()=>[a(O,{label:"服务详情",name:"details"}),a(O,{label:"数据血缘",name:"dataBlood"})]),_:1},8,["modelValue"])])):(t(),c("span",us,"服务"+z(l(Tt).get(B.dialogType)),1))]),C.value==="details"?(t(),c("div",ps,[r("div",ms,[fs,r("div",gs,[a(Ae,{ref_key:"editFormRef",ref:n,class:"form edit-form",inline:"",model:p.editData,rules:u.value?p.rules:void 0,"label-width":"auto","label-position":"right"},{default:e(()=>[r("div",ys,[a(V,{label:"服务标识",prop:"name"},{default:e(()=>[r("span",null,z(p.editData.name),1)]),_:1}),a(V,{label:"服务名称",prop:"aliasName"},{default:e(()=>[u.value?(t(),k(l(Qe),{key:0,modelValue:p.editData.aliasName,"onUpdate:modelValue":_[1]||(_[1]=F=>p.editData.aliasName=F),type:"text",placeholder:"请输入服务名称"},null,8,["modelValue"])):(t(),c("span",_s,z(p.editData.aliasName),1))]),_:1})]),r("div",bs,[a(V,{label:"服务类型",prop:"categoryAliasName"},{default:e(()=>[r("span",null,z(p.editData.categoryAliasName),1)]),_:1}),g.value?G("",!0):(t(),k(V,{key:0,label:"数据名称",prop:"resourceName"},{default:e(()=>[r("span",null,z(p.editData.resourceName),1)]),_:1}))]),r("div",vs,[a(V,{label:"服务说明",prop:"description"},{default:e(()=>[u.value?(t(),k(l(Qe),{key:0,modelValue:p.editData.description,"onUpdate:modelValue":_[2]||(_[2]=F=>p.editData.description=F),type:"text",placeholder:"请输入服务说明",clearable:""},null,8,["modelValue"])):(t(),c("span",{key:1,class:Re(["description",p.editData.description?"":"empty"])},z(p.editData.description||"未说明"),3))]),_:1}),u.value?G("",!0):(t(),k(V,{key:0,label:"服务来源",prop:"serviceType"},{default:e(()=>[r("span",null,z(p.editData.serviceType===0?"内部发布服务":"外部注册服务"),1)]),_:1}))]),p.classifyTreeData.length||!u.value?(t(),c("div",hs,[a(V,{label:"所属目录"},{default:e(()=>{var F;return[u.value?(t(),k(l(xa),{key:0,ref_key:"selectTreeRef",ref:v,modelValue:p.catalogObj,"onUpdate:modelValue":_[3]||(_[3]=x=>p.catalogObj=x),"tree-props":p.treeProps,"tree-data":p.classifyTreeData,"value-key":p.treeValueKey,style:{width:"100%"}},null,8,["modelValue","tree-props","tree-data","value-key"])):(t(),c("span",Ts,z(((F=p.catalogObj)==null?void 0:F.name)||"--"),1))]}),_:1}),a(V)])):G("",!0),r("div",Is,[S.value?(t(),k(V,{key:0,label:"服务状态",prop:"status"},{default:e(()=>[g.value?(t(),c("span",Ds,z(p.editData.status===0?"已启动":"已停止"),1)):(t(),k(be,{key:0,modelValue:p.editData.status,"onUpdate:modelValue":_[4]||(_[4]=F=>p.editData.status=F),class:"swith-btn","active-value":0,"inactive-value":1},null,8,["modelValue"]))]),_:1})):G("",!0),a(V,{label:"服务标签"},{default:e(()=>{var F;return[(t(!0),c(ae,null,ve(p.dynamicTags,x=>(t(),k(fe,{key:x,class:"mx-1",closable:"","disable-transitions":!1,onClose:ie=>Y(x)},{default:e(()=>[q(z(x),1)]),_:2},1032,["onClose"]))),128)),!((F=p.dynamicTags)!=null&&F.length)&&!u.value?(t(),c("span",ks," --")):G("",!0),p.inputVisible?(t(),k(l(Qe),{key:1,ref_key:"InputRef",ref:pe,modelValue:p.inputValue,"onUpdate:modelValue":_[5]||(_[5]=x=>p.inputValue=x),placeholder:"",size:"small",class:"mx-1 w-input",maxlength:50,onKeyup:wa(M,["enter"]),onBlur:M},null,8,["modelValue"])):G("",!0),!p.inputVisible&&u.value?(t(),k(Ce,{key:2,size:"small",class:"mx-1",onClick:N},{default:e(()=>[a(ce,null,{default:e(()=>[a($e)]),_:1})]),_:1})):G("",!0)]}),_:1})]),g.value?G("",!0):(t(),c("div",Ss,[a(V,{label:"发布人",prop:"creator"},{default:e(()=>[r("span",null,z(p.editData.creator),1)]),_:1}),a(V,{label:"发布时间",prop:"publishTime"},{default:e(()=>[r("span",null,z(p.editData.publishTime),1)]),_:1})])),g.value?G("",!0):(t(),c("div",Vs,[a(V,{label:"服务地址",prop:"url"},{default:e(()=>[r("span",Cs,z(p.editData.url),1)]),_:1})])),r("div",ws,[a(V,{label:"注册地址",prop:"realUrl"},{default:e(()=>[u.value?(t(),k(l(Qe),{key:0,modelValue:p.editData.realUrl,"onUpdate:modelValue":_[6]||(_[6]=F=>p.editData.realUrl=F),type:"textarea",rows:3,placeholder:"请填写完整URL地址"},null,8,["modelValue"])):(t(),c("span",Fs,z(p.editData.realUrl),1))]),_:1})]),g.value?(t(),c("div",Es,[a(V,{label:"服务更新方式","label-width":"110px"},{default:e(()=>[a(Me,{modelValue:w.value,"onUpdate:modelValue":_[7]||(_[7]=F=>w.value=F),class:"ml-4"},{default:e(()=>[a(Ge,{label:0},{default:e(()=>[q("选择数据更新")]),_:1},8,["label"]),a(Ge,{label:1},{default:e(()=>[q("选择已有版本更新")]),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1})])):G("",!0)]),_:1},8,["model","rules"])])]),h.includes(p.editData.category)?G("",!0):(t(),c("div",$s,[u.value?(t(),c(ae,{key:0},[r("div",Os,[q(" 版本信息 "),u.value?(t(),c("div",xs,[f.value?(t(),k(Ce,{key:0,type:"primary",link:!0,onClick:_[8]||(_[8]=F=>f.value=!1)},{default:e(()=>[q("退出")]),_:1})):G("",!0),f.value?G("",!0):(t(),k(Ce,{key:1,type:"primary",link:!0,onClick:_[9]||(_[9]=F=>f.value=!0)},{default:e(()=>[q("编辑")]),_:1}))])):G("",!0)]),Rs,r("div",Ls,[a(Ce,{type:"primary",plain:"",onClick:ue},{default:e(()=>[q(" 添加版本 ")]),_:1}),a(Ne,{title:"确定删除选中版本？",onConfirm:me},{reference:e(()=>[a(Ce,{type:"danger",plain:"",disabled:p.versionSelection.length===0},{default:e(()=>[q(" 删除版本 ")]),_:1},8,["disabled"])]),_:1})])],64)):(t(),c("div",As,"版本信息")),r("div",Ns,[a(aa,{ref_key:"versionTableRef",ref:T,class:"data-table",data:p.tableData,"max-height":"300","row-key":"id",onSelectionChange:K},{default:e(()=>[f.value?(t(),k(Ee,{key:0,align:"center",type:"selection",label:"选中","reserve-selection":"",selectable:X})):G("",!0),a(Ee,{label:"版本号","min-width":"120"},{default:e(F=>[F.row.useVersion==="0"?(t(),c("span",Us,z(F.row.version)+"(当前版本) ",1)):(t(),c("span",Ps,z(F.row.version),1))]),_:1}),a(Ee,{prop:"resourceName",label:"数据名称","min-width":"120"},{default:e(F=>[r("span",Ms,z(F.row.resourceName),1)]),_:1}),a(Ee,{prop:"updateTime","min-width":"120",label:"更新时间"}),a(Ee,{label:"操作","class-name":"tableOperate","min-width":"120"},{default:e(F=>[f.value?(t(),c("span",{key:0,class:Re({disabled:F.row.useVersion==="0"}),onClick:la(x=>W(F.row,F.row.useVersion==="0"),["stop"])}," 使用此版本 ",10,Bs)):G("",!0),r("span",{class:Re({disabled:h.includes(F.row.category)}),onClick:la(x=>D(F.row,h.includes(F.row.category)),["stop"])}," 预览 ",10,zs),f.value?(t(),k(Ne,{key:1,title:"确定删除该版本？",disabled:F.row.useVersion==="0",onConfirm:x=>J(F.row,F.row.useVersion==="0")},{reference:e(()=>[r("span",{class:Re(["delete",{disabled:F.row.useVersion==="0"}])}," 删除 ",2)]),_:2},1032,["disabled","onConfirm"])):G("",!0)]),_:1})]),_:1},8,["data"])])])),g.value&&w.value===0?(t(),c("div",Gs,[r("div",qs,[Ws,r("span",{class:"func-btn",onClick:_[10]||(_[10]=F=>R.value=!0)}," 点击选择数据 ")]),p.dataInfoForm?(t(),k(ja,{key:0},[(t(),k($a(o.value),{"relese-data-info":p.dataInfoForm},null,8,["relese-data-info"]))],1024)):G("",!0)])):g.value||w.value===1?(t(),c("div",js,[Hs,r("div",Ks,[a(aa,{class:"data-table",data:p.tableData,"max-height":"300"},{default:e(()=>[a(Ee,{label:"版本号","min-width":"120"},{default:e(F=>[F.row.useVersion==="0"?(t(),c("span",Js,z(F.row.version)+"(当前版本) ",1)):(t(),c("span",Ys,z(F.row.version),1))]),_:1}),a(Ee,{prop:"resourceName",label:"数据名称","min-width":"120"},{default:e(F=>[r("span",Xs,z(F.row.resourceName),1)]),_:1}),a(Ee,{prop:"updateTime","min-width":"120",label:"更新时间"}),a(Ee,{label:"操作","class-name":"tableOperate","min-width":"120"},{default:e(F=>[g.value?(t(),c("span",{key:0,class:Re({disabled:F.row.useVersion==="0"}),onClick:la(x=>W(F.row,F.row.useVersion==="0"),["stop"])}," 使用此版本 ",10,Zs)):G("",!0),r("span",{class:Re({disabled:h.includes(F.row.category)}),onClick:la(x=>D(F.row,h.includes(F.row.category)),["stop"])}," 预览 ",10,Qs),g.value?(t(),c("span",{key:1,class:Re([{disabled:F.row.useVersion==="0"},"delete"]),onClick:la(x=>J(F.row,F.row.useVersion==="0"),["stop"])}," 删除 ",10,ei)):G("",!0)]),_:1})]),_:1},8,["data"])])])):G("",!0)])):G("",!0),C.value==="dataBlood"&&S.value?(t(),c("div",ai,[a(l(wt),{id:A.curEditId,type:"SERVICE_MANAGE"},null,8,["id"])])):G("",!0),C.value!=="dataBlood"&&!H.value?(t(),c("div",ti,[a(Ce,{onClick:P},{default:e(()=>[q("取消")]),_:1}),w.value===0?(t(),c(ae,{key:0},[S.value?(t(),k(Ce,{key:0,type:"primary",onClick:E},{default:e(()=>[q("编辑")]),_:1})):(t(),k(Ce,{key:1,type:"primary",loading:p.submiting,onClick:m},{default:e(()=>[q(" 保存 ")]),_:1},8,["loading"]))],64)):G("",!0)])):G("",!0)])),[[j,p.loading]])]),_:1},8,["model-value","append-to-dom"]),a(vo,{modelValue:R.value,"onUpdate:modelValue":_[11]||(_[11]=F=>R.value=F),onSuccess:Q},null,8,["modelValue"])],64)}}});const oi={class:"modal-content"},ni=r("p",{class:"preview-btn"},[r("span",null,"点击查看"),r("a",{class:"link",href:"dataInfo/时空数据服务注册规范202401.pdf",target:"_blank"}," 服务注册规范详情 ")],-1),si={style:{float:"left"}},ii={style:{float:"right",color:"#8492a6"}},ri={class:"dialog-footer"},di=Oe({__name:"RegisterServiceDialog",props:{visible:{type:Boolean,default:!1},curCatalogId:{type:String,default:""}},emits:["closed","save"],setup(re,{emit:te}){const h=te,I=re,A=ft(),b=ee(),n=ee(),v=Fe({loadingInstance:null,dialogVisible:!1,categoryOptions:[],defaultForm:{aliasName:"",category:"",description:"",id:"",name:"",permission:"",permissionType:1,realUrl:"",serviceType:1,status:0},form:{permission:""},rules:{aliasName:[{required:!0,message:"请输入服务名称",trigger:["change","blur"]}],category:[{required:!0,message:"请选择服务类型",trigger:"change"}],realUrl:[{required:!0,message:"请输入注册地址",trigger:["change","blur"]},{type:"url",message:"注册地址格式不正确",trigger:["change","blur"]}]},checkNameing:!1,checkTimer:null,submiting:!1,permissionDialogVisible:!1,dynamicTags:[],inputVisible:!1,inputValue:"",classifyTreeData:[],catalogObj:null,treeProps:{label:"name",children:"children",disabled:"no"},treeValueKey:"id"}),T=ee();Ke(()=>I.visible,u=>{v.dialogVisible=u});function C(u,g,o){g?(v.checkNameing=!1,o()):(v.checkTimer&&clearTimeout(v.checkTimer),v.checkNameing=!1,o())}async function w(){if(v.classifyTreeData=await Ra(La.SERVICE),I.curCatalogId==="#"){const u=v.classifyTreeData.find(g=>g.isDefault);v.catalogObj={id:u==null?void 0:u.id,name:""}}else v.catalogObj={id:I.curCatalogId,name:""};He(()=>{var u,g;v.loadingInstance=Ka.service({target:".service-dialog"}),U(),(u=b.value)==null||u.resetFields(),v.form=Ie.cloneDeep(v.defaultForm),v.form.permission=A.userInfo.id,v.catalogObj=(g=n.value)==null?void 0:g.getTypeObj(v.catalogObj.id),v.loadingInstance.close()})}function R(){h("closed"),v.form={permission:""}}function U(){et("kjfwlx").then(u=>{if(u.code==="0000"){const{data:{kjfwlx:g}}=u;v.categoryOptions=g}else oe({type:"warning",message:"获取服务分类失败"})}).catch(()=>{oe({type:"error",message:"获取服务分类失败"})})}function H(){b.value.validate(u=>{if(u)f();else return!1})}function f(){v.submiting=!0;const u=Ie.cloneDeep(v.form),g=v.categoryOptions.find(d=>d.dictKey===v.form.category),o=v.dynamicTags.join(",");u.categoryAliasName=g?g.dictValue:"未知类型",u.label=o,u.catalogId=v.catalogObj.id,u.catalogName=v.catalogObj.name,xe.registerServiceInfo(u).then(d=>{d.code==="0000"?(he({type:"success",title:"注册成功"}),v.submiting=!1,h("save"),R()):(v.submiting=!1,he({type:"warning",title:"注册失败"}))}).catch(()=>{v.submiting=!1,he({type:"error",title:"注册错误"})})}function p(u){v.dynamicTags.splice(v.dynamicTags.indexOf(u),1)}function pe(){v.inputValue&&v.dynamicTags.push(v.inputValue),v.inputValue="",v.inputVisible=!1}function S(){v.inputVisible=!0,He(()=>{T.value.input.focus()})}return(u,g)=>{const o=y("el-form-item"),d=y("el-icon"),s=y("el-option"),$=y("el-select"),E=y("el-tag"),i=y("CirclePlus"),L=y("el-button"),P=y("el-form"),m=y("el-dialog");return t(),k(m,{modelValue:v.dialogVisible,"onUpdate:modelValue":g[8]||(g[8]=le=>v.dialogVisible=le),class:"service-dialog center-dialog",title:"注册服务",width:"500px","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,onOpen:w,onClosed:R},{footer:e(()=>[r("span",ri,[a(L,{onClick:g[7]||(g[7]=le=>h("closed"))},{default:e(()=>[q("取 消")]),_:1}),a(L,{type:"primary",loading:v.submiting,onClick:H},{default:e(()=>[q(" 确 定 ")]),_:1},8,["loading"])])]),default:e(()=>[r("div",oi,[ni,a(P,{ref_key:"serviceForm",ref:b,class:"serviceForm",model:v.form,rules:v.rules,"label-width":"auto"},{default:e(()=>[a(o,{label:"服务名称",prop:"aliasName"},{default:e(()=>[a(l(Qe),{modelValue:v.form.aliasName,"onUpdate:modelValue":g[0]||(g[0]=le=>v.form.aliasName=le),modelModifiers:{trim:!0},placeholder:"不超过50个字符",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(o,{label:"服务标识",prop:"name",rules:[{validator:C,trigger:"blur"},{validator:C,trigger:"change"}]},{default:e(()=>[a(l(Qe),{modelValue:v.form.name,"onUpdate:modelValue":g[1]||(g[1]=le=>v.form.name=le),placeholder:"英文大小写字母和数字，不超过50个字符",maxlength:"50","show-word-limit":""},dt({_:2},[v.checkNameing?{name:"suffix",fn:e(()=>[a(d,{class:"el-input__icon"},{default:e(()=>[a(l(ut))]),_:1})]),key:"0"}:void 0]),1032,["modelValue"])]),_:1},8,["rules"]),a(o,{label:"注册地址",prop:"realUrl"},{default:e(()=>[a(l(Qe),{modelValue:v.form.realUrl,"onUpdate:modelValue":g[2]||(g[2]=le=>v.form.realUrl=le),type:"textarea",rows:3,placeholder:"请填写完整URL地址"},null,8,["modelValue"])]),_:1}),a(o,{label:"服务类型",prop:"category"},{default:e(()=>[a($,{modelValue:v.form.category,"onUpdate:modelValue":g[3]||(g[3]=le=>v.form.category=le),style:{width:"100%"},placeholder:"请选择服务类型"},{default:e(()=>[(t(!0),c(ae,null,ve(v.categoryOptions,le=>(t(),k(s,{key:le.id,label:le.dictValue,value:le.dictKey},{default:e(()=>[r("span",si,z(le.dictValue),1),r("span",ii,z(le.dictKey),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(o,{label:"所属目录"},{default:e(()=>[a(l(xa),{ref_key:"selectTreeRef",ref:n,modelValue:v.catalogObj,"onUpdate:modelValue":g[4]||(g[4]=le=>v.catalogObj=le),"tree-props":v.treeProps,"tree-data":v.classifyTreeData,"value-key":v.treeValueKey,style:{width:"100%"}},null,8,["modelValue","tree-props","tree-data","value-key"])]),_:1}),a(o,{label:"服务标签"},{default:e(()=>[(t(!0),c(ae,null,ve(v.dynamicTags,le=>(t(),k(E,{key:le,class:"mx-1",closable:"","disable-transitions":!1,onClose:se=>p(le)},{default:e(()=>[q(z(le),1)]),_:2},1032,["onClose"]))),128)),v.inputVisible?(t(),k(l(Qe),{key:0,ref_key:"InputRef",ref:T,modelValue:v.inputValue,"onUpdate:modelValue":g[5]||(g[5]=le=>v.inputValue=le),placeholder:"",size:"small",class:"mx-1 w-input",maxlength:50,onKeyup:wa(pe,["enter"]),onBlur:pe},null,8,["modelValue"])):G("",!0),v.inputVisible?G("",!0):(t(),k(L,{key:1,size:"small",class:"mx-1",onClick:S},{default:e(()=>[a(d,null,{default:e(()=>[a(i)]),_:1})]),_:1}))]),_:1}),a(o,{label:"服务说明",prop:"description"},{default:e(()=>[a(l(Qe),{modelValue:v.form.description,"onUpdate:modelValue":g[6]||(g[6]=le=>v.form.description=le),maxlength:"100","show-word-limit":"",type:"textarea",rows:3,resize:"none"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])]),_:1},8,["modelValue"])}}});function ui(re){const te=ee(re),h=Fe({treeProps:{label:"name",children:"children",disabled:"no"},treeValueKey:"id",classifyTreeData:[]}),I=we("getClassifyTreeData");h.classifyTreeData=Se(()=>(I==null?void 0:I())||[]);const A=Se(()=>{const T=new Map,C=(w,R)=>{w.forEach(U=>{var f;const H=U.pid==="#"?U.name:`${R} / ${U.name}`;T.set(U.id,H),((f=U==null?void 0:U.children)==null?void 0:f.length)>0&&C(U.children,H)})};return C(Ie.cloneDeep(h.classifyTreeData),""),T});function b(T){if(typeof T!="object")te.value.type=null;else{const C=Ie.cloneDeep(T);te.value.type={...n(C)}}}function n(T){const C={[h.treeProps.label]:A.value.get(T.id),id:T.id};return Ie.cloneDeep(C)}function v(T,C){for(const w of T){if(w.id===C)return w;if(w.children){const R=v(w.children,C);if(R)return R}}return null}return{...ra(h),handleTypeChange:b,getTypeObj:n,findTreeNodeById:v,currentEditData:te,catalogNameMap:A}}const ci={class:"modal-content"},pi=r("div",{class:"tips"},[r("span",null,"上传文件需按模板填写，点击下载"),r("a",{class:"link",href:"dataInfo/批量注册模板.xlsx",download:"导入文件模板.xlsx"}," 导入文件模板 ")],-1),mi=["accept"],fi={class:"dialog-footer"},gi=Oe({__name:"BatchRegisterSeviceDialog",props:{visible:{type:Boolean,default:!1}},emits:["closed","save"],setup(re,{emit:te}){const h=te,I=we("getCatalogNode"),A=re,b=Fe({loadingInstance:null,dialogVisible:!1,file:null,isHandling:!1,isChecking:!1,validateItem:{show:!1,isPass:!1,message:""},acceptList:".xls, .xlsx",fileMaxSize:500,form:{permission:"",fileName:"",type:null},rules:{type:[{required:!0,message:"所属分组不能为空",trigger:["change"]}],fileName:[{required:!0,message:"请上传文件",trigger:["change"]}]},submiting:!1}),n=ee([]),v=ee(),T=ee(),{treeProps:C,catalogNameMap:w}=ui(b.form);Ke(()=>A.visible,g=>{b.dialogVisible=g});async function R(){n.value=await Ra(La.SERVICE)||[],b.file=null,He(()=>{var g,o;if(b.loadingInstance=Ka.service({target:".service-dialog"}),(g=v.value)==null||g.resetFields(),I!=null&&I())b.form.type={id:(o=I==null?void 0:I())==null?void 0:o.id,[C.value.label]:""};else{const d=n.value.find(s=>s.isDefault);b.form.type={id:d==null?void 0:d.id,[C.value.label]:""}}n.value.length===0?b.form.type=null:b.form.type[C.value.label]=w.value.get(b.form.type.id),b.loadingInstance.close()})}function U(){h("closed"),b.form={permission:"",fileName:"",type:null},b.validateItem.show=!1}function H(){v.value.validate(g=>{if(g)b.submiting=!0,p(()=>{f(!0)});else return!1})}function f(g=!1){const{type:o}=b.form;let d={};d=Ie.cloneDeep(b.form),d.catalogId=o.id,d.catalog=o[C.value.label],delete d.type,g&&(d.file=b.file,delete d.fileName),b.submiting=!0,xe.batchRegisterExternalService(d).then(s=>{var $;s.code==="0000"?(he({type:"success",title:`${g?"批量":""}注册成功`}),g&&oe({type:"success",message:($=s.data)==null?void 0:$.join("")}),b.submiting=!1,h("save"),U()):(b.submiting=!1,he({type:"warning",title:`${g?"批量":""}注册失败`}))}).catch(()=>{b.submiting=!1,he({type:"error",title:`${g?"批量":""}注册错误`})})}function p(g){if(b.isChecking=!0,b.validateItem.show=!1,!b.file){Le.alert("请上传文件","提示",{confirmButtonText:"确定",type:"error"}),b.submiting=!1;return}xe.checkBatchRegisterFile(b.file).then(o=>{const{code:d,data:s}=o;d==="0000"?s.verify?(b.validateItem.isPass=!0,b.validateItem.show=!0,b.isChecking=!1,g==null||g()):(b.validateItem.isPass=!1,b.validateItem.message=s.message,b.validateItem.show=!0,b.isChecking=!1):(b.validateItem.isPass=!1,b.validateItem.message="",b.validateItem.show=!0,b.isChecking=!1)}).catch(()=>{b.isChecking=!1,b.submiting=!1,he({type:"error",title:"校验文件错误"})})}function pe(){T.value.click()}function S(g){const{files:o}=g.target;if(o.length===0)return;const d=o[0];if(b.isHandling=!0,d.size&&d.size/1024/1024>b.fileMaxSize){Le.alert(`文件超过${b.fileMaxSize}MB! 无法上传`,"提示",{confirmButtonText:"确定",type:"error"}),g.target.value="",b.isHandling=!1;return}const s=["xlsx","xls"],$=u(d.name).toLowerCase();if(s.includes($))b.file=new File([d],d.name),b.form.fileName=d.name,b.isHandling=!1,b.validateItem.show=!1;else{Le.alert("上传失败，请选择正确的文件格式上传","提示",{confirmButtonText:"确定",type:"error"}),g.target.value="",b.isHandling=!1;return}g.target.value=""}function u(g){return g.replace(/.+\./,"")}return(g,o)=>{const d=y("el-form-item"),s=y("el-input"),$=y("el-button"),E=y("el-form"),i=y("el-alert"),L=y("el-dialog");return t(),k(L,{modelValue:b.dialogVisible,"onUpdate:modelValue":o[4]||(o[4]=P=>b.dialogVisible=P),class:Re("service-dialog center-dialog"),title:"批量注册",width:"600px","append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,onOpen:R,onClosed:U},{footer:e(()=>[r("span",fi,[a($,{onClick:o[3]||(o[3]=P=>h("closed"))},{default:e(()=>[q("取 消")]),_:1}),a($,{type:"primary",loading:b.submiting,onClick:H},{default:e(()=>[q(" 确 定 ")]),_:1},8,["loading"])])]),default:e(()=>[r("div",ci,[pi,a(E,{ref_key:"serviceForm",ref:v,class:"serviceForm",model:b.form,rules:b.rules,"label-width":"auto"},{default:e(()=>[a(d,{label:"所属分组",prop:"type"},{default:e(()=>[a(l(xa),{modelValue:b.form.type,"onUpdate:modelValue":o[0]||(o[0]=P=>b.form.type=P),"tree-props":l(C),"tree-data":n.value,clearable:"",style:{width:"100%"}},null,8,["modelValue","tree-props","tree-data"])]),_:1}),a(d,{label:"文件上传",prop:"fileName"},{default:e(()=>[a(s,{modelValue:b.form.fileName,"onUpdate:modelValue":o[1]||(o[1]=P=>b.form.fileName=P),class:"mr",type:"text",readonly:"",placeholder:"请点击右侧按钮上传文件",style:{flex:"1","margin-right":"16px"}},null,8,["modelValue"]),a($,{type:"primary",icon:l(Ea),plain:"",disabled:b.isHandling,onClick:pe},{default:e(()=>[q(z(b.isHandling?"处理中":"上  传"),1)]),_:1},8,["icon","disabled"]),a($,{type:"primary",icon:l(ct),plain:"",disabled:b.isChecking||!b.file,onClick:o[2]||(o[2]=P=>p())},{default:e(()=>[q(z(b.isChecking?"校验中":"校  验"),1)]),_:1},8,["icon","disabled"])]),_:1}),r("input",{ref_key:"uploadFile",ref:T,style:{display:"none"},type:"file",class:"uploadFile",directory:"",nwdirectory:"",accept:b.acceptList,onChange:S},null,40,mi)]),_:1},8,["model","rules"]),b.validateItem.show?(t(),c(ae,{key:0},[b.validateItem.isPass?(t(),k(i,{key:0,title:"文件校验通过！",type:"success","show-icon":"",closable:!1})):(t(),k(i,{key:1,title:`文件校验未通过！${b.validateItem.message}`,class:"error-alert",type:"error","show-icon":!0,closable:!1},null,8,["title"]))],64)):G("",!0)])]),_:1},8,["modelValue"])}}});function yi(){const re=Fe({labelOptions:[],typeOptions:[{label:"所有",value:"ALL"}],statusOptions:[{label:"所有",value:""},{label:"已停止",value:1},{label:"已启动",value:0}]}),te={0:"发布",1:"注册"},{statusOptions:h,labelOptions:I,typeOptions:A}=ra(re),b=Fe({searchOptions:[{label:"关键字",key:"keyword",type:"text",placeholder:"标识/名称/发布人",span:5},{label:"服务类型",key:"category",type:"select",options:A,clearable:!0,span:5},{label:"服务状态",key:"status",type:"select",options:h,clearable:!0,span:5},{label:"服务标签",key:"label",type:"select",options:I,clearable:!0,span:5}],columns:[{prop:"thumbnailUrl",label:"缩略图",minWidth:120,slot:"thumbnailUrl"},{prop:"aliasName",label:"服务名称",minWidth:300,slot:"aliasName"},{prop:"name",label:"服务标识",minWidth:280},{prop:"catalogName",label:"所属目录",minWidth:120},{prop:"categoryAliasName",label:"服务类型",minWidth:120},{prop:"label",label:"数据标签",minWidth:120},{prop:"creator",label:"发布人",minWidth:120},{prop:"serviceType",label:"服务来源",minWidth:120,formatter:n},{prop:"publishTime",label:"发布时间",minWidth:180,sortable:!0},{prop:"status",label:"服务状态",minWidth:180,sortable:!0,fixed:"right",slot:"status"}]});function n(C){return te[C.serviceType]}const v=()=>{xe.getAllTags().then(C=>{C.code==="0000"&&(re.labelOptions=C.data.map(w=>({label:w,value:w})))})},T=()=>{et("kjfwlx").then(C=>{if(C.code==="0000"){const{data:{kjfwlx:w}}=C,R=w.map(U=>({...U,label:U.dictValue,value:U.dictKey}));re.typeOptions=re.typeOptions.concat(R)}})};return Xe(()=>{v(),T()}),{...ra(b)}}const _i=["src","onClick"],bi=Oe({__name:"index",setup(re){const te=ee(),h=ee(),I=Se(()=>{var X;return(X=h.value)==null?void 0:X.$el}),A=_a(),b=mt(),n=Se(()=>{var X;return((X=b.query)==null?void 0:X.keyword)||""}),v=ee(!1),T=Fe({domId:"dialog-wrap",isLoadingTable:!1,tableData:[],selection:[],dialogVisible:!1,dialogType:De.CHECK,curEditId:"",thumbnailDialogVisible:!1,curPreviewItem:{},registerDialogVisible:!1,isBatchRegister:!1}),C={catalogId:"#"},{searchOptions:w,columns:R}=yi(),{data:U,total:H,pageNo:f,pageSize:p,multipleSelection:pe,loading:S,handleSizeChange:u,handleCurrentChange:g,handleSelectionChange:o,handleSearch:d,initData:s}=gt(xe.getServicePageList,C),$=["VECTOR2","TERRAIN","IOT","WFS"];Xe(()=>{n.value?He(()=>{te==null||te.value.handleSetFormValue("keyword",n.value)}):s()});function E(X){!X||!X.id||xe.changeServiceStatus(X.id,X.status).then(Q=>{Q.code==="0000"?oe({message:`服务已${X.status===0?"启动":"停止"}！`,type:"success",duration:2e3}):oe({type:"warning",message:"服务状态更改失败"}),s()}).catch(()=>{s()})}function i(X){se(X.id).then(B=>{if(B){const _=A.resolve({name:"ServicePreview",query:{id:X.id}});window.open(_.href,"_blank")}else oe({type:"error",message:"服务不存在"})}).catch(()=>{oe({type:"error",message:"获取服务信息失败"})})}function L(X){se(X.id).then(B=>{B?(T.curEditId=X.id,T.dialogType=De.EDIT,T.dialogVisible=!0):oe({type:"error",message:"服务不存在"})}).catch(()=>{oe({type:"error",message:"获取服务信息失败"})})}function P(){T.dialogType=De.CHECK}function m(){T.dialogType=De.EDIT}function le(){T.dialogType=De.UPDATE}function se(X){return new Promise((Q,B)=>{xe.getServiceInfoById(X).then(_=>{_.code==="0000"?Q(!0):Q(!1)}).catch(()=>{B(!1)})})}function W(X){const Q="删除";Le.confirm(`${Q}【${X.name}】服务, 是否继续?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{T.isLoadingTable=!0,xe.deleteServiceByIds(X.id).then(B=>{T.isLoadingTable=!1,B.code==="0000"&&s()}).catch(()=>{T.isLoadingTable=!1})})}function D(){const X="删除";Le.confirm(`是否批量${X}选中服务?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{T.isLoadingTable=!0;const Q=pe.value.map(B=>B.id).join(",");xe.deleteServiceByIds(Q).then(B=>{T.isLoadingTable=!1,B.code==="0000"&&s()}).catch(B=>{T.isLoadingTable=!1,he({type:"error",title:`批量${X}错误`,message:B.message||"服务有错"})})}).catch(()=>{})}function J(X){const Q=X.srcElement;Q.src=Dt,Q.onerror=null}function Y(X){xe.getServiceInfoById(X.id).then(Q=>{if(Q.code==="0000"){const{name:B,url:_,latLonBoundingBox:ne}=Q.data;T.curPreviewItem={...X,layerName:B,url:_,rectangle:ne?JSON.parse(ne):{}},T.thumbnailDialogVisible=!0}else oe({type:"error",message:Q.message||"获取服务信息失败"})}).catch(()=>{oe({type:"error",message:"获取服务信息错误"})})}function M(){T.registerDialogVisible=!0}function N(){T.isBatchRegister=!0}function ue(X){C.catalogId=X,s()}function me(X){se(X.id).then(B=>{B?(T.curEditId=X.id,T.dialogType=De.CHECK,T.dialogVisible=!0):oe({type:"error",message:"服务不存在"})}).catch(()=>{oe({type:"error",message:"获取服务信息失败"})})}function K(){v.value=!0;const X=U.value.map(Q=>Q.id).join(",");xe.checkMapServiceStatus(X).then(Q=>{let B=0;const _=Q.data;U.value=U.value.map(ne=>(_[ne.id]===1&&B++,{...ne,latestStatus:_[ne.id]})),oe({type:B===0?"success":"error",message:B===0?"检测结果：当前页无异常服务":`检测结果：当前页存在${B}个异常服务`})}).catch(()=>{oe({type:"error",message:"检测失败"})}).finally(()=>{v.value=!1})}return(X,Q)=>{const B=y("el-button"),_=y("CircleCheck"),ne=y("el-icon"),ce=y("el-tooltip"),O=y("el-link"),_e=y("el-switch");return t(),c(ae,null,[a(l(fa),{id:"dialog-wrap",background:""},{default:e(()=>[a(l(Ja),{ref_key:"asideRef",ref:h},{default:e(()=>[a(Za,{type:"SERVICE",onChange:ue})]),_:1},512),a(l(fa),null,{default:e(()=>[a(l(yt),{target:I.value},null,8,["target"]),a(l(ha),{padding:"1 1 0",border:""},{default:e(()=>[a(l(_t),{ref_key:"SmartSearchRef",ref:te,options:l(w),onHandleSearch:l(d)},null,8,["options","onHandleSearch"])]),_:1}),a(l(Ya),null,{default:e(()=>[a(l(bt),{ref:"baseTable","operation-width":"220",columns:l(R),"table-data":l(U),"current-page":l(f),"page-size":l(p),total:l(H),"pagination-is-need":!0,"operation-is-need":!0,loading:l(S),"search-form-ref":te.value,"selection-is-need":!0,"index-is-need":!1,onSizeChange:l(u),onCurrentChange:l(g),onSelectionChange:l(o)},{"smart-table_operation":e(()=>[a(B,{type:"primary",onClick:M},{default:e(()=>[q(" 注册服务 ")]),_:1}),a(B,{type:"primary",onClick:N},{default:e(()=>[q(" 批量注册 ")]),_:1})]),"smart-table_setting":e(()=>[a(ce,{effect:"dark",content:v.value?"检测中":"检测",placement:"top"},{default:e(()=>[a(B,{link:"",disabled:v.value,onClick:K},{default:e(()=>[a(ne,{size:22,color:v.value?"#00ff00":""},{default:e(()=>[a(_)]),_:1},8,["color"])]),_:1},8,["disabled"])]),_:1},8,["content"])]),"smart-table_batch-operation":e(()=>[a(B,{type:"danger",icon:l(pt),link:"",onClick:D},{default:e(()=>[q(" 批量删除 ")]),_:1},8,["icon"])]),thumbnailUrl:e(({scope:V})=>[r("img",{class:"image-preview",src:l(Xa)+V.row.thumbnailUrl,style:{height:"55px","margin-top":"5px"},alt:"缩略图",onError:Q[0]||(Q[0]=be=>J(be)),onClick:be=>Y(V.row)},null,40,_i)]),aliasName:e(({scope:V})=>[a(O,{type:V.row.latestStatus!==1?"primary":"danger",onClick:be=>me(V.row)},{default:e(()=>[q(z(V.row.aliasName),1)]),_:2},1032,["type","onClick"])]),status:e(({scope:V})=>[a(_e,{modelValue:V.row.status,"onUpdate:modelValue":be=>V.row.status=be,"active-value":0,"inactive-value":1,onChange:be=>E(V.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),operation:e(({scope:V})=>[a(B,{link:"",disabled:$.includes(V.row.category)||V.row.status===1,type:"primary",onClick:be=>i(V.row)},{default:e(()=>[q(" 预览 ")]),_:2},1032,["disabled","onClick"]),a(B,{type:"primary",link:"",onClick:be=>L(V.row)},{default:e(()=>[q(" 编辑 ")]),_:2},1032,["onClick"]),a(B,{type:"danger",link:"",onClick:be=>W(V.row)},{default:e(()=>[q(" 删除 ")]),_:2},1032,["onClick"])]),_:1},8,["columns","table-data","current-page","page-size","total","loading","search-form-ref","onSizeChange","onCurrentChange","onSelectionChange"])]),_:1})]),_:1})]),_:1}),a(li,{visible:T.dialogVisible,"onUpdate:visible":Q[1]||(Q[1]=V=>T.dialogVisible=V),"dom-id":T.domId,"dialog-type":T.dialogType,"cur-edit-id":T.curEditId,"cur-catalog-id":C.catalogId,onSave:l(s),onChangeCheck:P,onChangeEdit:m,onChangeUpdate:le},null,8,["visible","dom-id","dialog-type","cur-edit-id","cur-catalog-id","onSave"]),a(St,{visible:T.thumbnailDialogVisible,"onUpdate:visible":Q[2]||(Q[2]=V=>T.thumbnailDialogVisible=V),title:"服务封面","preview-data":T.curPreviewItem,onSave:l(s)},null,8,["visible","preview-data","onSave"]),a(di,{visible:T.registerDialogVisible,"onUpdate:visible":Q[3]||(Q[3]=V=>T.registerDialogVisible=V),"cur-catalog-id":C.catalogId,onClosed:Q[4]||(Q[4]=V=>T.registerDialogVisible=!1),onSave:l(s)},null,8,["visible","cur-catalog-id","onSave"]),a(gi,{visible:T.isBatchRegister,"onUpdate:visible":Q[5]||(Q[5]=V=>T.isBatchRegister=V),"cur-catalog-id":C.catalogId,onClosed:Q[6]||(Q[6]=V=>T.isBatchRegister=!1),onSave:l(s)},null,8,["visible","cur-catalog-id","onSave"])],64)}}});const Mi=ya(bi,[["__scopeId","data-v-f7bc1a96"]]);export{Mi as default};
