import{r as F,S as oe,c as O,N as ce,d as Z,b as k,o as _,f as T,g as o,F as G,y as Q,U as te,ad as E,B as c,Z as de,_ as ue,e as y,v as ae,ae as ne,j as s,k as n,l as j,Q as re,x as K,u as m,cb as _e,z as ee,cc as ve,aj as B,w as me,T as ge,t as ye,ak as ie}from"./element-plus.59ccb443.js";import{r as N,S as $,D as he,U as Se,v as se,w as be,x as X,y as Ce,z as ke}from"./login.a4e9287e.js";import{g as we}from"./index.81042689.js";import{_ as le}from"./error.229cea25.js";import{j as Ve}from"./lodash.22f463b4.js";import"../../app-config.js";import"./index.e0e8e942.js";function Le(){return N.doGetPromise("/mapserver/manager/services/catalog/tree")}function De(l){return N.doGetPromise("/mapserver/manager/searchForPortal",l)}function Re(l){return N.doPostPromise("mapserver/manager/collectService",{serviceId:l})}function Te(l){return N.doPostPromise("mapserver/manager/unCollectService ",{serviceId:l})}function Pe(l){return N.doPostPromise("/mapserver/service/apply/submit",l)}function pe(){return N.doGetPromise("/mapserver/manager/getAllLabels")}function Ie(l){return N.doGetPromise(`/mapserver/manager/services/updateShareAccessCount?id=${l}`)}function Ae(l){const b=F({tagsOptions:[]}),{tagsOptions:w}=oe(b),h=O(()=>l.keyword),u=O(()=>l.label),V=F({searchOptions:[{label:"关键字",key:"keyword",type:"text",value:h,placeholder:"请输入关键字",span:8},{label:"数据标签",key:"label",type:"select",options:w,clearable:!0,multiple:!0,value:u,span:7}]}),t=async()=>{const L=await pe();L.code===$.SUCCESS&&(b.tagsOptions=L.data.map(r=>({label:r,value:r})))},i=async()=>{t()};return ce(async()=>{i()}),{...oe(V)}}const Me=l=>(de("data-v-aba9cda0"),l=l(),ue(),l),xe=Me(()=>o("span",null,"全部服务: ",-1)),Oe={class:"service-tags"},Ee=["onClick"],Ue=Z({__name:"checkbox",emits:["cb"],setup(l,{expose:b,emit:w}){const h=w,u=k("all"),V=k(),t=F({serviceList:[{name:"所有",type:"all"},{name:"倾斜摄影",type:"IMAGERY"},{name:"点云数据",type:"POINTCLOUD"},{name:"模型数据",type:"MODEL"},{name:"BIM模型",type:"BIMMODEL"},{name:"矢量数据",type:"VECTOR"},{name:"海量矢量",type:"VECTOR2"},{name:"影像数据",type:"IMAGEDATA"},{name:"地形数据",type:"TERRAIN"},{name:"全景影像",type:"PANORAMICIMAGE"},{name:"KML",type:"KML"},{name:"地质模型",type:"GEO3DML"},{name:"WMS",type:"WMS"},{name:"WMTS",type:"WMTS"},{name:"WFS服务",type:"WFS"}]}),i=S=>{u.value=S.type,h("cb",S.type)};return b({tagRef:V,reset:()=>{u.value="all",h("cb","all")},setTagValue:S=>{u.value=S}}),(S,M)=>(_(),T("div",{ref_key:"tagRef",ref:V,class:"service-checkbox-container"},[xe,o("div",Oe,[(_(!0),T(G,null,Q(t.serviceList,p=>(_(),T("div",{key:p.type,class:te(["tag-item",{active:u.value===p.type}]),onClick:E(C=>i(p),["stop"])},c(p.name),11,Ee))),128))])],512))}});const qe=le(Ue,[["__scopeId","data-v-aba9cda0"]]),$e={IMAGERY:"倾斜",BIMMODEL:"BIM",POINTCLOUD:"点云",MODEL:"模型",IMAGEDATA:"影像",TERRAIN:"地形",PANORAMICIMAGE:"全景影像",VECTOR:"矢量",VECTOR2:"海量矢量",KML:"KML",GEO3DML:"地质模型",WMTS:"WMTS",WMS:"WMS"},fe=["TERRAIN","VECTORICON","IOT","WFS"],Y=l=>(de("data-v-72f9dae3"),l=l(),ue(),l),Ne={class:"not-date"},ze=["onClick"],We={class:"service-top"},Be={class:"service-top__main"},Ge=["title","onClick"],je=["onMouseover"],Fe={class:"service-alias"},Ke=["title"],Ye={class:"service-url"},He=["title","onClick"],Qe={class:"service-bottom"},Ze={class:"service-bottom__info"},Je=Y(()=>o("span",{class:"line"},null,-1)),Xe=Y(()=>o("span",{class:"line"},null,-1)),et=Y(()=>o("span",{class:"line"},null,-1)),tt={class:"service-bottom__operation"},at=["onClick"],lt=Y(()=>o("span",{class:"line"},null,-1)),st=["onClick"],ot=Y(()=>o("span",{class:"line"},null,-1)),nt=["onClick"],rt=Y(()=>o("span",{class:"line"},null,-1)),it=["onClick"],ct=Z({__name:"service",props:{data:{}},emits:["operate"],setup(l,{expose:b,emit:w}){const h=l,u=w,V=["审核中","已通过","申请服务","申请服务","申请服务","申请服务"],t=k(),i=k(),L=k(),r=k(),S=k(),M=k(""),p=O(()=>{const g=document.documentElement;return getComputedStyle(g).getPropertyValue("--el-color-warning-light-3")}),C=O(()=>h.data),P=O(()=>g=>{const{category:D}=g;return $e[D]??"NULL"}),U=O(()=>g=>{const{collected:D}=g;return D?"取消收藏":"收藏"}),q=O(()=>({position:"absolute",width:"100%",height:"100%"})),I=(g,D)=>{u("operate",g,D)};function A(g){return g>1}function z(g){return V[g]||"申请服务"}function f(g,D){const H=L.value[D].offsetWidth,W=r.value[D].offsetWidth,a=i.value[D].scrollWidth,d=S.value[D].offsetWidth-32-H-W-32;d&&a&&d<a&&(M.value=g.id)}return b({serviceRef:t}),(g,D)=>{const H=y("el-popover"),W=y("el-icon"),a=y("el-scrollbar");return _(),T("div",{ref_key:"serviceRef",ref:t,class:"service-container"},[ae(o("div",Ne,"暂无数据",512),[[ne,!C.value.length]]),ae(s(a,{style:re(q.value)},{default:n(()=>[(_(!0),T(G,null,Q(C.value,(e,d)=>(_(),T("div",{key:e.id,ref_for:!0,ref_key:"rowRef",ref:S,class:"service-row",onClick:E(v=>I("preview",e),["stop"])},[o("div",We,[o("div",Be,[o("div",{ref_for:!0,ref_key:"typeRef",ref:L,class:"service-top__type"},c(P.value(e)),513),o("div",{ref_for:!0,ref_key:"nameRef",ref:r,class:"service-top__name",title:e.name,onClick:E(v=>I("detail",e),["stop"])},c(e.name),9,Ge),s(H,{disabled:M.value!==e.id,placement:"top-end","show-arrow":!1,width:"500"},{reference:n(()=>[o("div",{ref_for:!0,ref_key:"tagRef",ref:i,class:"service-top__tags",onMouseover:E(v=>f(e,d),["stop"])},[(_(!0),T(G,null,Q(e.tags,(v,x)=>(_(),T("span",{key:x,class:"tag-item"},"#"+c(v),1))),128))],40,je)]),default:n(()=>[(_(!0),T(G,null,Q(e.tags,(v,x)=>(_(),T("span",{key:x,class:"popover-tag-item"},"#"+c(v),1))),128))]),_:2},1032,["disabled"])])]),o("div",Fe,[j(" 服务别名:    "),o("div",{class:"alias",title:e.aliasName},c(e.aliasName),9,Ke)]),o("div",Ye,[j(" 服务地址:    "),o("div",{class:"url",title:e.url,onClick:E(v=>I("preview",e),["stop"])},c(e.url||"********"),9,He)]),o("div",Qe,[o("div",Ze,[o("span",null,c(e.createTime),1),Je,o("span",null,c(e.creator),1),Xe,o("span",null,"浏览: "+c(e.shareAccessCount),1),et,o("span",null,"申请: "+c(e.applyCount),1)]),o("div",tt,[o("span",{class:"collect",style:re({color:e.collected?p.value:""}),onClick:E(v=>I("collect",e),["stop"])},[e.collected?(_(),K(W,{key:0,size:"18",color:p.value},{default:n(()=>[s(m(_e))]),_:1},8,["color"])):ee("",!0),e.collected?ee("",!0):(_(),K(W,{key:1,size:"14"},{default:n(()=>[s(m(ve))]),_:1})),j(" "+c(U.value(e)),1)],12,at),lt,e.havePermissionType===0?(_(),T("span",{key:0,class:te(["apply",A(e.applyStatus)?"can-apply":"disabled"]),onClick:E(v=>I("apply",e),["stop"])},c(z(e.applyStatus)),11,st)):ee("",!0),ot,o("span",{class:"detail",onClick:E(v=>I("detail",e),["stop"])},"详情",8,nt),rt,o("span",{class:te({preview:!0,disable:m(fe).includes(e==null?void 0:e.category)}),onClick:E(v=>I("preview",e),["stop"])},"预览",10,it)])])],8,ze))),128))]),_:1},8,["style"]),[[ne,C.value.length]])],512)}}});const dt=le(ct,[["__scopeId","data-v-72f9dae3"]]),ut=Z({__name:"apply",props:{modelValue:{type:Boolean,default:!1},info:{type:Object,default:()=>({})}},emits:["update:modelValue","refresh"],setup(l,{emit:b}){const w=l,h=b,u=F({applyReason:"",validateDays:7,radios:Object.freeze([{title:"7天",value:7},{title:"1个月",value:30},{title:"3个月",value:90},{title:"永久",value:36500}]),btnLoading:!1}),V={applyReason:[{required:!0,message:"申请理由不能为空",trigger:["change","blur"]}],validateDays:[{required:!0,message:"请选择",trigger:"change"}]},t=k(),i=F({validateDays:7,applyReason:""}),L=O(()=>w.modelValue),r=()=>{i.applyReason="",i.validateDays=7,h("update:modelValue",!1)},S=async()=>{var p;const M=m(t);if(M)try{await M.validate(),u.btnLoading=!0;const{validateDays:C,applyReason:P}=i;if(!P||((p=P==null?void 0:P.trim())==null?void 0:p.length)===0)return B.warning("请输入申请理由");const{id:U,applyRecordId:q}=w.info;Pe({approvalId:q,id:U,validDays:C,applyReason:P}).then(A=>{A.code===$.SUCCESS?(B({message:"申请成功",type:"success"}),h("refresh"),r()):B({message:A.message,type:"warning"})}).catch(A=>{u.btnLoading=!1,B.error(`申请服务异常 : ${A.message}`)})}catch{}};return(M,p)=>{const C=y("el-form-item"),P=y("el-radio"),U=y("el-radio-group"),q=y("el-input"),I=y("el-form"),A=y("el-button"),z=y("el-dialog");return _(),K(z,{modelValue:L.value,"onUpdate:modelValue":p[2]||(p[2]=f=>L.value=f)},{footer:n(()=>[s(A,{onClick:r},{default:n(()=>[j("取消")]),_:1}),s(A,{type:"primary",onClick:S},{default:n(()=>[j("提交")]),_:1})]),default:n(()=>[s(I,{ref_key:"formRef",ref:t,model:i,rules:V,"label-width":"120px"},{default:n(()=>[s(C,{label:"申请服务 :"},{default:n(()=>{var f;return[o("span",null,c((f=l.info)==null?void 0:f.name),1)]}),_:1}),s(C,{label:"服务别名 :"},{default:n(()=>{var f;return[o("span",null,c((f=l.info)==null?void 0:f.aliasName),1)]}),_:1}),s(C,{label:"持续时间 :",prop:"validateDays"},{default:n(()=>[s(U,{modelValue:i.validateDays,"onUpdate:modelValue":p[0]||(p[0]=f=>i.validateDays=f)},{default:n(()=>[(_(!0),T(G,null,Q(u.radios,f=>(_(),K(P,{key:f.value,label:f.value},{default:n(()=>[j(c(f.title),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(C,{label:"申请理由 :",prop:"applyReason"},{default:n(()=>[s(q,{modelValue:i.applyReason,"onUpdate:modelValue":p[1]||(p[1]=f=>i.applyReason=f),style:{width:"90%"},type:"textarea","min-rows":3,rows:3,maxlength:100,"show-word-limit":"",placeholder:"请填写申请理由，不超过100字"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),pt=["title"],ft=Z({__name:"detail",props:{modelValue:{type:Boolean,default:!1},serviceInfo:{type:Object,default:()=>({})}},emits:["viewService"],setup(l,{emit:b}){const w=b,h=l,u=O(()=>h.modelValue);return(V,t)=>{const i=y("el-form-item"),L=y("el-form"),r=y("el-dialog");return _(),K(r,{modelValue:u.value,"onUpdate:modelValue":t[1]||(t[1]=S=>u.value=S)},{default:n(()=>[s(L,{ref:"form","label-width":"120px"},{default:n(()=>[s(i,{label:"服务名称 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.name),1)]),_:1}),s(i,{label:"服务别名 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.aliasName),1)]),_:1}),s(i,{label:"服务类型 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.categoryAliasName),1)]),_:1}),s(i,{label:"服务描述 :"},{default:n(()=>[o("span",{class:te(["description",l.serviceInfo.description?"":"empty"])},c(l.serviceInfo.description||"未描述"),3)]),_:1}),s(i,{label:"发布人 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.creator),1)]),_:1}),s(i,{label:"发布时间 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.createTime),1)]),_:1}),s(i,{label:"访问次数 :"},{default:n(()=>[o("span",null,c(l.serviceInfo.accessCount||0),1)]),_:1}),l.serviceInfo.url?(_(),K(i,{key:0,label:"服务地址 :"},{default:n(()=>[o("span",{class:"url",title:l.serviceInfo.url,onClick:t[0]||(t[0]=S=>w("viewService",l.serviceInfo))},c(l.serviceInfo.url),9,pt)]),_:1})):ee("",!0)]),_:1},512)]),_:1},8,["modelValue"])}}});const _t=le(ft,[["__scopeId","data-v-f7ab9e0a"]]),vt=Z({__name:"index",setup(l){const b=k("all"),w=k(),h=k(),u=k(),V=k(),t=F({treeData:[],serviceList:[],total:0,data:[],pageSizes:[5,10,15,20,30],pageSize:5,currentPage:1,treeProps:{label:"name"},requestParams:{category:"",status:"",permissionType:"",startTime:"",endTime:"",keyword:"",label:"",catalogId:"",page:1,rows:5,isCollect:0},backUpRequestParams:{},serviceListLoading:!1,treeLoading:!1,applyDialogVisible:!1,currentService:null,detailDialogVisible:!1,tags:[]}),{searchOptions:i}=Ae(t.requestParams),L=O(()=>{var a;return(a=w.value)==null?void 0:a.$el}),r=()=>({getServiceTree(){t.treeLoading=!0,t.treeData=[],Le().then(a=>{a.code===$.SUCCESS&&(t.treeData=a.data)}).finally(()=>{t.treeLoading=!1})},getServiceList(){t.serviceListLoading=!0,t.serviceList=[],De(t.requestParams).then(a=>{a.code===$.SUCCESS&&(t.total=a.data.total,t.serviceList=a.data.records.map(e=>({...e,tags:e!=null&&e.label?e.label.split(","):[]})))}).finally(()=>{t.serviceListLoading=!1})},collectService(a){Re(a).then(e=>{e.code===$.SUCCESS&&r().getServiceList()})},unCollectService(a){Te(a).then(e=>{e.code===$.SUCCESS&&r().getServiceList()})},getAllTags(){pe().then(a=>{a.code===$.SUCCESS&&(t.tags=a.data)})},updateShareAccessCount(a){Ie(a)}}),S=()=>{r().getServiceTree(),r().getServiceList(),r().getAllTags()},M=()=>{Object.assign(t.requestParams,t.backUpRequestParams)},p=a=>{const{keyword:e,label:d}=a;t.requestParams.keyword=e,t.requestParams.label=Array.isArray(d)?d.join(","):d,r().getServiceList()},C=a=>{t.requestParams.category=a==="all"?"":a,r().getServiceList()},P=()=>{t.requestParams.keyword="",t.requestParams.label="",V.value.setFormValue("keyword",""),V.value.setFormValue("label","")},U=a=>{var d,v,x;(d=h.value)==null||d.setTagValue("all"),t.requestParams.category="",P();const{id:e}=a;t.requestParams.catalogId=e,(v=u.value)==null||v.changeCheckBoxStatus(!1),(x=u.value)==null||x.smartTreeRef.setCheckedKeys([a.id]),r().getServiceList()},q=()=>{var a;(a=h.value)==null||a.setTagValue("all"),t.requestParams.category="",P(),t.requestParams.catalogId="",r().getServiceList()},I=a=>{t.requestParams.rows=a,r().getServiceList()},A=a=>{t.requestParams.page=a,r().getServiceList()},z=async a=>{const{category:e,id:d,serviceType:v,name:x,url:J}=a,R=we({category:e,id:d,serviceType:v,name:x,url:J});if(!R){B.error("预览服务出错, 请稍后重试!");return}await r().updateShareAccessCount(a.id),window.open(R)};function f(a){const{applyStatus:e,havePermissionType:d}=a;return d||e===1}function g(a){const{url:e,applyStatus:d}=a;return e&&d!==null}const D=(a,e)=>{switch(a){case"collect":e.collected?r().unCollectService(e.id):r().collectService(e.id);break;case"apply":const{applyStatus:d}=e;d>1&&(t.currentService=e,t.applyDialogVisible=!0);break;case"detail":t.currentService=e,t.detailDialogVisible=!0;break;case"preview":if(fe.includes(e==null?void 0:e.category))return!1;f(e)?z(e):g(e)&&(e.applyStatus===2||e.applyStatus===3)?ie.confirm("该服务已过期，是否重新申请？","权限提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{t.currentService=e,t.applyDialogVisible=!0}).catch(()=>{}):e.applyStatus>1?ie.confirm("您还没有该服务的查看权限，是否前往申请？","权限提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{t.currentService=e,t.applyDialogVisible=!0}).catch(()=>{}):e.applyStatus===0&&B.warning("该服务的申请正在审核中, 请稍后操作");break}};me(b,a=>{M(),t.requestParams.isCollect=a==="all"?0:1,r().getServiceList()});const H=()=>{t.applyDialogVisible=!1,t.currentService=null},W=()=>{t.detailDialogVisible=!1,t.currentService=null};return ce(()=>{t.backUpRequestParams=Ve(t.requestParams),S()}),ge(()=>{M()}),(a,e)=>{const d=y("el-tab-pane"),v=y("el-tabs"),x=y("el-pagination"),J=ye("loading");return _(),T(G,null,[s(m(se),{background:""},{default:n(()=>[s(m(he),{ref_key:"treeAsideRef",ref:w},{default:n(()=>[ae(s(m(Se),{ref_key:"treeRef",ref:u,data:t.treeData,props:t.treeProps,"default-expand-all":"","node-key":"id","highlight-current":"","expand-on-click-node":!1,onNodeClick:U,onCheckBoxChange:q},null,8,["data","props"]),[[J,t.treeLoading]])]),_:1},512),s(m(se),null,{default:n(()=>[s(m(be),{target:L.value},null,8,["target"]),s(m(se),null,{default:n(()=>[s(m(X),{padding:"0 0"},{default:n(()=>[s(v,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=R=>b.value=R)},{default:n(()=>[s(d,{label:"全部资源",name:"all"}),s(d,{label:"收藏资源",name:"collect"})]),_:1},8,["modelValue"])]),_:1}),s(m(X),{padding:"1 1 0",border:""},{default:n(()=>[s(m(Ce),{ref_key:"SmartSearchRef",ref:V,options:m(i),"query-permission":"sys_district_page",onHandleSearch:p},null,8,["options"])]),_:1}),s(m(X),{padding:"1 1 0"},{default:n(()=>[s(qe,{ref_key:"tagRef",ref:h,onCb:C},null,512)]),_:1}),s(m(ke),null,{default:n(()=>[ae(s(dt,{style:{height:"100%"},data:t.serviceList,onOperate:D},null,8,["data"]),[[J,t.serviceListLoading]])]),_:1}),s(m(X),{justify:"end",padding:"0 1 1"},{default:n(()=>[s(x,{"current-page":t.currentPage,"onUpdate:currentPage":e[1]||(e[1]=R=>t.currentPage=R),"page-size":t.pageSize,"onUpdate:pageSize":e[2]||(e[2]=R=>t.pageSize=R),layout:"total, sizes, prev, pager, next, jumper",total:t.total,"page-sizes":t.pageSizes,background:"",onSizeChange:I,onCurrentChange:A},null,8,["current-page","page-size","total","page-sizes"])]),_:1})]),_:1})]),_:1})]),_:1}),s(ut,{modelValue:t.applyDialogVisible,"onUpdate:modelValue":e[3]||(e[3]=R=>t.applyDialogVisible=R),width:"40%",title:"服务使用申请",info:t.currentService,onClose:H,onRefresh:e[4]||(e[4]=R=>r().getServiceList())},null,8,["modelValue","info"]),s(_t,{modelValue:t.detailDialogVisible,"onUpdate:modelValue":e[5]||(e[5]=R=>t.detailDialogVisible=R),title:"注册服务详情","service-info":t.currentService,onViewService:z,onClose:W},null,8,["modelValue","service-info"])],64)}}});const kt=le(vt,[["__scopeId","data-v-123f1f99"]]);export{kt as default};
