import{v as I,q as R}from"./lodash.22f463b4.js";import{h as M,f as b}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";import{i as B,m as _}from"./index-a95bb620.js";import{r as w,S as G,aj as g,i as H,c as F,bH as v,ai as y}from"./element-plus.59ccb443.js";import{r as p}from"./login.a4e9287e.js";import{S as J}from"./serviceManage.8c46f250.js";function X(i,h=!0){const e=w({defaultTileInfoForm:{taskInfo:[]},tileInfoForm:{taskInfo:[]},tileInfoFormRule:{taskInfo:[{required:!0,message:"切片方案不能为空",trigger:"change"}]},treeProps:{label:"name",children:"children"},taskTreeData:[],curTaskId:"",cellData:[],publishConfigList:[],isLoadingScheme:!1,showErrorTip:!1});function L(){e.tileInfoForm=I(e.defaultTileInfoForm),e.curTaskId="",e.cellData=[],e.publishConfigList=[],e.isLoadingScheme=!1,e.showErrorTip=!1}function T(){M.getClassifyTree().then(a=>{a.code==="0000"?(e.taskTreeData=a.data,S()):(g({type:"warning",message:"获取切片方案数据有误"}),e.taskTreeData=[])}).catch(a=>{g({type:"error",message:a.message||"获取切片方案数据有误"}),e.taskTreeData=[]})}function S(){const a=s=>{var t;for(let n=0,o=s.length;n<o;n++)s[n].type===1&&s[n].dataType?s[n].name=`(默认) ${s[n].name}`:((t=s[n].children)==null?void 0:t.length)>0&&a(s[n].children)};a(e.taskTreeData),h&&D()}function D(){let a=null;const s=t=>{var n;for(let o=0,r=t.length;o<r;o++)if(t[o].type===1&&t[o].dataType&&t[o].dataType===i.value){a=t[o];break}else((n=t[o].children)==null?void 0:n.length)>0&&s(t[o].children)};s(e.taskTreeData),e.tileInfoForm.taskInfo=a,a&&O(a)}function N(a){let s=null;const t=n=>{var o;for(let r=0,f=n.length;r<f;r++)if(n[r].type===1&&n[r].id===a){s=n[r];break}else((o=n[r].children)==null?void 0:o.length)>0&&t(n[r].children)};t(e.taskTreeData),e.tileInfoForm.taskInfo=s,s&&(e.curTaskId=(s==null?void 0:s.id)||""),e.isLoadingScheme=!1}function O(a){a.id!==e.curTaskId&&(e.curTaskId=a.id,e.isLoadingScheme=!0,M.getSchemeInfo(e.curTaskId).then(s=>{if(s.code==="0000"){const t=JSON.parse(s.data.scheme).cells;e.cellData=I(t),c();const n=e.cellData.filter(o=>{var r;return o.type==="algorithm.Element"&&o.algorithmType!=="READ_DATASOURCE"&&o.algorithmType!=="WRITE_DATASOURCE"&&((r=o.publishParamList)==null?void 0:r.length)>0});for(let o=0,r=n.length;o<r;o++)l(n[o]);E(t)}else e.isLoadingScheme=!1,g({type:"warning",message:"获取方案信息有误"})}).catch(s=>{e.isLoadingScheme=!1,g({type:"error",message:s.message||"获取方案信息错误"})}))}function C(a){e.isLoadingScheme=!0;const s=JSON.parse(a).cells;e.cellData=I(s),c(),E(s)}function P(a){return e.cellData.find(s=>s.id===a)}function E(a){const s=a.filter(t=>{var n;return t.type==="algorithm.Element"&&t.algorithmType!=="READ_DATASOURCE"&&t.algorithmType!=="WRITE_DATASOURCE"&&((n=t.publishParamList)==null?void 0:n.length)>0});if(s.length>0){const t=Array(s.length).fill(null);s.forEach((o,r)=>{t[r]=A(o.version.id,o.id)}),Promise.all(t).then(o=>{o.some(r=>!r)?(g({type:"warning",message:"获取参数失败！"}),e.publishConfigList=[]):(e.publishConfigList=I(o),s.forEach(r=>{e.publishConfigList.forEach(f=>{f.uid===r.id&&r.publishParamList.forEach(m=>{f.pubulishData[m]=r.data[m]})})}),e.publishConfigList.forEach(r=>{r.paramsConfigList=r.paramsConfigList.filter(f=>r.pubulishData.hasOwnProperty(f.paramName)&&f.paramDirection!=="INPUT"),r.relations=r.relations.filter(f=>r.pubulishData.hasOwnProperty(f.source)&&r.pubulishData.hasOwnProperty(f.target))}),e.isLoadingScheme=!1)})}else e.publishConfigList=[],e.isLoadingScheme=!1}function A(a,s){return new Promise(t=>{M.getAlgorithmDetailInfo(a).then(n=>{if(n.code==="0000"){const{data:o}=n,{name:r,paramsConfig:f}=o;if(B(f)){const d=JSON.parse(f),U={paramsConfigList:d.config||[],relations:d.relations||[],type:d.type||"JOB",name:r,uid:s,pubulishData:{}};setTimeout(()=>{t(I(U))},100)}else t(!1)}else t(!1)}).catch(()=>{t(!1),e.isLoadingScheme=!1})})}function k(a,s,t){const n=e.publishConfigList.find(r=>r.uid===t);n.pubulishData[s]=a;const o=P(t);o.data[s]=a,l(o),setTimeout(()=>{c()},100)}function l(a){const{data:s={},requiredParamList:t=[],paramTypeEnums:n={}}=a;let o=!0;for(let r=0,f=t.length;r<f;r++){if(s[t[r]]===void 0||s[t[r]]===null||s[t[r]]===""){o=!1;break}if(n[t[r]]==="GEO_SRS")if(B(s[t[r]])){const m=JSON.parse(s[t[r]]);if(!Array.isArray(m)||Array.isArray(m)&&m.length===0){o=!1;break}else if(m.some(d=>!(d!=null&&d.coordinateName)||!(d!=null&&d.geodeticDatum))){o=!1;break}}else{o=!1;break}}a.isPassValid=o}function c(a=!1){const s=I(e.cellData);return new Promise(t=>{let n=!0;for(let o=0,r=s.length;o<r;o++){const f=s[o];if(f.type==="algorithm.Element"&&(f.isError||!f.isPassValid)){n=!1;break}}n?(t(!0),e.showErrorTip=!1):(a&&g({type:"warning",message:"请正确填写参数赋值或选择正确的切片方案"}),t(!1),e.showErrorTip=!0)})}function u(a){return new Promise(s=>{a.validate(t=>{s(t)})})}return{...G(e),initSchemeData:L,getAllTask:T,formatTreeData:S,getDefaultTaskInfo:D,handleTaskChange:O,getCellData:P,createTileInfoForm:E,getParamConfigPromise:A,handleControlChange:k,setCellPassValid:l,checkDagScheme:c,checkSchemeForm:u,getTaskInfoById:N,renderSchemeByDag:C}}const ee={getDictreeByCatalogId(i){return p.doGetPromise("/resourcerelease/manager/resources/datas/resourceset/getDictreeByCatalogId",{catalogId:i})},getResourcesetPageList(i){return p.doGetPromise("/resourcerelease/manager/resources/datas/resourceset/list",i)},addResourceset(i,h={}){return p.doPostPromiseJson("/resourcerelease/manager/resources/datas/resourceset/save",i,h)},updateResourceset(i,h={}){return p.doPostPromiseJson("/resourcerelease/manager/resources/datas/resourceset/update",i,h)},publishResourceset(i,h={}){return p.doPostPromiseJson("mapserver/manager/services/publishResourceSet",i,h)},getResourcesetById(i,h=!1){return p.doGetPromise(`/resourcerelease/manager/resources/datas/resourceset/${i}`,{hasDel:h})},deleteResourcesetByIdArr(i){return p.doPostPromiseJson("/resourcerelease/manager/resources/datas/resourceset/delete",i,{})},buildDataByresourceId(i){return p.doGetPromise("/resourcerelease/manager/resources/datas/resourceset/createResourceSet",{geoDbResourceId:i})}},se=["IMAGERY","BIMMODEL","PANORAMICIMAGE","MODEL","POINTCLOUD"],te=["3DTILES","GEOJSON","TERRAIN","PNG","WEBP","PAK","ZNP"],V=["TERRAIN","IMAGEDATA","IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],ae=["IMAGERY","POINTCLOUD","BIMMODEL","MODEL"],re=["BIMMODEL","MODEL"],ie=["TERRAIN","IMAGEDATA"],oe=[...V,"VECTOR"],ne=["IMAGEDATA","TERRAIN","VECTOR"];var W=(i=>(i.NONE="",i.LIGHTWEIGHT="TILESET",i.ORIGINAL="ORIGIN",i))(W||{}),j=(i=>(i.NOT_PUBLISH="NOT_PUBLISH",i.PUBLISHED="PUBLISHED",i.PUBLISHING="PUBLISHING",i.PUBLISH_FAIL="PUBLISH_FAIL",i))(j||{});const le=new Map([["NOT_PUBLISH","未发布"],["PUBLISHED","已发布"],["PUBLISHING","正在发布"],["PUBLISH_FAIL","发布失败"]]),ce="EPSG:4326",fe="0,0,0",ue=0;var q=(i=>(i.NONE="NONE",i.THREE_DIMENSION="THREE_DIMENSION",i.TWO_DIMENSION="TWO_DIMENSION",i))(q||{}),Y=(i=>(i.IMAGERY="倾斜数据",i.POINTCLOUD="点云数据",i.MODEL="模型数据",i.BIMMODEL="BIM模型",i.IMAGEDATA="影像数据",i.TERRAIN="地形数据",i.VECTOR="矢量数据",i))(Y||{});function he(i,h){const e=w({checkNameing:!1,checkTimer:null,srsOptions:[],srsCopyOptions:[],stylesList:[],treeProps:{label:"name",children:"children"},groupIdentify:{key:"type",value:0},gridSetsList:[]}),L=H("getAllServiceOptions"),T=F(()=>(L==null?void 0:L())||[]);v(()=>{S(),N(),O()});function S(){b.getSrsList().then(l=>{l.code==="0000"?(e.srsOptions=l.data,e.srsOptions.forEach(c=>{c.value=`EPSG:${c.value}`})):(e.srsOptions=[],g({type:"error",message:"获取坐标系统失败"}))}).catch(()=>{e.srsOptions=[],g({type:"error",message:"获取坐标系统错误"})}).finally(()=>{e.srsCopyOptions=R.cloneDeep(e.srsOptions)})}function D(l){l?e.srsOptions=R.cloneDeep(e.srsCopyOptions).filter(c=>c.label.toLowerCase().includes(l.toLowerCase())||c.value.toLowerCase().includes(l.toLowerCase())):e.srsOptions=R.cloneDeep(e.srsCopyOptions)}function N(){_.getStylesList().then(l=>{l.code==="0000"?e.stylesList=l.data||[]:y({type:"error",title:"获取样式列表失败",message:l.message})}).catch(l=>{y({type:"error",title:"获取样式列表错误",message:l.message})})}function O(){b.getGridSetsList().then(l=>{l.code==="0000"?e.gridSetsList=l.data||[]:y({type:"error",title:"获取网格集数据失败",message:l.message})}).catch(l=>{y({type:"error",title:"获取网格集数据错误",message:l.message})})}function C(l,c,u){if(c){const a=c.match(/[\W_]/);(a==null?void 0:a.length)>0?u(new Error("数据集标识不能输入汉字、空格和特殊符号!")):(e.checkNameing=!0,e.checkTimer&&clearTimeout(e.checkTimer),e.checkTimer=setTimeout(()=>{J.checkServiceName(c,i(),h()).then(s=>{s.code==="0000"?s.data?u(new Error("该数据集标识已被使用")):u():(g({type:"warning",message:s.message}),u(new Error("后台验证失败，无法通过")))}).catch(()=>{g({type:"error",message:"验证是否重名接口失败"}),u(new Error("后台验证失败，无法通过"))}).finally(()=>{e.checkNameing=!1})},500))}else e.checkTimer&&clearTimeout(e.checkTimer),e.checkNameing=!1,u(new Error("数据集标识不能为空"))}function P(l){return new Promise(c=>{l.value?l.value.validate(u=>{c(u)}):c(!1)})}function E(l){var u;const c=(u=T.value)==null?void 0:u.find(a=>a.code===l);return c?c.showValue:l}function A(l){const c=e.gridSetsList.find(u=>u.value===l);return c?c.label:l}function k(l){let c=null;const u=a=>{var s;for(let t=0,n=a.length;t<n;t++)if(a[t].id===l){c=a[t];break}else((s=a[t].children)==null?void 0:s.length)>0&&u(a[t].children)};return u(e.stylesList),c}return{...G(e),allServiceOptions:T,checkFormPass:P,checkResourceSetName:C,srsFilterFunc:D,formartDataType:E,getGridSetsName:A,getStyleById:k}}export{ee as A,W as D,q as R,j as S,se as _,ae as a,re as b,fe as c,ce as d,ue as e,X as f,ie as g,Y as h,oe as i,V as j,te as k,le as s,ne as t,he as u};
