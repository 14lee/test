import{d as B,r as V,b as G,w as A,e as w,o as p,x as b,k as I,g as C,z as L,f as k,u as M,j as O,ai as u,i as P,c as U,N as j,S as $,aj as D}from"./element-plus.59ccb443.js";import{b as J}from"./login.a4e9287e.js";import{m as R}from"./index-a95bb620.js";import{S as N}from"./serviceManage.8c46f250.js";import{l as W}from"./loseImg1.511f080c.js";import{_ as z}from"./SmartMap.vue_vue_type_style_index_0_lang.6bf21d60.js";import{v as E}from"./lodash.22f463b4.js";import{u as F}from"./error.229cea25.js";import{f as S}from"./index.vue_vue_type_style_index_0_scoped_7b7c1886_lang.2666f209.js";const q={class:"thumbnail-preview"},H=["src"],K=C("span",{class:"text"},"设置封面",-1),te=B({__name:"ThumbnailPreviewDialog",props:{visible:{type:Boolean,default:!1},title:{default:"封面"},previewData:{default:()=>({})},isData:{type:Boolean,default:!1}},emits:["update:visible","save"],setup(g,{emit:c}){const l=g,s=["VECTOR2","TERRAIN","IOT","WFS"],d=c,t=V({dialogVisible:!1,submiting:!1,isImg:!1}),f=G();A(()=>l.visible,a=>{t.dialogVisible=a});function T(){var a,o;l.isData?t.isImg=!(((a=l.previewData)==null?void 0:a.dataFormat)==="3DTILES"&&((o=l.previewData)!=null&&o.previewUrl)):t.isImg=s.includes(l.previewData.category),t.submiting=!1}function h(){d("update:visible",!1)}function _(a){const o=a.srcElement;o.src=W,o.onerror=null}function y(){var a;l.previewData.thumbnailView&&((a=f.value)==null||a.flyByPerspectiveJson(l.previewData.thumbnailView))}function v(){var a;(a=f.value)==null||a.handleSetAngle((o,e)=>{const i={base64:e,visualAngle:JSON.stringify(o)};l.isData?i.resourceId=l.previewData.resourceId:i.serviceId=l.previewData.id,t.submiting=!0,(l.isData?R.generateServiceThumbnail:N.generateServiceThumbnail)(i).then(r=>{t.submiting=!1,r.code==="0000"?(u({type:"success",title:"封面设置成功"}),d("save"),h()):u({type:"warning",title:"封面设置成功失败，请重试"})}).catch(r=>{t.submiting=!1,u({type:"error",title:"封面设置成功错误",message:r.message||"服务有错"})})})}return(a,o)=>{const e=w("Loading"),i=w("el-icon"),n=w("CameraFilled"),r=w("el-dialog");return p(),b(r,{modelValue:t.dialogVisible,"onUpdate:modelValue":o[1]||(o[1]=m=>t.dialogVisible=m),class:"thumbnail-preview-dialog center-dialog",title:a.title,"append-to-body":"","close-on-click-modal":!1,"close-on-press-escape":!1,width:"600px",onOpen:T,onClosed:h},{default:I(()=>[C("div",q,[t.dialogVisible&&!t.isImg?(p(),b(z,{key:0,ref_key:"smartMapRef",ref:f,"is-data":a.isData,"layer-name":a.previewData.name,url:a.previewData.url,category:a.previewData.category,rectangle:a.previewData.rectangle||{},"alias-name":a.previewData.aliasName,"need-fly":!a.previewData.thumbnailView,onLoadSuccess:y},null,8,["is-data","layer-name","url","category","rectangle","alias-name","need-fly"])):L("",!0),t.dialogVisible&&t.isImg?(p(),k("img",{key:1,class:"image-preview",src:M(J)+a.previewData.thumbnailUrl,style:{width:"100%",height:"auto"},onError:o[0]||(o[0]=m=>_(m))},null,40,H)):L("",!0),t.isImg?L("",!0):(p(),k("div",{key:2,class:"btn",onClick:v},[t.submiting?(p(),b(i,{key:0,class:"is-loading"},{default:I(()=>[O(e)]),_:1})):(p(),b(i,{key:1},{default:I(()=>[O(n)]),_:1})),K]))])]),_:1},8,["modelValue","title"])}}});function oe(g,c){const l=F(),s=V({submiting:!1,checkNameing:!1,checkTimer:null,includeStylesList:["IMAGEDATA","VECTOR","TERRAIN"],stylesList:[],includeGridSetslist:["IMAGEDATA","VECTOR","TERRAIN"],gridSetsList:[],srsOptions:[],srsCopyOptions:[],dataType:"",treeProps:{label:"name",children:"children"},groupIdentify:{key:"type",value:0}}),d=P("getDataInfo"),t=U(()=>d==null?void 0:d());A(()=>t.value.resourceId,e=>{e&&g()}),j(()=>{s.dataType=t.value.dataType,t.value.resourceId&&g()});function f(e,i,n){if(i&&(c!=null&&c())){const r=i.match(/[\W_]/);(r==null?void 0:r.length)>0?n(new Error("服务标识不能输入汉字、空格和特殊符号!")):(s.checkNameing=!0,s.checkTimer&&clearTimeout(s.checkTimer),s.checkTimer=setTimeout(()=>{N.checkServiceName(i,c==null?void 0:c()).then(m=>{s.checkNameing=!1,m.code==="0000"?m.data?n(new Error("该服务标识已被使用")):n():(D({type:"warning",message:m.message}),n(new Error("后台验证失败，无法通过")))}).catch(()=>{D({type:"error",message:"验证是否重名接口失败"}),n(new Error("后台验证失败，无法通过"))})},500))}else s.checkTimer&&clearTimeout(s.checkTimer),s.checkNameing=!1,n()}function T(e,i){return new Promise(n=>{e.value?e.value.validate(r=>{n(i?{name:i,valid:r}:r)}):n(i?{name:i,valid:!1}:!1)})}function h(e){if(!e)return;const i={name:e};l.push(i)}function _(){const{dataType:e}=t.value;s.includeStylesList.includes(e)&&y(),s.includeGridSetslist.includes(e)&&v(),a()}function y(){R.getStylesList().then(e=>{e.code==="0000"?s.stylesList=e.data||[]:u({type:"error",title:"获取样式列表失败",message:e.message})}).catch(e=>{u({type:"error",title:"获取样式列表错误",message:e.message})})}function v(){S.getGridSetsList().then(e=>{e.code==="0000"?s.gridSetsList=e.data||[]:u({type:"error",title:"获取网格集数据失败",message:e.message})}).catch(e=>{u({type:"error",title:"获取网格集数据错误",message:e.message})})}function a(){S.getSrsList().then(e=>{e.code==="0000"?(s.srsOptions=e.data,s.srsOptions.forEach(i=>{i.value=`EPSG:${i.value}`})):(s.srsOptions=[],D({type:"error",message:"获取坐标系统失败"}))}).catch(()=>{s.srsOptions=[],D({type:"error",message:"获取坐标系统错误"})}).finally(()=>{s.srsCopyOptions=E(s.srsOptions)})}function o(e){e?s.srsOptions=E(s.srsCopyOptions).filter(i=>i.label.toLowerCase().includes(e.toLowerCase())||i.value.toLowerCase().includes(e.toLowerCase())):s.srsOptions=E(s.srsCopyOptions)}return{...$(s),releseDataInfo:t,checkFormPass:T,checkServiceName:f,goToServiceManage:h,getListData:_,getStylesList:y,getGridSetsList:v,getSrsList:a,srsFilterFunc:o}}export{te as _,oe as u};
